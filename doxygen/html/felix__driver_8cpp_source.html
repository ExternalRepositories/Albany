<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Albany: a Trilinos-based PDE code: felix_driver.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>felix_driver.cpp</h1>  </div>
</div>
<div class="contents">
<a href="felix__driver_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;fstream&gt;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &quot;<a class="code" href="felix__driver_8H.html">felix_driver.H</a>&quot;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &quot;<a class="code" href="Albany__CismSTKMeshStruct_8hpp.html">Albany_CismSTKMeshStruct.hpp</a>&quot;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &quot;Teuchos_ParameterList.hpp&quot;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &quot;Teuchos_RCP.hpp&quot;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &quot;<a class="code" href="Albany__Utils_8hpp.html">Albany_Utils.hpp</a>&quot;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;<a class="code" href="Albany__SolverFactory_8hpp.html">Albany_SolverFactory.hpp</a>&quot;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &quot;Teuchos_XMLParameterListHelpers.hpp&quot;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;stk_mesh/base/FieldData.hpp&gt;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;Piro_PerformSolve.hpp&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;stk_io/IossBridge.hpp&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;stk_io/MeshReadWriteUtils.hpp&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;stk_mesh/base/GetEntities.hpp&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;stk_mesh/base/FieldData.hpp&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;Ionit_Initializer.h&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="Albany__OrdinarySTKFieldContainer_8hpp.html">Albany_OrdinarySTKFieldContainer.hpp</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;Thyra_EpetraThyraWrappers.hpp&quot;</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="comment">//uncomment the following if you want to write stuff out to matrix market to debug</span>
<a name="l00022"></a>00022 <span class="comment">//#define WRITE_TO_MATRIX_MARKET </span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="preprocessor">#ifdef WRITE_TO_MATRIX_MARKET</span>
<a name="l00025"></a>00025 <span class="preprocessor"></span><span class="preprocessor">#include &quot;EpetraExt_MultiVectorOut.h&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;EpetraExt_BlockMapOut.h&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#endif </span>
<a name="l00028"></a>00028 <span class="preprocessor"></span>
<a name="l00029"></a><a class="code" href="felix__driver_8cpp.html#ab17857c6a5d0e7cb559027884f5135d0">00029</a> Teuchos::RCP&lt;Albany::CismSTKMeshStruct&gt; <a class="code" href="felix__driver_8cpp.html#ab17857c6a5d0e7cb559027884f5135d0">meshStruct</a>;
<a name="l00030"></a><a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">00030</a> Teuchos::RCP&lt;const Epetra_Comm&gt; <a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>;
<a name="l00031"></a><a class="code" href="felix__driver_8cpp.html#ac72c72afb7da5a0adcf02a0e202b4d92">00031</a> Teuchos::RCP&lt;Teuchos::ParameterList&gt; <a class="code" href="felix__driver_8cpp.html#ac72c72afb7da5a0adcf02a0e202b4d92">appParams</a>;
<a name="l00032"></a><a class="code" href="felix__driver_8cpp.html#a7ff94c51f5dd7df62f8038f9c8e15803">00032</a> Teuchos::RCP&lt;Teuchos::ParameterList&gt; <a class="code" href="felix__driver_8cpp.html#a7ff94c51f5dd7df62f8038f9c8e15803">discParams</a>;
<a name="l00033"></a><a class="code" href="felix__driver_8cpp.html#aa2ffb8fe45b2c5323c662073bbded859">00033</a> Teuchos::RCP&lt;Albany::SolverFactory&gt; <a class="code" href="felix__driver_8cpp.html#aa2ffb8fe45b2c5323c662073bbded859">slvrfctry</a>;
<a name="l00034"></a><a class="code" href="felix__driver_8cpp.html#a972cd8f5f47d36a2a3cea6e71a0ffa11">00034</a> Teuchos::RCP&lt;Thyra::ModelEvaluator&lt;double&gt; &gt; <a class="code" href="felix__driver_8cpp.html#a972cd8f5f47d36a2a3cea6e71a0ffa11">solver</a>;
<a name="l00035"></a>00035 <span class="comment">//IK, 11/14/13: what is reducedComm for? </span>
<a name="l00036"></a><a class="code" href="felix__driver_8cpp.html#a22f184faf197359d03fc3e77e2bea60b">00036</a> MPI_Comm <a class="code" href="felix__driver_8cpp.html#ab048c6f9fcbcfaa57ce68b00263dbebe">comm</a>, <a class="code" href="felix__driver_8cpp.html#a22f184faf197359d03fc3e77e2bea60b">reducedComm</a>;
<a name="l00037"></a><a class="code" href="felix__driver_8cpp.html#af1beb0c410a8a48552ab0fdb5e8c49ed">00037</a> <span class="keywordtype">bool</span> <a class="code" href="felix__driver_8cpp.html#af1beb0c410a8a48552ab0fdb5e8c49ed">interleavedOrdering</a>; 
<a name="l00038"></a><a class="code" href="felix__driver_8cpp.html#a1174e24eeba8055c402b92f4f60bfd6f">00038</a> <span class="keywordtype">int</span> <a class="code" href="felix__driver_8cpp.html#a1174e24eeba8055c402b92f4f60bfd6f">nNodes2D</a>; <span class="comment">//number global nodes in the domain in 2D </span>
<a name="l00039"></a><a class="code" href="felix__driver_8cpp.html#a29e784fe0952393697d73c3b417bb9ca">00039</a> <span class="keywordtype">int</span> <a class="code" href="felix__driver_8cpp.html#a29e784fe0952393697d73c3b417bb9ca">nNodesProc2D</a>; <span class="comment">//number of nodes on each processor in 2D  </span>
<a name="l00040"></a>00040 <span class="comment">//vector used to renumber nodes on each processor from the Albany convention (horizontal levels first) to the CISM convention (vertical layers first)</span>
<a name="l00041"></a><a class="code" href="felix__driver_8cpp.html#a1c055a28ab77eebc667f57e9adca360a">00041</a> std::vector&lt;int&gt; <a class="code" href="felix__driver_8cpp.html#a1c055a28ab77eebc667f57e9adca360a">cismToAlbanyNodeNumberMap</a>; 
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 
<a name="l00044"></a><a class="code" href="felix__driver_8cpp.html#a6cfd95afd0afebd625b889fb6e58371c">00044</a> <span class="keywordtype">int</span> <a class="code" href="felix__driver_8cpp.html#a6cfd95afd0afebd625b889fb6e58371c">rank</a>, <a class="code" href="felix__driver_8cpp.html#af246a82f31a689ce98de58b09b7561b5">number_procs</a>;
<a name="l00045"></a><a class="code" href="felix__driver_8cpp.html#a8dd58c252e36bf87ee1eb41cadb21421">00045</a> <span class="keywordtype">long</span>  <a class="code" href="felix__driver_8cpp.html#a8dd58c252e36bf87ee1eb41cadb21421">cism_communicator</a>; 
<a name="l00046"></a><a class="code" href="felix__driver_8cpp.html#a2493b19baf4fd1ad3a714b31ca11ed71">00046</a> <span class="keywordtype">int</span> <a class="code" href="felix__driver_8cpp.html#a76dd1f3a71795a1455a459c2619648db">cism_process_count</a>, <a class="code" href="felix__driver_8cpp.html#a2493b19baf4fd1ad3a714b31ca11ed71">my_cism_rank</a>;
<a name="l00047"></a><a class="code" href="felix__driver_8cpp.html#ad08a07debb791d23c0c8b3d44f4029d9">00047</a> <span class="keywordtype">double</span> <a class="code" href="felix__driver_8cpp.html#affcc17141c51ccbbec2496279df8813f">dew</a>, <a class="code" href="felix__driver_8cpp.html#ad08a07debb791d23c0c8b3d44f4029d9">dns</a>;
<a name="l00048"></a><a class="code" href="felix__driver_8cpp.html#abd8d1639529f999e6d1bfc6efc3fec1b">00048</a> <span class="keywordtype">long</span> * <a class="code" href="felix__driver_8cpp.html#abd8d1639529f999e6d1bfc6efc3fec1b">dimInfo</a>;        
<a name="l00049"></a><a class="code" href="felix__driver_8cpp.html#aaa2cafa89e6e1617776b4f2c49f2b282">00049</a> <span class="keywordtype">int</span> * <a class="code" href="felix__driver_8cpp.html#aaa2cafa89e6e1617776b4f2c49f2b282">dimInfoGeom</a>; 
<a name="l00050"></a><a class="code" href="felix__driver_8cpp.html#a642f2498a656efddf6118e732d0c195e">00050</a> <span class="keywordtype">long</span> <a class="code" href="felix__driver_8cpp.html#a2b582274af3b1f805cdb0729187fd6e4">ewlb</a>, <a class="code" href="felix__driver_8cpp.html#a2b5f18bd7c3d97f532b8fea77c410f1d">ewub</a>, <a class="code" href="felix__driver_8cpp.html#af2e9ac50c71f2038cc74dd768d742fac">nslb</a>, <a class="code" href="felix__driver_8cpp.html#a642f2498a656efddf6118e732d0c195e">nsub</a>;
<a name="l00051"></a><a class="code" href="felix__driver_8cpp.html#a536cbbfa58672a4d27b7baf804bc3acf">00051</a> <span class="keywordtype">long</span> <a class="code" href="felix__driver_8cpp.html#abaf03ce76028bb0766397be59a6da33e">ewn</a>, <a class="code" href="felix__driver_8cpp.html#ab535ad6429f94303bc2e0347bb388e0d">nsn</a>, <a class="code" href="felix__driver_8cpp.html#a536cbbfa58672a4d27b7baf804bc3acf">upn</a>, <a class="code" href="felix__driver_8cpp.html#ad5e3206ff1abe2f3f806cae173f65309">nhalo</a>; 
<a name="l00052"></a><a class="code" href="felix__driver_8cpp.html#ae883eb14937c6d0dc57be4bdd8d4116c">00052</a> <span class="keywordtype">long</span> <a class="code" href="felix__driver_8cpp.html#ab98b1b45c88b0fb97ccb6a32dc237d84">global_ewn</a>, <a class="code" href="felix__driver_8cpp.html#ae883eb14937c6d0dc57be4bdd8d4116c">global_nsn</a>; 
<a name="l00053"></a><a class="code" href="felix__driver_8cpp.html#ae04f3ad368404cf236baf6bc3905b149">00053</a> <span class="keywordtype">double</span> * <a class="code" href="felix__driver_8cpp.html#ae04f3ad368404cf236baf6bc3905b149">seconds_per_year_ptr</a>, * <a class="code" href="felix__driver_8cpp.html#a8c0ee12b673dd18835373ce13ceb03af">gravity_ptr</a>, * <a class="code" href="felix__driver_8cpp.html#a7a34e3c1a83ceb9956c757f25f135a02">rho_ice_ptr</a>, * <a class="code" href="felix__driver_8cpp.html#a814f7bfc9074037a27b51b74a6dbba7f">rho_seawater_ptr</a>;
<a name="l00054"></a><a class="code" href="felix__driver_8cpp.html#ae76f1fd81af6a7b486c546bc44124763">00054</a> <span class="keywordtype">double</span> * <a class="code" href="felix__driver_8cpp.html#a5a1fe0d205042877e724f336ff175038">thicknessDataPtr</a>, *<a class="code" href="felix__driver_8cpp.html#ae76f1fd81af6a7b486c546bc44124763">topographyDataPtr</a>;
<a name="l00055"></a><a class="code" href="felix__driver_8cpp.html#ab3a6e4d2e78bb30133169ba1879c7cb8">00055</a> <span class="keywordtype">double</span> * <a class="code" href="felix__driver_8cpp.html#ab3a6e4d2e78bb30133169ba1879c7cb8">upperSurfaceDataPtr</a>, * <a class="code" href="felix__driver_8cpp.html#a41f50f6d1633e338550c8daa2a64519a">lowerSurfaceDataPtr</a>;
<a name="l00056"></a><a class="code" href="felix__driver_8cpp.html#ab1cfa639a256986c34bee0e8cc920dee">00056</a> <span class="keywordtype">double</span> * <a class="code" href="felix__driver_8cpp.html#afe2fdee9ba3442834c836fe47b703ce4">floating_maskDataPtr</a>, * <a class="code" href="felix__driver_8cpp.html#ae5c4ced0bbb03362d77a768d1f59bf38">ice_maskDataPtr</a>, * <a class="code" href="felix__driver_8cpp.html#ab1cfa639a256986c34bee0e8cc920dee">lower_cell_locDataPtr</a>;
<a name="l00057"></a><a class="code" href="felix__driver_8cpp.html#a74fc3f0a9d140b6b442f4976f0a2cb32">00057</a> <span class="keywordtype">long</span> <a class="code" href="felix__driver_8cpp.html#a74fc3f0a9d140b6b442f4976f0a2cb32">nCellsActive</a>;
<a name="l00058"></a><a class="code" href="felix__driver_8cpp.html#ab5242add5962116d4d46270da25895b3">00058</a> <span class="keywordtype">int</span> <a class="code" href="felix__driver_8cpp.html#ab5242add5962116d4d46270da25895b3">nNodes</a>, <a class="code" href="felix__driver_8cpp.html#aed1db7de491b9311aad60370dc10a170">nElementsActive</a>;  
<a name="l00059"></a><a class="code" href="felix__driver_8cpp.html#af62380358bbc17081a691d49d86005d4">00059</a> <span class="keywordtype">double</span>* <a class="code" href="felix__driver_8cpp.html#af62380358bbc17081a691d49d86005d4">xyz_at_nodes_Ptr</a>, *<a class="code" href="felix__driver_8cpp.html#a912ab5f799265bddff9a30ce4b4699b6">surf_height_at_nodes_Ptr</a>, *<a class="code" href="felix__driver_8cpp.html#a93a4ecba1916b1bc3ec66bdecab75044">beta_at_nodes_Ptr</a>;
<a name="l00060"></a><a class="code" href="felix__driver_8cpp.html#a7aec45ea844c90fcb7d0027297e7c6cb">00060</a> <span class="keywordtype">double</span> *<a class="code" href="felix__driver_8cpp.html#a7aec45ea844c90fcb7d0027297e7c6cb">flwa_at_active_elements_Ptr</a>; 
<a name="l00061"></a><a class="code" href="felix__driver_8cpp.html#a82efeaf71a4f15b46f17749f6cc76206">00061</a> <span class="keywordtype">int</span> * <a class="code" href="felix__driver_8cpp.html#a82efeaf71a4f15b46f17749f6cc76206">global_node_id_owned_map_Ptr</a>; 
<a name="l00062"></a><a class="code" href="felix__driver_8cpp.html#a0dcbe6fa72ab0fd4fc399e679112f4c7">00062</a> <span class="keywordtype">int</span> * <a class="code" href="felix__driver_8cpp.html#a0dcbe6fa72ab0fd4fc399e679112f4c7">global_element_conn_active_Ptr</a>; 
<a name="l00063"></a><a class="code" href="felix__driver_8cpp.html#ab9f22496d26d21aae9ba0c06e406660c">00063</a> <span class="keywordtype">int</span> * <a class="code" href="felix__driver_8cpp.html#ab9f22496d26d21aae9ba0c06e406660c">global_element_id_active_owned_map_Ptr</a>; 
<a name="l00064"></a><a class="code" href="felix__driver_8cpp.html#af94320f5df9a5923e219d70db3b0a438">00064</a> <span class="keywordtype">int</span> * <a class="code" href="felix__driver_8cpp.html#af94320f5df9a5923e219d70db3b0a438">global_basal_face_conn_active_Ptr</a>; 
<a name="l00065"></a><a class="code" href="felix__driver_8cpp.html#aa94bb6fc735a20064046aef6e73b8808">00065</a> <span class="keywordtype">int</span> * <a class="code" href="felix__driver_8cpp.html#aa94bb6fc735a20064046aef6e73b8808">global_basal_face_id_active_owned_map_Ptr</a>; 
<a name="l00066"></a><a class="code" href="felix__driver_8cpp.html#aa95651d5002e20d6e0af4b082dce923d">00066</a> <span class="keywordtype">double</span> *<a class="code" href="felix__driver_8cpp.html#aa95651d5002e20d6e0af4b082dce923d">uVel_ptr</a>; 
<a name="l00067"></a><a class="code" href="felix__driver_8cpp.html#aa1f3d948a28f0b81641f76cd8f0aaced">00067</a> <span class="keywordtype">double</span> *<a class="code" href="felix__driver_8cpp.html#aa1f3d948a28f0b81641f76cd8f0aaced">vVel_ptr</a>; 
<a name="l00068"></a><a class="code" href="felix__driver_8cpp.html#af15f444812d331b09076f23ff813d05d">00068</a> <span class="keywordtype">bool</span> <a class="code" href="felix__driver_8cpp.html#af15f444812d331b09076f23ff813d05d">first_time_step</a> = <span class="keyword">true</span>; 
<a name="l00069"></a><a class="code" href="felix__driver_8cpp.html#af9808ee708d8ece5df6ce04b52de71dd">00069</a> Teuchos::RCP&lt;Epetra_Map&gt; <a class="code" href="felix__driver_8cpp.html#af9808ee708d8ece5df6ce04b52de71dd">node_map</a>; 
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 Teuchos::RCP&lt;const Epetra_Vector&gt;
<a name="l00073"></a><a class="code" href="felix__driver_8cpp.html#a9893178d2f0de9d56a7d7df9b51f0bca">00073</a> <a class="code" href="felix__driver_8cpp.html#a9893178d2f0de9d56a7d7df9b51f0bca">epetraVectorFromThyra</a>(
<a name="l00074"></a>00074   <span class="keyword">const</span> Teuchos::RCP&lt;const Epetra_Comm&gt; &amp;<a class="code" href="felix__driver_8cpp.html#ab048c6f9fcbcfaa57ce68b00263dbebe">comm</a>,
<a name="l00075"></a>00075   <span class="keyword">const</span> Teuchos::RCP&lt;<span class="keyword">const</span> Thyra::VectorBase&lt;double&gt; &gt; &amp;thyra)
<a name="l00076"></a>00076 {
<a name="l00077"></a>00077   Teuchos::RCP&lt;const Epetra_Vector&gt; result;
<a name="l00078"></a>00078   <span class="keywordflow">if</span> (Teuchos::nonnull(thyra)) {
<a name="l00079"></a>00079     <span class="keyword">const</span> Teuchos::RCP&lt;const Epetra_Map&gt; epetra_map = Thyra::get_Epetra_Map(*thyra-&gt;space(), comm);
<a name="l00080"></a>00080     result = Thyra::get_Epetra_Vector(*epetra_map, thyra);
<a name="l00081"></a>00081   }
<a name="l00082"></a>00082   <span class="keywordflow">return</span> result;
<a name="l00083"></a>00083 }
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 Teuchos::RCP&lt;const Epetra_MultiVector&gt;
<a name="l00086"></a><a class="code" href="felix__driver_8cpp.html#afe9d79bb19a8a5a1d6f7b9af3159c379">00086</a> <a class="code" href="felix__driver_8cpp.html#afe9d79bb19a8a5a1d6f7b9af3159c379">epetraMultiVectorFromThyra</a>(
<a name="l00087"></a>00087   <span class="keyword">const</span> Teuchos::RCP&lt;const Epetra_Comm&gt; &amp;<a class="code" href="felix__driver_8cpp.html#ab048c6f9fcbcfaa57ce68b00263dbebe">comm</a>,
<a name="l00088"></a>00088   <span class="keyword">const</span> Teuchos::RCP&lt;<span class="keyword">const</span> Thyra::MultiVectorBase&lt;double&gt; &gt; &amp;thyra)
<a name="l00089"></a>00089 {
<a name="l00090"></a>00090   Teuchos::RCP&lt;const Epetra_MultiVector&gt; result;
<a name="l00091"></a>00091   <span class="keywordflow">if</span> (Teuchos::nonnull(thyra)) {
<a name="l00092"></a>00092     <span class="keyword">const</span> Teuchos::RCP&lt;const Epetra_Map&gt; epetra_map = Thyra::get_Epetra_Map(*thyra-&gt;range(), comm);
<a name="l00093"></a>00093     result = Thyra::get_Epetra_MultiVector(*epetra_map, thyra);
<a name="l00094"></a>00094   }
<a name="l00095"></a>00095   <span class="keywordflow">return</span> result;
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 
<a name="l00098"></a><a class="code" href="felix__driver_8cpp.html#a3260e8ae7702f29c0639c7f999354327">00098</a> <span class="keywordtype">void</span> <a class="code" href="felix__driver_8cpp.html#a3260e8ae7702f29c0639c7f999354327">epetraFromThyra</a>(
<a name="l00099"></a>00099   <span class="keyword">const</span> Teuchos::RCP&lt;const Epetra_Comm&gt; &amp;<a class="code" href="felix__driver_8cpp.html#ab048c6f9fcbcfaa57ce68b00263dbebe">comm</a>,
<a name="l00100"></a>00100   <span class="keyword">const</span> Teuchos::Array&lt;Teuchos::RCP&lt;<span class="keyword">const</span> Thyra::VectorBase&lt;double&gt; &gt; &gt; &amp;thyraResponses,
<a name="l00101"></a>00101   <span class="keyword">const</span> Teuchos::Array&lt;Teuchos::Array&lt;Teuchos::RCP&lt;<span class="keyword">const</span> Thyra::MultiVectorBase&lt;double&gt; &gt; &gt; &gt; &amp;thyraSensitivities,
<a name="l00102"></a>00102   Teuchos::Array&lt;Teuchos::RCP&lt;const Epetra_Vector&gt; &gt; &amp;responses,
<a name="l00103"></a>00103   Teuchos::Array&lt;Teuchos::Array&lt;Teuchos::RCP&lt;const Epetra_MultiVector&gt; &gt; &gt; &amp;sensitivities)
<a name="l00104"></a>00104 {
<a name="l00105"></a>00105   responses.clear();
<a name="l00106"></a>00106   responses.reserve(thyraResponses.size());
<a name="l00107"></a>00107   <span class="keyword">typedef</span> Teuchos::Array&lt;Teuchos::RCP&lt;const Thyra::VectorBase&lt;double&gt; &gt; &gt; ThyraResponseArray;
<a name="l00108"></a>00108   <span class="keywordflow">for</span> (ThyraResponseArray::const_iterator it_begin = thyraResponses.begin(),
<a name="l00109"></a>00109       it_end = thyraResponses.end(),
<a name="l00110"></a>00110       it = it_begin;
<a name="l00111"></a>00111       it != it_end;
<a name="l00112"></a>00112       ++it) {
<a name="l00113"></a>00113     responses.push_back(<a class="code" href="felix__driver_8cpp.html#a9893178d2f0de9d56a7d7df9b51f0bca">epetraVectorFromThyra</a>(comm, *it));
<a name="l00114"></a>00114   }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116   sensitivities.clear();
<a name="l00117"></a>00117   sensitivities.reserve(thyraSensitivities.size());
<a name="l00118"></a>00118   <span class="keyword">typedef</span> Teuchos::Array&lt;Teuchos::Array&lt;Teuchos::RCP&lt;const Thyra::MultiVectorBase&lt;double&gt; &gt; &gt; &gt; ThyraSensitivityArray;
<a name="l00119"></a>00119   <span class="keywordflow">for</span> (ThyraSensitivityArray::const_iterator it_begin = thyraSensitivities.begin(),
<a name="l00120"></a>00120       it_end = thyraSensitivities.end(),
<a name="l00121"></a>00121       it = it_begin;
<a name="l00122"></a>00122       it != it_end;
<a name="l00123"></a>00123       ++it) {
<a name="l00124"></a>00124     ThyraSensitivityArray::const_reference sens_thyra = *it;
<a name="l00125"></a>00125     Teuchos::Array&lt;Teuchos::RCP&lt;const Epetra_MultiVector&gt; &gt; sens;
<a name="l00126"></a>00126     sens.reserve(sens_thyra.size());
<a name="l00127"></a>00127     <span class="keywordflow">for</span> (ThyraSensitivityArray::value_type::const_iterator jt = sens_thyra.begin(),
<a name="l00128"></a>00128         jt_end = sens_thyra.end();
<a name="l00129"></a>00129         jt != jt_end;
<a name="l00130"></a>00130         ++jt) {
<a name="l00131"></a>00131         sens.push_back(<a class="code" href="felix__driver_8cpp.html#afe9d79bb19a8a5a1d6f7b9af3159c379">epetraMultiVectorFromThyra</a>(comm, *jt));
<a name="l00132"></a>00132     }
<a name="l00133"></a>00133     sensitivities.push_back(sens);
<a name="l00134"></a>00134   }
<a name="l00135"></a>00135 }
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 
<a name="l00138"></a>00138 <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">void</span> <a class="code" href="felix__driver_8cpp.html#a2105da36db1c42d6ac7791905abf234c">felix_driver_</a>();
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 <span class="comment">//What is exec_mode??</span>
<a name="l00141"></a><a class="code" href="felix__driver_8H.html#af45f0511614b095cf331615c19839dde">00141</a> <span class="keywordtype">void</span> <a class="code" href="felix__driver_8cpp.html#af45f0511614b095cf331615c19839dde">felix_driver_init</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">int</span> exec_mode, FelixToGlimmer * ftg_ptr, <span class="keyword">const</span> <span class="keywordtype">char</span> * input_fname)
<a name="l00142"></a>00142 { 
<a name="l00143"></a>00143 
<a name="l00144"></a>00144     <span class="comment">// ---------------------------------------------</span>
<a name="l00145"></a>00145     <span class="comment">//get communicator / communicator info from CISM</span>
<a name="l00146"></a>00146     <span class="comment">//TO DO: ifdef to check if CISM and Albany have MPI?  </span>
<a name="l00147"></a>00147     <span class="comment">//#ifdef HAVE_MPI</span>
<a name="l00148"></a>00148     <span class="comment">//#else</span>
<a name="l00149"></a>00149     <span class="comment">//#endif</span>
<a name="l00150"></a>00150     <span class="comment">// ---------------------------------------------</span>
<a name="l00151"></a>00151     <span class="comment">// The following line needs to change...  It is for a serial run...</span>
<a name="l00152"></a>00152     <a class="code" href="felix__driver_8cpp.html#a8dd58c252e36bf87ee1eb41cadb21421">cism_communicator</a> = *(ftg_ptr -&gt; getLongVar(<span class="stringliteral">&quot;communicator&quot;</span>,<span class="stringliteral">&quot;mpi_vars&quot;</span>));
<a name="l00153"></a>00153     <a class="code" href="felix__driver_8cpp.html#a76dd1f3a71795a1455a459c2619648db">cism_process_count</a> = *(ftg_ptr -&gt; getLongVar(<span class="stringliteral">&quot;process_count&quot;</span>,<span class="stringliteral">&quot;mpi_vars&quot;</span>));
<a name="l00154"></a>00154     <a class="code" href="felix__driver_8cpp.html#a2493b19baf4fd1ad3a714b31ca11ed71">my_cism_rank</a> = *(ftg_ptr -&gt; getLongVar(<span class="stringliteral">&quot;my_rank&quot;</span>,<span class="stringliteral">&quot;mpi_vars&quot;</span>));
<a name="l00155"></a>00155     <span class="comment">//get MPI_COMM from Fortran</span>
<a name="l00156"></a>00156     <a class="code" href="felix__driver_8cpp.html#ab048c6f9fcbcfaa57ce68b00263dbebe">comm</a> = MPI_Comm_f2c(<a class="code" href="felix__driver_8cpp.html#a8dd58c252e36bf87ee1eb41cadb21421">cism_communicator</a>);
<a name="l00157"></a>00157     <span class="comment">//MPI_COMM_size (comm, &amp;cism_process_count); </span>
<a name="l00158"></a>00158     <span class="comment">//MPI_COMM_rank (comm, &amp;my_cism_rank); </span>
<a name="l00159"></a>00159     <span class="comment">//convert comm to Epetra_Comm </span>
<a name="l00160"></a>00160     <span class="comment">//mpiComm = Albany::createEpetraCommFromMpiComm(reducedComm); </span>
<a name="l00161"></a>00161     <a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a> = <a class="code" href="namespaceAlbany.html#a2394fd7517392d558039d24639ff3939">Albany::createEpetraCommFromMpiComm</a>(<a class="code" href="felix__driver_8cpp.html#ab048c6f9fcbcfaa57ce68b00263dbebe">comm</a>); 
<a name="l00162"></a>00162   
<a name="l00163"></a>00163     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) {
<a name="l00164"></a>00164       std::cout &lt;&lt; <span class="stringliteral">&quot;In felix_driver...&quot;</span> &lt;&lt; std::endl;
<a name="l00165"></a>00165       std::cout &lt;&lt; <span class="stringliteral">&quot;Printing this from Albany...  This worked!  Yay!  Nov. 14 2013&quot;</span> &lt;&lt; std::endl; 
<a name="l00166"></a>00166     }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 
<a name="l00169"></a>00169     <span class="comment">// ---------------------------------------------</span>
<a name="l00170"></a>00170     <span class="comment">// get geometry info from CISM  </span>
<a name="l00171"></a>00171     <span class="comment">//IK, 11/14/13: these things may not be needed in Albany/FELIX...  for now they are passed anyway.</span>
<a name="l00172"></a>00172     <span class="comment">// ---------------------------------------------</span>
<a name="l00173"></a>00173     
<a name="l00174"></a>00174     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;Getting geometry info from CISM...&quot;</span> &lt;&lt; std::endl; 
<a name="l00175"></a>00175     <a class="code" href="felix__driver_8cpp.html#abd8d1639529f999e6d1bfc6efc3fec1b">dimInfo</a> = ftg_ptr -&gt; getLongVar(<span class="stringliteral">&quot;dimInfo&quot;</span>,<span class="stringliteral">&quot;geometry&quot;</span>);
<a name="l00176"></a>00176     <a class="code" href="felix__driver_8cpp.html#affcc17141c51ccbbec2496279df8813f">dew</a> = *(ftg_ptr -&gt; getDoubleVar(<span class="stringliteral">&quot;dew&quot;</span>,<span class="stringliteral">&quot;numerics&quot;</span>));
<a name="l00177"></a>00177     <a class="code" href="felix__driver_8cpp.html#ad08a07debb791d23c0c8b3d44f4029d9">dns</a> = *(ftg_ptr -&gt; getDoubleVar(<span class="stringliteral">&quot;dns&quot;</span>,<span class="stringliteral">&quot;numerics&quot;</span>));
<a name="l00178"></a>00178     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;In felix_driver: dew, dns = &quot;</span> &lt;&lt; <a class="code" href="felix__driver_8cpp.html#affcc17141c51ccbbec2496279df8813f">dew</a> &lt;&lt; <span class="stringliteral">&quot;  &quot;</span> &lt;&lt; <a class="code" href="felix__driver_8cpp.html#ad08a07debb791d23c0c8b3d44f4029d9">dns</a> &lt;&lt; std::endl;
<a name="l00179"></a>00179     <a class="code" href="felix__driver_8cpp.html#aaa2cafa89e6e1617776b4f2c49f2b282">dimInfoGeom</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[<a class="code" href="felix__driver_8cpp.html#abd8d1639529f999e6d1bfc6efc3fec1b">dimInfo</a>[0]+1];    
<a name="l00180"></a>00180     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;=dimInfo[0];i++) <a class="code" href="felix__driver_8cpp.html#aaa2cafa89e6e1617776b4f2c49f2b282">dimInfoGeom</a>[i] = dimInfo[i];   
<a name="l00181"></a>00181     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) {
<a name="l00182"></a>00182       std::cout &lt;&lt; <span class="stringliteral">&quot;DimInfoGeom  in felix_driver: &quot;</span> &lt;&lt; std::endl;
<a name="l00183"></a>00183       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;=<a class="code" href="felix__driver_8cpp.html#aaa2cafa89e6e1617776b4f2c49f2b282">dimInfoGeom</a>[0];i++) std::cout &lt;&lt; <a class="code" href="felix__driver_8cpp.html#aaa2cafa89e6e1617776b4f2c49f2b282">dimInfoGeom</a>[i] &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;
<a name="l00184"></a>00184       std::cout &lt;&lt; std::endl;
<a name="l00185"></a>00185     }
<a name="l00186"></a>00186     <a class="code" href="felix__driver_8cpp.html#ab98b1b45c88b0fb97ccb6a32dc237d84">global_ewn</a> = <a class="code" href="felix__driver_8cpp.html#aaa2cafa89e6e1617776b4f2c49f2b282">dimInfoGeom</a>[2]; 
<a name="l00187"></a>00187     <a class="code" href="felix__driver_8cpp.html#ae883eb14937c6d0dc57be4bdd8d4116c">global_nsn</a> = <a class="code" href="felix__driver_8cpp.html#aaa2cafa89e6e1617776b4f2c49f2b282">dimInfoGeom</a>[3]; 
<a name="l00188"></a>00188     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;In felix_driver: global_ewn = &quot;</span> &lt;&lt; <a class="code" href="felix__driver_8cpp.html#ab98b1b45c88b0fb97ccb6a32dc237d84">global_ewn</a> &lt;&lt; <span class="stringliteral">&quot;, global_nsn = &quot;</span> &lt;&lt; <a class="code" href="felix__driver_8cpp.html#ae883eb14937c6d0dc57be4bdd8d4116c">global_nsn</a> &lt;&lt; std::endl;
<a name="l00189"></a>00189     <a class="code" href="felix__driver_8cpp.html#a2b582274af3b1f805cdb0729187fd6e4">ewlb</a> = *(ftg_ptr -&gt; getLongVar(<span class="stringliteral">&quot;ewlb&quot;</span>,<span class="stringliteral">&quot;geometry&quot;</span>));
<a name="l00190"></a>00190     <a class="code" href="felix__driver_8cpp.html#a2b5f18bd7c3d97f532b8fea77c410f1d">ewub</a> = *(ftg_ptr -&gt; getLongVar(<span class="stringliteral">&quot;ewub&quot;</span>,<span class="stringliteral">&quot;geometry&quot;</span>));
<a name="l00191"></a>00191     <a class="code" href="felix__driver_8cpp.html#af2e9ac50c71f2038cc74dd768d742fac">nslb</a> = *(ftg_ptr -&gt; getLongVar(<span class="stringliteral">&quot;nslb&quot;</span>,<span class="stringliteral">&quot;geometry&quot;</span>));
<a name="l00192"></a>00192     <a class="code" href="felix__driver_8cpp.html#a642f2498a656efddf6118e732d0c195e">nsub</a> = *(ftg_ptr -&gt; getLongVar(<span class="stringliteral">&quot;nsub&quot;</span>,<span class="stringliteral">&quot;geometry&quot;</span>));
<a name="l00193"></a>00193     <a class="code" href="felix__driver_8cpp.html#ad5e3206ff1abe2f3f806cae173f65309">nhalo</a> = *(ftg_ptr -&gt; getLongVar(<span class="stringliteral">&quot;nhalo&quot;</span>,<span class="stringliteral">&quot;geometry&quot;</span>));
<a name="l00194"></a>00194     <a class="code" href="felix__driver_8cpp.html#abaf03ce76028bb0766397be59a6da33e">ewn</a> = *(ftg_ptr -&gt; getLongVar(<span class="stringliteral">&quot;ewn&quot;</span>,<span class="stringliteral">&quot;geometry&quot;</span>));
<a name="l00195"></a>00195     <a class="code" href="felix__driver_8cpp.html#ab535ad6429f94303bc2e0347bb388e0d">nsn</a> = *(ftg_ptr -&gt; getLongVar(<span class="stringliteral">&quot;nsn&quot;</span>,<span class="stringliteral">&quot;geometry&quot;</span>));
<a name="l00196"></a>00196     <a class="code" href="felix__driver_8cpp.html#a536cbbfa58672a4d27b7baf804bc3acf">upn</a> = *(ftg_ptr -&gt; getLongVar(<span class="stringliteral">&quot;upn&quot;</span>,<span class="stringliteral">&quot;geometry&quot;</span>));
<a name="l00197"></a>00197     std::cout &lt;&lt; <span class="stringliteral">&quot;In felix_driver: Proc #&quot;</span> &lt;&lt; <a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() &lt;&lt; <span class="stringliteral">&quot;, ewn = &quot;</span> &lt;&lt; <a class="code" href="felix__driver_8cpp.html#abaf03ce76028bb0766397be59a6da33e">ewn</a> &lt;&lt; <span class="stringliteral">&quot;, nsn = &quot;</span> &lt;&lt; <a class="code" href="felix__driver_8cpp.html#ab535ad6429f94303bc2e0347bb388e0d">nsn</a> &lt;&lt; <span class="stringliteral">&quot;, upn = &quot;</span> &lt;&lt; <a class="code" href="felix__driver_8cpp.html#a536cbbfa58672a4d27b7baf804bc3acf">upn</a> &lt;&lt; <span class="stringliteral">&quot;, nhalo = &quot;</span> &lt;&lt; <a class="code" href="felix__driver_8cpp.html#ad5e3206ff1abe2f3f806cae173f65309">nhalo</a> &lt;&lt; std::endl;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     <span class="comment">// ---------------------------------------------</span>
<a name="l00201"></a>00201     <span class="comment">// get constants from CISM</span>
<a name="l00202"></a>00202     <span class="comment">// IK, 11/14/13: these things may not be needed in Albany/FELIX...  for now they are passed anyway.</span>
<a name="l00203"></a>00203     <span class="comment">// ---------------------------------------------</span>
<a name="l00204"></a>00204  
<a name="l00205"></a>00205     <a class="code" href="felix__driver_8cpp.html#ae04f3ad368404cf236baf6bc3905b149">seconds_per_year_ptr</a> = ftg_ptr -&gt; getDoubleVar(<span class="stringliteral">&quot;seconds_per_year&quot;</span>,<span class="stringliteral">&quot;constants&quot;</span>);
<a name="l00206"></a>00206     <a class="code" href="felix__driver_8cpp.html#a8c0ee12b673dd18835373ce13ceb03af">gravity_ptr</a> = ftg_ptr -&gt; getDoubleVar(<span class="stringliteral">&quot;gravity&quot;</span>,<span class="stringliteral">&quot;constants&quot;</span>);
<a name="l00207"></a>00207     <a class="code" href="felix__driver_8cpp.html#a7a34e3c1a83ceb9956c757f25f135a02">rho_ice_ptr</a> = ftg_ptr -&gt; getDoubleVar(<span class="stringliteral">&quot;rho_ice&quot;</span>,<span class="stringliteral">&quot;constants&quot;</span>);
<a name="l00208"></a>00208     <a class="code" href="felix__driver_8cpp.html#a814f7bfc9074037a27b51b74a6dbba7f">rho_seawater_ptr</a> = ftg_ptr -&gt; getDoubleVar(<span class="stringliteral">&quot;rho_seawater&quot;</span>,<span class="stringliteral">&quot;constants&quot;</span>);
<a name="l00209"></a>00209     <a class="code" href="felix__driver_8cpp.html#a5a1fe0d205042877e724f336ff175038">thicknessDataPtr</a> = ftg_ptr -&gt; getDoubleVar(<span class="stringliteral">&quot;thck&quot;</span>,<span class="stringliteral">&quot;geometry&quot;</span>);
<a name="l00210"></a>00210     <a class="code" href="felix__driver_8cpp.html#ae76f1fd81af6a7b486c546bc44124763">topographyDataPtr</a> = ftg_ptr -&gt; getDoubleVar(<span class="stringliteral">&quot;topg&quot;</span>,<span class="stringliteral">&quot;geometry&quot;</span>);
<a name="l00211"></a>00211     <a class="code" href="felix__driver_8cpp.html#ab3a6e4d2e78bb30133169ba1879c7cb8">upperSurfaceDataPtr</a> = ftg_ptr -&gt; getDoubleVar(<span class="stringliteral">&quot;usrf&quot;</span>,<span class="stringliteral">&quot;geometry&quot;</span>);
<a name="l00212"></a>00212     <a class="code" href="felix__driver_8cpp.html#a41f50f6d1633e338550c8daa2a64519a">lowerSurfaceDataPtr</a> = ftg_ptr -&gt; getDoubleVar(<span class="stringliteral">&quot;lsrf&quot;</span>,<span class="stringliteral">&quot;geometry&quot;</span>);
<a name="l00213"></a>00213     <a class="code" href="felix__driver_8cpp.html#afe2fdee9ba3442834c836fe47b703ce4">floating_maskDataPtr</a> = ftg_ptr -&gt; getDoubleVar(<span class="stringliteral">&quot;floating_mask&quot;</span>,<span class="stringliteral">&quot;geometry&quot;</span>);
<a name="l00214"></a>00214     <a class="code" href="felix__driver_8cpp.html#ae5c4ced0bbb03362d77a768d1f59bf38">ice_maskDataPtr</a> = ftg_ptr -&gt; getDoubleVar(<span class="stringliteral">&quot;ice_mask&quot;</span>,<span class="stringliteral">&quot;geometry&quot;</span>);
<a name="l00215"></a>00215     <a class="code" href="felix__driver_8cpp.html#ab1cfa639a256986c34bee0e8cc920dee">lower_cell_locDataPtr</a> = ftg_ptr -&gt; getDoubleVar(<span class="stringliteral">&quot;lower_cell_loc&quot;</span>,<span class="stringliteral">&quot;geometry&quot;</span>);
<a name="l00216"></a>00216 
<a name="l00217"></a>00217     <span class="comment">// ---------------------------------------------</span>
<a name="l00218"></a>00218     <span class="comment">// get connectivity arrays from CISM </span>
<a name="l00219"></a>00219     <span class="comment">// IK, 11/14/13: these things may not be needed in Albany/FELIX...  for now they are passed anyway.</span>
<a name="l00220"></a>00220     <span class="comment">// ---------------------------------------------</span>
<a name="l00221"></a>00221     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;In felix_driver: grabbing connectivity array pointers from CISM...&quot;</span> &lt;&lt; std::endl; 
<a name="l00222"></a>00222     <span class="comment">//IK, 11/13/13: check that connectivity derived types are transfered over from CISM to Albany/FELIX    </span>
<a name="l00223"></a>00223     <a class="code" href="felix__driver_8cpp.html#a74fc3f0a9d140b6b442f4976f0a2cb32">nCellsActive</a> = *(ftg_ptr -&gt; getLongVar(<span class="stringliteral">&quot;nCellsActive&quot;</span>,<span class="stringliteral">&quot;connectivity&quot;</span>)); 
<a name="l00224"></a>00224     std::cout &lt;&lt; <span class="stringliteral">&quot;In felix_driver: Proc #&quot;</span> &lt;&lt; <a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() &lt;&lt; <span class="stringliteral">&quot;, nCellsActive = &quot;</span> &lt;&lt; <a class="code" href="felix__driver_8cpp.html#a74fc3f0a9d140b6b442f4976f0a2cb32">nCellsActive</a> &lt;&lt;  std::endl;
<a name="l00225"></a>00225     <a class="code" href="felix__driver_8cpp.html#af62380358bbc17081a691d49d86005d4">xyz_at_nodes_Ptr</a> = ftg_ptr -&gt; getDoubleVar(<span class="stringliteral">&quot;xyz_at_nodes&quot;</span>,<span class="stringliteral">&quot;connectivity&quot;</span>); 
<a name="l00226"></a>00226     <a class="code" href="felix__driver_8cpp.html#a912ab5f799265bddff9a30ce4b4699b6">surf_height_at_nodes_Ptr</a> = ftg_ptr -&gt; getDoubleVar(<span class="stringliteral">&quot;surf_height_at_nodes&quot;</span>,<span class="stringliteral">&quot;connectivity&quot;</span>); 
<a name="l00227"></a>00227     <a class="code" href="felix__driver_8cpp.html#a93a4ecba1916b1bc3ec66bdecab75044">beta_at_nodes_Ptr</a> = ftg_ptr -&gt; getDoubleVar(<span class="stringliteral">&quot;beta_at_nodes&quot;</span>,<span class="stringliteral">&quot;connectivity&quot;</span>);
<a name="l00228"></a>00228     <a class="code" href="felix__driver_8cpp.html#a7aec45ea844c90fcb7d0027297e7c6cb">flwa_at_active_elements_Ptr</a> = ftg_ptr -&gt; getDoubleVar(<span class="stringliteral">&quot;flwa_at_active_elements&quot;</span>,<span class="stringliteral">&quot;connectivity&quot;</span>); 
<a name="l00229"></a>00229     <a class="code" href="felix__driver_8cpp.html#a82efeaf71a4f15b46f17749f6cc76206">global_node_id_owned_map_Ptr</a> = ftg_ptr -&gt; getInt4Var(<span class="stringliteral">&quot;global_node_id_owned_map&quot;</span>,<span class="stringliteral">&quot;connectivity&quot;</span>);  
<a name="l00230"></a>00230     <a class="code" href="felix__driver_8cpp.html#a0dcbe6fa72ab0fd4fc399e679112f4c7">global_element_conn_active_Ptr</a> = ftg_ptr -&gt; getInt4Var(<span class="stringliteral">&quot;global_element_conn_active&quot;</span>,<span class="stringliteral">&quot;connectivity&quot;</span>);  
<a name="l00231"></a>00231     <a class="code" href="felix__driver_8cpp.html#ab9f22496d26d21aae9ba0c06e406660c">global_element_id_active_owned_map_Ptr</a> = ftg_ptr -&gt; getInt4Var(<span class="stringliteral">&quot;global_element_id_active_owned_map&quot;</span>,<span class="stringliteral">&quot;connectivity&quot;</span>);  
<a name="l00232"></a>00232     <a class="code" href="felix__driver_8cpp.html#af94320f5df9a5923e219d70db3b0a438">global_basal_face_conn_active_Ptr</a> = ftg_ptr -&gt; getInt4Var(<span class="stringliteral">&quot;global_basal_face_conn_active&quot;</span>,<span class="stringliteral">&quot;connectivity&quot;</span>);  
<a name="l00233"></a>00233     <a class="code" href="felix__driver_8cpp.html#aa94bb6fc735a20064046aef6e73b8808">global_basal_face_id_active_owned_map_Ptr</a> = ftg_ptr -&gt; getInt4Var(<span class="stringliteral">&quot;global_basal_face_id_active_owned_map&quot;</span>,<span class="stringliteral">&quot;connectivity&quot;</span>);  
<a name="l00234"></a>00234     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;...done!&quot;</span> &lt;&lt; std::endl; 
<a name="l00235"></a>00235 
<a name="l00236"></a>00236     <span class="comment">// ---------------------------------------------</span>
<a name="l00237"></a>00237     <span class="comment">// get u and v velocity solution from Glimmer-CISM </span>
<a name="l00238"></a>00238     <span class="comment">// IK, 11/26/13: need to concatenate these into a single solve for initial condition for Albany/FELIX solve  </span>
<a name="l00239"></a>00239     <span class="comment">// ---------------------------------------------</span>
<a name="l00240"></a>00240     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;In felix_driver: grabbing pointers to u and v velocities in CISM...&quot;</span> &lt;&lt; std::endl; 
<a name="l00241"></a>00241     <a class="code" href="felix__driver_8cpp.html#aa95651d5002e20d6e0af4b082dce923d">uVel_ptr</a> = ftg_ptr -&gt;getDoubleVar(<span class="stringliteral">&quot;uvel&quot;</span>, <span class="stringliteral">&quot;velocity&quot;</span>); 
<a name="l00242"></a>00242     <a class="code" href="felix__driver_8cpp.html#aa1f3d948a28f0b81641f76cd8f0aaced">vVel_ptr</a> = ftg_ptr -&gt;getDoubleVar(<span class="stringliteral">&quot;vvel&quot;</span>, <span class="stringliteral">&quot;velocity&quot;</span>); 
<a name="l00243"></a>00243     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;...done!&quot;</span> &lt;&lt; std::endl; 
<a name="l00244"></a>00244     
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 
<a name="l00247"></a>00247     <span class="comment">// ---------------------------------------------</span>
<a name="l00248"></a>00248     <span class="comment">// create Albany mesh  </span>
<a name="l00249"></a>00249     <span class="comment">// ---------------------------------------------</span>
<a name="l00250"></a>00250     <span class="comment">// Read input file, the name of which is provided in the Glimmer/CISM .config file.</span>
<a name="l00251"></a>00251     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;In felix_driver: creating Albany mesh struct...&quot;</span> &lt;&lt; std::endl; 
<a name="l00252"></a>00252     <a class="code" href="felix__driver_8cpp.html#aa2ffb8fe45b2c5323c662073bbded859">slvrfctry</a> = Teuchos::rcp(<span class="keyword">new</span> <a class="code" href="classAlbany_1_1SolverFactory.html" title="A factory class to instantiate AbstractSolver objects.">Albany::SolverFactory</a>(input_fname, <a class="code" href="felix__driver_8cpp.html#ab048c6f9fcbcfaa57ce68b00263dbebe">comm</a>));
<a name="l00253"></a>00253     <a class="code" href="felix__driver_8cpp.html#a7ff94c51f5dd7df62f8038f9c8e15803">discParams</a> = Teuchos::sublist(Teuchos::rcp(&amp;<a class="code" href="felix__driver_8cpp.html#aa2ffb8fe45b2c5323c662073bbded859">slvrfctry</a>-&gt;getParameters(),<span class="keyword">false</span>), <span class="stringliteral">&quot;Discretization&quot;</span>, <span class="keyword">true</span>);
<a name="l00254"></a>00254     Teuchos::RCP&lt;Albany::StateInfoStruct&gt; <a class="code" href="InterfaceTry_8cpp.html#a22a797db574d6de7b11c63d19b59ce22">sis</a>=Teuchos::rcp(<span class="keyword">new</span> <a class="code" href="classAlbany_1_1StateInfoStruct.html">Albany::StateInfoStruct</a>);
<a name="l00255"></a>00255     <a class="code" href="classAlbany_1_1AbstractFieldContainer.html#a2bfe39ada257455a2bbe082a0b743704">Albany::AbstractFieldContainer::FieldContainerRequirements</a> req;
<a name="l00256"></a>00256     req.push_back(<span class="stringliteral">&quot;Surface Height&quot;</span>);
<a name="l00257"></a>00257     req.push_back(<span class="stringliteral">&quot;Temperature&quot;</span>);
<a name="l00258"></a>00258     req.push_back(<span class="stringliteral">&quot;Basal Friction&quot;</span>);
<a name="l00259"></a>00259     req.push_back(<span class="stringliteral">&quot;Thickness&quot;</span>);
<a name="l00260"></a>00260     req.push_back(<span class="stringliteral">&quot;Flow Factor&quot;</span>);
<a name="l00261"></a>00261     <span class="keywordtype">int</span> neq = 2; <span class="comment">//number of equations - 2 for FO Stokes</span>
<a name="l00262"></a>00262     <span class="comment">//IK, 11/14/13, debug output: check that pointers that are passed from CISM are not null </span>
<a name="l00263"></a>00263     <span class="comment">//std::cout &lt;&lt; &quot;DEBUG: xyz_at_nodes_Ptr:&quot; &lt;&lt; xyz_at_nodes_Ptr &lt;&lt; std::endl; </span>
<a name="l00264"></a>00264     <span class="comment">//std::cout &lt;&lt; &quot;DEBUG: surf_height_at_nodes_Ptr:&quot; &lt;&lt; surf_height_at_nodes_Ptr &lt;&lt; std::endl; </span>
<a name="l00265"></a>00265     <span class="comment">//std::cout &lt;&lt; &quot;DEBUG: beta_at_nodes_Ptr:&quot; &lt;&lt; beta_at_nodes_Ptr &lt;&lt; std::endl; </span>
<a name="l00266"></a>00266     <span class="comment">//std::cout &lt;&lt; &quot;DEBUG: flwa_at_active_elements_Ptr:&quot; &lt;&lt; flwa_at_active_elements_Ptr &lt;&lt; std::endl; </span>
<a name="l00267"></a>00267     <span class="comment">//std::cout &lt;&lt; &quot;DEBUG: global_node_id_owned_map_Ptr:&quot; &lt;&lt; global_node_id_owned_map_Ptr &lt;&lt; std::endl; </span>
<a name="l00268"></a>00268     <span class="comment">//std::cout &lt;&lt; &quot;DEBUG: global_element_conn_active_Ptr:&quot; &lt;&lt; global_element_conn_active_Ptr &lt;&lt; std::endl; </span>
<a name="l00269"></a>00269     <span class="comment">//std::cout &lt;&lt; &quot;DEBUG: global_basal_face_conn_active_Ptr:&quot; &lt;&lt; global_basal_face_conn_active_Ptr &lt;&lt; std::endl; </span>
<a name="l00270"></a>00270     <span class="comment">//std::cout &lt;&lt; &quot;DEBUG: global_basal_face_id_active_owned_map_Ptr:&quot; &lt;&lt; global_basal_face_id_active_owned_map_Ptr &lt;&lt; std::endl;</span>
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <a class="code" href="felix__driver_8cpp.html#ab5242add5962116d4d46270da25895b3">nNodes</a> = (<a class="code" href="felix__driver_8cpp.html#abaf03ce76028bb0766397be59a6da33e">ewn</a>-2*<a class="code" href="felix__driver_8cpp.html#ad5e3206ff1abe2f3f806cae173f65309">nhalo</a>+1)*(<a class="code" href="felix__driver_8cpp.html#ab535ad6429f94303bc2e0347bb388e0d">nsn</a>-2*<a class="code" href="felix__driver_8cpp.html#ad5e3206ff1abe2f3f806cae173f65309">nhalo</a>+1)*<a class="code" href="felix__driver_8cpp.html#a536cbbfa58672a4d27b7baf804bc3acf">upn</a>; <span class="comment">//number of nodes in mesh (on each processor) </span>
<a name="l00273"></a>00273     <a class="code" href="felix__driver_8cpp.html#aed1db7de491b9311aad60370dc10a170">nElementsActive</a> = <a class="code" href="felix__driver_8cpp.html#a74fc3f0a9d140b6b442f4976f0a2cb32">nCellsActive</a>*(<a class="code" href="felix__driver_8cpp.html#a536cbbfa58672a4d27b7baf804bc3acf">upn</a>-1); <span class="comment">//number of 3D active elements in mesh  </span>
<a name="l00274"></a>00274     
<a name="l00275"></a>00275     <a class="code" href="felix__driver_8cpp.html#ab17857c6a5d0e7cb559027884f5135d0">meshStruct</a> = Teuchos::rcp(<span class="keyword">new</span> <a class="code" href="classAlbany_1_1CismSTKMeshStruct.html">Albany::CismSTKMeshStruct</a>(<a class="code" href="felix__driver_8cpp.html#a7ff94c51f5dd7df62f8038f9c8e15803">discParams</a>, <a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>, <a class="code" href="felix__driver_8cpp.html#af62380358bbc17081a691d49d86005d4">xyz_at_nodes_Ptr</a>, <a class="code" href="felix__driver_8cpp.html#a82efeaf71a4f15b46f17749f6cc76206">global_node_id_owned_map_Ptr</a>, <a class="code" href="felix__driver_8cpp.html#ab9f22496d26d21aae9ba0c06e406660c">global_element_id_active_owned_map_Ptr</a>, 
<a name="l00276"></a>00276                                                            <a class="code" href="felix__driver_8cpp.html#a0dcbe6fa72ab0fd4fc399e679112f4c7">global_element_conn_active_Ptr</a>, <a class="code" href="felix__driver_8cpp.html#aa94bb6fc735a20064046aef6e73b8808">global_basal_face_id_active_owned_map_Ptr</a>, <a class="code" href="felix__driver_8cpp.html#af94320f5df9a5923e219d70db3b0a438">global_basal_face_conn_active_Ptr</a>, 
<a name="l00277"></a>00277                                                            <a class="code" href="felix__driver_8cpp.html#a93a4ecba1916b1bc3ec66bdecab75044">beta_at_nodes_Ptr</a>, <a class="code" href="felix__driver_8cpp.html#a912ab5f799265bddff9a30ce4b4699b6">surf_height_at_nodes_Ptr</a>, <a class="code" href="felix__driver_8cpp.html#a7aec45ea844c90fcb7d0027297e7c6cb">flwa_at_active_elements_Ptr</a>, <a class="code" href="felix__driver_8cpp.html#ab5242add5962116d4d46270da25895b3">nNodes</a>, <a class="code" href="felix__driver_8cpp.html#aed1db7de491b9311aad60370dc10a170">nElementsActive</a>, <a class="code" href="felix__driver_8cpp.html#a74fc3f0a9d140b6b442f4976f0a2cb32">nCellsActive</a>));
<a name="l00278"></a>00278     meshStruct-&gt;constructMesh(<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>, <a class="code" href="felix__driver_8cpp.html#a7ff94c51f5dd7df62f8038f9c8e15803">discParams</a>, neq, req, sis, meshStruct-&gt;getMeshSpecs()[0]-&gt;worksetSize);
<a name="l00279"></a>00279  
<a name="l00280"></a>00280     <a class="code" href="felix__driver_8cpp.html#af1beb0c410a8a48552ab0fdb5e8c49ed">interleavedOrdering</a> = meshStruct-&gt;getInterleavedOrdering();
<a name="l00281"></a>00281     <a class="code" href="classAlbany_1_1AbstractSTKFieldContainer.html#ab29b7b67367d394e0364838c6e3fcf73">Albany::AbstractSTKFieldContainer::VectorFieldType</a>* solutionField;
<a name="l00282"></a>00282     <span class="keywordflow">if</span>(<a class="code" href="felix__driver_8cpp.html#af1beb0c410a8a48552ab0fdb5e8c49ed">interleavedOrdering</a>)
<a name="l00283"></a>00283       solutionField = Teuchos::rcp_dynamic_cast&lt;<a class="code" href="classAlbany_1_1OrdinarySTKFieldContainer.html">Albany::OrdinarySTKFieldContainer&lt;true&gt;</a> &gt;(meshStruct-&gt;getFieldContainer())-&gt;getSolutionField();
<a name="l00284"></a>00284     <span class="keywordflow">else</span>
<a name="l00285"></a>00285       solutionField = Teuchos::rcp_dynamic_cast&lt;<a class="code" href="classAlbany_1_1OrdinarySTKFieldContainer.html">Albany::OrdinarySTKFieldContainer&lt;false&gt;</a> &gt;(meshStruct-&gt;getFieldContainer())-&gt;getSolutionField();
<a name="l00286"></a>00286 
<a name="l00287"></a>00287     <span class="comment">//Create node_map</span>
<a name="l00288"></a>00288     <span class="comment">//global_node_id_owned_map_Ptr is 1-based, so node_map is 1-based</span>
<a name="l00289"></a>00289      <a class="code" href="felix__driver_8cpp.html#af9808ee708d8ece5df6ce04b52de71dd">node_map</a> = Teuchos::rcp(<span class="keyword">new</span> Epetra_Map(-1, <a class="code" href="felix__driver_8cpp.html#ab5242add5962116d4d46270da25895b3">nNodes</a>, <a class="code" href="felix__driver_8cpp.html#a82efeaf71a4f15b46f17749f6cc76206">global_node_id_owned_map_Ptr</a>, 0, *<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>)); <span class="comment">//node_map is 1-based</span>
<a name="l00290"></a>00290 
<a name="l00291"></a>00291     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;...done!&quot;</span> &lt;&lt; std::endl; 
<a name="l00292"></a>00292 
<a name="l00293"></a>00293     <span class="comment">// ---------------------------------------------</span>
<a name="l00294"></a>00294     <span class="comment">// Set restart solution to the one passed from CISM </span>
<a name="l00295"></a>00295     <span class="comment">// ---------------------------------------------</span>
<a name="l00296"></a>00296 
<a name="l00297"></a>00297     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;In felix_driver: setting initial condition from CISM...&quot;</span> &lt;&lt; std::endl; 
<a name="l00298"></a>00298      <span class="comment">//Create vector used to renumber nodes on each processor from the Albany convention (horizontal levels first) to the CISM convention (vertical layers first)</span>
<a name="l00299"></a>00299      <a class="code" href="felix__driver_8cpp.html#a1174e24eeba8055c402b92f4f60bfd6f">nNodes2D</a> = (<a class="code" href="felix__driver_8cpp.html#ab98b1b45c88b0fb97ccb6a32dc237d84">global_ewn</a> + 1)*(<a class="code" href="felix__driver_8cpp.html#ae883eb14937c6d0dc57be4bdd8d4116c">global_nsn</a>+1); <span class="comment">//number global nodes in the domain in 2D </span>
<a name="l00300"></a>00300      <a class="code" href="felix__driver_8cpp.html#a29e784fe0952393697d73c3b417bb9ca">nNodesProc2D</a> = (<a class="code" href="felix__driver_8cpp.html#ab535ad6429f94303bc2e0347bb388e0d">nsn</a>-2*<a class="code" href="felix__driver_8cpp.html#ad5e3206ff1abe2f3f806cae173f65309">nhalo</a>+1)*(<a class="code" href="felix__driver_8cpp.html#abaf03ce76028bb0766397be59a6da33e">ewn</a>-2*<a class="code" href="felix__driver_8cpp.html#ad5e3206ff1abe2f3f806cae173f65309">nhalo</a>+1); <span class="comment">//number of nodes on each processor in 2D  </span>
<a name="l00301"></a>00301      <a class="code" href="felix__driver_8cpp.html#a1c055a28ab77eebc667f57e9adca360a">cismToAlbanyNodeNumberMap</a>.resize(<a class="code" href="felix__driver_8cpp.html#a536cbbfa58672a4d27b7baf804bc3acf">upn</a>*<a class="code" href="felix__driver_8cpp.html#a29e784fe0952393697d73c3b417bb9ca">nNodesProc2D</a>);
<a name="l00302"></a>00302      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;<a class="code" href="felix__driver_8cpp.html#ab535ad6429f94303bc2e0347bb388e0d">nsn</a>-2*<a class="code" href="felix__driver_8cpp.html#ad5e3206ff1abe2f3f806cae173f65309">nhalo</a>+1;j++) { 
<a name="l00303"></a>00303        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="felix__driver_8cpp.html#abaf03ce76028bb0766397be59a6da33e">ewn</a>-2*nhalo+1; i++) {
<a name="l00304"></a>00304          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;<a class="code" href="felix__driver_8cpp.html#a536cbbfa58672a4d27b7baf804bc3acf">upn</a>; k++) { 
<a name="l00305"></a>00305            <span class="keywordtype">int</span> index = k+upn*i + j*(<a class="code" href="felix__driver_8cpp.html#abaf03ce76028bb0766397be59a6da33e">ewn</a>-2*nhalo+1)*upn; 
<a name="l00306"></a>00306            <a class="code" href="felix__driver_8cpp.html#a1c055a28ab77eebc667f57e9adca360a">cismToAlbanyNodeNumberMap</a>[index] = k*<a class="code" href="felix__driver_8cpp.html#a1174e24eeba8055c402b92f4f60bfd6f">nNodes2D</a> + <a class="code" href="felix__driver_8cpp.html#a82efeaf71a4f15b46f17749f6cc76206">global_node_id_owned_map_Ptr</a>[i+j*(<a class="code" href="felix__driver_8cpp.html#abaf03ce76028bb0766397be59a6da33e">ewn</a>-2*nhalo+1)]; 
<a name="l00307"></a>00307            <span class="comment">//if (mpiComm-&gt;MyPID() == 0) </span>
<a name="l00308"></a>00308            <span class="comment">//  std::cout &lt;&lt; &quot;index: &quot; &lt;&lt; index &lt;&lt; &quot;, cismToAlbanyNodeNumberMap: &quot; &lt;&lt; cismToAlbanyNodeNumberMap[index] &lt;&lt; std::endl; </span>
<a name="l00309"></a>00309           }
<a name="l00310"></a>00310         }
<a name="l00311"></a>00311       }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313      <span class="comment">//The way it worked out, uVel_ptr and vVel_ptr have more nodes than the nodes in the mesh passed to Albany/CISM for the solve.  In particular, </span>
<a name="l00314"></a>00314      <span class="comment">//there is 1 row of halo elements in uVel_ptr and vVel_ptr.  To account for this, we copy uVel_ptr and vVel_ptr into std::vectors, which do not have the halo elements. </span>
<a name="l00315"></a>00315      std::vector&lt;double&gt; uvel_vec(<a class="code" href="felix__driver_8cpp.html#a536cbbfa58672a4d27b7baf804bc3acf">upn</a>*nNodesProc2D); 
<a name="l00316"></a>00316      std::vector&lt;double&gt; vvel_vec(<a class="code" href="felix__driver_8cpp.html#a536cbbfa58672a4d27b7baf804bc3acf">upn</a>*nNodesProc2D); 
<a name="l00317"></a>00317      <span class="keywordtype">int</span> counter1 = 0; 
<a name="l00318"></a>00318      <span class="keywordtype">int</span> counter2 = 0; 
<a name="l00319"></a>00319      <span class="keywordtype">int</span> local_nodeID;  
<a name="l00320"></a>00320      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;<a class="code" href="felix__driver_8cpp.html#ab535ad6429f94303bc2e0347bb388e0d">nsn</a>-1; j++) {
<a name="l00321"></a>00321        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="felix__driver_8cpp.html#abaf03ce76028bb0766397be59a6da33e">ewn</a>-1; i++) { 
<a name="l00322"></a>00322          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;<a class="code" href="felix__driver_8cpp.html#a536cbbfa58672a4d27b7baf804bc3acf">upn</a>; k++) {
<a name="l00323"></a>00323            <span class="keywordflow">if</span> (j &gt;= nhalo-1 &amp; j &lt; nsn-nhalo) {
<a name="l00324"></a>00324              <span class="keywordflow">if</span> (i &gt;= nhalo-1 &amp; i &lt; ewn-nhalo) { 
<a name="l00325"></a>00325                local_nodeID = <a class="code" href="felix__driver_8cpp.html#af9808ee708d8ece5df6ce04b52de71dd">node_map</a>-&gt;LID(<a class="code" href="felix__driver_8cpp.html#a1c055a28ab77eebc667f57e9adca360a">cismToAlbanyNodeNumberMap</a>[counter1]); 
<a name="l00326"></a>00326                uvel_vec[counter1] = <a class="code" href="felix__driver_8cpp.html#aa95651d5002e20d6e0af4b082dce923d">uVel_ptr</a>[counter2]; 
<a name="l00327"></a>00327                vvel_vec[counter1] = <a class="code" href="felix__driver_8cpp.html#aa1f3d948a28f0b81641f76cd8f0aaced">vVel_ptr</a>[counter2]; 
<a name="l00328"></a>00328                counter1++;
<a name="l00329"></a>00329             }
<a name="l00330"></a>00330             }
<a name="l00331"></a>00331             counter2++; 
<a name="l00332"></a>00332          }
<a name="l00333"></a>00333         }
<a name="l00334"></a>00334      }
<a name="l00335"></a>00335      <span class="comment">//Loop over all the elements to find which nodes are active.  For the active nodes, copy uvel and vvel from CISM into Albany solution array to </span>
<a name="l00336"></a>00336      <span class="comment">//use as initial condition.</span>
<a name="l00337"></a>00337      <span class="comment">//NOTE: there is some inefficiency here by looping over all the elements.  TO DO? pass only active nodes from Albany-CISM to improve this? </span>
<a name="l00338"></a>00338      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="felix__driver_8cpp.html#aed1db7de491b9311aad60370dc10a170">nElementsActive</a>; i++) {
<a name="l00339"></a>00339        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;8; j++) {
<a name="l00340"></a>00340         <span class="keywordtype">int</span> node_GID =  <a class="code" href="felix__driver_8cpp.html#a0dcbe6fa72ab0fd4fc399e679112f4c7">global_element_conn_active_Ptr</a>[i + nElementsActive*j]; <span class="comment">//node_GID is 1-based</span>
<a name="l00341"></a>00341         <span class="keywordtype">int</span> node_LID =  <a class="code" href="felix__driver_8cpp.html#af9808ee708d8ece5df6ce04b52de71dd">node_map</a>-&gt;LID(node_GID); <span class="comment">//node_LID is 0-based</span>
<a name="l00342"></a>00342         <a class="code" href="namespaceAAdapt.html#a6e672c66f1cfcf2ba9f8baf4a51e0381">stk::mesh::Entity</a>&amp; node = *meshStruct-&gt;bulkData-&gt;get_entity(meshStruct-&gt;metaData-&gt;node_rank(), node_GID);
<a name="l00343"></a>00343         <span class="keywordtype">double</span>* sol = stk::mesh::field_data(*solutionField, node);
<a name="l00344"></a>00344         sol[0] = uvel_vec[node_LID];
<a name="l00345"></a>00345         sol[1] = vvel_vec[node_LID];
<a name="l00346"></a>00346       }
<a name="l00347"></a>00347     }
<a name="l00348"></a>00348 
<a name="l00349"></a>00349     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;...done!&quot;</span> &lt;&lt; std::endl; 
<a name="l00350"></a>00350  
<a name="l00351"></a>00351     <span class="comment">// clean up</span>
<a name="l00352"></a>00352     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;exec mode = &quot;</span> &lt;&lt; exec_mode &lt;&lt; std::endl;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354 }
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 <span class="comment">// The solve is done in the felix_driver_run function, and the solution is passed back to Glimmer-CISM </span>
<a name="l00357"></a>00357 <span class="comment">// IK, 12/3/13: time_inc_yr and cur_time_yr are not used here... </span>
<a name="l00358"></a><a class="code" href="felix__driver_8H.html#aebf9b4f3db25c0dc8cf7d0edfba52d34">00358</a> <span class="keywordtype">void</span> <a class="code" href="felix__driver_8cpp.html#ae255a948e74ec5c727a9a110178d4ef5">felix_driver_run</a>(FelixToGlimmer * ftg_ptr, <span class="keywordtype">double</span>&amp; cur_time_yr, <span class="keywordtype">double</span> time_inc_yr)
<a name="l00359"></a>00359 {
<a name="l00360"></a>00360 
<a name="l00361"></a>00361     <span class="comment">//IK, 12/9/13: how come FancyOStream prints an all processors??    </span>
<a name="l00362"></a>00362     Teuchos::RCP&lt;Teuchos::FancyOStream&gt; out(Teuchos::VerboseObjectBase::getDefaultOStream());
<a name="l00363"></a>00363 
<a name="l00364"></a>00364     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;In felix_driver_run, cur_time, time_inc = &quot;</span> &lt;&lt; cur_time_yr &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt; time_inc_yr &lt;&lt; std::endl;
<a name="l00365"></a>00365     <span class="comment">// ---------------------------------------------------------------------------------------------------</span>
<a name="l00366"></a>00366     <span class="comment">// Solve </span>
<a name="l00367"></a>00367     <span class="comment">// ---------------------------------------------------------------------------------------------------</span>
<a name="l00368"></a>00368 
<a name="l00369"></a>00369     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;In felix_driver_run: starting the solve... &quot;</span> &lt;&lt; std::endl;
<a name="l00370"></a>00370     <span class="comment">//Need to set HasRestart solution such that uvel_Ptr and vvel_Ptr (u and v from Glimmer/CISM) are always set as initial condition?  </span>
<a name="l00371"></a>00371     <a class="code" href="felix__driver_8cpp.html#ab17857c6a5d0e7cb559027884f5135d0">meshStruct</a>-&gt;setHasRestartSolution(!<a class="code" href="felix__driver_8cpp.html#af15f444812d331b09076f23ff813d05d">first_time_step</a>);
<a name="l00372"></a>00372  
<a name="l00373"></a>00373     Teuchos::RCP&lt;Albany::AbstractSTKMeshStruct&gt; <a class="code" href="InterfaceTry_8cpp.html#ab9ed82a85952e00ff0e9affddaf97c8a">stkMeshStruct</a> = <a class="code" href="felix__driver_8cpp.html#ab17857c6a5d0e7cb559027884f5135d0">meshStruct</a>;
<a name="l00374"></a>00374     <a class="code" href="felix__driver_8cpp.html#a7ff94c51f5dd7df62f8038f9c8e15803">discParams</a>-&gt;set(<span class="stringliteral">&quot;STKMeshStruct&quot;</span>,stkMeshStruct);
<a name="l00375"></a>00375     Teuchos::RCP&lt;Teuchos::ParameterList&gt; paramList = Teuchos::rcp(&amp;<a class="code" href="felix__driver_8cpp.html#aa2ffb8fe45b2c5323c662073bbded859">slvrfctry</a>-&gt;getParameters(),<span class="keyword">false</span>);
<a name="l00376"></a>00376     <span class="comment">//TO DO: add checking if first time step or not</span>
<a name="l00377"></a>00377     <span class="keywordflow">if</span> (!<a class="code" href="felix__driver_8cpp.html#af15f444812d331b09076f23ff813d05d">first_time_step</a>)
<a name="l00378"></a>00378     {
<a name="l00379"></a>00379        <a class="code" href="felix__driver_8cpp.html#ab17857c6a5d0e7cb559027884f5135d0">meshStruct</a>-&gt;setRestartDataTime(paramList-&gt;sublist(<span class="stringliteral">&quot;Problem&quot;</span>).get(<span class="stringliteral">&quot;Homotopy Restart Step&quot;</span>, 1.));
<a name="l00380"></a>00380        <span class="keywordtype">double</span> homotopy = paramList-&gt;sublist(<span class="stringliteral">&quot;Problem&quot;</span>).sublist(<span class="stringliteral">&quot;FELIX Viscosity&quot;</span>).get(<span class="stringliteral">&quot;Glen&#39;s Law Homotopy Parameter&quot;</span>, 1.0);
<a name="l00381"></a>00381        <span class="keywordflow">if</span>(<a class="code" href="felix__driver_8cpp.html#ab17857c6a5d0e7cb559027884f5135d0">meshStruct</a>-&gt;restartDataTime()== homotopy)
<a name="l00382"></a>00382          paramList-&gt;sublist(<span class="stringliteral">&quot;Problem&quot;</span>).set(<span class="stringliteral">&quot;Solution Method&quot;</span>, <span class="stringliteral">&quot;Steady&quot;</span>);
<a name="l00383"></a>00383     }
<a name="l00384"></a>00384     Teuchos::RCP&lt;Albany::Application&gt; <a class="code" href="InterfaceTry_8cpp.html#a5687d6d7d8e1356f9cbed0616b9e7cec">app</a> = Teuchos::rcp(<span class="keyword">new</span> <a class="code" href="classAlbany_1_1Application.html">Albany::Application</a>(<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>, paramList));
<a name="l00385"></a>00385     <a class="code" href="felix__driver_8cpp.html#a972cd8f5f47d36a2a3cea6e71a0ffa11">solver</a> = <a class="code" href="felix__driver_8cpp.html#aa2ffb8fe45b2c5323c662073bbded859">slvrfctry</a>-&gt;createThyraSolverAndGetAlbanyApp(app, <a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>, <a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>);
<a name="l00386"></a>00386 
<a name="l00387"></a>00387 
<a name="l00388"></a>00388     Teuchos::ParameterList solveParams;
<a name="l00389"></a>00389     solveParams.set(<span class="stringliteral">&quot;Compute Sensitivities&quot;</span>, <span class="keyword">true</span>);
<a name="l00390"></a>00390     Teuchos::Array&lt;Teuchos::RCP&lt;const Thyra::VectorBase&lt;double&gt; &gt; &gt; thyraResponses;
<a name="l00391"></a>00391     Teuchos::Array&lt;Teuchos::Array&lt;Teuchos::RCP&lt;const Thyra::MultiVectorBase&lt;double&gt; &gt; &gt; &gt; thyraSensitivities;
<a name="l00392"></a>00392     Piro::PerformSolveBase(*<a class="code" href="felix__driver_8cpp.html#a972cd8f5f47d36a2a3cea6e71a0ffa11">solver</a>, solveParams, thyraResponses, thyraSensitivities);
<a name="l00393"></a>00393 
<a name="l00394"></a>00394      <span class="keyword">const</span> Epetra_Map&amp; ownedMap(*app-&gt;getDiscretization()-&gt;getMap()); <span class="comment">//owned map</span>
<a name="l00395"></a>00395      <span class="keyword">const</span> Epetra_Map&amp; overlapMap(*app-&gt;getDiscretization()-&gt;getOverlapMap()); <span class="comment">//overlap map</span>
<a name="l00396"></a>00396      Epetra_Import <span class="keyword">import</span>(overlapMap, ownedMap); <span class="comment">//importer from ownedMap to overlapMap </span>
<a name="l00397"></a>00397      Epetra_Vector solutionOverlap(overlapMap); <span class="comment">//overlapped solution </span>
<a name="l00398"></a>00398      solutionOverlap.Import(*app-&gt;getDiscretization()-&gt;getSolutionField(), <span class="keyword">import</span>, Insert);
<a name="l00399"></a>00399     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;..done!&quot;</span> &lt;&lt; std::endl;
<a name="l00400"></a>00400 
<a name="l00401"></a>00401 <span class="preprocessor">#ifdef WRITE_TO_MATRIX_MARKET</span>
<a name="l00402"></a>00402 <span class="preprocessor"></span>    <span class="comment">//For debug: write solution and maps to matrix market file </span>
<a name="l00403"></a>00403      EpetraExt::BlockMapToMatrixMarketFile(<span class="stringliteral">&quot;node_map.mm&quot;</span>, *<a class="code" href="felix__driver_8cpp.html#af9808ee708d8ece5df6ce04b52de71dd">node_map</a>); 
<a name="l00404"></a>00404      EpetraExt::BlockMapToMatrixMarketFile(<span class="stringliteral">&quot;map.mm&quot;</span>, ownedMap); 
<a name="l00405"></a>00405      EpetraExt::BlockMapToMatrixMarketFile(<span class="stringliteral">&quot;overlap_map.mm&quot;</span>, overlapMap); 
<a name="l00406"></a>00406      EpetraExt::MultiVectorToMatrixMarketFile(<span class="stringliteral">&quot;solution.mm&quot;</span>, *app-&gt;getDiscretization()-&gt;getSolutionField());
<a name="l00407"></a>00407 <span class="preprocessor">#endif</span>
<a name="l00408"></a>00408 <span class="preprocessor"></span>    
<a name="l00409"></a>00409     <span class="comment">// ---------------------------------------------------------------------------------------------------</span>
<a name="l00410"></a>00410     <span class="comment">// Compute sensitivies / responses and perform regression tests</span>
<a name="l00411"></a>00411     <span class="comment">// IK, 12/9/13: how come this is turned off in mpas branch? </span>
<a name="l00412"></a>00412     <span class="comment">// ---------------------------------------------------------------------------------------------------</span>
<a name="l00413"></a>00413   
<a name="l00414"></a>00414     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;Computing responses and sensitivities...&quot;</span> &lt;&lt; std::endl;
<a name="l00415"></a>00415     <span class="keywordtype">int</span> status=0; <span class="comment">// 0 = pass, failures are incremented</span>
<a name="l00416"></a>00416     Teuchos::Array&lt;Teuchos::RCP&lt;const Epetra_Vector&gt; &gt; responses;
<a name="l00417"></a>00417     Teuchos::Array&lt;Teuchos::Array&lt;Teuchos::RCP&lt;const Epetra_MultiVector&gt; &gt; &gt; sensitivities;
<a name="l00418"></a>00418     <a class="code" href="felix__driver_8cpp.html#a3260e8ae7702f29c0639c7f999354327">epetraFromThyra</a>(<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>, thyraResponses, thyraSensitivities, responses, sensitivities);
<a name="l00419"></a>00419 
<a name="l00420"></a>00420     <span class="keyword">const</span> <span class="keywordtype">int</span> num_p = <a class="code" href="felix__driver_8cpp.html#a972cd8f5f47d36a2a3cea6e71a0ffa11">solver</a>-&gt;Np(); <span class="comment">// Number of *vectors* of parameters</span>
<a name="l00421"></a>00421     <span class="keyword">const</span> <span class="keywordtype">int</span> num_g = <a class="code" href="felix__driver_8cpp.html#a972cd8f5f47d36a2a3cea6e71a0ffa11">solver</a>-&gt;Ng(); <span class="comment">// Number of *vectors* of responses</span>
<a name="l00422"></a>00422 
<a name="l00423"></a>00423     *out &lt;&lt; <span class="stringliteral">&quot;Finished eval of first model: Params, Responses &quot;</span>
<a name="l00424"></a>00424       &lt;&lt; std::setprecision(12) &lt;&lt; std::endl;
<a name="l00425"></a>00425 
<a name="l00426"></a>00426     <span class="keyword">const</span> Thyra::ModelEvaluatorBase::InArgs&lt;double&gt; nominal = <a class="code" href="felix__driver_8cpp.html#a972cd8f5f47d36a2a3cea6e71a0ffa11">solver</a>-&gt;getNominalValues();
<a name="l00427"></a>00427     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;num_p; i++) {
<a name="l00428"></a>00428       <span class="keyword">const</span> Teuchos::RCP&lt;const Epetra_Vector&gt; p_init = <a class="code" href="felix__driver_8cpp.html#a9893178d2f0de9d56a7d7df9b51f0bca">epetraVectorFromThyra</a>(<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>, nominal.get_p(i));
<a name="l00429"></a>00429       p_init-&gt;Print(*out &lt;&lt; <span class="stringliteral">&quot;\nParameter vector &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;:\n&quot;</span>);
<a name="l00430"></a>00430     }
<a name="l00431"></a>00431 
<a name="l00432"></a>00432     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;num_g-1; i++) {
<a name="l00433"></a>00433       <span class="keyword">const</span> Teuchos::RCP&lt;const Epetra_Vector&gt; <a class="code" href="namespaceFELIX.html#a6288e24787bb4182b95927dafefba8fe">g</a> = responses[i];
<a name="l00434"></a>00434       <span class="keywordtype">bool</span> is_scalar = <span class="keyword">true</span>;
<a name="l00435"></a>00435 
<a name="l00436"></a>00436       <span class="keywordflow">if</span> (app != Teuchos::null)
<a name="l00437"></a>00437         is_scalar = app-&gt;getResponse(i)-&gt;isScalarResponse();
<a name="l00438"></a>00438 
<a name="l00439"></a>00439       <span class="keywordflow">if</span> (is_scalar) {
<a name="l00440"></a>00440         g-&gt;Print(*out &lt;&lt; <span class="stringliteral">&quot;\nResponse vector &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;:\n&quot;</span>);
<a name="l00441"></a>00441 
<a name="l00442"></a>00442         <span class="keywordflow">if</span> (num_p == 0) {
<a name="l00443"></a>00443           <span class="comment">// Just calculate regression data</span>
<a name="l00444"></a>00444           status += <a class="code" href="felix__driver_8cpp.html#aa2ffb8fe45b2c5323c662073bbded859">slvrfctry</a>-&gt;checkSolveTestResults(i, 0, g.get(), NULL);
<a name="l00445"></a>00445         } <span class="keywordflow">else</span> {
<a name="l00446"></a>00446           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;num_p; j++) {
<a name="l00447"></a>00447             <span class="keyword">const</span> Teuchos::RCP&lt;const Epetra_MultiVector&gt; dgdp = sensitivities[i][j];
<a name="l00448"></a>00448             <span class="keywordflow">if</span> (Teuchos::nonnull(dgdp)) {
<a name="l00449"></a>00449               dgdp-&gt;Print(*out &lt;&lt; <span class="stringliteral">&quot;\nSensitivities (&quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; j &lt;&lt; <span class="stringliteral">&quot;):!\n&quot;</span>);
<a name="l00450"></a>00450             }
<a name="l00451"></a>00451             status += <a class="code" href="felix__driver_8cpp.html#aa2ffb8fe45b2c5323c662073bbded859">slvrfctry</a>-&gt;checkSolveTestResults(i, j, g.get(), dgdp.get());
<a name="l00452"></a>00452           }
<a name="l00453"></a>00453         }
<a name="l00454"></a>00454       }
<a name="l00455"></a>00455     }
<a name="l00456"></a>00456 
<a name="l00457"></a>00457     *out &lt;&lt; <span class="stringliteral">&quot;\nNumber of Failed Comparisons: &quot;</span> &lt;&lt; status &lt;&lt; std::endl;
<a name="l00458"></a>00458     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;...done!&quot;</span> &lt;&lt; std::endl;
<a name="l00459"></a>00459 
<a name="l00460"></a>00460 
<a name="l00461"></a>00461     <span class="comment">// ---------------------------------------------------------------------------------------------------</span>
<a name="l00462"></a>00462     <span class="comment">// Copy solution back to glimmer uvel and vvel arrays to be passed back</span>
<a name="l00463"></a>00463     <span class="comment">// ---------------------------------------------------------------------------------------------------</span>
<a name="l00464"></a>00464 
<a name="l00465"></a>00465     <span class="comment">//std::cout &lt;&lt; &quot;overlapMap # global elements: &quot; &lt;&lt; overlapMap.NumGlobalElements() &lt;&lt; std::endl; </span>
<a name="l00466"></a>00466     <span class="comment">//std::cout &lt;&lt; &quot;overlapMap # my elements: &quot; &lt;&lt; overlapMap.NumMyElements() &lt;&lt; std::endl; </span>
<a name="l00467"></a>00467     <span class="comment">//std::cout &lt;&lt; &quot;overlapMap: &quot; &lt;&lt; overlapMap &lt;&lt; std::endl; </span>
<a name="l00468"></a>00468     <span class="comment">//std::cout &lt;&lt; &quot;map # global elements: &quot; &lt;&lt; ownedMap.NumGlobalElements() &lt;&lt; std::endl; </span>
<a name="l00469"></a>00469     <span class="comment">//std::cout &lt;&lt; &quot;map # my elements: &quot; &lt;&lt; ownedMap.NumMyElements() &lt;&lt; std::endl; </span>
<a name="l00470"></a>00470     <span class="comment">//std::cout &lt;&lt; &quot;node_map # global elements: &quot; &lt;&lt; node_map-&gt;NumGlobalElements() &lt;&lt; std::endl; </span>
<a name="l00471"></a>00471     <span class="comment">//std::cout &lt;&lt; &quot;node_map # my elements: &quot; &lt;&lt; node_map-&gt;NumMyElements() &lt;&lt; std::endl; </span>
<a name="l00472"></a>00472     <span class="comment">//std::cout &lt;&lt; &quot;node_map: &quot; &lt;&lt; *node_map &lt;&lt; std::endl; </span>
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;In felix_driver_run: copying Albany solution to uvel and vvel to send back to CISM... &quot;</span> &lt;&lt; std::endl;
<a name="l00475"></a>00475     <span class="comment">//Epetra_Vectors to hold uvel and vvel to be passed to Glimmer/CISM </span>
<a name="l00476"></a>00476     Epetra_Vector uvel(*<a class="code" href="felix__driver_8cpp.html#af9808ee708d8ece5df6ce04b52de71dd">node_map</a>, <span class="keyword">true</span>); 
<a name="l00477"></a>00477     Epetra_Vector vvel(*<a class="code" href="felix__driver_8cpp.html#af9808ee708d8ece5df6ce04b52de71dd">node_map</a>, <span class="keyword">true</span>); 
<a name="l00478"></a>00478 
<a name="l00479"></a>00479     
<a name="l00480"></a>00480     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#af1beb0c410a8a48552ab0fdb5e8c49ed">interleavedOrdering</a> == <span class="keyword">true</span>) { 
<a name="l00481"></a>00481       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;overlapMap.NumMyElements(); i++) { 
<a name="l00482"></a>00482         <span class="keywordtype">int</span> global_dof = overlapMap.GID(i);
<a name="l00483"></a>00483         <span class="keywordtype">double</span> sol_value = solutionOverlap[i];  
<a name="l00484"></a>00484         <span class="keywordtype">int</span> modulo = (global_dof % 2); <span class="comment">//check if dof is for u or for v </span>
<a name="l00485"></a>00485         <span class="keywordtype">int</span> vel_global_dof, vel_local_dof; 
<a name="l00486"></a>00486         <span class="keywordflow">if</span> (modulo == 0) { <span class="comment">//u dof </span>
<a name="l00487"></a>00487           vel_global_dof = global_dof/2+1; <span class="comment">//add 1 because node_map is 1-based </span>
<a name="l00488"></a>00488           vel_local_dof = <a class="code" href="felix__driver_8cpp.html#af9808ee708d8ece5df6ce04b52de71dd">node_map</a>-&gt;LID(vel_global_dof); <span class="comment">//look up local id corresponding to global id in node_map</span>
<a name="l00489"></a>00489           <span class="comment">//std::cout &lt;&lt; &quot;uvel: global_dof = &quot; &lt;&lt; global_dof &lt;&lt; &quot;, uvel_global_dof = &quot; &lt;&lt; vel_global_dof &lt;&lt; &quot;, uvel_local_dof = &quot; &lt;&lt; vel_local_dof &lt;&lt; std::endl; </span>
<a name="l00490"></a>00490           uvel.ReplaceMyValues(1, &amp;sol_value, &amp;vel_local_dof); 
<a name="l00491"></a>00491         }
<a name="l00492"></a>00492         <span class="keywordflow">else</span> { <span class="comment">// v dof </span>
<a name="l00493"></a>00493           vel_global_dof = (global_dof-1)/2+1; <span class="comment">//add 1 because node_map is 1-based </span>
<a name="l00494"></a>00494           vel_local_dof = <a class="code" href="felix__driver_8cpp.html#af9808ee708d8ece5df6ce04b52de71dd">node_map</a>-&gt;LID(vel_global_dof); <span class="comment">//look up local id corresponding to global id in node_map</span>
<a name="l00495"></a>00495           vvel.ReplaceMyValues(1, &amp;sol_value, &amp; vel_local_dof); 
<a name="l00496"></a>00496         }
<a name="l00497"></a>00497       }
<a name="l00498"></a>00498     }
<a name="l00499"></a>00499     <span class="keywordflow">else</span> { <span class="comment">//note: the case with non-interleaved ordering has not been tested...</span>
<a name="l00500"></a>00500       <span class="keywordtype">int</span> numDofs = overlapMap.NumGlobalElements(); 
<a name="l00501"></a>00501       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;overlapMap.NumMyElements(); i++) { 
<a name="l00502"></a>00502         <span class="keywordtype">int</span> global_dof = overlapMap.GID(i);
<a name="l00503"></a>00503         <span class="keywordtype">double</span> sol_value = solutionOverlap[i];  
<a name="l00504"></a>00504         <span class="keywordtype">int</span> vel_global_dof, vel_local_dof; 
<a name="l00505"></a>00505         <span class="keywordflow">if</span> (global_dof &lt; numDofs/2) { <span class="comment">//u dof</span>
<a name="l00506"></a>00506           vel_global_dof = global_dof+1; <span class="comment">//add 1 because node_map is 1-based </span>
<a name="l00507"></a>00507           vel_local_dof = <a class="code" href="felix__driver_8cpp.html#af9808ee708d8ece5df6ce04b52de71dd">node_map</a>-&gt;LID(vel_global_dof); <span class="comment">//look up local id corresponding to global id in node_map</span>
<a name="l00508"></a>00508           uvel.ReplaceMyValues(1, &amp;sol_value, &amp;vel_local_dof); 
<a name="l00509"></a>00509         }
<a name="l00510"></a>00510         <span class="keywordflow">else</span> { <span class="comment">//v dofs </span>
<a name="l00511"></a>00511           vel_global_dof = global_dof-numDofs/2+1; <span class="comment">//add 1 because node_map is 1-based</span>
<a name="l00512"></a>00512           vel_local_dof = <a class="code" href="felix__driver_8cpp.html#af9808ee708d8ece5df6ce04b52de71dd">node_map</a>-&gt;LID(vel_global_dof); <span class="comment">//look up local id corresponding to global id in node_map</span>
<a name="l00513"></a>00513           vvel.ReplaceMyValues(1, &amp;sol_value, &amp; vel_local_dof);
<a name="l00514"></a>00514         } 
<a name="l00515"></a>00515       }
<a name="l00516"></a>00516     }
<a name="l00517"></a>00517  
<a name="l00518"></a>00518 
<a name="l00519"></a>00519 <span class="preprocessor">#ifdef WRITE_TO_MATRIX_MARKET</span>
<a name="l00520"></a>00520 <span class="preprocessor"></span>    <span class="comment">//For debug: write solution to matrix market file </span>
<a name="l00521"></a>00521      EpetraExt::MultiVectorToMatrixMarketFile(<span class="stringliteral">&quot;uvel.mm&quot;</span>, uvel); 
<a name="l00522"></a>00522      EpetraExt::MultiVectorToMatrixMarketFile(<span class="stringliteral">&quot;vvel.mm&quot;</span>, vvel);
<a name="l00523"></a>00523 <span class="preprocessor">#endif</span>
<a name="l00524"></a>00524 <span class="preprocessor"></span> 
<a name="l00525"></a>00525      <span class="comment">//Copy uvel and vvel into uVel_ptr and vVel_ptr respectively (the arrays passed back to CISM) according to the numbering consistent w/ CISM. </span>
<a name="l00526"></a>00526      <span class="keywordtype">int</span> counter1 = 0; 
<a name="l00527"></a>00527      <span class="keywordtype">int</span> counter2 = 0; 
<a name="l00528"></a>00528      <span class="keywordtype">int</span> local_nodeID;  
<a name="l00529"></a>00529      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;<a class="code" href="felix__driver_8cpp.html#ab535ad6429f94303bc2e0347bb388e0d">nsn</a>-1; j++) {
<a name="l00530"></a>00530        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="felix__driver_8cpp.html#abaf03ce76028bb0766397be59a6da33e">ewn</a>-1; i++) { 
<a name="l00531"></a>00531          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;<a class="code" href="felix__driver_8cpp.html#a536cbbfa58672a4d27b7baf804bc3acf">upn</a>; k++) {
<a name="l00532"></a>00532            <span class="keywordflow">if</span> (j &gt;= <a class="code" href="felix__driver_8cpp.html#ad5e3206ff1abe2f3f806cae173f65309">nhalo</a>-1 &amp; j &lt; nsn-<a class="code" href="felix__driver_8cpp.html#ad5e3206ff1abe2f3f806cae173f65309">nhalo</a>) {
<a name="l00533"></a>00533              <span class="keywordflow">if</span> (i &gt;= <a class="code" href="felix__driver_8cpp.html#ad5e3206ff1abe2f3f806cae173f65309">nhalo</a>-1 &amp; i &lt; ewn-<a class="code" href="felix__driver_8cpp.html#ad5e3206ff1abe2f3f806cae173f65309">nhalo</a>) { 
<a name="l00534"></a>00534                local_nodeID = <a class="code" href="felix__driver_8cpp.html#af9808ee708d8ece5df6ce04b52de71dd">node_map</a>-&gt;LID(<a class="code" href="felix__driver_8cpp.html#a1c055a28ab77eebc667f57e9adca360a">cismToAlbanyNodeNumberMap</a>[counter1]); 
<a name="l00535"></a>00535                <span class="comment">//if (mpiComm-&gt;MyPID() == 0) </span>
<a name="l00536"></a>00536                <span class="comment">//std::cout &lt;&lt; &quot;counter1:&quot; &lt;&lt; counter1 &lt;&lt; &quot;, cismToAlbanyNodeNumberMap[counter1]: &quot; &lt;&lt; cismToAlbanyNodeNumberMap[counter1] &lt;&lt; &quot;, local_nodeID: &quot; </span>
<a name="l00537"></a>00537                <span class="comment">//&lt;&lt; local_nodeID &lt;&lt; &quot;, uvel: &quot; &lt;&lt; uvel[local_nodeID] &lt;&lt; std::endl; //uvel[local_nodeID] &lt;&lt; std::endl;  </span>
<a name="l00538"></a>00538                <a class="code" href="felix__driver_8cpp.html#aa95651d5002e20d6e0af4b082dce923d">uVel_ptr</a>[counter2] = uvel[local_nodeID];
<a name="l00539"></a>00539                <a class="code" href="felix__driver_8cpp.html#aa1f3d948a28f0b81641f76cd8f0aaced">vVel_ptr</a>[counter2] = vvel[local_nodeID];  
<a name="l00540"></a>00540                counter1++;
<a name="l00541"></a>00541             }
<a name="l00542"></a>00542             }
<a name="l00543"></a>00543             <span class="keywordflow">else</span> {
<a name="l00544"></a>00544              <a class="code" href="felix__driver_8cpp.html#aa95651d5002e20d6e0af4b082dce923d">uVel_ptr</a>[counter2] = 0.0; 
<a name="l00545"></a>00545              <a class="code" href="felix__driver_8cpp.html#aa1f3d948a28f0b81641f76cd8f0aaced">vVel_ptr</a>[counter2] = 0.0; 
<a name="l00546"></a>00546             }
<a name="l00547"></a>00547             counter2++; 
<a name="l00548"></a>00548          }
<a name="l00549"></a>00549         }
<a name="l00550"></a>00550       }
<a name="l00551"></a>00551     
<a name="l00552"></a>00552     <span class="keywordflow">if</span> (<a class="code" href="felix__driver_8cpp.html#a84cd23ab6ebe7a67df7cd4482b0644c1">mpiComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;..done!&quot;</span> &lt;&lt; std::endl;
<a name="l00553"></a>00553 
<a name="l00554"></a>00554 
<a name="l00555"></a>00555     <a class="code" href="felix__driver_8cpp.html#af15f444812d331b09076f23ff813d05d">first_time_step</a> = <span class="keyword">false</span>;
<a name="l00556"></a>00556  
<a name="l00557"></a>00557 }
<a name="l00558"></a>00558   
<a name="l00559"></a>00559 
<a name="l00560"></a>00560 <span class="comment">//Clean up</span>
<a name="l00561"></a>00561 <span class="comment">//IK, 12/3/13: this is not called anywhere in the interface code...  used to be called (based on old bisicles interface code)?  </span>
<a name="l00562"></a><a class="code" href="felix__driver_8H.html#a5af15d47aa448292dbc44484c4020776">00562</a> <span class="keywordtype">void</span> <a class="code" href="felix__driver_8cpp.html#a5af15d47aa448292dbc44484c4020776">felix_driver_finalize</a>(<span class="keywordtype">int</span> amr_obj_index)
<a name="l00563"></a>00563 {
<a name="l00564"></a>00564 
<a name="l00565"></a>00565   std::cout &lt;&lt; <span class="stringliteral">&quot;In felix_driver_finalize: cleaning up...&quot;</span> &lt;&lt; std::endl;
<a name="l00566"></a>00566   std::cout &lt;&lt; <span class="stringliteral">&quot;done cleaning up!&quot;</span> &lt;&lt; std::endl &lt;&lt; std::endl; 
<a name="l00567"></a>00567   
<a name="l00568"></a>00568 }
<a name="l00569"></a>00569 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Mar 26 2014 18:36:38 for Albany: a Trilinos-based PDE code by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
