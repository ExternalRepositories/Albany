<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Albany: a Trilinos-based PDE code: QCAD_CoupledPoissonSchrodinger.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>QCAD_CoupledPoissonSchrodinger.cpp</h1>  </div>
</div>
<div class="contents">
<a href="QCAD__CoupledPoissonSchrodinger_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//*****************************************************************//</span>
<a name="l00002"></a>00002 <span class="comment">//    Albany 2.0:  Copyright 2012 Sandia Corporation               //</span>
<a name="l00003"></a>00003 <span class="comment">//    This Software is released under the BSD license detailed     //</span>
<a name="l00004"></a>00004 <span class="comment">//    in the file &quot;license.txt&quot; in the top-level Albany directory  //</span>
<a name="l00005"></a>00005 <span class="comment">//*****************************************************************//</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="preprocessor">#include &quot;<a class="code" href="QCAD__CoupledPoissonSchrodinger_8hpp.html">QCAD_CoupledPoissonSchrodinger.hpp</a>&quot;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &quot;<a class="code" href="QCAD__CoupledPSJacobian_8hpp.html">QCAD_CoupledPSJacobian.hpp</a>&quot;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;Piro_Epetra_LOCASolver.hpp&quot;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &quot;Stokhos.hpp&quot;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &quot;Stokhos_Epetra.hpp&quot;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;Sacado_PCE_OrthogPoly.hpp&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;Teuchos_XMLParameterListHelpers.hpp&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;Teuchos_TestForException.hpp&quot;</span>
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;Teuchos_ParameterList.hpp&quot;</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="Albany__ModelFactory_8hpp.html">Albany_ModelFactory.hpp</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="Albany__Utils_8hpp.html">Albany_Utils.hpp</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="Albany__SolverFactory_8hpp.html">Albany_SolverFactory.hpp</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="Albany__StateInfoStruct_8hpp.html">Albany_StateInfoStruct.hpp</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="Albany__EigendataInfoStruct_8hpp.html">Albany_EigendataInfoStruct.hpp</a>&quot;</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="QCAD__CoupledPSJacobian_8hpp.html">QCAD_CoupledPSJacobian.hpp</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="QCAD__CoupledPSPreconditioner_8hpp.html">QCAD_CoupledPSPreconditioner.hpp</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="QCAD__MultiSolutionObserver_8hpp.html">QCAD_MultiSolutionObserver.hpp</a>&quot;</span> <span class="comment">//for utility functions</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="comment">//For creating discretiation object without a problem object</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="Albany__DiscretizationFactory_8hpp.html">Albany_DiscretizationFactory.hpp</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="Albany__StateInfoStruct_8hpp.html">Albany_StateInfoStruct.hpp</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="Albany__AbstractFieldContainer_8hpp.html">Albany_AbstractFieldContainer.hpp</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;Piro_NullSpaceUtils.hpp&quot;</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="comment">//Ifpack includes</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;Ifpack_ConfigDefs.h&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;Ifpack.h&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 
<a name="l00039"></a><a class="code" href="namespaceQCAD.html#a692ce4bfb403a4c4f6198a6959cae663">00039</a> std::string <a class="code" href="namespaceQCAD.html#a692ce4bfb403a4c4f6198a6959cae663">QCAD::strdim</a>(<span class="keyword">const</span> std::string s, <span class="keyword">const</span> <span class="keywordtype">int</span> dim) {
<a name="l00040"></a>00040   std::ostringstream ss;
<a name="l00041"></a>00041   ss &lt;&lt; s &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; dim &lt;&lt; <span class="stringliteral">&quot;D&quot;</span>;
<a name="l00042"></a>00042   <span class="keywordflow">return</span> ss.str();
<a name="l00043"></a>00043 }
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a72e59fe6db06abadfe3202fc9247c111">QCAD::CoupledPoissonSchrodinger::</a>
<a name="l00047"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a72e59fe6db06abadfe3202fc9247c111">00047</a> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a72e59fe6db06abadfe3202fc9247c111">CoupledPoissonSchrodinger</a>(<span class="keyword">const</span> Teuchos::RCP&lt;Teuchos::ParameterList&gt;&amp; appParams_,
<a name="l00048"></a>00048         <span class="keyword">const</span> Teuchos::RCP&lt;const Epetra_Comm&gt;&amp; <a class="code" href="felix__driver_8cpp.html#ab048c6f9fcbcfaa57ce68b00263dbebe">comm</a>,
<a name="l00049"></a>00049         <span class="keyword">const</span> Teuchos::RCP&lt;const Epetra_Vector&gt;&amp; initial_guess)
<a name="l00050"></a>00050 {
<a name="l00051"></a>00051   <span class="keyword">using</span> std::string;
<a name="l00052"></a>00052   
<a name="l00053"></a>00053   <span class="comment">// make a copy of the appParams, since we modify them below (e.g. discretization list)</span>
<a name="l00054"></a>00054   Teuchos::RCP&lt;Teuchos::ParameterList&gt; <a class="code" href="felix__driver_8cpp.html#ac72c72afb7da5a0adcf02a0e202b4d92">appParams</a> = Teuchos::rcp( <span class="keyword">new</span> Teuchos::ParameterList(*appParams_) );
<a name="l00055"></a>00055 
<a name="l00056"></a>00056   <span class="keyword">const</span> <a class="code" href="Albany__Utils_8hpp.html#a8443cc10136989d1bc30c0e715ab3cbf">Albany_MPI_Comm</a>&amp; mcomm = <a class="code" href="namespaceAlbany.html#a15bbfa6de65c4c7e0314fb5589e7d041">Albany::getMpiCommFromEpetraComm</a>(*comm);
<a name="l00057"></a>00057   Teuchos::RCP&lt;Teuchos::Comm&lt;int&gt; &gt; tcomm = <a class="code" href="namespaceAlbany.html#ac2dc62ae621c8491340872af7501816e">Albany::createTeuchosCommFromMpiComm</a>(mcomm);
<a name="l00058"></a>00058 
<a name="l00059"></a>00059   <span class="comment">// Get sub-problem input xml files from problem parameters</span>
<a name="l00060"></a>00060   Teuchos::ParameterList&amp; problemParams = appParams-&gt;sublist(<span class="stringliteral">&quot;Problem&quot;</span>);
<a name="l00061"></a>00061 
<a name="l00062"></a>00062   <span class="comment">// Validate Problem parameters against list for this specific problem</span>
<a name="l00063"></a>00063   problemParams.validateParameters(*<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa7534779d7610b69161f6517a0ae9ee9">getValidProblemParameters</a>(),0);
<a name="l00064"></a>00064 
<a name="l00065"></a>00065   <span class="comment">// Get the number of dimensions</span>
<a name="l00066"></a>00066   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a24b90c4101bde7d44b03c719ef2a9b4e" title="Miscellaneous.">numDims</a> = 0;
<a name="l00067"></a>00067   <span class="keywordtype">string</span> name = problemParams.get&lt;std::string&gt;(<span class="stringliteral">&quot;Name&quot;</span>);
<a name="l00068"></a>00068   <span class="keywordflow">if</span>(name == <span class="stringliteral">&quot;Poisson Schrodinger 1D&quot;</span>) <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a24b90c4101bde7d44b03c719ef2a9b4e" title="Miscellaneous.">numDims</a> = 1;
<a name="l00069"></a>00069   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(name == <span class="stringliteral">&quot;Poisson Schrodinger 2D&quot;</span>) <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a24b90c4101bde7d44b03c719ef2a9b4e" title="Miscellaneous.">numDims</a> = 2;
<a name="l00070"></a>00070   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(name == <span class="stringliteral">&quot;Poisson Schrodinger 3D&quot;</span>) <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a24b90c4101bde7d44b03c719ef2a9b4e" title="Miscellaneous.">numDims</a> = 3;
<a name="l00071"></a>00071   <span class="keywordflow">else</span> TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter, std::endl 
<a name="l00072"></a>00072         &lt;&lt; <span class="stringliteral">&quot;Error!  Invalid problem name &quot;</span> &lt;&lt; name &lt;&lt; std::endl);
<a name="l00073"></a>00073 
<a name="l00074"></a>00074   <span class="comment">// Get parameters from Problem sublist used to generate poisson and schrodinger app lists</span>
<a name="l00075"></a>00075   <span class="keywordtype">int</span> vizDetail         = problemParams.get&lt;<span class="keywordtype">int</span>&gt;(<span class="stringliteral">&quot;Phalanx Graph Visualization Detail&quot;</span>);
<a name="l00076"></a>00076   <span class="keywordtype">double</span> Temp           = problemParams.get&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Temperature&quot;</span>);
<a name="l00077"></a>00077   <span class="keywordtype">double</span> lenUnit        = problemParams.get&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Length Unit In Meters&quot;</span>, 1e-6);
<a name="l00078"></a>00078   <span class="keywordtype">double</span> energyUnit     = problemParams.get&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Energy Unit In Electron Volts&quot;</span>, 1.0);
<a name="l00079"></a>00079   std::string matrlFile = problemParams.get&lt;std::string&gt;(<span class="stringliteral">&quot;MaterialDB Filename&quot;</span>, <span class="stringliteral">&quot;materials.xml&quot;</span>);
<a name="l00080"></a>00080   <span class="keywordtype">bool</span>   bXCPot         = problemParams.get&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;Include exchange-correlation potential&quot;</span>,<span class="keyword">false</span>);
<a name="l00081"></a>00081   <span class="keywordtype">bool</span>   bQBOnly        = problemParams.get&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;Only solve schrodinger in quantum blocks&quot;</span>,<span class="keyword">true</span>);
<a name="l00082"></a>00082   
<a name="l00083"></a>00083   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>   = problemParams.get&lt;<span class="keywordtype">int</span>&gt;(<span class="stringliteral">&quot;Number of Eigenvalues&quot;</span>);
<a name="l00084"></a>00084   Teuchos::ParameterList&amp; discList = appParams-&gt;sublist(<span class="stringliteral">&quot;Discretization&quot;</span>);
<a name="l00085"></a>00085   Teuchos::ParameterList&amp; poisson_subList = problemParams.sublist(<span class="stringliteral">&quot;Poisson Problem&quot;</span>, <span class="keyword">false</span>);
<a name="l00086"></a>00086   Teuchos::ParameterList&amp; schro_subList = problemParams.sublist(<span class="stringliteral">&quot;Schrodinger Problem&quot;</span>, <span class="keyword">false</span>);
<a name="l00087"></a>00087 
<a name="l00088"></a>00088   <span class="comment">// Process debug options to write poisson and schrodinger app params to files</span>
<a name="l00089"></a>00089   Teuchos::ParameterList&amp; debugList = appParams-&gt;sublist(<span class="stringliteral">&quot;Debug Output&quot;</span>, <span class="keyword">true</span>);
<a name="l00090"></a>00090   std::string poissonXmlFile       = debugList.get(<span class="stringliteral">&quot;Poisson XML Input&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00091"></a>00091   std::string schrodingerXmlFile   = debugList.get(<span class="stringliteral">&quot;Schrodinger XML Input&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00092"></a>00092   std::string poissonExoOutput     = debugList.get(<span class="stringliteral">&quot;Poisson Exodus Output&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00093"></a>00093   std::string schrodingerExoOutput = debugList.get(<span class="stringliteral">&quot;Schrodinger Exodus Output&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 
<a name="l00096"></a>00096   <span class="comment">// Create input parameter list for poission app which mimics a separate input file</span>
<a name="l00097"></a>00097   Teuchos::RCP&lt;Teuchos::ParameterList&gt; poisson_appParams = 
<a name="l00098"></a>00098     Teuchos::createParameterList(<span class="stringliteral">&quot;Poisson Application Parameters&quot;</span>);
<a name="l00099"></a>00099   Teuchos::ParameterList&amp; poisson_probParams = poisson_appParams-&gt;sublist(<span class="stringliteral">&quot;Problem&quot;</span>,<span class="keyword">false</span>);
<a name="l00100"></a>00100   
<a name="l00101"></a>00101   poisson_probParams.set(<span class="stringliteral">&quot;Name&quot;</span>, <a class="code" href="namespaceQCAD.html#a692ce4bfb403a4c4f6198a6959cae663">QCAD::strdim</a>(<span class="stringliteral">&quot;Poisson&quot;</span>,<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a24b90c4101bde7d44b03c719ef2a9b4e" title="Miscellaneous.">numDims</a>));
<a name="l00102"></a>00102   poisson_probParams.set(<span class="stringliteral">&quot;Phalanx Graph Visualization Detail&quot;</span>, vizDetail);
<a name="l00103"></a>00103   poisson_probParams.set(<span class="stringliteral">&quot;Length Unit In Meters&quot;</span>,lenUnit);
<a name="l00104"></a>00104   poisson_probParams.set(<span class="stringliteral">&quot;Energy Unit In Electron Volts&quot;</span>,energyUnit);
<a name="l00105"></a>00105   poisson_probParams.set(<span class="stringliteral">&quot;Temperature&quot;</span>,Temp);
<a name="l00106"></a>00106   poisson_probParams.set(<span class="stringliteral">&quot;MaterialDB Filename&quot;</span>, matrlFile);
<a name="l00107"></a>00107 
<a name="l00108"></a>00108   {
<a name="l00109"></a>00109     Teuchos::ParameterList auto_sourceList;
<a name="l00110"></a>00110     auto_sourceList.set(<span class="stringliteral">&quot;Factor&quot;</span>,1.0);
<a name="l00111"></a>00111     auto_sourceList.set(<span class="stringliteral">&quot;Device&quot;</span>,<span class="stringliteral">&quot;elementblocks&quot;</span>);
<a name="l00112"></a>00112     auto_sourceList.set(<span class="stringliteral">&quot;Quantum Region Source&quot;</span>, <span class="stringliteral">&quot;schrodinger&quot;</span>);
<a name="l00113"></a>00113     auto_sourceList.set(<span class="stringliteral">&quot;Non Quantum Region Source&quot;</span>, bQBOnly ? <span class="stringliteral">&quot;semiclassical&quot;</span> : <span class="stringliteral">&quot;schrodinger&quot;</span>);
<a name="l00114"></a>00114     auto_sourceList.set(<span class="stringliteral">&quot;Eigenvectors to Import&quot;</span>, nEigenvals);
<a name="l00115"></a>00115     auto_sourceList.set(<span class="stringliteral">&quot;Use predictor-corrector method&quot;</span>, <span class="keyword">false</span>);
<a name="l00116"></a>00116     auto_sourceList.set(<span class="stringliteral">&quot;Include exchange-correlation potential&quot;</span>, bXCPot);
<a name="l00117"></a>00117 
<a name="l00118"></a>00118     Teuchos::ParameterList&amp; sourceList = poisson_probParams.sublist(<span class="stringliteral">&quot;Poisson Source&quot;</span>, <span class="keyword">false</span>);
<a name="l00119"></a>00119     <span class="keywordflow">if</span>(poisson_subList.isSublist(<span class="stringliteral">&quot;Poisson Source&quot;</span>))
<a name="l00120"></a>00120       sourceList.setParameters( poisson_subList.sublist(<span class="stringliteral">&quot;Poisson Source&quot;</span>) );
<a name="l00121"></a>00121     sourceList.setParametersNotAlreadySet( auto_sourceList );
<a name="l00122"></a>00122   }
<a name="l00123"></a>00123 
<a name="l00124"></a>00124   {
<a name="l00125"></a>00125     Teuchos::ParameterList auto_permList;
<a name="l00126"></a>00126     auto_permList.set(<span class="stringliteral">&quot;Permittivity Type&quot;</span>,<span class="stringliteral">&quot;Block Dependent&quot;</span>);
<a name="l00127"></a>00127 
<a name="l00128"></a>00128     Teuchos::ParameterList&amp; permList = poisson_probParams.sublist(<span class="stringliteral">&quot;Permittivity&quot;</span>, <span class="keyword">false</span>);
<a name="l00129"></a>00129     <span class="keywordflow">if</span>(!poisson_subList.isSublist(<span class="stringliteral">&quot;Permittivity&quot;</span>))
<a name="l00130"></a>00130       permList.setParameters( poisson_subList.sublist(<span class="stringliteral">&quot;Permittivity&quot;</span>) );
<a name="l00131"></a>00131     permList.setParametersNotAlreadySet( auto_permList );
<a name="l00132"></a>00132   }  
<a name="l00133"></a>00133 
<a name="l00134"></a>00134             
<a name="l00135"></a>00135   <span class="keywordflow">if</span>(poisson_subList.isSublist(<span class="stringliteral">&quot;Dirichlet BCs&quot;</span>)) {
<a name="l00136"></a>00136     Teuchos::ParameterList&amp; tmp = poisson_probParams.sublist(<span class="stringliteral">&quot;Dirichlet BCs&quot;</span>, <span class="keyword">false</span>);
<a name="l00137"></a>00137     tmp.setParameters(poisson_subList.sublist(<span class="stringliteral">&quot;Dirichlet BCs&quot;</span>));
<a name="l00138"></a>00138   }
<a name="l00139"></a>00139 
<a name="l00140"></a>00140   <span class="comment">// Copy Parameter list over, or create an empty list if it was omitted (so validation passes)</span>
<a name="l00141"></a>00141   Teuchos::ParameterList&amp; poisson_params = poisson_probParams.sublist(<span class="stringliteral">&quot;Parameters&quot;</span>, <span class="keyword">false</span>);
<a name="l00142"></a>00142   <span class="keywordflow">if</span>(poisson_subList.isSublist(<span class="stringliteral">&quot;Parameters&quot;</span>))
<a name="l00143"></a>00143     poisson_params.setParameters(poisson_subList.sublist(<span class="stringliteral">&quot;Parameters&quot;</span>));
<a name="l00144"></a>00144   <span class="keywordflow">else</span> poisson_params.set(<span class="stringliteral">&quot;Number&quot;</span>,0);
<a name="l00145"></a>00145 
<a name="l00146"></a>00146   <span class="comment">// Copy Response Functions list over, or create an empty list if it was omitted (so validation passes)</span>
<a name="l00147"></a>00147   Teuchos::ParameterList&amp; poisson_resps = poisson_probParams.sublist(<span class="stringliteral">&quot;Response Functions&quot;</span>, <span class="keyword">false</span>);
<a name="l00148"></a>00148   <span class="keywordflow">if</span>(poisson_subList.isSublist(<span class="stringliteral">&quot;Response Functions&quot;</span>))
<a name="l00149"></a>00149     poisson_resps.setParameters(poisson_subList.sublist(<span class="stringliteral">&quot;Response Functions&quot;</span>));
<a name="l00150"></a>00150   <span class="keywordflow">else</span> poisson_resps.set(<span class="stringliteral">&quot;Number&quot;</span>,0);  
<a name="l00151"></a>00151   
<a name="l00152"></a>00152 
<a name="l00153"></a>00153   Teuchos::ParameterList&amp; poisson_discList = poisson_appParams-&gt;sublist(<span class="stringliteral">&quot;Discretization&quot;</span>, <span class="keyword">false</span>);
<a name="l00154"></a>00154   poisson_discList.setParameters(discList);
<a name="l00155"></a>00155   <span class="keywordflow">if</span>(poissonExoOutput.length() &gt; 0) 
<a name="l00156"></a>00156     poisson_discList.set(<span class="stringliteral">&quot;Exodus Output File Name&quot;</span>,poissonExoOutput);
<a name="l00157"></a>00157   <span class="keywordflow">else</span> poisson_discList.remove(<span class="stringliteral">&quot;Exodus Output File Name&quot;</span>,<span class="keyword">false</span>); 
<a name="l00158"></a>00158 
<a name="l00159"></a>00159   <span class="keywordflow">if</span>(poissonXmlFile.length() &gt; 0 and tcomm-&gt;getRank() == 0)
<a name="l00160"></a>00160     Teuchos::writeParameterListToXmlFile(*poisson_appParams, poissonXmlFile);
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 
<a name="l00164"></a>00164   <span class="comment">// Create input parameter list for schrodinger app which mimics a separate input file</span>
<a name="l00165"></a>00165   Teuchos::RCP&lt;Teuchos::ParameterList&gt; schro_appParams = 
<a name="l00166"></a>00166     Teuchos::createParameterList(<span class="stringliteral">&quot;Schrodinger Application Parameters&quot;</span>);  
<a name="l00167"></a>00167   Teuchos::ParameterList&amp; schro_probParams = schro_appParams-&gt;sublist(<span class="stringliteral">&quot;Problem&quot;</span>,<span class="keyword">false</span>);
<a name="l00168"></a>00168 
<a name="l00169"></a>00169   schro_probParams.set(<span class="stringliteral">&quot;Name&quot;</span>, <a class="code" href="namespaceQCAD.html#a692ce4bfb403a4c4f6198a6959cae663">QCAD::strdim</a>(<span class="stringliteral">&quot;Schrodinger&quot;</span>,<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a24b90c4101bde7d44b03c719ef2a9b4e" title="Miscellaneous.">numDims</a>));
<a name="l00170"></a>00170   schro_probParams.set(<span class="stringliteral">&quot;Solution Method&quot;</span>, <span class="stringliteral">&quot;Continuation&quot;</span>);
<a name="l00171"></a>00171   schro_probParams.set(<span class="stringliteral">&quot;Phalanx Graph Visualization Detail&quot;</span>, vizDetail);
<a name="l00172"></a>00172   schro_probParams.set(<span class="stringliteral">&quot;Energy Unit In Electron Volts&quot;</span>,energyUnit);
<a name="l00173"></a>00173   schro_probParams.set(<span class="stringliteral">&quot;Length Unit In Meters&quot;</span>,lenUnit);
<a name="l00174"></a>00174   schro_probParams.set(<span class="stringliteral">&quot;MaterialDB Filename&quot;</span>, matrlFile);
<a name="l00175"></a>00175   schro_probParams.set(<span class="stringliteral">&quot;Only solve in quantum blocks&quot;</span>, bQBOnly);
<a name="l00176"></a>00176 
<a name="l00177"></a>00177   {
<a name="l00178"></a>00178     Teuchos::ParameterList auto_potList;
<a name="l00179"></a>00179     auto_potList.set(<span class="stringliteral">&quot;Type&quot;</span>,<span class="stringliteral">&quot;From Aux Data Vector&quot;</span>);
<a name="l00180"></a>00180     auto_potList.set(<span class="stringliteral">&quot;Aux Index&quot;</span>, 0); <span class="comment">//we import potential using aux vector 0</span>
<a name="l00181"></a>00181     
<a name="l00182"></a>00182     Teuchos::ParameterList&amp; potList = schro_probParams.sublist(<span class="stringliteral">&quot;Potential&quot;</span>, <span class="keyword">false</span>);
<a name="l00183"></a>00183     <span class="keywordflow">if</span>(schro_subList.isSublist(<span class="stringliteral">&quot;Potential&quot;</span>))
<a name="l00184"></a>00184       potList.setParameters(schro_subList.sublist(<span class="stringliteral">&quot;Potential&quot;</span>));
<a name="l00185"></a>00185     potList.setParametersNotAlreadySet(auto_potList);
<a name="l00186"></a>00186   }
<a name="l00187"></a>00187 
<a name="l00188"></a>00188   <span class="keywordflow">if</span>(!schro_subList.isSublist(<span class="stringliteral">&quot;Dirichlet BCs&quot;</span>) &amp;&amp; poisson_subList.isSublist(<span class="stringliteral">&quot;Dirichlet BCs&quot;</span>)) {
<a name="l00189"></a>00189     Teuchos::ParameterList&amp; schro_dbcList = schro_probParams.sublist(<span class="stringliteral">&quot;Dirichlet BCs&quot;</span>, <span class="keyword">false</span>);
<a name="l00190"></a>00190     <span class="keyword">const</span> Teuchos::ParameterList&amp; poisson_dbcList = poisson_subList.sublist(<span class="stringliteral">&quot;Dirichlet BCs&quot;</span>);
<a name="l00191"></a>00191     Teuchos::ParameterList::ConstIterator it;
<a name="l00192"></a>00192     <span class="keywordflow">for</span>(it = poisson_dbcList.begin(); it != poisson_dbcList.end(); ++it) {
<a name="l00193"></a>00193       std::string dbcName = poisson_dbcList.name(it);
<a name="l00194"></a>00194       std::size_t k = dbcName.find(<span class="stringliteral">&quot;Phi&quot;</span>);
<a name="l00195"></a>00195       <span class="keywordflow">if</span>( k != std::string::npos ) {
<a name="l00196"></a>00196   dbcName.replace(k, 3 <span class="comment">/* len(&quot;Phi&quot;) */</span>, <span class="stringliteral">&quot;psi&quot;</span>);  <span class="comment">// replace Phi -&gt; psi</span>
<a name="l00197"></a>00197   schro_dbcList.set( dbcName, 0.0 ); <span class="comment">//copy all poisson DBCs but set to zero</span>
<a name="l00198"></a>00198       }
<a name="l00199"></a>00199     }
<a name="l00200"></a>00200   }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202   <span class="comment">// Copy Parameter list over, or create an empty list if it was omitted (so validation passes)</span>
<a name="l00203"></a>00203   Teuchos::ParameterList&amp; schro_params = schro_probParams.sublist(<span class="stringliteral">&quot;Parameters&quot;</span>, <span class="keyword">false</span>);
<a name="l00204"></a>00204   <span class="keywordflow">if</span>(schro_subList.isSublist(<span class="stringliteral">&quot;Parameters&quot;</span>))
<a name="l00205"></a>00205     schro_params.setParameters(schro_subList.sublist(<span class="stringliteral">&quot;Parameters&quot;</span>));
<a name="l00206"></a>00206   <span class="keywordflow">else</span> schro_params.set(<span class="stringliteral">&quot;Number&quot;</span>,0);
<a name="l00207"></a>00207 
<a name="l00208"></a>00208   <span class="comment">// Copy Response Functions list over, or create an empty list if it was omitted (so validation passes)</span>
<a name="l00209"></a>00209   Teuchos::ParameterList&amp; schro_resps = schro_probParams.sublist(<span class="stringliteral">&quot;Response Functions&quot;</span>, <span class="keyword">false</span>);
<a name="l00210"></a>00210   <span class="keywordflow">if</span>(schro_subList.isSublist(<span class="stringliteral">&quot;Response Functions&quot;</span>))
<a name="l00211"></a>00211     schro_resps.setParameters(schro_subList.sublist(<span class="stringliteral">&quot;Response Functions&quot;</span>));
<a name="l00212"></a>00212   <span class="keywordflow">else</span> schro_resps.set(<span class="stringliteral">&quot;Number&quot;</span>,0);
<a name="l00213"></a>00213 
<a name="l00214"></a>00214   Teuchos::ParameterList&amp; schro_discList = schro_appParams-&gt;sublist(<span class="stringliteral">&quot;Discretization&quot;</span>, <span class="keyword">false</span>);
<a name="l00215"></a>00215   schro_discList.setParameters(discList);
<a name="l00216"></a>00216   <span class="keywordflow">if</span>(schrodingerExoOutput.length() &gt; 0) 
<a name="l00217"></a>00217     schro_discList.set(<span class="stringliteral">&quot;Exodus Output File Name&quot;</span>,schrodingerExoOutput);
<a name="l00218"></a>00218   <span class="keywordflow">else</span> schro_discList.remove(<span class="stringliteral">&quot;Exodus Output File Name&quot;</span>,<span class="keyword">false</span>); 
<a name="l00219"></a>00219 
<a name="l00220"></a>00220   <span class="keywordflow">if</span>(schrodingerXmlFile.length() &gt; 0 and tcomm-&gt;getRank() == 0)
<a name="l00221"></a>00221     Teuchos::writeParameterListToXmlFile(*schro_appParams, schrodingerXmlFile);
<a name="l00222"></a>00222 
<a name="l00223"></a>00223     
<a name="l00224"></a>00224   <span class="comment">//TODO: need to add meshmover initialization, as in Albany::Application constructor??</span>
<a name="l00225"></a>00225 
<a name="l00226"></a>00226   <span class="comment">//Create a dummy solverFactory for validating application parameter lists</span>
<a name="l00227"></a>00227   <a class="code" href="classAlbany_1_1SolverFactory.html" title="A factory class to instantiate AbstractSolver objects.">Albany::SolverFactory</a> validFactory( Teuchos::createParameterList(<span class="stringliteral">&quot;Empty dummy for Validation&quot;</span>), mcomm );
<a name="l00228"></a>00228   Teuchos::RCP&lt;const Teuchos::ParameterList&gt; validAppParams = validFactory.<a class="code" href="classAlbany_1_1SolverFactory.html#a382c777a2eca387ac5e3fb72a9f622d5">getValidAppParameters</a>();
<a name="l00229"></a>00229   Teuchos::RCP&lt;const Teuchos::ParameterList&gt; validParameterParams = validFactory.<a class="code" href="classAlbany_1_1SolverFactory.html#afcad7836926e39abcab380b591631b16">getValidParameterParameters</a>();
<a name="l00230"></a>00230   Teuchos::RCP&lt;const Teuchos::ParameterList&gt; validResponseParams = validFactory.<a class="code" href="classAlbany_1_1SolverFactory.html#a0cdb46819b756475844dde504671b690">getValidResponseParameters</a>();
<a name="l00231"></a>00231 
<a name="l00235"></a>00235 
<a name="l00236"></a>00236   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a157106f86a128a573e8010008c9634f7">saved_initial_guess</a> = initial_guess;
<a name="l00237"></a>00237 
<a name="l00238"></a>00238   <span class="comment">// Validate common parts of poisson app param list: may move inside individual Problem class</span>
<a name="l00239"></a>00239   poisson_appParams-&gt;validateParametersAndSetDefaults(*validAppParams,0);
<a name="l00240"></a>00240   poisson_appParams-&gt;sublist(<span class="stringliteral">&quot;Problem&quot;</span>).sublist(<span class="stringliteral">&quot;Parameters&quot;</span>).validateParameters(*validParameterParams, 0);
<a name="l00241"></a>00241   poisson_appParams-&gt;sublist(<span class="stringliteral">&quot;Problem&quot;</span>).sublist(<span class="stringliteral">&quot;Response Functions&quot;</span>).validateParameters(*validResponseParams, 0);
<a name="l00242"></a>00242   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a> = Teuchos::rcp(<span class="keyword">new</span> <a class="code" href="classAlbany_1_1Application.html">Albany::Application</a>(comm, poisson_appParams, Teuchos::null)); <span class="comment">//validates problem params</span>
<a name="l00243"></a>00243 
<a name="l00244"></a>00244   <span class="comment">// Create model evaluator</span>
<a name="l00245"></a>00245   <a class="code" href="classAlbany_1_1ModelFactory.html">Albany::ModelFactory</a> poissonModelFactory(poisson_appParams, <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>);
<a name="l00246"></a>00246   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ac344dcea687b3b287ccd29a9add35a62">poissonModel</a> = poissonModelFactory.<a class="code" href="classAlbany_1_1ModelFactory.html#a5df3f04b85aad6c1bb4243a39919be6d">create</a>();
<a name="l00247"></a>00247 
<a name="l00248"></a>00248 
<a name="l00252"></a>00252 
<a name="l00253"></a>00253   <span class="comment">// Validate common parts of schrodinger app param list: may move inside individual Problem class</span>
<a name="l00254"></a>00254   schro_appParams-&gt;validateParametersAndSetDefaults(*validAppParams,0);
<a name="l00255"></a>00255   schro_appParams-&gt;sublist(<span class="stringliteral">&quot;Problem&quot;</span>).sublist(<span class="stringliteral">&quot;Parameters&quot;</span>).validateParameters(*validParameterParams, 0);
<a name="l00256"></a>00256   schro_appParams-&gt;sublist(<span class="stringliteral">&quot;Problem&quot;</span>).sublist(<span class="stringliteral">&quot;Response Functions&quot;</span>).validateParameters(*validResponseParams, 0);
<a name="l00257"></a>00257   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0b1ebffc57924085d4c641415fca50a6">schrodingerApp</a> = Teuchos::rcp(<span class="keyword">new</span> <a class="code" href="classAlbany_1_1Application.html">Albany::Application</a>(comm, schro_appParams, Teuchos::null)); <span class="comment">//validates problem params</span>
<a name="l00258"></a>00258 
<a name="l00259"></a>00259   <span class="comment">// Create model evaluator</span>
<a name="l00260"></a>00260   <a class="code" href="classAlbany_1_1ModelFactory.html">Albany::ModelFactory</a> schrodingerModelFactory(schro_appParams, <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0b1ebffc57924085d4c641415fca50a6">schrodingerApp</a>);
<a name="l00261"></a>00261   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a90e1ff5d429b0b008dddad454d4801b1">schrodingerModel</a> = schrodingerModelFactory.<a class="code" href="classAlbany_1_1ModelFactory.html#a5df3f04b85aad6c1bb4243a39919be6d">create</a>();
<a name="l00262"></a>00262 
<a name="l00263"></a>00263   <span class="comment">//Save the discretization&#39;s maps for convenience (should be the same for Poisson and Schrodinger apps)</span>
<a name="l00264"></a>00264   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2cfd1cdbe58ce0b8e0d7fff094b468d2">disc_map</a> = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;getMap();
<a name="l00265"></a>00265   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a6d12f409329de2e065ddc70e56fb686a">disc_overlap_map</a> =  <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;getStateMgr().getDiscretization()-&gt;getOverlapMap();
<a name="l00266"></a>00266   
<a name="l00267"></a>00267   <span class="comment">//Create map for the entire coupled S-P application from the maps from the individual Poisson and Schrodinger applications</span>
<a name="l00268"></a>00268   <span class="comment">//  We need to create a map which is the product of 1 disc_map (for P), N disc_maps (for S&#39;s), +N extra (for norm. eqns)</span>
<a name="l00269"></a>00269   <span class="comment">//  in such a way that the elements for each disc_map are contiguous in index space (so that we can easily get Epetra vector views</span>
<a name="l00270"></a>00270   <span class="comment">//  to them separately)</span>
<a name="l00271"></a>00271   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a5894c6bfeb505219673300d50c7742de">combined_SP_map</a> = <a class="code" href="namespaceQCAD.html#ac8d8b92b5489b11d7175e8fb4f5845bc">QCAD::CreateCombinedMap</a>(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2cfd1cdbe58ce0b8e0d7fff094b468d2">disc_map</a>, 1+nEigenvals, nEigenvals, comm);
<a name="l00272"></a>00272 
<a name="l00273"></a>00273   <span class="comment">// Parameter vectors:  Parameter vectors of coupled PS model evaluator are just the parameter vectors</span>
<a name="l00274"></a>00274   <span class="comment">//   of the Poisson then Schrodinger model evaluators (in order).</span>
<a name="l00275"></a>00275 
<a name="l00276"></a>00276   <span class="comment">//Get the number of parameter vectors of the Poisson model evaluator</span>
<a name="l00277"></a>00277   EpetraExt::ModelEvaluator::InArgs poisson_inArgs = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ac344dcea687b3b287ccd29a9add35a62">poissonModel</a>-&gt;createInArgs();
<a name="l00278"></a>00278   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a> = poisson_inArgs.Np();
<a name="l00279"></a>00279 
<a name="l00280"></a>00280   <span class="comment">//Get the number of parameter vectors of the Schrodginer model evaluator</span>
<a name="l00281"></a>00281   EpetraExt::ModelEvaluator::InArgs schrodinger_inArgs = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a90e1ff5d429b0b008dddad454d4801b1">schrodingerModel</a>-&gt;createInArgs();
<a name="l00282"></a>00282   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ae234cf7c48060a76c3ed83f187120101">num_schrodinger_param_vecs</a> = schrodinger_inArgs.Np();
<a name="l00283"></a>00283 
<a name="l00284"></a>00284   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0699380cf33379fbee4e25d130dfa00a">num_param_vecs</a> = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a> + <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ae234cf7c48060a76c3ed83f187120101">num_schrodinger_param_vecs</a>;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286   <span class="comment">// Create sacado parameter vectors of appropriate size for use in evalModel</span>
<a name="l00287"></a>00287   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8ae4cd9fb6dd70e36740d430972c1ad4" title="Sacado parameter vectors.">poisson_sacado_param_vec</a>.resize(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>);
<a name="l00288"></a>00288   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a353b6a52985b107ee628e74c3323c5be">schrodinger_sacado_param_vec</a>.resize(num_schrodinger_param_vecs);
<a name="l00289"></a>00289 
<a name="l00290"></a>00290   <span class="comment">// Response vectors:  Response vectors of coupled PS model evaluator are just the response vectors</span>
<a name="l00291"></a>00291   <span class="comment">//   of the Poisson then Schrodinger model evaluators (in order).</span>
<a name="l00292"></a>00292   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a50533f369cae6236b09c5143609458b8">num_response_vecs</a> = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;getNumResponses() + <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0b1ebffc57924085d4c641415fca50a6">schrodingerApp</a>-&gt;getNumResponses();
<a name="l00293"></a>00293 
<a name="l00294"></a>00294 
<a name="l00295"></a>00295   <span class="comment">// Set member variables based on parameters from the main list</span>
<a name="l00296"></a>00296   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a24fb135e650bf09dd4c20a29411c017a">temperature</a> = Temp;
<a name="l00297"></a>00297   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#afc67da44792fdc3324d2d4a0905c7983">length_unit_in_m</a>  = lenUnit;
<a name="l00298"></a>00298   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a7088522e5f3c6d7b9ac66fa9aaddc08b">energy_unit_in_eV</a> = energyUnit;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 
<a name="l00301"></a>00301   <span class="comment">// Get conduction band offset from reference level (solution to poisson problem), as this</span>
<a name="l00302"></a>00302   <span class="comment">//   is needed to convert the poisson solution vector to conduction band values expected by the schrodinger problem</span>
<a name="l00303"></a>00303 
<a name="l00304"></a>00304     <span class="comment">// Material database</span>
<a name="l00305"></a>00305   std::string mtrlDbFilename = <span class="stringliteral">&quot;materials.xml&quot;</span>;
<a name="l00306"></a>00306   <span class="keywordflow">if</span>(problemParams.isType&lt;std::string&gt;(<span class="stringliteral">&quot;MaterialDB Filename&quot;</span>))
<a name="l00307"></a>00307     mtrlDbFilename = problemParams.get&lt;std::string&gt;(<span class="stringliteral">&quot;MaterialDB Filename&quot;</span>);
<a name="l00308"></a>00308   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a4826f330a5db96e2865dad8f99ea59a9" title="Material database.">materialDB</a> = Teuchos::rcp(<span class="keyword">new</span> <a class="code" href="classQCAD_1_1MaterialDatabase.html" title="Centralized collection of material parameters.">QCAD::MaterialDatabase</a>(mtrlDbFilename, comm));
<a name="l00309"></a>00309   
<a name="l00310"></a>00310   std::string refMtrlName = materialDB-&gt;getParam&lt;std::string&gt;(<span class="stringliteral">&quot;Reference Material&quot;</span>);
<a name="l00311"></a>00311   <span class="keywordtype">double</span> refmatChi = materialDB-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Electron Affinity&quot;</span>);
<a name="l00312"></a>00312 
<a name="l00313"></a>00313   <span class="comment">// compute energy reference</span>
<a name="l00314"></a>00314   <span class="keywordtype">double</span> qPhiRef;
<a name="l00315"></a>00315   {
<a name="l00316"></a>00316     <span class="keyword">const</span> <span class="keywordtype">double</span> kB = 8.617332e-5;  <span class="comment">// eV/K</span>
<a name="l00317"></a>00317     std::string category = materialDB-&gt;getMaterialParam&lt;std::string&gt;(refMtrlName,<span class="stringliteral">&quot;Category&quot;</span>);
<a name="l00318"></a>00318     <span class="keywordflow">if</span> (category == <span class="stringliteral">&quot;Semiconductor&quot;</span>) 
<a name="l00319"></a>00319     {
<a name="l00320"></a>00320       <span class="comment">// Same qPhiRef needs to be used for the entire structure</span>
<a name="l00321"></a>00321       <span class="keywordtype">double</span> mdn = materialDB-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Electron DOS Effective Mass&quot;</span>);
<a name="l00322"></a>00322       <span class="keywordtype">double</span> mdp = materialDB-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Hole DOS Effective Mass&quot;</span>);
<a name="l00323"></a>00323       <span class="keywordtype">double</span> Chi = materialDB-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Electron Affinity&quot;</span>);
<a name="l00324"></a>00324       <span class="keywordtype">double</span> Eg0 = materialDB-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Zero Temperature Band Gap&quot;</span>);
<a name="l00325"></a>00325       <span class="keywordtype">double</span> <a class="code" href="namespaceFELIX.html#a4d08741b97fea3938089670d2a84c598">alpha</a> = materialDB-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Band Gap Alpha Coefficient&quot;</span>);
<a name="l00326"></a>00326       <span class="keywordtype">double</span> beta = materialDB-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Band Gap Beta Coefficient&quot;</span>);
<a name="l00327"></a>00327       
<a name="l00328"></a>00328       <span class="keywordtype">double</span> Eg = Eg0 - alpha*pow(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a24fb135e650bf09dd4c20a29411c017a">temperature</a>,2.0)/(beta+<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a24fb135e650bf09dd4c20a29411c017a">temperature</a>); <span class="comment">// in [eV]</span>
<a name="l00329"></a>00329       <span class="keywordtype">double</span> kbT = kB * <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a24fb135e650bf09dd4c20a29411c017a">temperature</a>;      <span class="comment">// in [eV]</span>
<a name="l00330"></a>00330       <span class="keywordtype">double</span> Eic = -Eg/2. + 3./4.*kbT*log(mdp/mdn);  <span class="comment">// (Ei-Ec) in [eV]</span>
<a name="l00331"></a>00331       qPhiRef = Chi - Eic;  <span class="comment">// (Evac-Ei) in [eV] where Evac = vacuum level</span>
<a name="l00332"></a>00332     }
<a name="l00333"></a>00333     <span class="keywordflow">else</span> 
<a name="l00334"></a>00334       TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter, std::endl 
<a name="l00335"></a>00335         &lt;&lt; <span class="stringliteral">&quot;Error!  Invalid category &quot;</span> &lt;&lt; category &lt;&lt; <span class="stringliteral">&quot; for reference material !&quot;</span> &lt;&lt; std::endl);
<a name="l00336"></a>00336   } 
<a name="l00337"></a>00337 
<a name="l00338"></a>00338   <span class="comment">// NOTE: this works for element blocks of the reference material, but really needs to have refmatChi replaced by the</span>
<a name="l00339"></a>00339   <span class="comment">//     chi (electron affinity) for the element block that owns each node...</span>
<a name="l00340"></a>00340   this-&gt;<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0f545418c853536bcb4adb5cb4df9a76">offset_to_CB</a> = qPhiRef - refmatChi; <span class="comment">// Conduction Band = offset - poisson_solution</span>
<a name="l00341"></a>00341 
<a name="l00342"></a>00342 
<a name="l00343"></a>00343   <span class="comment">// Add discretization parameters to appParams to describe to discretization object how to </span>
<a name="l00344"></a>00344   <span class="comment">//   interpret the &quot;combined&quot; solution vector used by the coupled P-S solver.</span>
<a name="l00345"></a>00345   std::vector&lt;std::string&gt; solnVecComps( 2*(1+nEigenvals) ), residVecComps( 2*(1+nEigenvals) );
<a name="l00346"></a>00346   
<a name="l00347"></a>00347   solnVecComps[0] = <span class="stringliteral">&quot;solution&quot;</span>; solnVecComps[1] = <span class="stringliteral">&quot;S&quot;</span>; <span class="comment">//was &quot;Potential&quot; but keep as &quot;solution&quot; for backward compatibility</span>
<a name="l00348"></a>00348   residVecComps[0] = <span class="stringliteral">&quot;PoissonRes&quot;</span>; residVecComps[1] = <span class="stringliteral">&quot;S&quot;</span>;
<a name="l00349"></a>00349   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;nEigenvals; i++) {
<a name="l00350"></a>00350     std::ostringstream ss1; ss1 &lt;&lt; <span class="stringliteral">&quot;Eigenvector&quot;</span> &lt;&lt; i;
<a name="l00351"></a>00351     solnVecComps[ 2*(i+1) ] = ss1.str(); solnVecComps[ 2*(i+1)+1 ] = <span class="stringliteral">&quot;S&quot;</span>;
<a name="l00352"></a>00352     std::ostringstream ss2; ss2 &lt;&lt; <span class="stringliteral">&quot;SchroRes&quot;</span> &lt;&lt; i;
<a name="l00353"></a>00353     residVecComps[ 2*(i+1) ] = ss2.str(); ; residVecComps[ 2*(i+1)+1 ] = <span class="stringliteral">&quot;S&quot;</span>;
<a name="l00354"></a>00354   }
<a name="l00355"></a>00355   
<a name="l00356"></a>00356   discList.set(<span class="stringliteral">&quot;Solution Vector Components&quot;</span>, Teuchos::Array&lt;std::string&gt;(solnVecComps));
<a name="l00357"></a>00357   discList.set(<span class="stringliteral">&quot;Residual Vector Components&quot;</span>, Teuchos::Array&lt;std::string&gt;(residVecComps));
<a name="l00358"></a>00358   discList.set(<span class="stringliteral">&quot;Interleaved Ordering&quot;</span>, <span class="keyword">false</span>); <span class="comment">//combined vector is concatenated, not &quot;interleaved&quot;</span>
<a name="l00359"></a>00359 
<a name="l00360"></a>00360   <span class="comment">/* -- Example XML this would generate --</span>
<a name="l00361"></a>00361 <span class="comment">     &lt;Parameter name=&quot;Solution Vector Components&quot; type=&quot;Array(string)&quot; value=&quot;{Potential, S, Eigenvector0, S, Eigenvector1, S}&quot;/&gt;</span>
<a name="l00362"></a>00362 <span class="comment">     &lt;Parameter name=&quot;Residual Vector Components&quot; type=&quot;Array(string)&quot; value=&quot;{PoissonRes, S, SchroRes0, S, SchroRes1, S}&quot;/&gt;</span>
<a name="l00363"></a>00363 <span class="comment">     &lt;Parameter name=&quot;Interleaved Ordering&quot; type=&quot;bool&quot; value=&quot;false&quot;/&gt;</span>
<a name="l00364"></a>00364 <span class="comment">  */</span>
<a name="l00365"></a>00365 
<a name="l00366"></a>00366   <span class="comment">// Create discretization object solely for producing collected output</span>
<a name="l00367"></a>00367   <a class="code" href="classAlbany_1_1DiscretizationFactory.html" title="A factory class to instantiate AbstractDiscretization objects.">Albany::DiscretizationFactory</a> discFactory(appParams, comm);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369   <span class="comment">// Get mesh specification object: worksetSize, cell topology, etc</span>
<a name="l00370"></a>00370   Teuchos::ArrayRCP&lt;Teuchos::RCP&lt;Albany::MeshSpecsStruct&gt; &gt; meshSpecs =
<a name="l00371"></a>00371     discFactory.<a class="code" href="classAlbany_1_1DiscretizationFactory.html#a054bb3b44c6cd53344dbb4593aa3b455">createMeshSpecs</a>();
<a name="l00372"></a>00372 
<a name="l00373"></a>00373   <a class="code" href="classAlbany_1_1AbstractFieldContainer.html#a2bfe39ada257455a2bbe082a0b743704">Albany::AbstractFieldContainer::FieldContainerRequirements</a> requirements; <span class="comment">//empty?</span>
<a name="l00374"></a>00374   Teuchos::RCP&lt;Albany::StateInfoStruct&gt; stateInfo = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;getStateMgr().getStateInfoStruct(); <span class="comment">//for now, just use Poisson app&#39;s states</span>
<a name="l00375"></a>00375                             <span class="comment">//Teuchos::rcp(new Albany::StateInfoStruct); //empty</span>
<a name="l00376"></a>00376 
<a name="l00377"></a>00377   <span class="keywordtype">int</span> neq = 1+nEigenvals; <span class="comment">// number of mesh-equations</span>
<a name="l00378"></a>00378   Teuchos::RCP&lt;Piro::MLRigidBodyModes&gt; rigidBodyModes(Teuchos::rcp(<span class="keyword">new</span> Piro::MLRigidBodyModes(neq)));
<a name="l00379"></a>00379   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a4dd637dbdc64dfb203de29e90cced79e" title="Element discretization (just for collected exodus output).">disc</a> = discFactory.<a class="code" href="classAlbany_1_1DiscretizationFactory.html#a8c22d16bf0b69409ef9bf15e97a45aa8">createDiscretization</a>(neq, stateInfo,requirements,rigidBodyModes);
<a name="l00380"></a>00380 
<a name="l00381"></a>00381   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a7ff0cfa9b31d4960b80e14a94abfe6eb">myComm</a> = comm;
<a name="l00382"></a>00382 }
<a name="l00383"></a>00383 
<a name="l00384"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ab52c4258baccbfeb6436c7eda5db4d44">00384</a> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ab52c4258baccbfeb6436c7eda5db4d44">QCAD::CoupledPoissonSchrodinger::~CoupledPoissonSchrodinger</a>()
<a name="l00385"></a>00385 {
<a name="l00386"></a>00386 }
<a name="l00387"></a>00387 
<a name="l00388"></a>00388 
<a name="l00389"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ae12ca71dc9505dc0e14b7f38555a7661">00389</a> Teuchos::RCP&lt;const Epetra_Map&gt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ae12ca71dc9505dc0e14b7f38555a7661">QCAD::CoupledPoissonSchrodinger::get_x_map</a>()<span class="keyword"> const</span>
<a name="l00390"></a>00390 <span class="keyword"></span>{
<a name="l00391"></a>00391   <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a5894c6bfeb505219673300d50c7742de">combined_SP_map</a>;
<a name="l00392"></a>00392 }
<a name="l00393"></a>00393 
<a name="l00394"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0e35b3b633b05aff268dbba99395abed">00394</a> Teuchos::RCP&lt;const Epetra_Map&gt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0e35b3b633b05aff268dbba99395abed">QCAD::CoupledPoissonSchrodinger::get_f_map</a>()<span class="keyword"> const</span>
<a name="l00395"></a>00395 <span class="keyword"></span>{
<a name="l00396"></a>00396   <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a5894c6bfeb505219673300d50c7742de">combined_SP_map</a>;
<a name="l00397"></a>00397 }
<a name="l00398"></a>00398 
<a name="l00399"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a3d5a649e613b7798437ca97e3c4991c9">00399</a> Teuchos::RCP&lt;const Epetra_Map&gt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a3d5a649e613b7798437ca97e3c4991c9">QCAD::CoupledPoissonSchrodinger::get_p_map</a>(<span class="keywordtype">int</span> l)<span class="keyword"> const</span>
<a name="l00400"></a>00400 <span class="keyword"></span>{
<a name="l00401"></a>00401   TEUCHOS_TEST_FOR_EXCEPTION(l &gt;= <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0699380cf33379fbee4e25d130dfa00a">num_param_vecs</a> || l &lt; 0, Teuchos::Exceptions::InvalidParameter,
<a name="l00402"></a>00402                      std::endl &lt;&lt;
<a name="l00403"></a>00403                      <span class="stringliteral">&quot;Error in QCAD::CoupledPoissonSchrodinger::get_p_map():  &quot;</span> &lt;&lt;
<a name="l00404"></a>00404                      <span class="stringliteral">&quot;Invalid parameter index l = &quot;</span> &lt;&lt; l &lt;&lt; std::endl);
<a name="l00405"></a>00405   <span class="keywordflow">if</span>(l &lt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>)
<a name="l00406"></a>00406     <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ac344dcea687b3b287ccd29a9add35a62">poissonModel</a>-&gt;get_p_map(l);
<a name="l00407"></a>00407   <span class="keywordflow">else</span>
<a name="l00408"></a>00408     <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a90e1ff5d429b0b008dddad454d4801b1">schrodingerModel</a>-&gt;get_p_map(l - <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>);
<a name="l00409"></a>00409 }
<a name="l00410"></a>00410 
<a name="l00411"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#adcee5c12c7119da512ea7b3b11c5b46a">00411</a> Teuchos::RCP&lt;const Epetra_Map&gt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#adcee5c12c7119da512ea7b3b11c5b46a">QCAD::CoupledPoissonSchrodinger::get_g_map</a>(<span class="keywordtype">int</span> j)<span class="keyword"> const</span>
<a name="l00412"></a>00412 <span class="keyword"></span>{
<a name="l00413"></a>00413   TEUCHOS_TEST_FOR_EXCEPTION(j &gt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a50533f369cae6236b09c5143609458b8">num_response_vecs</a> || j &lt; 0, Teuchos::Exceptions::InvalidParameter,
<a name="l00414"></a>00414                      std::endl &lt;&lt;
<a name="l00415"></a>00415                      <span class="stringliteral">&quot;Error in QCAD::CoupledPoissonSchrodinger::get_g_map():  &quot;</span> &lt;&lt;
<a name="l00416"></a>00416                      <span class="stringliteral">&quot;Invalid response index j = &quot;</span> &lt;&lt; j &lt;&lt; std::endl);
<a name="l00417"></a>00417   
<a name="l00418"></a>00418   <span class="keywordflow">if</span>(j &lt; poissonApp-&gt;getNumResponses())
<a name="l00419"></a>00419     <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ac344dcea687b3b287ccd29a9add35a62">poissonModel</a>-&gt;get_g_map(j);
<a name="l00420"></a>00420   <span class="keywordflow">else</span>
<a name="l00421"></a>00421     <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a90e1ff5d429b0b008dddad454d4801b1">schrodingerModel</a>-&gt;get_g_map(j - <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;getNumResponses());
<a name="l00422"></a>00422 }
<a name="l00423"></a>00423 
<a name="l00424"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a6e222919752670b57b209ff2e9b56287">00424</a> Teuchos::RCP&lt;const Teuchos::Array&lt;std::string&gt; &gt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a6e222919752670b57b209ff2e9b56287">QCAD::CoupledPoissonSchrodinger::get_p_names</a>(<span class="keywordtype">int</span> l)<span class="keyword"> const</span>
<a name="l00425"></a>00425 <span class="keyword"></span>{
<a name="l00426"></a>00426   TEUCHOS_TEST_FOR_EXCEPTION(l &gt;= <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0699380cf33379fbee4e25d130dfa00a">num_param_vecs</a> || l &lt; 0, 
<a name="l00427"></a>00427          Teuchos::Exceptions::InvalidParameter,
<a name="l00428"></a>00428                      std::endl &lt;&lt; 
<a name="l00429"></a>00429                      <span class="stringliteral">&quot;Error!  Albany::ModelEvaluator::get_p_names():  &quot;</span> &lt;&lt;
<a name="l00430"></a>00430                      <span class="stringliteral">&quot;Invalid parameter index l = &quot;</span> &lt;&lt; l &lt;&lt; std::endl);
<a name="l00431"></a>00431   <span class="keywordflow">if</span>(l &lt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>)
<a name="l00432"></a>00432     <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ac344dcea687b3b287ccd29a9add35a62">poissonModel</a>-&gt;get_p_names(l);
<a name="l00433"></a>00433   <span class="keywordflow">else</span>
<a name="l00434"></a>00434     <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a90e1ff5d429b0b008dddad454d4801b1">schrodingerModel</a>-&gt;get_p_names(l - <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>);
<a name="l00435"></a>00435 }
<a name="l00436"></a>00436 
<a name="l00437"></a>00437 
<a name="l00438"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a3f797e20d6b7a55d25fca9c5708b4324">00438</a> Teuchos::RCP&lt;const Epetra_Vector&gt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a3f797e20d6b7a55d25fca9c5708b4324">QCAD::CoupledPoissonSchrodinger::get_x_init</a>()<span class="keyword"> const</span>
<a name="l00439"></a>00439 <span class="keyword"></span>{
<a name="l00440"></a>00440   <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a157106f86a128a573e8010008c9634f7">saved_initial_guess</a> != Teuchos::null) {
<a name="l00441"></a>00441     std::cout &lt;&lt; <span class="stringliteral">&quot;DEBUG CPS: returning saved initial guess!&quot;</span> &lt;&lt; std::endl;
<a name="l00442"></a>00442     <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a157106f86a128a573e8010008c9634f7">saved_initial_guess</a>;
<a name="l00443"></a>00443   }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445   <span class="comment">//Put together x_init&#39;s from Poisson and Schrodinger for now (but does this make sense for eigenvectors?) -- TODO: discuss</span>
<a name="l00446"></a>00446   Teuchos::RCP&lt;const Epetra_Vector&gt; poisson_x_init = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ac344dcea687b3b287ccd29a9add35a62">poissonModel</a>-&gt;get_x_init(); <span class="comment">// should have disc_map</span>
<a name="l00447"></a>00447   Teuchos::RCP&lt;const Epetra_Vector&gt; schrodinger_x_init = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a90e1ff5d429b0b008dddad454d4801b1">schrodingerModel</a>-&gt;get_x_init(); <span class="comment">// should have disc_map</span>
<a name="l00448"></a>00448   
<a name="l00449"></a>00449   Teuchos::RCP&lt;Epetra_Vector&gt; x_init = Teuchos::rcp(<span class="keyword">new</span> Epetra_Vector(*<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a5894c6bfeb505219673300d50c7742de">combined_SP_map</a>));
<a name="l00450"></a>00450   Teuchos::RCP&lt;Epetra_Vector&gt; x_init_poisson;
<a name="l00451"></a>00451   Teuchos::RCP&lt;Epetra_MultiVector&gt; x_init_schrodinger;
<a name="l00452"></a>00452 
<a name="l00453"></a>00453   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8627ebdfea8acd03664adba3e601d7ba">separateCombinedVector</a>(x_init, x_init_poisson, x_init_schrodinger);
<a name="l00454"></a>00454 
<a name="l00455"></a>00455   std::vector&lt;int&gt; localInds( poisson_x_init-&gt;MyLength() );
<a name="l00456"></a>00456   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i &lt; poisson_x_init-&gt;MyLength(); i++) localInds[i] = i;
<a name="l00457"></a>00457 
<a name="l00458"></a>00458   x_init_poisson-&gt;ReplaceMyValues( poisson_x_init-&gt;MyLength(), &amp;(*poisson_x_init)[0], &amp;localInds[0] );
<a name="l00459"></a>00459   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k &lt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>; k++)
<a name="l00460"></a>00460     (*x_init_schrodinger)(k)-&gt;ReplaceMyValues( schrodinger_x_init-&gt;MyLength(), &amp;(*schrodinger_x_init)[0], &amp;localInds[0] ); <span class="comment">//localInds are the same</span>
<a name="l00461"></a>00461   
<a name="l00462"></a>00462   <span class="keywordflow">return</span> x_init;
<a name="l00463"></a>00463 }
<a name="l00464"></a>00464 
<a name="l00465"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#af4f9220be701787bc80c8ecacf05a93b">00465</a> Teuchos::RCP&lt;const Epetra_Vector&gt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#af4f9220be701787bc80c8ecacf05a93b">QCAD::CoupledPoissonSchrodinger::get_x_dot_init</a>()<span class="keyword"> const</span>
<a name="l00466"></a>00466 <span class="keyword"></span>{
<a name="l00467"></a>00467   <span class="comment">//Put together x_dot_init&#39;s from Poisson and Schrodinger for now (but does this make sense for eigenvectors?) -- TODO: discuss</span>
<a name="l00468"></a>00468   Teuchos::RCP&lt;const Epetra_Vector&gt; poisson_x_dot_init = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ac344dcea687b3b287ccd29a9add35a62">poissonModel</a>-&gt;get_x_dot_init(); <span class="comment">// should have disc_map</span>
<a name="l00469"></a>00469   Teuchos::RCP&lt;const Epetra_Vector&gt; schrodinger_x_dot_init = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a90e1ff5d429b0b008dddad454d4801b1">schrodingerModel</a>-&gt;get_x_dot_init(); <span class="comment">// should have disc_map</span>
<a name="l00470"></a>00470   
<a name="l00471"></a>00471   Teuchos::RCP&lt;Epetra_Vector&gt; x_dot_init = Teuchos::rcp(<span class="keyword">new</span> Epetra_Vector(*<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a5894c6bfeb505219673300d50c7742de">combined_SP_map</a>));
<a name="l00472"></a>00472   Teuchos::RCP&lt;Epetra_Vector&gt; x_dot_init_poisson;
<a name="l00473"></a>00473   Teuchos::RCP&lt;Epetra_MultiVector&gt; x_dot_init_schrodinger;
<a name="l00474"></a>00474 
<a name="l00475"></a>00475   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8627ebdfea8acd03664adba3e601d7ba">separateCombinedVector</a>(x_dot_init, x_dot_init_poisson, x_dot_init_schrodinger);
<a name="l00476"></a>00476 
<a name="l00477"></a>00477   std::vector&lt;int&gt; localInds( poisson_x_dot_init-&gt;MyLength() );
<a name="l00478"></a>00478   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i &lt; poisson_x_dot_init-&gt;MyLength(); i++) localInds[i] = i;
<a name="l00479"></a>00479 
<a name="l00480"></a>00480   x_dot_init_poisson-&gt;ReplaceMyValues( poisson_x_dot_init-&gt;MyLength(), &amp;(*poisson_x_dot_init)[0], &amp;localInds[0] );
<a name="l00481"></a>00481   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k &lt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>; k++)
<a name="l00482"></a>00482     (*x_dot_init_schrodinger)(k)-&gt;ReplaceMyValues( schrodinger_x_dot_init-&gt;MyLength(), &amp;(*schrodinger_x_dot_init)[0], &amp;localInds[0] ); <span class="comment">//same localInds are the same</span>
<a name="l00483"></a>00483   
<a name="l00484"></a>00484   <span class="comment">//Teuchos::RCP&lt;const Epetra_Vector&gt; const_x_dot_init = Teuchos::rcp(new const Epetra_Vector(*x_dot_init));</span>
<a name="l00485"></a>00485   <span class="keywordflow">return</span> x_dot_init;
<a name="l00486"></a>00486 }
<a name="l00487"></a>00487 
<a name="l00488"></a>00488 
<a name="l00489"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a89a4186741602027e60befb57d1c840f">00489</a> Teuchos::RCP&lt;const Epetra_Vector&gt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a89a4186741602027e60befb57d1c840f">QCAD::CoupledPoissonSchrodinger::get_p_init</a>(<span class="keywordtype">int</span> l)<span class="keyword"> const</span>
<a name="l00490"></a>00490 <span class="keyword"></span>{
<a name="l00491"></a>00491   TEUCHOS_TEST_FOR_EXCEPTION(l &gt;= <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0699380cf33379fbee4e25d130dfa00a">num_param_vecs</a> || l &lt; 0, Teuchos::Exceptions::InvalidParameter,
<a name="l00492"></a>00492                      std::endl &lt;&lt;
<a name="l00493"></a>00493                      <span class="stringliteral">&quot;Error in QCAD::CoupledPoissonSchrodinger::get_p_init():  &quot;</span> &lt;&lt;
<a name="l00494"></a>00494                      <span class="stringliteral">&quot;Invalid parameter index l = &quot;</span> &lt;&lt; l &lt;&lt; std::endl);
<a name="l00495"></a>00495 
<a name="l00496"></a>00496   <span class="keywordflow">if</span>(l &lt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>)
<a name="l00497"></a>00497     <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ac344dcea687b3b287ccd29a9add35a62">poissonModel</a>-&gt;get_p_init(l);
<a name="l00498"></a>00498   <span class="keywordflow">else</span>
<a name="l00499"></a>00499     <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a90e1ff5d429b0b008dddad454d4801b1">schrodingerModel</a>-&gt;get_p_init(l - <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>);
<a name="l00500"></a>00500 }
<a name="l00501"></a>00501 
<a name="l00502"></a>00502 
<a name="l00503"></a>00503 Teuchos::RCP&lt;Epetra_Operator&gt;
<a name="l00504"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ae7d4b500932b66fb2fbf508816fe0bbd">00504</a> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ae7d4b500932b66fb2fbf508816fe0bbd">QCAD::CoupledPoissonSchrodinger::create_W</a>()<span class="keyword"> const</span>
<a name="l00505"></a>00505 <span class="keyword"></span>{
<a name="l00506"></a>00506   <span class="comment">// Get material parameters for quantum region, used in computing quantum density</span>
<a name="l00507"></a>00507   std::string quantumMtrlName = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a4826f330a5db96e2865dad8f99ea59a9" title="Material database.">materialDB</a>-&gt;getParam&lt;std::string&gt;(<span class="stringliteral">&quot;Quantum Material&quot;</span>);
<a name="l00508"></a>00508   <span class="keywordtype">int</span> valleyDegeneracyFactor = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a4826f330a5db96e2865dad8f99ea59a9" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">int</span>&gt;(quantumMtrlName,<span class="stringliteral">&quot;Number of conduction band min&quot;</span>,2);
<a name="l00509"></a>00509   <span class="keywordtype">double</span> effMass = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a4826f330a5db96e2865dad8f99ea59a9" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(quantumMtrlName,<span class="stringliteral">&quot;Transverse Electron Effective Mass&quot;</span>);
<a name="l00510"></a>00510 
<a name="l00511"></a>00511   std::cout &lt;&lt; <span class="stringliteral">&quot;DEBUG:  CPS create_W called!!&quot;</span> &lt;&lt; std::endl;
<a name="l00512"></a>00512   <span class="keywordflow">return</span> Teuchos::rcp( <span class="keyword">new</span> <a class="code" href="classQCAD_1_1CoupledPSJacobian.html" title="An Epetra operator that evaluates the Jacobian of a QCAD coupled Poisson-Schrodinger problem...">QCAD::CoupledPSJacobian</a>(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>, <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2cfd1cdbe58ce0b8e0d7fff094b468d2">disc_map</a>, <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a5894c6bfeb505219673300d50c7742de">combined_SP_map</a>, <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a7ff0cfa9b31d4960b80e14a94abfe6eb">myComm</a>, 
<a name="l00513"></a>00513                <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a24b90c4101bde7d44b03c719ef2a9b4e" title="Miscellaneous.">numDims</a>, valleyDegeneracyFactor, <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a24fb135e650bf09dd4c20a29411c017a">temperature</a>,
<a name="l00514"></a>00514                <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#afc67da44792fdc3324d2d4a0905c7983">length_unit_in_m</a>, <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a7088522e5f3c6d7b9ac66fa9aaddc08b">energy_unit_in_eV</a>, effMass, <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0f545418c853536bcb4adb5cb4df9a76">offset_to_CB</a>) );
<a name="l00515"></a>00515 }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517 Teuchos::RCP&lt;EpetraExt::ModelEvaluator::Preconditioner&gt;
<a name="l00518"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a43b2b578cd0c1123011d15f7cf855cd8">00518</a> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a43b2b578cd0c1123011d15f7cf855cd8">QCAD::CoupledPoissonSchrodinger::create_WPrec</a>()<span class="keyword"> const</span>
<a name="l00519"></a>00519 <span class="keyword"></span>{
<a name="l00520"></a>00520   <span class="comment">//std::cout &lt;&lt; &quot;DEBUG:  CPS create_WPrec called!!&quot; &lt;&lt; std::endl;</span>
<a name="l00521"></a>00521   Teuchos::RCP&lt;Epetra_Operator&gt; precOp = Teuchos::rcp( <span class="keyword">new</span> <a class="code" href="classQCAD_1_1CoupledPSPreconditioner.html" title="An Epetra operator that evaluates the Jacobian of a QCAD coupled Poisson-Schrodinger problem...">QCAD::CoupledPSPreconditioner</a>(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>, <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2cfd1cdbe58ce0b8e0d7fff094b468d2">disc_map</a>, <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a5894c6bfeb505219673300d50c7742de">combined_SP_map</a>, <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a7ff0cfa9b31d4960b80e14a94abfe6eb">myComm</a>) );
<a name="l00522"></a>00522 
<a name="l00523"></a>00523   <span class="comment">// bool is answer to: &quot;Prec is already inverted?&quot;</span>
<a name="l00524"></a>00524   <span class="keywordflow">return</span> Teuchos::rcp(<span class="keyword">new</span> EpetraExt::ModelEvaluator::Preconditioner(precOp,<span class="keyword">true</span>));
<a name="l00525"></a>00525 }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527 Teuchos::RCP&lt;Epetra_Operator&gt;
<a name="l00528"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ab15d71a4d79d1431f05b168f313b108f">00528</a> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ab15d71a4d79d1431f05b168f313b108f">QCAD::CoupledPoissonSchrodinger::create_DgDx_op</a>(<span class="keywordtype">int</span> j)<span class="keyword"> const</span>
<a name="l00529"></a>00529 <span class="keyword"></span>{
<a name="l00530"></a>00530   TEUCHOS_TEST_FOR_EXCEPTION(
<a name="l00531"></a>00531     j &gt;= <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a50533f369cae6236b09c5143609458b8">num_response_vecs</a> || j &lt; 0, 
<a name="l00532"></a>00532     Teuchos::Exceptions::InvalidParameter,
<a name="l00533"></a>00533     std::endl &lt;&lt; 
<a name="l00534"></a>00534     <span class="stringliteral">&quot;Error!  Albany::ModelEvaluator::create_DgDx_op():  &quot;</span> &lt;&lt; 
<a name="l00535"></a>00535     <span class="stringliteral">&quot;Invalid response index j = &quot;</span> &lt;&lt; j &lt;&lt; std::endl);
<a name="l00536"></a>00536   
<a name="l00537"></a>00537   <span class="keywordflow">if</span>(j &lt; poissonApp-&gt;getNumResponses())
<a name="l00538"></a>00538     <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;getResponse(j)-&gt;createGradientOp();
<a name="l00539"></a>00539   <span class="keywordflow">else</span>
<a name="l00540"></a>00540     <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0b1ebffc57924085d4c641415fca50a6">schrodingerApp</a>-&gt;getResponse(j - <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;getNumResponses())-&gt;createGradientOp();
<a name="l00541"></a>00541 }
<a name="l00542"></a>00542 
<a name="l00543"></a>00543 Teuchos::RCP&lt;Epetra_Operator&gt;
<a name="l00544"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2aa3a9ba2e8222d3ae0bd9dcca399102">00544</a> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2aa3a9ba2e8222d3ae0bd9dcca399102">QCAD::CoupledPoissonSchrodinger::create_DgDx_dot_op</a>(<span class="keywordtype">int</span> j)<span class="keyword"> const</span>
<a name="l00545"></a>00545 <span class="keyword"></span>{
<a name="l00546"></a>00546   TEUCHOS_TEST_FOR_EXCEPTION(
<a name="l00547"></a>00547     j &gt;= <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a50533f369cae6236b09c5143609458b8">num_response_vecs</a> || j &lt; 0, 
<a name="l00548"></a>00548     Teuchos::Exceptions::InvalidParameter,
<a name="l00549"></a>00549     std::endl &lt;&lt; 
<a name="l00550"></a>00550     <span class="stringliteral">&quot;Error!  Albany::ModelEvaluator::create_DgDx_dot_op():  &quot;</span> &lt;&lt; 
<a name="l00551"></a>00551     <span class="stringliteral">&quot;Invalid response index j = &quot;</span> &lt;&lt; j &lt;&lt; std::endl);
<a name="l00552"></a>00552   
<a name="l00553"></a>00553   <span class="keywordflow">if</span>(j &lt; poissonApp-&gt;getNumResponses())
<a name="l00554"></a>00554     <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;getResponse(j)-&gt;createGradientOp();
<a name="l00555"></a>00555   <span class="keywordflow">else</span>
<a name="l00556"></a>00556     <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0b1ebffc57924085d4c641415fca50a6">schrodingerApp</a>-&gt;getResponse(j - <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;getNumResponses())-&gt;createGradientOp();
<a name="l00557"></a>00557 }
<a name="l00558"></a>00558 
<a name="l00559"></a>00559 
<a name="l00560"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a166c9ec15c42bcc8b42d8526eebf86d2">00560</a> EpetraExt::ModelEvaluator::InArgs <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a166c9ec15c42bcc8b42d8526eebf86d2">QCAD::CoupledPoissonSchrodinger::createInArgs</a>()<span class="keyword"> const</span>
<a name="l00561"></a>00561 <span class="keyword"></span>{
<a name="l00562"></a>00562   InArgsSetup inArgs;
<a name="l00563"></a>00563   inArgs.setModelEvalDescription(<span class="stringliteral">&quot;QCAD Coupled Poisson-Schrodinger Model Evaluator&quot;</span>);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565   inArgs.setSupports(IN_ARG_t,<span class="keyword">true</span>);
<a name="l00566"></a>00566   inArgs.setSupports(IN_ARG_x,<span class="keyword">true</span>);
<a name="l00567"></a>00567   inArgs.setSupports(IN_ARG_x_dot,<span class="keyword">true</span>);
<a name="l00568"></a>00568   inArgs.setSupports(IN_ARG_alpha,<span class="keyword">true</span>);
<a name="l00569"></a>00569   inArgs.setSupports(IN_ARG_beta,<span class="keyword">true</span>);
<a name="l00570"></a>00570   inArgs.set_Np(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0699380cf33379fbee4e25d130dfa00a">num_param_vecs</a>);
<a name="l00571"></a>00571 
<a name="l00572"></a>00572   <span class="comment">// Note: no SG support yet...</span>
<a name="l00573"></a>00573 
<a name="l00574"></a>00574   <span class="keywordflow">return</span> inArgs;
<a name="l00575"></a>00575 }
<a name="l00576"></a>00576 
<a name="l00577"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a66a7673eee6fa01154037407623e2922">00577</a> EpetraExt::ModelEvaluator::OutArgs <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a66a7673eee6fa01154037407623e2922">QCAD::CoupledPoissonSchrodinger::createOutArgs</a>()<span class="keyword"> const</span>
<a name="l00578"></a>00578 <span class="keyword"></span>{
<a name="l00579"></a>00579   OutArgsSetup outArgs;
<a name="l00580"></a>00580   outArgs.setModelEvalDescription(<span class="stringliteral">&quot;QCAD Coupled Poisson-Schrodinger Model Evaluator&quot;</span>);
<a name="l00581"></a>00581 
<a name="l00582"></a>00582   <span class="keywordtype">int</span> n_g = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a50533f369cae6236b09c5143609458b8">num_response_vecs</a>;
<a name="l00583"></a>00583   <span class="keywordtype">bool</span> bScalarResponse;
<a name="l00584"></a>00584 
<a name="l00585"></a>00585   <span class="comment">// Deterministic</span>
<a name="l00586"></a>00586   outArgs.setSupports(OUT_ARG_f,<span class="keyword">true</span>);
<a name="l00587"></a>00587   outArgs.setSupports(OUT_ARG_W,<span class="keyword">true</span>);
<a name="l00588"></a>00588   outArgs.set_W_properties(
<a name="l00589"></a>00589     DerivativeProperties(DERIV_LINEARITY_UNKNOWN, DERIV_RANK_FULL, <span class="keyword">true</span>));
<a name="l00590"></a>00590   outArgs.setSupports(OUT_ARG_WPrec, <span class="keyword">true</span>);
<a name="l00591"></a>00591   outArgs.set_Np_Ng(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0699380cf33379fbee4e25d130dfa00a">num_param_vecs</a>, n_g);
<a name="l00592"></a>00592 
<a name="l00593"></a>00593   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0699380cf33379fbee4e25d130dfa00a">num_param_vecs</a>; i++)
<a name="l00594"></a>00594     outArgs.setSupports(OUT_ARG_DfDp, i, DerivativeSupport(DERIV_MV_BY_COL));
<a name="l00595"></a>00595   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;n_g; i++) {
<a name="l00596"></a>00596 
<a name="l00597"></a>00597     <span class="keywordflow">if</span>(i &lt; poissonApp-&gt;getNumResponses())
<a name="l00598"></a>00598       bScalarResponse = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;getResponse(i)-&gt;isScalarResponse();
<a name="l00599"></a>00599     <span class="keywordflow">else</span>
<a name="l00600"></a>00600       bScalarResponse = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0b1ebffc57924085d4c641415fca50a6">schrodingerApp</a>-&gt;getResponse(i - <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;getNumResponses())-&gt;isScalarResponse();
<a name="l00601"></a>00601 
<a name="l00602"></a>00602     <span class="keywordflow">if</span>(bScalarResponse) {
<a name="l00603"></a>00603       outArgs.setSupports(OUT_ARG_DgDx, i,
<a name="l00604"></a>00604                           DerivativeSupport(DERIV_TRANS_MV_BY_ROW));
<a name="l00605"></a>00605       outArgs.setSupports(OUT_ARG_DgDx_dot, i,
<a name="l00606"></a>00606                           DerivativeSupport(DERIV_TRANS_MV_BY_ROW));
<a name="l00607"></a>00607     }
<a name="l00608"></a>00608     <span class="keywordflow">else</span> {
<a name="l00609"></a>00609       outArgs.setSupports(OUT_ARG_DgDx, i,
<a name="l00610"></a>00610                           DerivativeSupport(DERIV_LINEAR_OP));
<a name="l00611"></a>00611       outArgs.setSupports(OUT_ARG_DgDx_dot, i,
<a name="l00612"></a>00612                           DerivativeSupport(DERIV_LINEAR_OP));
<a name="l00613"></a>00613     }
<a name="l00614"></a>00614 
<a name="l00615"></a>00615     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;num_param_vecs; j++)
<a name="l00616"></a>00616       outArgs.setSupports(OUT_ARG_DgDp, i, j,
<a name="l00617"></a>00617                           DerivativeSupport(DERIV_MV_BY_COL));
<a name="l00618"></a>00618   }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620   <span class="comment">//Note: no SG support yet...</span>
<a name="l00621"></a>00621 
<a name="l00622"></a>00622   <span class="keywordflow">return</span> outArgs;
<a name="l00623"></a>00623 }
<a name="l00624"></a>00624 
<a name="l00625"></a>00625 
<a name="l00626"></a>00626 <span class="keywordtype">void</span> 
<a name="l00627"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#adfa1281957eb68eab6abc2a31cfb6ed7">00627</a> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#adfa1281957eb68eab6abc2a31cfb6ed7">QCAD::CoupledPoissonSchrodinger::evalModel</a>(<span class="keyword">const</span> InArgs&amp; inArgs,
<a name="l00628"></a>00628       <span class="keyword">const</span> OutArgs&amp; outArgs )<span class="keyword"> const</span>
<a name="l00629"></a>00629 <span class="keyword"></span>{
<a name="l00630"></a>00630   <span class="comment">//?? Teuchos::TimeMonitor Timer(*timer); //start timer</span>
<a name="l00631"></a>00631 
<a name="l00632"></a>00632   <span class="comment">//</span>
<a name="l00633"></a>00633   <span class="comment">// Get the input arguments</span>
<a name="l00634"></a>00634   <span class="comment">//</span>
<a name="l00635"></a>00635   Teuchos::RCP&lt;const Epetra_Vector&gt; x = inArgs.get_x();
<a name="l00636"></a>00636   Teuchos::RCP&lt;const Epetra_Vector&gt; x_dot;
<a name="l00637"></a>00637   <span class="keywordtype">double</span> <a class="code" href="namespaceFELIX.html#a4d08741b97fea3938089670d2a84c598">alpha</a>     = 0.0;  <span class="comment">// M coeff</span>
<a name="l00638"></a>00638   <span class="keywordtype">double</span> beta      = 1.0;  <span class="comment">// J coeff</span>
<a name="l00639"></a>00639   <span class="keywordtype">double</span> curr_time = 0.0;
<a name="l00640"></a>00640   x_dot = inArgs.get_x_dot();
<a name="l00641"></a>00641   <span class="keywordflow">if</span> (x_dot != Teuchos::null) {
<a name="l00642"></a>00642     alpha = inArgs.get_alpha();
<a name="l00643"></a>00643     beta = inArgs.get_beta();
<a name="l00644"></a>00644     curr_time  = inArgs.get_t();
<a name="l00645"></a>00645     std::cout &lt;&lt; <span class="stringliteral">&quot;DEBUG: WARNING: x_dot given to CoupledPoissonSchrodinger evalModel!!&quot;</span> &lt;&lt; std::endl;
<a name="l00646"></a>00646   }
<a name="l00647"></a>00647   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;inArgs.Np(); i++) {
<a name="l00648"></a>00648     Teuchos::RCP&lt;const Epetra_Vector&gt; p = inArgs.get_p(i);
<a name="l00649"></a>00649     <span class="keywordflow">if</span> (p != Teuchos::null) {
<a name="l00650"></a>00650       <span class="keywordflow">if</span>(i &lt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>) {
<a name="l00651"></a>00651   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j=0; j&lt;<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8ae4cd9fb6dd70e36740d430972c1ad4" title="Sacado parameter vectors.">poisson_sacado_param_vec</a>[i].size(); j++)
<a name="l00652"></a>00652     <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8ae4cd9fb6dd70e36740d430972c1ad4" title="Sacado parameter vectors.">poisson_sacado_param_vec</a>[i][j].baseValue = (*p)[j];
<a name="l00653"></a>00653       }
<a name="l00654"></a>00654       <span class="keywordflow">else</span> {
<a name="l00655"></a>00655   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j=0; j&lt;<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a353b6a52985b107ee628e74c3323c5be">schrodinger_sacado_param_vec</a>[i-<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>].size(); j++)
<a name="l00656"></a>00656     <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a353b6a52985b107ee628e74c3323c5be">schrodinger_sacado_param_vec</a>[i-<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>][j].baseValue = (*p)[j];
<a name="l00657"></a>00657       }
<a name="l00658"></a>00658     }
<a name="l00659"></a>00659   }
<a name="l00660"></a>00660 
<a name="l00661"></a>00661 
<a name="l00662"></a>00662   <span class="comment">//</span>
<a name="l00663"></a>00663   <span class="comment">// Get the output arguments</span>
<a name="l00664"></a>00664   <span class="comment">//</span>
<a name="l00665"></a>00665   EpetraExt::ModelEvaluator::Evaluation&lt;Epetra_Vector&gt; f_out = outArgs.get_f();
<a name="l00666"></a>00666   Teuchos::RCP&lt;Epetra_Operator&gt; W_out = outArgs.get_W();
<a name="l00667"></a>00667 
<a name="l00668"></a>00668   <span class="comment">// Get preconditioner operator, if requested</span>
<a name="l00669"></a>00669   Teuchos::RCP&lt;Epetra_Operator&gt; WPrec_out;
<a name="l00670"></a>00670   <span class="keywordflow">if</span> (outArgs.supports(OUT_ARG_WPrec)) WPrec_out = outArgs.get_WPrec();
<a name="l00671"></a>00671 
<a name="l00672"></a>00672 
<a name="l00673"></a>00673   <span class="comment">//</span>
<a name="l00674"></a>00674   <span class="comment">// Get views into &#39;x&#39; (and &#39;xdot&#39;?) vectors to use for separate poisson and schrodinger application object calls</span>
<a name="l00675"></a>00675   <span class="comment">//</span>
<a name="l00676"></a>00676   <span class="keywordtype">int</span> disc_nMyElements = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2cfd1cdbe58ce0b8e0d7fff094b468d2">disc_map</a>-&gt;NumMyElements();
<a name="l00677"></a>00677 
<a name="l00678"></a>00678   Teuchos::RCP&lt;const Epetra_Vector&gt; x_poisson, xdot_poisson, eigenvals_dist;
<a name="l00679"></a>00679   Teuchos::RCP&lt;const Epetra_MultiVector&gt; x_schrodinger, xdot_schrodinger;
<a name="l00680"></a>00680   std::vector&lt;const Epetra_Vector*&gt; xdot_schrodinger_vec(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>);
<a name="l00681"></a>00681   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8627ebdfea8acd03664adba3e601d7ba">separateCombinedVector</a>(x, x_poisson, x_schrodinger, eigenvals_dist);
<a name="l00682"></a>00682     
<a name="l00683"></a>00683   <span class="keywordflow">if</span> (x_dot != Teuchos::null) {  <span class="comment">//maybe unnecessary - it seems that the coupled PS model evaluator shouldn&#39;t support x_dot ...</span>
<a name="l00684"></a>00684     <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8627ebdfea8acd03664adba3e601d7ba">separateCombinedVector</a>(x_dot, xdot_poisson, xdot_schrodinger);
<a name="l00685"></a>00685     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>; i++) xdot_schrodinger_vec[i] = (*xdot_schrodinger)(i);
<a name="l00686"></a>00686   }
<a name="l00687"></a>00687   <span class="keywordflow">else</span> {
<a name="l00688"></a>00688     xdot_poisson = Teuchos::null;
<a name="l00689"></a>00689     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>; i++) 
<a name="l00690"></a>00690       xdot_schrodinger_vec[i] = NULL;
<a name="l00691"></a>00691   }
<a name="l00692"></a>00692 
<a name="l00693"></a>00693   <span class="comment">//</span>
<a name="l00694"></a>00694   <span class="comment">// Communicate all the eigenvalues to every processor, since all parts of the mesh need them</span>
<a name="l00695"></a>00695   <span class="comment">//</span>
<a name="l00696"></a>00696   <span class="keywordtype">int</span> my_nEigenvals = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a5894c6bfeb505219673300d50c7742de">combined_SP_map</a>-&gt;NumMyElements() - disc_nMyElements * (1+<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>);
<a name="l00697"></a>00697   Epetra_Map dist_eigenval_map(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>, my_nEigenvals, 0, *<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a7ff0cfa9b31d4960b80e14a94abfe6eb">myComm</a>);
<a name="l00698"></a>00698   Epetra_LocalMap local_eigenval_map(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>, 0, *<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a7ff0cfa9b31d4960b80e14a94abfe6eb">myComm</a>);
<a name="l00699"></a>00699   Epetra_Import eigenval_importer(local_eigenval_map, dist_eigenval_map);
<a name="l00700"></a>00700 
<a name="l00701"></a>00701   Teuchos::RCP&lt;Epetra_Vector&gt; eigenvals =  Teuchos::rcp(<span class="keyword">new</span> Epetra_Vector(local_eigenval_map));
<a name="l00702"></a>00702   eigenvals-&gt;Import(*eigenvals_dist, eigenval_importer, Insert);
<a name="l00703"></a>00703   Teuchos::RCP&lt;std::vector&lt;double&gt; &gt; stdvec_eigenvals = Teuchos::rcp(<span class="keyword">new</span> std::vector&lt;double&gt;(&amp;(*eigenvals)[0], &amp;(*eigenvals)[0] + <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>));
<a name="l00704"></a>00704 
<a name="l00705"></a>00705   <span class="comment">//</span>
<a name="l00706"></a>00706   <span class="comment">// Get views into &#39;f&#39; residual vector to use for separate poisson and schrodinger application object calls</span>
<a name="l00707"></a>00707   <span class="comment">//</span>
<a name="l00708"></a>00708   Teuchos::RCP&lt;Epetra_Vector&gt;   f_poisson, f_norm_local, f_norm_dist;
<a name="l00709"></a>00709   Teuchos::RCP&lt;Epetra_MultiVector&gt; f_schrodinger;
<a name="l00710"></a>00710   std::vector&lt;Epetra_Vector*&gt; f_schrodinger_vec(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>);
<a name="l00711"></a>00711 
<a name="l00712"></a>00712   <span class="keywordflow">if</span>(f_out != Teuchos::null) {
<a name="l00713"></a>00713     <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8627ebdfea8acd03664adba3e601d7ba">separateCombinedVector</a>(f_out, f_poisson, f_schrodinger, f_norm_dist);
<a name="l00714"></a>00714     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>; i++) f_schrodinger_vec[i] = (*f_schrodinger)(i);
<a name="l00715"></a>00715 
<a name="l00716"></a>00716     <span class="comment">// Create local vector for holding the residual of the normalization equations on each proc.</span>
<a name="l00717"></a>00717     <span class="comment">//   (later we sum all procs contributions together and copy into distributed f_norm_dist vector)</span>
<a name="l00718"></a>00718     f_norm_local = Teuchos::rcp(<span class="keyword">new</span> Epetra_Vector(local_eigenval_map));
<a name="l00719"></a>00719   }
<a name="l00720"></a>00720   <span class="keywordflow">else</span> {
<a name="l00721"></a>00721     f_poisson = Teuchos::null;
<a name="l00722"></a>00722     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>; i++) f_schrodinger_vec[i] = NULL;
<a name="l00723"></a>00723     f_norm_local = f_norm_dist = Teuchos::null;
<a name="l00724"></a>00724   }
<a name="l00725"></a>00725 
<a name="l00726"></a>00726 
<a name="l00727"></a>00727   <span class="comment">// Create an eigendata struct for passing the eigenvectors to the poisson app</span>
<a name="l00728"></a>00728   <span class="comment">//  -- note that this requires the *overlapped* eigenvectors</span>
<a name="l00729"></a>00729   Teuchos::RCP&lt;Albany::EigendataStruct&gt; eigenData = Teuchos::rcp( <span class="keyword">new</span> <a class="code" href="structAlbany_1_1EigendataStruct.html">Albany::EigendataStruct</a> );
<a name="l00730"></a>00730 
<a name="l00731"></a>00731   eigenData-&gt;eigenvalueRe = stdvec_eigenvals;
<a name="l00732"></a>00732   eigenData-&gt;eigenvectorRe = 
<a name="l00733"></a>00733     Teuchos::rcp(<span class="keyword">new</span> Epetra_MultiVector(*<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a6d12f409329de2e065ddc70e56fb686a">disc_overlap_map</a>, <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>));
<a name="l00734"></a>00734   eigenData-&gt;eigenvectorIm = Teuchos::null; <span class="comment">// no imaginary eigenvalue data... </span>
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     <span class="comment">// Importer for overlapped data</span>
<a name="l00737"></a>00737   Teuchos::RCP&lt;Epetra_Import&gt; overlap_importer =
<a name="l00738"></a>00738     Teuchos::rcp(<span class="keyword">new</span> Epetra_Import(*<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a6d12f409329de2e065ddc70e56fb686a">disc_overlap_map</a>, *<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2cfd1cdbe58ce0b8e0d7fff094b468d2">disc_map</a>));
<a name="l00739"></a>00739 
<a name="l00740"></a>00740     <span class="comment">// Overlapped eigenstate vectors</span>
<a name="l00741"></a>00741   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>; i++) {
<a name="l00742"></a>00742     (*(eigenData-&gt;eigenvectorRe))(i)-&gt;Import( *((*x_schrodinger)(i)), *overlap_importer, Insert );
<a name="l00743"></a>00743     <span class="comment">//(*(eigenData-&gt;eigenvectorRe))(i)-&gt;PutScalar(0.0); //DEBUG - zero out eigenvectors passed to Poisson</span>
<a name="l00744"></a>00744   }
<a name="l00745"></a>00745 
<a name="l00746"></a>00746     <span class="comment">// set eigenvalues / eigenvectors for use in poisson problem:</span>
<a name="l00747"></a>00747   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;getStateMgr().setEigenData(eigenData);
<a name="l00748"></a>00748 
<a name="l00749"></a>00749 
<a name="l00750"></a>00750   <span class="comment">// Get overlapped version of potential (x_poisson) for passing as auxData to schrodinger app</span>
<a name="l00751"></a>00751   Teuchos::RCP&lt;Epetra_MultiVector&gt; overlapped_V = Teuchos::rcp(<span class="keyword">new</span> Epetra_MultiVector(*<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a6d12f409329de2e065ddc70e56fb686a">disc_overlap_map</a>, 1));
<a name="l00752"></a>00752   Teuchos::RCP&lt;Epetra_Vector&gt; ones_vec = Teuchos::rcp(<span class="keyword">new</span> Epetra_Vector(*<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a6d12f409329de2e065ddc70e56fb686a">disc_overlap_map</a>));
<a name="l00753"></a>00753   ones_vec-&gt;PutScalar(1.0);
<a name="l00754"></a>00754   (*overlapped_V)(0)-&gt;Import( *x_poisson, *overlap_importer, Insert );
<a name="l00755"></a>00755   (*overlapped_V)(0)-&gt;Update(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0f545418c853536bcb4adb5cb4df9a76">offset_to_CB</a>, *ones_vec, -1.0);
<a name="l00756"></a>00756   <span class="comment">//std::cout &lt;&lt; &quot;DEBUG: Offset to conduction band = &quot; &lt;&lt; offset_to_CB &lt;&lt; std::endl;</span>
<a name="l00757"></a>00757 
<a name="l00758"></a>00758   <span class="comment">// set potential for use in schrodinger problem</span>
<a name="l00759"></a>00759   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0b1ebffc57924085d4c641415fca50a6">schrodingerApp</a>-&gt;getStateMgr().setAuxData(overlapped_V);
<a name="l00760"></a>00760 
<a name="l00761"></a>00761 
<a name="l00762"></a>00762   
<a name="l00763"></a>00763   <span class="comment">//</span>
<a name="l00764"></a>00764   <span class="comment">// Compute the functions</span>
<a name="l00765"></a>00765   <span class="comment">//</span>
<a name="l00766"></a>00766   <span class="keywordtype">bool</span> f_poisson_already_computed = <span class="keyword">false</span>;
<a name="l00767"></a>00767   std::vector&lt;bool&gt; f_schrodinger_already_computed(nEigenvals, <span class="keyword">false</span>);
<a name="l00768"></a>00768 
<a name="l00769"></a>00769   Teuchos::RCP&lt;Epetra_CrsMatrix&gt; W_out_poisson_crs; <span class="comment">//possibly used by preconditioner, so declare here</span>
<a name="l00770"></a>00770   Teuchos::RCP&lt;Epetra_CrsMatrix&gt; W_out_schrodinger_crs; <span class="comment">//possibly used by preconditioner, so declare here</span>
<a name="l00771"></a>00771 
<a name="l00772"></a>00772   <span class="comment">// Mass Matrix -- needed even if we don&#39;t need to compute the Jacobian, since it enters into the normalization equations</span>
<a name="l00773"></a>00773   <span class="comment">//   --&gt; Compute mass matrix using schrodinger equation -- independent of eigenvector so can just use 0th</span>
<a name="l00774"></a>00774   <span class="comment">//       Note: to compute this, we need to evaluate the schrodinger problem as a transient problem, so create a dummy xdot...</span>
<a name="l00775"></a>00775   Teuchos::RCP&lt;Epetra_Operator&gt; M_out_schrodinger = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a90e1ff5d429b0b008dddad454d4801b1">schrodingerModel</a>-&gt;create_W(); <span class="comment">//maybe re-use this and not create it every time?</span>
<a name="l00776"></a>00776   Teuchos::RCP&lt;Epetra_CrsMatrix&gt; M_out_schrodinger_crs = Teuchos::rcp_dynamic_cast&lt;Epetra_CrsMatrix&gt;(M_out_schrodinger, <span class="keyword">true</span>);
<a name="l00777"></a>00777   Teuchos::RCP&lt;const Epetra_Vector&gt; dummy_xdot = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a90e1ff5d429b0b008dddad454d4801b1">schrodingerModel</a>-&gt;get_x_dot_init(); <span class="comment">// I think this would work as well: Teuchos::rcp(new Epetra_Vector(*disc_map)) </span>
<a name="l00778"></a>00778   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0b1ebffc57924085d4c641415fca50a6">schrodingerApp</a>-&gt;computeGlobalJacobian(1.0, 0.0, 0.0, curr_time, dummy_xdot.get(), NULL, *((*x_schrodinger)(0)), 
<a name="l00779"></a>00779               <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a353b6a52985b107ee628e74c3323c5be">schrodinger_sacado_param_vec</a>, f_schrodinger_vec[0], *M_out_schrodinger_crs);
<a name="l00780"></a>00780 
<a name="l00781"></a>00781 
<a name="l00782"></a>00782   <span class="comment">// Hamiltionan Matrix -- needed even if we don&#39;t need to compute the Jacobian, since this is how we compute the schrodinger residuals</span>
<a name="l00783"></a>00783   <span class="comment">//   --&gt; Computed as jacobian matrix of schrodinger equation -- independent of eigenvector so can just use 0th</span>
<a name="l00784"></a>00784   Teuchos::RCP&lt;Epetra_Operator&gt; J_out_schrodinger = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a90e1ff5d429b0b008dddad454d4801b1">schrodingerModel</a>-&gt;create_W(); <span class="comment">//maybe re-use this and not create it every time?</span>
<a name="l00785"></a>00785   Teuchos::RCP&lt;Epetra_CrsMatrix&gt; J_out_schrodinger_crs = Teuchos::rcp_dynamic_cast&lt;Epetra_CrsMatrix&gt;(J_out_schrodinger, <span class="keyword">true</span>);
<a name="l00786"></a>00786   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0b1ebffc57924085d4c641415fca50a6">schrodingerApp</a>-&gt;computeGlobalJacobian(0.0, 1.0, 0.0, curr_time, dummy_xdot.get(), NULL, *((*x_schrodinger)(0)), 
<a name="l00787"></a>00787               <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a353b6a52985b107ee628e74c3323c5be">schrodinger_sacado_param_vec</a>, f_schrodinger_vec[0], *J_out_schrodinger_crs);
<a name="l00788"></a>00788 
<a name="l00789"></a>00789   f_schrodinger_already_computed[0] = <span class="keyword">true</span>; <span class="comment">//residual is not affected by alpha &amp; beta, so both of the above calls compute it.</span>
<a name="l00790"></a>00790 
<a name="l00791"></a>00791 
<a name="l00792"></a>00792   <span class="comment">// W </span>
<a name="l00793"></a>00793   <span class="keywordflow">if</span> (W_out != Teuchos::null) { 
<a name="l00794"></a>00794     <span class="comment">// W = alpha*M + beta*J where M is mass mx and J is jacobian</span>
<a name="l00795"></a>00795 
<a name="l00796"></a>00796     <span class="comment">//if we need to compute the jacobian, get the jacobians of the poisson and schrodinger</span>
<a name="l00797"></a>00797     <span class="comment">//  applications (as crs matrices), as well as the mass matrix (from the schrodinger problem,</span>
<a name="l00798"></a>00798     <span class="comment">//  since it includes xdot - maybe need to fabricate this??) and from these construct a CoupledPoissonSchrodingerJacobian object (an Epetra_Operator)</span>
<a name="l00799"></a>00799     
<a name="l00800"></a>00800     <span class="comment">//TODO - how to allow general alpha and beta?  This won&#39;t work given current logic, so we should test that alpha=0, beta=1 and throw an error otherwise...</span>
<a name="l00801"></a>00801 
<a name="l00802"></a>00802     <span class="comment">// Compute poisson Jacobian</span>
<a name="l00803"></a>00803     Teuchos::RCP&lt;Epetra_Operator&gt; W_out_poisson = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ac344dcea687b3b287ccd29a9add35a62">poissonModel</a>-&gt;create_W(); <span class="comment">//maybe re-use this and not create it every time?</span>
<a name="l00804"></a>00804     W_out_poisson_crs = Teuchos::rcp_dynamic_cast&lt;Epetra_CrsMatrix&gt;(W_out_poisson, <span class="keyword">true</span>);
<a name="l00805"></a>00805 
<a name="l00806"></a>00806     <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;computeGlobalJacobian(alpha, beta, 0.0, curr_time, xdot_poisson.get(), NULL, *x_poisson, 
<a name="l00807"></a>00807               <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8ae4cd9fb6dd70e36740d430972c1ad4" title="Sacado parameter vectors.">poisson_sacado_param_vec</a>, f_poisson.get(), *W_out_poisson_crs);
<a name="l00808"></a>00808     f_poisson_already_computed = <span class="keyword">true</span>;
<a name="l00809"></a>00809 
<a name="l00810"></a>00810     
<a name="l00811"></a>00811     TEUCHOS_TEST_FOR_EXCEPTION(nEigenvals &lt;= 0, Teuchos::Exceptions::InvalidParameter,<span class="stringliteral">&quot;Error! The number of eigenvalues must be greater than zero.&quot;</span>);
<a name="l00812"></a>00812       
<a name="l00813"></a>00813     <span class="comment">//Compute schrodinger Jacobian using first eigenvector -- independent of eigenvector since Schro. eqn is linear</span>
<a name="l00814"></a>00814     <span class="comment">// (test for cases we&#39;ve already computed above)</span>
<a name="l00815"></a>00815     <span class="keywordflow">if</span>(alpha == 1.0 &amp;&amp; beta == 0.0)
<a name="l00816"></a>00816       W_out_schrodinger_crs = M_out_schrodinger_crs;
<a name="l00817"></a>00817     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(alpha == 0.0 &amp;&amp; beta == 1.0)
<a name="l00818"></a>00818       W_out_schrodinger_crs = J_out_schrodinger_crs;
<a name="l00819"></a>00819     <span class="keywordflow">else</span> {
<a name="l00820"></a>00820       Teuchos::RCP&lt;Epetra_Operator&gt; W_out_schrodinger = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a90e1ff5d429b0b008dddad454d4801b1">schrodingerModel</a>-&gt;create_W(); <span class="comment">//maybe re-use this and not create it every time?</span>
<a name="l00821"></a>00821       W_out_schrodinger_crs = Teuchos::rcp_dynamic_cast&lt;Epetra_CrsMatrix&gt;(W_out_schrodinger, <span class="keyword">true</span>);
<a name="l00822"></a>00822       <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0b1ebffc57924085d4c641415fca50a6">schrodingerApp</a>-&gt;computeGlobalJacobian(alpha, beta, 0.0, curr_time, xdot_schrodinger_vec[0], NULL, *((*x_schrodinger)(0)), 
<a name="l00823"></a>00823             <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a353b6a52985b107ee628e74c3323c5be">schrodinger_sacado_param_vec</a>, f_schrodinger_vec[0], *W_out_schrodinger_crs);
<a name="l00824"></a>00824       f_schrodinger_already_computed[0] = <span class="keyword">true</span>;
<a name="l00825"></a>00825     }
<a name="l00826"></a>00826     
<a name="l00827"></a>00827     Teuchos::RCP&lt;QCAD::CoupledPSJacobian&gt; W_out_psj = Teuchos::rcp_dynamic_cast&lt;<a class="code" href="classQCAD_1_1CoupledPSJacobian.html" title="An Epetra operator that evaluates the Jacobian of a QCAD coupled Poisson-Schrodinger problem...">QCAD::CoupledPSJacobian</a>&gt;(W_out, <span class="keyword">true</span>);
<a name="l00828"></a>00828     W_out_psj-&gt;initialize(W_out_poisson_crs, W_out_schrodinger_crs, M_out_schrodinger_crs, eigenvals, x_schrodinger);
<a name="l00829"></a>00829 
<a name="l00830"></a>00830 
<a name="l00831"></a>00831 
<a name="l00832"></a>00832     <span class="comment">/*</span>
<a name="l00833"></a>00833 <span class="comment">    // DEBUG --- JACOBIAN TEST -----------------------------------------------------------------------------------------</span>
<a name="l00834"></a>00834 <span class="comment">     </span>
<a name="l00835"></a>00835 <span class="comment">    Teuchos::RCP&lt;Epetra_Vector&gt; x_plus_dx = Teuchos::rcp( new Epetra_Vector(*combined_SP_map) );</span>
<a name="l00836"></a>00836 <span class="comment">    Teuchos::RCP&lt;Epetra_Vector&gt; dx_test = Teuchos::rcp( new Epetra_Vector(*combined_SP_map) );</span>
<a name="l00837"></a>00837 <span class="comment">    double eps;</span>
<a name="l00838"></a>00838 <span class="comment">    </span>
<a name="l00839"></a>00839 <span class="comment">    //Init dx_test</span>
<a name="l00840"></a>00840 <span class="comment">    Teuchos::RCP&lt;Epetra_Vector&gt; dx_test_poisson, dx_test_eigenvals;</span>
<a name="l00841"></a>00841 <span class="comment">    Teuchos::RCP&lt;Epetra_MultiVector&gt; dx_test_schrodinger;</span>
<a name="l00842"></a>00842 <span class="comment">    separateCombinedVector(dx_test, dx_test_poisson, dx_test_schrodinger, dx_test_eigenvals);</span>
<a name="l00843"></a>00843 <span class="comment"></span>
<a name="l00844"></a>00844 <span class="comment">    eps = 1e-7;</span>
<a name="l00845"></a>00845 <span class="comment">    dx_test-&gt;PutScalar(1.0);</span>
<a name="l00846"></a>00846 <span class="comment">    //dx_test_poisson-&gt;PutScalar(1.0);</span>
<a name="l00847"></a>00847 <span class="comment">    //dx_test_schrodinger-&gt;PutScalar(1.0);</span>
<a name="l00848"></a>00848 <span class="comment">    //dx_test_eigenvals-&gt;PutScalar(1.0);</span>
<a name="l00849"></a>00849 <span class="comment"></span>
<a name="l00850"></a>00850 <span class="comment">    Teuchos::RCP&lt;Epetra_Vector&gt; f_test_manual = Teuchos::rcp( new Epetra_Vector(*combined_SP_map) );</span>
<a name="l00851"></a>00851 <span class="comment">    Teuchos::RCP&lt;Epetra_Vector&gt; f_test_tmp = Teuchos::rcp( new Epetra_Vector(*combined_SP_map) );</span>
<a name="l00852"></a>00852 <span class="comment">    Teuchos::RCP&lt;Epetra_Vector&gt; f_test_jac = Teuchos::rcp( new Epetra_Vector(*combined_SP_map) );</span>
<a name="l00853"></a>00853 <span class="comment"></span>
<a name="l00854"></a>00854 <span class="comment">    computeResidual(x, f_test_manual, M_out_schrodinger_crs);</span>
<a name="l00855"></a>00855 <span class="comment">    //f_test_manual-&gt;Print( std::cout &lt;&lt; &quot;JACOBIAN TEST:  MANUAL 1&quot; &lt;&lt; std::endl);</span>
<a name="l00856"></a>00856 <span class="comment">    x_plus_dx-&gt;Update(1.0, *x, eps, *dx_test, 0.0); // x + eps*dx</span>
<a name="l00857"></a>00857 <span class="comment">    computeResidual(x_plus_dx, f_test_tmp, M_out_schrodinger_crs);</span>
<a name="l00858"></a>00858 <span class="comment">    //f_test_tmp-&gt;Print( std::cout &lt;&lt; &quot;JACOBIAN TEST:  MANUAL 2&quot; &lt;&lt; std::endl);</span>
<a name="l00859"></a>00859 <span class="comment">    f_test_manual-&gt;Update(1.0/eps, *f_test_tmp, -1.0/eps); // f_test_manual = (resid(x+eps*dx) - resid(x)) / eps ~ jacobian * dx</span>
<a name="l00860"></a>00860 <span class="comment"></span>
<a name="l00861"></a>00861 <span class="comment">    W_out_psj-&gt;Apply(*dx_test, *f_test_jac);</span>
<a name="l00862"></a>00862 <span class="comment"></span>
<a name="l00863"></a>00863 <span class="comment"></span>
<a name="l00864"></a>00864 <span class="comment">    //x_schrodinger-&gt;Print( std::cout &lt;&lt; &quot;JACOBIAN TEST:  X_SCHRODINGER&quot; &lt;&lt; std::endl);</span>
<a name="l00865"></a>00865 <span class="comment">    f_test_manual-&gt;Print( std::cout &lt;&lt; &quot;JACOBIAN TEST:  MANUAL DIFF&quot; &lt;&lt; std::endl);</span>
<a name="l00866"></a>00866 <span class="comment">    f_test_jac-&gt;Print( std::cout &lt;&lt; &quot;JACOBIAN TEST:  JACOBIAN DIFF&quot; &lt;&lt; std::endl);</span>
<a name="l00867"></a>00867 <span class="comment"></span>
<a name="l00868"></a>00868 <span class="comment">    f_test_tmp-&gt;Update(1.0, *f_test_manual, -1.0, *f_test_jac, 0.0);</span>
<a name="l00869"></a>00869 <span class="comment">    f_test_tmp-&gt;Print( std::cout &lt;&lt; &quot;JACOBIAN TEST:  COMPARISON VECTOR&quot; &lt;&lt; std::endl);</span>
<a name="l00870"></a>00870 <span class="comment">    </span>
<a name="l00871"></a>00871 <span class="comment">    double test_norm;</span>
<a name="l00872"></a>00872 <span class="comment">    f_test_tmp-&gt;Norm2(&amp;test_norm);</span>
<a name="l00873"></a>00873 <span class="comment">    std::cout &lt;&lt; &quot;JACOBIAN TEST: COMPARISON VECTOR 2-NORM = &quot; &lt;&lt; test_norm &lt;&lt; std::endl;</span>
<a name="l00874"></a>00874 <span class="comment"></span>
<a name="l00875"></a>00875 <span class="comment">    // DEBUG --- JACOBIAN TEST -----------------------------------------------------------------------------------------</span>
<a name="l00876"></a>00876 <span class="comment">    */</span>
<a name="l00877"></a>00877   }
<a name="l00878"></a>00878 
<a name="l00879"></a>00879 
<a name="l00880"></a>00880   <span class="keywordflow">if</span> (WPrec_out != Teuchos::null) {
<a name="l00881"></a>00881      <span class="comment">// Get Poisson Preconditioner</span>
<a name="l00882"></a>00882      Teuchos::RCP&lt;Epetra_Operator&gt; WPrec_poisson;
<a name="l00883"></a>00883      
<a name="l00884"></a>00884      <span class="comment">// Get the Poisson Jacobian -- (just copy the it if we already computed it)</span>
<a name="l00885"></a>00885      Teuchos::RCP&lt;Epetra_CrsMatrix&gt; Extra_W_crs_poisson;
<a name="l00886"></a>00886      <span class="keywordflow">if</span>(W_out != Teuchos::null)
<a name="l00887"></a>00887        Extra_W_crs_poisson = Teuchos::rcp( <span class="keyword">new</span> Epetra_CrsMatrix(*W_out_poisson_crs) ); <span class="comment">//Check: does this need to copy?</span>
<a name="l00888"></a>00888      <span class="keywordflow">else</span> {
<a name="l00889"></a>00889        Extra_W_crs_poisson = Teuchos::rcp_dynamic_cast&lt;Epetra_CrsMatrix&gt;(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ac344dcea687b3b287ccd29a9add35a62">poissonModel</a>-&gt;create_W(), <span class="keyword">true</span>);
<a name="l00890"></a>00890        <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;computeGlobalJacobian(alpha, beta, 0.0, curr_time, xdot_poisson.get(), NULL, *x_poisson, 
<a name="l00891"></a>00891            <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8ae4cd9fb6dd70e36740d430972c1ad4" title="Sacado parameter vectors.">poisson_sacado_param_vec</a>, f_poisson.get(), *Extra_W_crs_poisson);
<a name="l00892"></a>00892        f_poisson_already_computed = <span class="keyword">true</span>;
<a name="l00893"></a>00893      }
<a name="l00894"></a>00894 
<a name="l00895"></a>00895      <span class="keywordtype">bool</span> poisson_supports_teko_prec = <span class="keyword">false</span>;  <span class="comment">// TODO: I think this should = whether poisson outargs supports OUT_ARG_WPrec</span>
<a name="l00896"></a>00896      <span class="keywordflow">if</span>( poisson_supports_teko_prec ) {
<a name="l00897"></a>00897        Teuchos::RCP&lt;EpetraExt::ModelEvaluator::Preconditioner&gt; WPrec_poisson_pre = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ac344dcea687b3b287ccd29a9add35a62">poissonModel</a>-&gt;create_WPrec(); <span class="comment">//maybe re-use this and not create it every time?</span>
<a name="l00898"></a>00898        WPrec_poisson = WPrec_poisson_pre-&gt;PrecOp;       
<a name="l00899"></a>00899        <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;computeGlobalPreconditioner(Extra_W_crs_poisson, WPrec_poisson);
<a name="l00900"></a>00900      }
<a name="l00901"></a>00901      <span class="keywordflow">else</span> {
<a name="l00902"></a>00902        <span class="comment">// Use Ifpack to get a pseudo inverse of Extra_W_crs_poisson</span>
<a name="l00903"></a>00903        Teuchos::ParameterList Ifpack_list;
<a name="l00904"></a>00904        Ifpack Ifpack_factory; <span class="comment">// allocate an IFPACK factory.</span>
<a name="l00905"></a>00905 
<a name="l00906"></a>00906        <span class="comment">// create the preconditioner. -- maybe pull this info from input file in FUTURE</span>
<a name="l00907"></a>00907        std::string PrecType = <span class="stringliteral">&quot;ILU&quot;</span>; <span class="comment">// incomplete LU</span>
<a name="l00908"></a>00908        <span class="keywordtype">int</span> OverlapLevel = 1; <span class="comment">// must be &gt;= 0. If Comm.NumProc() == 1, it is ignored.</span>
<a name="l00909"></a>00909 
<a name="l00910"></a>00910        Teuchos::RCP&lt;Ifpack_Preconditioner&gt; WPrec_poisson_pre = Teuchos::rcp( Ifpack_factory.Create(PrecType, &amp;*Extra_W_crs_poisson, OverlapLevel) );
<a name="l00911"></a>00911        assert(WPrec_poisson_pre != Teuchos::null);
<a name="l00912"></a>00912 
<a name="l00913"></a>00913        <span class="comment">// specify parameters for ILU -- maybe pull this info from input file in FUTURE</span>
<a name="l00914"></a>00914        Ifpack_list.set(<span class="stringliteral">&quot;fact: drop tolerance&quot;</span>, 1e-9);
<a name="l00915"></a>00915        Ifpack_list.set(<span class="stringliteral">&quot;fact: level-of-fill&quot;</span>, 1);
<a name="l00916"></a>00916        <span class="comment">// the combine mode is one of  the following:</span>
<a name="l00917"></a>00917        <span class="comment">// &quot;Add&quot;, &quot;Zero&quot;, &quot;Insert&quot;, &quot;InsertAdd&quot;, &quot;Average&quot;, &quot;AbsMax&quot; (Their meaning is as defined in file Epetra_CombineMode.h)</span>
<a name="l00918"></a>00918        Ifpack_list.set(<span class="stringliteral">&quot;schwarz: combine mode&quot;</span>, <span class="stringliteral">&quot;Add&quot;</span>);
<a name="l00919"></a>00919 
<a name="l00920"></a>00920 
<a name="l00921"></a>00921        <span class="keywordflow">if</span>( WPrec_poisson_pre-&gt;SetParameters(Ifpack_list) != 0 ) <span class="comment">// sets the parameters</span>
<a name="l00922"></a>00922    TEUCHOS_TEST_FOR_EXCEPTION(<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,<span class="stringliteral">&quot;Error! Invalid IFPACK Parameters.&quot;</span>);  
<a name="l00923"></a>00923        <span class="keywordflow">if</span>( WPrec_poisson_pre-&gt;Initialize() != 0)                <span class="comment">// initialize preconditioner (must fillComplete matrix by now)</span>
<a name="l00924"></a>00924    TEUCHOS_TEST_FOR_EXCEPTION(<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,<span class="stringliteral">&quot;Error Inializing Ifpack preconditioner&quot;</span>);   
<a name="l00925"></a>00925        <span class="keywordflow">if</span>( WPrec_poisson_pre-&gt;Compute() != 0)                   <span class="comment">// compute preconditioner</span>
<a name="l00926"></a>00926    TEUCHOS_TEST_FOR_EXCEPTION(<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,<span class="stringliteral">&quot;Error Computing Ifpack preconditioner&quot;</span>);  
<a name="l00927"></a>00927 
<a name="l00928"></a>00928        WPrec_poisson = Teuchos::rcp_dynamic_cast&lt;Epetra_Operator&gt;(WPrec_poisson_pre, <span class="keyword">true</span>);
<a name="l00929"></a>00929      }
<a name="l00930"></a>00930 
<a name="l00931"></a>00931      <span class="comment">// Get Schrodinger Preconditioner</span>
<a name="l00932"></a>00932      Teuchos::RCP&lt;Epetra_Operator&gt; WPrec_schrodinger;
<a name="l00933"></a>00933 
<a name="l00934"></a>00934        <span class="comment">// Get the Schrodinger Jacobian</span>
<a name="l00935"></a>00935      Teuchos::RCP&lt;Epetra_CrsMatrix&gt; Extra_W_crs_schrodinger;
<a name="l00936"></a>00936      <span class="keywordflow">if</span>(W_out != Teuchos::null)
<a name="l00937"></a>00937        Extra_W_crs_schrodinger = Teuchos::rcp( <span class="keyword">new</span> Epetra_CrsMatrix(*W_out_schrodinger_crs) ); <span class="comment">//Check: does this need to copy?</span>
<a name="l00938"></a>00938      <span class="keywordflow">else</span> {
<a name="l00939"></a>00939        Extra_W_crs_schrodinger = Teuchos::rcp_dynamic_cast&lt;Epetra_CrsMatrix&gt;(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a90e1ff5d429b0b008dddad454d4801b1">schrodingerModel</a>-&gt;create_W(), <span class="keyword">true</span>);
<a name="l00940"></a>00940        <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0b1ebffc57924085d4c641415fca50a6">schrodingerApp</a>-&gt;computeGlobalJacobian(alpha, beta, 0.0, curr_time, xdot_schrodinger_vec[0], NULL, *((*x_schrodinger)(0)), 
<a name="l00941"></a>00941                <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a353b6a52985b107ee628e74c3323c5be">schrodinger_sacado_param_vec</a>, f_schrodinger_vec[0], *Extra_W_crs_schrodinger);
<a name="l00942"></a>00942        f_schrodinger_already_computed[0] = <span class="keyword">true</span>;
<a name="l00943"></a>00943      }
<a name="l00944"></a>00944 
<a name="l00945"></a>00945      <span class="keywordtype">bool</span> schrodinger_supports_teko_prec = <span class="keyword">false</span>;  <span class="comment">// I think this should = whether poisson outargs supports OUT_ARG_WPrec</span>
<a name="l00946"></a>00946      <span class="keywordflow">if</span>( schrodinger_supports_teko_prec ) {
<a name="l00947"></a>00947        Teuchos::RCP&lt;EpetraExt::ModelEvaluator::Preconditioner&gt; WPrec_schrodinger_pre = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a90e1ff5d429b0b008dddad454d4801b1">schrodingerModel</a>-&gt;create_WPrec(); <span class="comment">//maybe re-use this and not create every time?</span>
<a name="l00948"></a>00948        WPrec_schrodinger = WPrec_schrodinger_pre-&gt;PrecOp;
<a name="l00949"></a>00949        <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0b1ebffc57924085d4c641415fca50a6">schrodingerApp</a>-&gt;computeGlobalPreconditioner(Extra_W_crs_schrodinger, WPrec_schrodinger);
<a name="l00950"></a>00950      }
<a name="l00951"></a>00951      <span class="keywordflow">else</span> {
<a name="l00952"></a>00952        <span class="comment">// Use Ifpack to get a pseudo inverse of Extra_W_crs_schrodinger</span>
<a name="l00953"></a>00953        Teuchos::ParameterList Ifpack_list;
<a name="l00954"></a>00954        Ifpack Ifpack_factory; <span class="comment">// allocate an IFPACK factory.</span>
<a name="l00955"></a>00955 
<a name="l00956"></a>00956        <span class="comment">// create the preconditioner. -- maybe pull this info from input file in FUTURE</span>
<a name="l00957"></a>00957        std::string PrecType = <span class="stringliteral">&quot;ILU&quot;</span>; <span class="comment">// incomplete LU</span>
<a name="l00958"></a>00958        <span class="keywordtype">int</span> OverlapLevel = 1; <span class="comment">// must be &gt;= 0. If Comm.NumProc() == 1, it is ignored.</span>
<a name="l00959"></a>00959 
<a name="l00960"></a>00960        Teuchos::RCP&lt;Ifpack_Preconditioner&gt; WPrec_schrodinger_pre = Teuchos::rcp( Ifpack_factory.Create(PrecType, &amp;*Extra_W_crs_schrodinger, OverlapLevel) );
<a name="l00961"></a>00961        assert(WPrec_schrodinger_pre != Teuchos::null);
<a name="l00962"></a>00962 
<a name="l00963"></a>00963        <span class="comment">// specify parameters for ILU -- maybe pull this info from input file in FUTURE</span>
<a name="l00964"></a>00964        Ifpack_list.set(<span class="stringliteral">&quot;fact: drop tolerance&quot;</span>, 1e-9);
<a name="l00965"></a>00965        Ifpack_list.set(<span class="stringliteral">&quot;fact: level-of-fill&quot;</span>, 1);
<a name="l00966"></a>00966        <span class="comment">// the combine mode is one of the following:</span>
<a name="l00967"></a>00967        <span class="comment">// &quot;Add&quot;, &quot;Zero&quot;, &quot;Insert&quot;, &quot;InsertAdd&quot;, &quot;Average&quot;, &quot;AbsMax&quot;   (Their meaning is as defined in file Epetra_CombineMode.h)</span>
<a name="l00968"></a>00968        Ifpack_list.set(<span class="stringliteral">&quot;schwarz: combine mode&quot;</span>, <span class="stringliteral">&quot;Add&quot;</span>);
<a name="l00969"></a>00969 
<a name="l00970"></a>00970 
<a name="l00971"></a>00971        <span class="keywordflow">if</span>( WPrec_schrodinger_pre-&gt;SetParameters(Ifpack_list) != 0 ) <span class="comment">// sets the parameters</span>
<a name="l00972"></a>00972    TEUCHOS_TEST_FOR_EXCEPTION(<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,<span class="stringliteral">&quot;Error! Invalid IFPACK Parameters.&quot;</span>);  
<a name="l00973"></a>00973        <span class="keywordflow">if</span>( WPrec_schrodinger_pre-&gt;Initialize() != 0)                <span class="comment">// initialize preconditioner (must fillComplete matrix by now)</span>
<a name="l00974"></a>00974    TEUCHOS_TEST_FOR_EXCEPTION(<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,<span class="stringliteral">&quot;Error Inializing Ifpack preconditioner&quot;</span>);   
<a name="l00975"></a>00975        <span class="keywordflow">if</span>( WPrec_schrodinger_pre-&gt;Compute() != 0)                   <span class="comment">// compute preconditioner</span>
<a name="l00976"></a>00976    TEUCHOS_TEST_FOR_EXCEPTION(<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,<span class="stringliteral">&quot;Error Computing Ifpack preconditioner&quot;</span>);  
<a name="l00977"></a>00977 
<a name="l00978"></a>00978        WPrec_schrodinger = Teuchos::rcp_dynamic_cast&lt;Epetra_Operator&gt;(WPrec_schrodinger_pre, <span class="keyword">true</span>);
<a name="l00979"></a>00979      }
<a name="l00980"></a>00980 
<a name="l00981"></a>00981      Teuchos::RCP&lt;QCAD::CoupledPSPreconditioner&gt; WPrec_out_psp = Teuchos::rcp_dynamic_cast&lt;<a class="code" href="classQCAD_1_1CoupledPSPreconditioner.html" title="An Epetra operator that evaluates the Jacobian of a QCAD coupled Poisson-Schrodinger problem...">QCAD::CoupledPSPreconditioner</a>&gt;(WPrec_out, <span class="keyword">true</span>);
<a name="l00982"></a>00982      WPrec_out_psp-&gt;initialize(WPrec_poisson, WPrec_schrodinger);
<a name="l00983"></a>00983   }
<a name="l00984"></a>00984 
<a name="l00985"></a>00985   <span class="comment">// df/dp</span>
<a name="l00986"></a>00986   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;outArgs.Np(); i++) {
<a name="l00987"></a>00987     Teuchos::RCP&lt;Epetra_MultiVector&gt; dfdp_out = 
<a name="l00988"></a>00988       outArgs.get_DfDp(i).getMultiVector();
<a name="l00989"></a>00989     <span class="keywordflow">if</span> (dfdp_out != Teuchos::null) {
<a name="l00990"></a>00990 
<a name="l00991"></a>00991 
<a name="l00992"></a>00992       <span class="comment">// Get views into dfdp_out vectors for poisson and schrodinger parts</span>
<a name="l00993"></a>00993       <span class="comment">//  Note that df/dp will be zero for parts of f corresponding to an app</span>
<a name="l00994"></a>00994       <span class="comment">//    different from the one owning the p vector.  E.g. if i==0 corresponds</span>
<a name="l00995"></a>00995       <span class="comment">//    to p being a poisson parameter vector then df/dp == 0 for all the schrodinger</span>
<a name="l00996"></a>00996       <span class="comment">//    parts of f.</span>
<a name="l00997"></a>00997 
<a name="l00998"></a>00998       <span class="keywordtype">int</span> nParamComponents = dfdp_out-&gt;NumVectors();
<a name="l00999"></a>00999       Teuchos::RCP&lt;Epetra_MultiVector&gt; dfdp_poisson;
<a name="l01000"></a>01000       std::vector&lt; Teuchos::RCP&lt;Epetra_MultiVector&gt; &gt; dfdp_schrodinger(nEigenvals);
<a name="l01001"></a>01001 
<a name="l01002"></a>01002       <span class="keywordtype">double</span> *dfdp_data; <span class="keywordtype">int</span> myLDA;
<a name="l01003"></a>01003       <span class="keywordflow">if</span>(dfdp_out-&gt;ExtractView(&amp;dfdp_data, &amp;myLDA) != 0) 
<a name="l01004"></a>01004   TEUCHOS_TEST_FOR_EXCEPTION(<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,
<a name="l01005"></a>01005            <span class="stringliteral">&quot;Error!  QCAD::CoupledPoissonSchrodinger -- cannot extract dgdp vector view&quot;</span>);
<a name="l01006"></a>01006 
<a name="l01007"></a>01007       dfdp_poisson = Teuchos::rcp(<span class="keyword">new</span> Epetra_MultiVector(::View, *<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2cfd1cdbe58ce0b8e0d7fff094b468d2">disc_map</a>, &amp;(dfdp_data[0]), myLDA, nParamComponents));
<a name="l01008"></a>01008       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k&lt;nEigenvals; k++)
<a name="l01009"></a>01009   dfdp_schrodinger[k] = Teuchos::rcp(<span class="keyword">new</span> Epetra_MultiVector(::View, *<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2cfd1cdbe58ce0b8e0d7fff094b468d2">disc_map</a>, &amp;(dfdp_data[(k+1)*disc_nMyElements]), myLDA, nParamComponents));
<a name="l01010"></a>01010 
<a name="l01011"></a>01011       <span class="comment">// Assemble p_vec</span>
<a name="l01012"></a>01012       Teuchos::Array&lt;int&gt; p_indexes = 
<a name="l01013"></a>01013         outArgs.get_DfDp(i).getDerivativeMultiVector().getParamIndexes();
<a name="l01014"></a>01014       Teuchos::RCP&lt;ParamVec&gt; p_vec;
<a name="l01015"></a>01015 
<a name="l01016"></a>01016       Teuchos::Array&lt;ParamVec&gt;&amp; sacado_param_vec = 
<a name="l01017"></a>01017   (i &lt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>) ? <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8ae4cd9fb6dd70e36740d430972c1ad4" title="Sacado parameter vectors.">poisson_sacado_param_vec</a> : <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a353b6a52985b107ee628e74c3323c5be">schrodinger_sacado_param_vec</a>;
<a name="l01018"></a>01018       <span class="keywordtype">int</span> offset = (i &lt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>) ? 0 : <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>;
<a name="l01019"></a>01019 
<a name="l01020"></a>01020       <span class="keywordflow">if</span> (p_indexes.size() == 0)
<a name="l01021"></a>01021         p_vec = Teuchos::rcp(&amp;sacado_param_vec[i-offset],<span class="keyword">false</span>);
<a name="l01022"></a>01022       <span class="keywordflow">else</span> {
<a name="l01023"></a>01023         p_vec = Teuchos::rcp(<span class="keyword">new</span> <a class="code" href="Albany__DataTypes_8hpp.html#aa17b892cdb0cb1ec55119bb8b01cb49e">ParamVec</a>);
<a name="l01024"></a>01024         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;p_indexes.size(); j++)
<a name="l01025"></a>01025           p_vec-&gt;addParam(sacado_param_vec[i-offset][p_indexes[j]].family, 
<a name="l01026"></a>01026                           sacado_param_vec[i-offset][p_indexes[j]].baseValue);
<a name="l01027"></a>01027       }
<a name="l01028"></a>01028 
<a name="l01029"></a>01029       dfdp_out-&gt;PutScalar(0.0);
<a name="l01030"></a>01030 
<a name="l01031"></a>01031       <span class="comment">// Compute full dfdp by computing non-zero parts and leaving zeros in others</span>
<a name="l01032"></a>01032       <span class="keywordflow">if</span> (i &lt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>) {
<a name="l01033"></a>01033   <span class="comment">// &quot;Poisson-owned&quot; param vector, so only poisson part of dfdp vector can be nonzero</span>
<a name="l01034"></a>01034   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;computeGlobalTangent(0.0, 0.0, 0.0, curr_time, <span class="keyword">false</span>, xdot_poisson.get(), NULL, *x_poisson, 
<a name="l01035"></a>01035           <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8ae4cd9fb6dd70e36740d430972c1ad4" title="Sacado parameter vectors.">poisson_sacado_param_vec</a>, p_vec.get(),
<a name="l01036"></a>01036           NULL, NULL, NULL, NULL, f_poisson.get(), NULL, 
<a name="l01037"></a>01037           dfdp_poisson.get());
<a name="l01038"></a>01038 
<a name="l01039"></a>01039   f_poisson_already_computed=<span class="keyword">true</span>;
<a name="l01040"></a>01040       }
<a name="l01041"></a>01041       <span class="keywordflow">else</span> {
<a name="l01042"></a>01042   <span class="comment">// &quot;Schrodinger-owned&quot; param vector, so only schrodinger parts of dfdp vector can be nonzero</span>
<a name="l01043"></a>01043   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k&lt;nEigenvals; k++) {
<a name="l01044"></a>01044     <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0b1ebffc57924085d4c641415fca50a6">schrodingerApp</a>-&gt;computeGlobalTangent(0.0, 0.0, 0.0, curr_time, <span class="keyword">false</span>, xdot_schrodinger_vec[k], NULL, *((*x_schrodinger)(k)),
<a name="l01045"></a>01045                  <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a353b6a52985b107ee628e74c3323c5be">schrodinger_sacado_param_vec</a>, p_vec.get(),
<a name="l01046"></a>01046                  NULL, NULL, NULL, NULL, f_schrodinger_vec[k], NULL, 
<a name="l01047"></a>01047                  dfdp_schrodinger[k].get());  
<a name="l01048"></a>01048     f_schrodinger_already_computed[k]=<span class="keyword">true</span>;
<a name="l01049"></a>01049   }
<a name="l01050"></a>01050       }
<a name="l01051"></a>01051     }
<a name="l01052"></a>01052   }
<a name="l01053"></a>01053 
<a name="l01054"></a>01054   <span class="comment">// f</span>
<a name="l01055"></a>01055   <span class="comment">/*if (app-&gt;is_adjoint) {  //TODO: support Adjoints?</span>
<a name="l01056"></a>01056 <span class="comment">    TEUCHOS_TEST_FOR_EXCEPTION(true, Teuchos::Exceptions::InvalidParameter,</span>
<a name="l01057"></a>01057 <span class="comment">           &quot;Error!  QCAD::CoupledPoissonSchrodinger -- adjoints not implemented yet&quot;);</span>
<a name="l01058"></a>01058 <span class="comment">    Derivative f_deriv(f_out, DERIV_TRANS_MV_BY_ROW);</span>
<a name="l01059"></a>01059 <span class="comment">    int response_index = 0; // need to add capability for sending this in</span>
<a name="l01060"></a>01060 <span class="comment">    app-&gt;evaluateResponseDerivative(response_index, curr_time, x_dot.get(), *x, </span>
<a name="l01061"></a>01061 <span class="comment">            sacado_param_vec, NULL, </span>
<a name="l01062"></a>01062 <span class="comment">            NULL, f_deriv, Derivative(), Derivative());</span>
<a name="l01063"></a>01063 <span class="comment">  }</span>
<a name="l01064"></a>01064 <span class="comment">  else {  */</span>
<a name="l01065"></a>01065     <span class="keywordflow">if</span> (f_out != Teuchos::null) { 
<a name="l01066"></a>01066       Epetra_Vector M_vec(*<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2cfd1cdbe58ce0b8e0d7fff094b468d2">disc_map</a>);  <span class="comment">//temp storage for mass matrix times vec -- maybe don&#39;t allocate this on the stack??</span>
<a name="l01067"></a>01067 
<a name="l01068"></a>01068       <span class="keywordflow">if</span>(!f_poisson_already_computed) {
<a name="l01069"></a>01069   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;computeGlobalResidual(curr_time, xdot_poisson.get(), NULL, *x_poisson, 
<a name="l01070"></a>01070             <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8ae4cd9fb6dd70e36740d430972c1ad4" title="Sacado parameter vectors.">poisson_sacado_param_vec</a>, *f_poisson);
<a name="l01071"></a>01071       }
<a name="l01072"></a>01072       
<a name="l01073"></a>01073       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;nEigenvals; i++) {
<a name="l01074"></a>01074 
<a name="l01075"></a>01075   <span class="comment">// Compute Mass_matrix * eigenvector[i]</span>
<a name="l01076"></a>01076   <span class="keyword">const</span> Epetra_Vector&amp; vec = *((*x_schrodinger)(i));
<a name="l01077"></a>01077   M_out_schrodinger_crs-&gt;Multiply(<span class="keyword">false</span>, vec, M_vec);  
<a name="l01078"></a>01078 
<a name="l01079"></a>01079 
<a name="l01080"></a>01080   <span class="comment">// Compute the schrodinger residual f_schrodinger_vec[i]: H*eigenvector[i] - eigenvalue[i] * M * eigenvector[i]</span>
<a name="l01081"></a>01081 
<a name="l01082"></a>01082   <span class="keywordflow">if</span>(!f_schrodinger_already_computed[i]) {
<a name="l01083"></a>01083 
<a name="l01084"></a>01084       <span class="comment">//Could call this, but multiply below is faster</span>
<a name="l01085"></a>01085     <span class="comment">/*schrodingerApp-&gt;computeGlobalResidual(curr_time, xdot_schrodinger_vec[i], *((*x_schrodinger)(i)), </span>
<a name="l01086"></a>01086 <span class="comment">                  schrodinger_sacado_param_vec, *(f_schrodinger_vec[i]) );  // H*evec[i] */</span>
<a name="l01087"></a>01087 
<a name="l01088"></a>01088     <span class="comment">// H * Psi - E * M * Psi</span>
<a name="l01089"></a>01089     <span class="keyword">const</span> Epetra_CrsMatrix&amp; Hamiltonian_crs =  *J_out_schrodinger_crs;
<a name="l01090"></a>01090     Hamiltonian_crs.Multiply(<span class="keyword">false</span>, vec, *(f_schrodinger_vec[i]));
<a name="l01091"></a>01091   }
<a name="l01092"></a>01092 
<a name="l01093"></a>01093   <span class="comment">/* ---- DEBUG ----</span>
<a name="l01094"></a>01094 <span class="comment">     double He_norm, Me_norm, H_expect;</span>
<a name="l01095"></a>01095 <span class="comment">     f_schrodinger_vec[i]-&gt;Norm2(&amp;He_norm);</span>
<a name="l01096"></a>01096 <span class="comment">     M_vec.Norm2(&amp;Me_norm);</span>
<a name="l01097"></a>01097 <span class="comment">     std::cout &lt;&lt; &quot;DEBUG &quot; &lt;&lt; i &lt;&lt; &quot;: norm(-H*evec) = &quot; &lt;&lt; He_norm &lt;&lt; &quot;, norm(M*evec) = &quot; &lt;&lt; Me_norm </span>
<a name="l01098"></a>01098 <span class="comment">     &lt;&lt; &quot;, eval = &quot; &lt;&lt; (*stdvec_eigenvals)[i] &lt;&lt; std::endl;</span>
<a name="l01099"></a>01099 <span class="comment">     f_schrodinger_vec[i]-&gt;Dot(vec, &amp;H_expect);</span>
<a name="l01100"></a>01100 <span class="comment">  */</span>
<a name="l01101"></a>01101 
<a name="l01102"></a>01102   <span class="comment">// add -eval[i]*M*evec[i] to H*evec[i] (recall evals are really negative_evals)</span>
<a name="l01103"></a>01103   f_schrodinger_vec[i]-&gt;Update( (*stdvec_eigenvals)[i], M_vec, 1.0); 
<a name="l01104"></a>01104 
<a name="l01105"></a>01105 
<a name="l01106"></a>01106         <span class="comment">// Compute normalization equation residuals:  f_norm[i] = abs(1 - evec[i] . M . evec[i])</span>
<a name="l01107"></a>01107   <span class="keywordtype">double</span> vec_M_vec;
<a name="l01108"></a>01108   vec.Dot( M_vec, &amp;vec_M_vec );
<a name="l01109"></a>01109   (*f_norm_local)[i] = 1.0 - vec_M_vec;
<a name="l01110"></a>01110       }
<a name="l01111"></a>01111 
<a name="l01112"></a>01112       <span class="comment">// Fill elements of f_norm_dist that belong to this processor, i.e. loop over</span>
<a name="l01113"></a>01113       <span class="comment">// eigenvalue indices &quot;owned&quot; by the current proc in the combined distributed map</span>
<a name="l01114"></a>01114       std::vector&lt;int&gt; eval_global_elements(my_nEigenvals);
<a name="l01115"></a>01115       dist_eigenval_map.MyGlobalElements(&amp;eval_global_elements[0]);
<a name="l01116"></a>01116       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;my_nEigenvals; i++)
<a name="l01117"></a>01117   (*f_norm_dist)[i] = (*f_norm_local)[eval_global_elements[i]];
<a name="l01118"></a>01118 
<a name="l01119"></a>01119       
<a name="l01120"></a>01120 
<a name="l01121"></a>01121       <span class="comment">//DEBUG -- print residual in gory detail for debugging</span>
<a name="l01122"></a>01122       <span class="keywordflow">if</span>(1) {
<a name="l01123"></a>01123   <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a7ff0cfa9b31d4960b80e14a94abfe6eb">myComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;DEBUG: ----------------- Coupled Schrodinger Poisson Info Dump ---------------------&quot;</span> &lt;&lt; std::endl;
<a name="l01124"></a>01124   <span class="keywordtype">double</span> norm, mean;
<a name="l01125"></a>01125 
<a name="l01126"></a>01126   <span class="comment">/*std::cout &lt;&lt; &quot;x map has &quot; &lt;&lt; x-&gt;Map().NumGlobalElements() &lt;&lt; &quot; global els&quot; &lt;&lt; std::endl;</span>
<a name="l01127"></a>01127 <span class="comment">    std::cout &lt;&lt; &quot;x_poisson map has &quot; &lt;&lt; x_poisson-&gt;Map().NumGlobalElements() &lt;&lt; &quot; global els&quot; &lt;&lt; std::endl;</span>
<a name="l01128"></a>01128 <span class="comment">    std::cout &lt;&lt; &quot;x_schrodinger map has &quot; &lt;&lt; x_schrodinger-&gt;Map().NumGlobalElements() &lt;&lt; &quot; global els (each vec)&quot; &lt;&lt; std::endl;</span>
<a name="l01129"></a>01129 <span class="comment">    std::cout &lt;&lt; &quot;dist_eval_map has &quot; &lt;&lt; dist_eigenval_map.NumGlobalElements() &lt;&lt; &quot; global els&quot; &lt;&lt; std::endl;</span>
<a name="l01130"></a>01130 <span class="comment">  */</span>
<a name="l01131"></a>01131 
<a name="l01132"></a>01132   x-&gt;Norm2(&amp;norm); x-&gt;MeanValue(&amp;mean);
<a name="l01133"></a>01133   std::cout &lt;&lt; std::setprecision(10);
<a name="l01134"></a>01134   <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a7ff0cfa9b31d4960b80e14a94abfe6eb">myComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;X Norm &amp; Mean = &quot;</span> &lt;&lt; norm &lt;&lt; <span class="stringliteral">&quot; , &quot;</span> &lt;&lt; mean &lt;&lt; std::endl;
<a name="l01135"></a>01135   
<a name="l01136"></a>01136   x_poisson-&gt;Norm2(&amp;norm); x_poisson-&gt;MeanValue(&amp;mean);
<a name="l01137"></a>01137   <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a7ff0cfa9b31d4960b80e14a94abfe6eb">myComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;Poisson-part X Norm &amp; Mean = &quot;</span> &lt;&lt; norm &lt;&lt; <span class="stringliteral">&quot; , &quot;</span> &lt;&lt; mean &lt;&lt; std::endl;
<a name="l01138"></a>01138   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;nEigenvals; i++) {
<a name="l01139"></a>01139     (*x_schrodinger)(i)-&gt;Norm2(&amp;norm);
<a name="l01140"></a>01140     <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a7ff0cfa9b31d4960b80e14a94abfe6eb">myComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;Schrodinger[&quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;]-part X Norm = &quot;</span> &lt;&lt; norm &lt;&lt; std::endl;
<a name="l01141"></a>01141   }
<a name="l01142"></a>01142   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;nEigenvals; i++) 
<a name="l01143"></a>01143     <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a7ff0cfa9b31d4960b80e14a94abfe6eb">myComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;Eigenvalue[&quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;] = &quot;</span> &lt;&lt; (*stdvec_eigenvals)[i] &lt;&lt; std::endl;
<a name="l01144"></a>01144   
<a name="l01145"></a>01145   f_poisson-&gt;Norm2(&amp;norm);
<a name="l01146"></a>01146   <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a7ff0cfa9b31d4960b80e14a94abfe6eb">myComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;Poisson-part Residual Norm = &quot;</span> &lt;&lt; norm &lt;&lt; std::endl; <span class="comment">//f_poisson-&gt;Print(std::cout);</span>
<a name="l01147"></a>01147   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;nEigenvals; i++) {
<a name="l01148"></a>01148     <span class="keywordflow">if</span>(f_schrodinger_vec[i] != NULL) {
<a name="l01149"></a>01149       f_schrodinger_vec[i]-&gt;Norm2(&amp;norm);
<a name="l01150"></a>01150       <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a7ff0cfa9b31d4960b80e14a94abfe6eb">myComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;Schrodinger[&quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;]-part Residual Norm = &quot;</span> &lt;&lt; norm &lt;&lt; std::endl; <span class="comment">//f_schrodinger_vec[i]-&gt;Print(std::cout);</span>
<a name="l01151"></a>01151     }
<a name="l01152"></a>01152   }
<a name="l01153"></a>01153   <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a7ff0cfa9b31d4960b80e14a94abfe6eb">myComm</a>-&gt;MyPID() == 0) std::cout &lt;&lt; <span class="stringliteral">&quot;Eigenvalue-part Residual: &quot;</span> &lt;&lt; std::endl;
<a name="l01154"></a>01154   f_norm_dist-&gt;Print(std::cout); <span class="comment">// only rank 0 prints</span>
<a name="l01155"></a>01155       }
<a name="l01156"></a>01156     }
<a name="l01157"></a>01157 
<a name="l01158"></a>01158   <span class="comment">// Response functions</span>
<a name="l01159"></a>01159   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;outArgs.Ng(); i++) {
<a name="l01160"></a>01160     Teuchos::RCP&lt;Epetra_Vector&gt; g_out = outArgs.get_g(i);
<a name="l01161"></a>01161    
<a name="l01162"></a>01162     <span class="keywordtype">bool</span> g_computed = <span class="keyword">false</span>;
<a name="l01163"></a>01163 
<a name="l01164"></a>01164     Derivative dgdx_out = outArgs.get_DgDx(i);
<a name="l01165"></a>01165     Derivative dgdxdot_out = outArgs.get_DgDx_dot(i);
<a name="l01166"></a>01166 
<a name="l01167"></a>01167     <span class="comment">// dg/dx, dg/dxdot</span>
<a name="l01168"></a>01168     <span class="keywordflow">if</span> (!dgdx_out.isEmpty() || !dgdxdot_out.isEmpty()) {
<a name="l01169"></a>01169       <span class="keywordflow">if</span>(i &lt; poissonApp-&gt;getNumResponses()) {
<a name="l01170"></a>01170   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;evaluateResponseDerivative(i, curr_time, xdot_poisson.get(), NULL, *(x_poisson),
<a name="l01171"></a>01171                                       <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8ae4cd9fb6dd70e36740d430972c1ad4" title="Sacado parameter vectors.">poisson_sacado_param_vec</a>, NULL,
<a name="l01172"></a>01172                                       g_out.get(), dgdx_out,
<a name="l01173"></a>01173                                       dgdxdot_out, Derivative(), Derivative());
<a name="l01174"></a>01174       }
<a name="l01175"></a>01175       <span class="keywordflow">else</span> {
<a name="l01176"></a>01176   <span class="comment">// take response derivatives using lowest eigenstate only (is there something better??)</span>
<a name="l01177"></a>01177   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0b1ebffc57924085d4c641415fca50a6">schrodingerApp</a>-&gt;evaluateResponseDerivative(i - <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;getNumResponses(), curr_time, xdot_schrodinger_vec[0], NULL,
<a name="l01178"></a>01178                                       *((*x_schrodinger)(0)),
<a name="l01179"></a>01179                                       <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a353b6a52985b107ee628e74c3323c5be">schrodinger_sacado_param_vec</a>, NULL,
<a name="l01180"></a>01180                                       g_out.get(), dgdx_out,
<a name="l01181"></a>01181                                       dgdxdot_out, Derivative(), Derivative());
<a name="l01182"></a>01182       }
<a name="l01183"></a>01183       g_computed = <span class="keyword">true</span>;
<a name="l01184"></a>01184     }
<a name="l01185"></a>01185 
<a name="l01186"></a>01186     <span class="comment">// dg/dp</span>
<a name="l01187"></a>01187     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;outArgs.Np(); j++) {
<a name="l01188"></a>01188       Teuchos::RCP&lt;Epetra_MultiVector&gt; dgdp_out =
<a name="l01189"></a>01189         outArgs.get_DgDp(i,j).getMultiVector();
<a name="l01190"></a>01190       <span class="keywordflow">if</span> (dgdp_out != Teuchos::null) {
<a name="l01191"></a>01191         Teuchos::Array&lt;int&gt; p_indexes =
<a name="l01192"></a>01192           outArgs.get_DgDp(i,j).getDerivativeMultiVector().getParamIndexes();
<a name="l01193"></a>01193 
<a name="l01194"></a>01194         Teuchos::RCP&lt;ParamVec&gt; p_vec;
<a name="l01195"></a>01195 
<a name="l01196"></a>01196   Teuchos::Array&lt;ParamVec&gt;&amp; sacado_param_vec = 
<a name="l01197"></a>01197     (j &lt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>) ? <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8ae4cd9fb6dd70e36740d430972c1ad4" title="Sacado parameter vectors.">poisson_sacado_param_vec</a> : <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a353b6a52985b107ee628e74c3323c5be">schrodinger_sacado_param_vec</a>;
<a name="l01198"></a>01198   <span class="keywordtype">int</span> offset = (j &lt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>) ? 0 : <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>;
<a name="l01199"></a>01199 
<a name="l01200"></a>01200         <span class="keywordflow">if</span> (p_indexes.size() == 0)
<a name="l01201"></a>01201           p_vec = Teuchos::rcp(&amp;sacado_param_vec[j-offset],<span class="keyword">false</span>);
<a name="l01202"></a>01202         <span class="keywordflow">else</span> {
<a name="l01203"></a>01203           p_vec = Teuchos::rcp(<span class="keyword">new</span> <a class="code" href="Albany__DataTypes_8hpp.html#aa17b892cdb0cb1ec55119bb8b01cb49e">ParamVec</a>);
<a name="l01204"></a>01204           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;p_indexes.size(); k++)
<a name="l01205"></a>01205             p_vec-&gt;addParam(sacado_param_vec[j-offset][p_indexes[k]].family,
<a name="l01206"></a>01206                             sacado_param_vec[j-offset][p_indexes[k]].baseValue);
<a name="l01207"></a>01207         }
<a name="l01208"></a>01208 
<a name="l01209"></a>01209   <span class="keywordflow">if</span>(i &lt; poissonApp-&gt;getNumResponses() &amp;&amp; j &lt; <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>) {
<a name="l01210"></a>01210     <span class="comment">//both response and param vectors belong to poisson problem</span>
<a name="l01211"></a>01211     <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;evaluateResponseTangent(i, alpha, beta, 0.0, curr_time, <span class="keyword">false</span>,
<a name="l01212"></a>01212                 xdot_poisson.get(), NULL, *x_poisson,
<a name="l01213"></a>01213                 <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8ae4cd9fb6dd70e36740d430972c1ad4" title="Sacado parameter vectors.">poisson_sacado_param_vec</a>, p_vec.get(),
<a name="l01214"></a>01214                 NULL, NULL, NULL, NULL, g_out.get(), NULL,
<a name="l01215"></a>01215                 dgdp_out.get());
<a name="l01216"></a>01216   }
<a name="l01217"></a>01217   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(i &gt;= <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;getNumResponses() &amp;&amp; j &gt;= <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa0042e01f39713d2df86d8ca8a6cce72">num_poisson_param_vecs</a>) {
<a name="l01218"></a>01218     <span class="comment">//both response and param vectors belong to schrodinger problem -- evaluate dg/dp using first eigenvector</span>
<a name="l01219"></a>01219     <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0b1ebffc57924085d4c641415fca50a6">schrodingerApp</a>-&gt;evaluateResponseTangent(i - <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;getNumResponses(), alpha, beta, 0.0, curr_time, <span class="keyword">false</span>,
<a name="l01220"></a>01220               xdot_schrodinger_vec[0], NULL, *((*x_schrodinger)(0)),
<a name="l01221"></a>01221               <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a353b6a52985b107ee628e74c3323c5be">schrodinger_sacado_param_vec</a>, p_vec.get(),
<a name="l01222"></a>01222               NULL, NULL, NULL, NULL, g_out.get(), NULL,
<a name="l01223"></a>01223               dgdp_out.get());
<a name="l01224"></a>01224   }
<a name="l01225"></a>01225   <span class="keywordflow">else</span> {
<a name="l01226"></a>01226     <span class="comment">// response and param vectors belong to different sub-problems (Poisson or Schrodinger)</span>
<a name="l01227"></a>01227     dgdp_out-&gt;PutScalar(0.0);
<a name="l01228"></a>01228   }
<a name="l01229"></a>01229 
<a name="l01230"></a>01230         g_computed = <span class="keyword">true</span>;
<a name="l01231"></a>01231       }
<a name="l01232"></a>01232     }
<a name="l01233"></a>01233 
<a name="l01234"></a>01234     <span class="keywordflow">if</span> (g_out != Teuchos::null &amp;&amp; !g_computed) {
<a name="l01235"></a>01235       <span class="keywordflow">if</span>(i &lt; poissonApp-&gt;getNumResponses()) {
<a name="l01236"></a>01236   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;evaluateResponse(i, curr_time, xdot_poisson.get(), NULL, *x_poisson,
<a name="l01237"></a>01237              <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8ae4cd9fb6dd70e36740d430972c1ad4" title="Sacado parameter vectors.">poisson_sacado_param_vec</a>, *g_out);
<a name="l01238"></a>01238       }
<a name="l01239"></a>01239       <span class="keywordflow">else</span> {
<a name="l01240"></a>01240   <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0b1ebffc57924085d4c641415fca50a6">schrodingerApp</a>-&gt;evaluateResponse(i - <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>-&gt;getNumResponses(), curr_time, xdot_schrodinger_vec[0], NULL, *((*x_schrodinger)(0)), 
<a name="l01241"></a>01241            <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a353b6a52985b107ee628e74c3323c5be">schrodinger_sacado_param_vec</a>, *g_out);
<a name="l01242"></a>01242       }
<a name="l01243"></a>01243     }
<a name="l01244"></a>01244 
<a name="l01245"></a>01245   }
<a name="l01246"></a>01246 
<a name="l01247"></a>01247 }
<a name="l01248"></a>01248 
<a name="l01249"></a>01249 Teuchos::RCP&lt;Albany::Application&gt;
<a name="l01250"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a4db274878c2d87b99c2c5ff993421d7c">01250</a> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a4db274878c2d87b99c2c5ff993421d7c">QCAD::CoupledPoissonSchrodinger::getPoissonApp</a>()<span class="keyword"> const</span>
<a name="l01251"></a>01251 <span class="keyword"></span>{
<a name="l01252"></a>01252   <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aee99aeb096023b00fe57ebf6ea1558a9">poissonApp</a>;
<a name="l01253"></a>01253 }
<a name="l01254"></a>01254 
<a name="l01255"></a>01255 Teuchos::RCP&lt;Albany::Application&gt;
<a name="l01256"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a518aac08f0312f49e990e7e97c17def1">01256</a> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a518aac08f0312f49e990e7e97c17def1">QCAD::CoupledPoissonSchrodinger::getSchrodingerApp</a>()<span class="keyword"> const</span>
<a name="l01257"></a>01257 <span class="keyword"></span>{
<a name="l01258"></a>01258   <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a0b1ebffc57924085d4c641415fca50a6">schrodingerApp</a>;
<a name="l01259"></a>01259 }
<a name="l01260"></a>01260 
<a name="l01261"></a>01261 
<a name="l01262"></a>01262 
<a name="l01263"></a>01263 <span class="comment">// Note: we could use QCAD::separateCombinedVector(...) to implement this function and those below</span>
<a name="l01264"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8627ebdfea8acd03664adba3e601d7ba">01264</a> <span class="keywordtype">void</span> <a class="code" href="namespaceQCAD.html#aa83eb8a6e568c7b2f975e69cba17af89">QCAD::CoupledPoissonSchrodinger::separateCombinedVector</a>(<span class="keyword">const</span> Teuchos::RCP&lt;Epetra_Vector&gt;&amp; combinedVector,
<a name="l01265"></a>01265                    Teuchos::RCP&lt;Epetra_Vector&gt;&amp; poisson_part,
<a name="l01266"></a>01266                    Teuchos::RCP&lt;Epetra_MultiVector&gt;&amp; schrodinger_part)<span class="keyword"> const</span>
<a name="l01267"></a>01267 <span class="keyword"></span>{
<a name="l01268"></a>01268   <span class="keywordtype">double</span>* data;
<a name="l01269"></a>01269   <span class="keywordtype">int</span> disc_nMyElements = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2cfd1cdbe58ce0b8e0d7fff094b468d2">disc_map</a>-&gt;NumMyElements();
<a name="l01270"></a>01270 
<a name="l01271"></a>01271   <span class="keywordflow">if</span>(combinedVector-&gt;ExtractView(&amp;data) != 0)
<a name="l01272"></a>01272     TEUCHOS_TEST_FOR_EXCEPTION(<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,
<a name="l01273"></a>01273              <span class="stringliteral">&quot;Error!  QCAD::CoupledPoissonSchrodinger cannot extract vector views&quot;</span>);
<a name="l01274"></a>01274 
<a name="l01275"></a>01275   poisson_part = Teuchos::rcp(<span class="keyword">new</span> Epetra_Vector(::View, *<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2cfd1cdbe58ce0b8e0d7fff094b468d2">disc_map</a>, &amp;data[0]));
<a name="l01276"></a>01276   schrodinger_part = Teuchos::rcp(<span class="keyword">new</span> Epetra_MultiVector(::View, *<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2cfd1cdbe58ce0b8e0d7fff094b468d2">disc_map</a>, &amp;data[disc_nMyElements], disc_nMyElements, <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>));
<a name="l01277"></a>01277 }
<a name="l01278"></a>01278 
<a name="l01279"></a>01279 
<a name="l01280"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a640a99e887d2af3f02a4929ec91ecbfa">01280</a> <span class="keywordtype">void</span> <a class="code" href="namespaceQCAD.html#aa83eb8a6e568c7b2f975e69cba17af89">QCAD::CoupledPoissonSchrodinger::separateCombinedVector</a>(<span class="keyword">const</span> Teuchos::RCP&lt;Epetra_Vector&gt;&amp; combinedVector,
<a name="l01281"></a>01281                    Teuchos::RCP&lt;Epetra_Vector&gt;&amp; poisson_part,
<a name="l01282"></a>01282                    Teuchos::RCP&lt;Epetra_MultiVector&gt;&amp; schrodinger_part,
<a name="l01283"></a>01283                    Teuchos::RCP&lt;Epetra_Vector&gt;&amp; eigenvalue_part)<span class="keyword"> const</span>
<a name="l01284"></a>01284 <span class="keyword"></span>{
<a name="l01285"></a>01285   this-&gt;<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8627ebdfea8acd03664adba3e601d7ba">separateCombinedVector</a>(combinedVector, poisson_part, schrodinger_part);
<a name="l01286"></a>01286 
<a name="l01287"></a>01287   <span class="keywordtype">double</span>* data;
<a name="l01288"></a>01288   <span class="keywordtype">int</span> disc_nMyElements = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2cfd1cdbe58ce0b8e0d7fff094b468d2">disc_map</a>-&gt;NumMyElements();
<a name="l01289"></a>01289   <span class="keywordtype">int</span> my_nEigenvals = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a5894c6bfeb505219673300d50c7742de">combined_SP_map</a>-&gt;NumMyElements() - disc_nMyElements * (1+<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>);
<a name="l01290"></a>01290   Epetra_Map dist_eigenval_map(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>, my_nEigenvals, 0, *<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a7ff0cfa9b31d4960b80e14a94abfe6eb">myComm</a>);
<a name="l01291"></a>01291 
<a name="l01292"></a>01292   combinedVector-&gt;ExtractView(&amp;data); <span class="comment">//above call tests for failure</span>
<a name="l01293"></a>01293   eigenvalue_part = Teuchos::rcp(<span class="keyword">new</span> Epetra_Vector(::View, dist_eigenval_map, &amp;data[(1+<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>)*disc_nMyElements]));
<a name="l01294"></a>01294 }
<a name="l01295"></a>01295 
<a name="l01296"></a>01296 
<a name="l01297"></a>01297 
<a name="l01298"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a298809c4aacfb4065eaa9036f680eede">01298</a> <span class="keywordtype">void</span> <a class="code" href="namespaceQCAD.html#aa83eb8a6e568c7b2f975e69cba17af89">QCAD::CoupledPoissonSchrodinger::separateCombinedVector</a>(<span class="keyword">const</span> Teuchos::RCP&lt;const Epetra_Vector&gt;&amp; combinedVector,
<a name="l01299"></a>01299                    Teuchos::RCP&lt;const Epetra_Vector&gt;&amp; poisson_part,
<a name="l01300"></a>01300                    Teuchos::RCP&lt;const Epetra_MultiVector&gt;&amp; schrodinger_part)<span class="keyword"> const</span>
<a name="l01301"></a>01301 <span class="keyword"></span>{
<a name="l01302"></a>01302   <span class="keywordtype">double</span>* data;
<a name="l01303"></a>01303   <span class="keywordtype">int</span> disc_nMyElements = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2cfd1cdbe58ce0b8e0d7fff094b468d2">disc_map</a>-&gt;NumMyElements();
<a name="l01304"></a>01304 
<a name="l01305"></a>01305   <span class="keywordflow">if</span>(combinedVector-&gt;ExtractView(&amp;data) != 0)
<a name="l01306"></a>01306     TEUCHOS_TEST_FOR_EXCEPTION(<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,
<a name="l01307"></a>01307              <span class="stringliteral">&quot;Error!  QCAD::CoupledPoissonSchrodinger cannot extract vector views&quot;</span>);
<a name="l01308"></a>01308 
<a name="l01309"></a>01309   poisson_part = Teuchos::rcp(<span class="keyword">new</span> <span class="keyword">const</span> Epetra_Vector(::View, *<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2cfd1cdbe58ce0b8e0d7fff094b468d2">disc_map</a>, &amp;data[0]));
<a name="l01310"></a>01310   schrodinger_part = Teuchos::rcp(<span class="keyword">new</span> <span class="keyword">const</span> Epetra_MultiVector(::View, *<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2cfd1cdbe58ce0b8e0d7fff094b468d2">disc_map</a>, &amp;data[disc_nMyElements], disc_nMyElements, <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>));
<a name="l01311"></a>01311 }
<a name="l01312"></a>01312 
<a name="l01313"></a>01313 
<a name="l01314"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a9ecfc726e5f964b6e8f259c583bd8317">01314</a> <span class="keywordtype">void</span> <a class="code" href="namespaceQCAD.html#aa83eb8a6e568c7b2f975e69cba17af89">QCAD::CoupledPoissonSchrodinger::separateCombinedVector</a>(<span class="keyword">const</span> Teuchos::RCP&lt;const Epetra_Vector&gt;&amp; combinedVector,
<a name="l01315"></a>01315                    Teuchos::RCP&lt;const Epetra_Vector&gt;&amp; poisson_part,
<a name="l01316"></a>01316                    Teuchos::RCP&lt;const Epetra_MultiVector&gt;&amp; schrodinger_part,
<a name="l01317"></a>01317                    Teuchos::RCP&lt;const Epetra_Vector&gt;&amp; eigenvalue_part)<span class="keyword"> const</span>
<a name="l01318"></a>01318 <span class="keyword"></span>{
<a name="l01319"></a>01319   this-&gt;<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a8627ebdfea8acd03664adba3e601d7ba">separateCombinedVector</a>(combinedVector, poisson_part, schrodinger_part);
<a name="l01320"></a>01320 
<a name="l01321"></a>01321   <span class="keywordtype">double</span>* data;
<a name="l01322"></a>01322   <span class="keywordtype">int</span> disc_nMyElements = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a2cfd1cdbe58ce0b8e0d7fff094b468d2">disc_map</a>-&gt;NumMyElements();
<a name="l01323"></a>01323   <span class="keywordtype">int</span> my_nEigenvals = <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a5894c6bfeb505219673300d50c7742de">combined_SP_map</a>-&gt;NumMyElements() - disc_nMyElements * (1+<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>);
<a name="l01324"></a>01324   Epetra_Map dist_eigenval_map(<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>, my_nEigenvals, 0, *<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a7ff0cfa9b31d4960b80e14a94abfe6eb">myComm</a>);
<a name="l01325"></a>01325 
<a name="l01326"></a>01326   combinedVector-&gt;ExtractView(&amp;data); <span class="comment">//above call tests for failure</span>
<a name="l01327"></a>01327   eigenvalue_part = Teuchos::rcp(<span class="keyword">new</span> <span class="keyword">const</span> Epetra_Vector(::View, dist_eigenval_map, &amp;data[(1+<a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#ad2874294d7a17d32ba6adb4ee60fda2e">nEigenvals</a>)*disc_nMyElements]));
<a name="l01328"></a>01328 }
<a name="l01329"></a>01329 
<a name="l01330"></a>01330 
<a name="l01331"></a>01331 
<a name="l01332"></a>01332 <span class="comment">//Copied from Albany::SolverFactory -- used to validate applicaton parameters of applications not created via a SolverFactory</span>
<a name="l01333"></a>01333 Teuchos::RCP&lt;const Teuchos::ParameterList&gt;
<a name="l01334"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a730e0d7492576a70bdb7f2629e9ba1ba">01334</a> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#a730e0d7492576a70bdb7f2629e9ba1ba">QCAD::CoupledPoissonSchrodinger::getValidAppParameters</a>()<span class="keyword"> const</span>
<a name="l01335"></a>01335 <span class="keyword"></span>{  
<a name="l01336"></a>01336   Teuchos::RCP&lt;Teuchos::ParameterList&gt; validPL = Teuchos::rcp(<span class="keyword">new</span> Teuchos::ParameterList(<span class="stringliteral">&quot;ValidAppParams&quot;</span>));;
<a name="l01337"></a>01337   validPL-&gt;sublist(<span class="stringliteral">&quot;Problem&quot;</span>,            <span class="keyword">false</span>, <span class="stringliteral">&quot;Problem sublist&quot;</span>);
<a name="l01338"></a>01338   validPL-&gt;sublist(<span class="stringliteral">&quot;Debug Output&quot;</span>,       <span class="keyword">false</span>, <span class="stringliteral">&quot;Debug Output sublist&quot;</span>);
<a name="l01339"></a>01339   validPL-&gt;sublist(<span class="stringliteral">&quot;Discretization&quot;</span>,     <span class="keyword">false</span>, <span class="stringliteral">&quot;Discretization sublist&quot;</span>);
<a name="l01340"></a>01340   validPL-&gt;sublist(<span class="stringliteral">&quot;Quadrature&quot;</span>,         <span class="keyword">false</span>, <span class="stringliteral">&quot;Quadrature sublist&quot;</span>);
<a name="l01341"></a>01341   validPL-&gt;sublist(<span class="stringliteral">&quot;Regression Results&quot;</span>, <span class="keyword">false</span>, <span class="stringliteral">&quot;Regression Results sublist&quot;</span>);
<a name="l01342"></a>01342   validPL-&gt;sublist(<span class="stringliteral">&quot;VTK&quot;</span>,                <span class="keyword">false</span>, <span class="stringliteral">&quot;DEPRECATED  VTK sublist&quot;</span>);
<a name="l01343"></a>01343   validPL-&gt;sublist(<span class="stringliteral">&quot;Piro&quot;</span>,               <span class="keyword">false</span>, <span class="stringliteral">&quot;Piro sublist&quot;</span>);
<a name="l01344"></a>01344   validPL-&gt;sublist(<span class="stringliteral">&quot;Coupled System&quot;</span>,     <span class="keyword">false</span>, <span class="stringliteral">&quot;Coupled system sublist&quot;</span>);
<a name="l01345"></a>01345 
<a name="l01346"></a>01346   <span class="keywordflow">return</span> validPL;
<a name="l01347"></a>01347 }
<a name="l01348"></a>01348 
<a name="l01349"></a>01349 Teuchos::RCP&lt;const Teuchos::ParameterList&gt;
<a name="l01350"></a><a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa7534779d7610b69161f6517a0ae9ee9">01350</a> <a class="code" href="classQCAD_1_1CoupledPoissonSchrodinger.html#aa7534779d7610b69161f6517a0ae9ee9">QCAD::CoupledPoissonSchrodinger::getValidProblemParameters</a>()<span class="keyword"> const</span>
<a name="l01351"></a>01351 <span class="keyword"></span>{
<a name="l01352"></a>01352   Teuchos::RCP&lt;Teuchos::ParameterList&gt; validPL = Teuchos::createParameterList(<span class="stringliteral">&quot;ValidPoissonSchrodingerProblemParams&quot;</span>);
<a name="l01353"></a>01353 
<a name="l01354"></a>01354   validPL-&gt;set&lt;std::string&gt;(<span class="stringliteral">&quot;Name&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;String to designate Problem Class&quot;</span>);
<a name="l01355"></a>01355   validPL-&gt;set&lt;<span class="keywordtype">int</span>&gt;(<span class="stringliteral">&quot;Phalanx Graph Visualization Detail&quot;</span>, 0,
<a name="l01356"></a>01356                     <span class="stringliteral">&quot;Flag to select output of Phalanx Graph and level of detail&quot;</span>);
<a name="l01357"></a>01357 
<a name="l01358"></a>01358   validPL-&gt;set&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Length Unit In Meters&quot;</span>,1e-6,<span class="stringliteral">&quot;Length unit in meters&quot;</span>);
<a name="l01359"></a>01359   validPL-&gt;set&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Energy Unit In Electron Volts&quot;</span>,1.0,<span class="stringliteral">&quot;Energy (voltage) unit in electron volts&quot;</span>);
<a name="l01360"></a>01360   validPL-&gt;set&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Temperature&quot;</span>,300,<span class="stringliteral">&quot;Temperature in Kelvin&quot;</span>);
<a name="l01361"></a>01361   validPL-&gt;set&lt;std::string&gt;(<span class="stringliteral">&quot;MaterialDB Filename&quot;</span>,<span class="stringliteral">&quot;materials.xml&quot;</span>,<span class="stringliteral">&quot;Filename of material database xml file&quot;</span>);
<a name="l01362"></a>01362   validPL-&gt;set&lt;<span class="keywordtype">int</span>&gt;(<span class="stringliteral">&quot;Number of Eigenvalues&quot;</span>,0,<span class="stringliteral">&quot;The number of eigenvalue-eigenvector pairs&quot;</span>);
<a name="l01363"></a>01363   validPL-&gt;set&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;Verbose Output&quot;</span>,<span class="keyword">false</span>,<span class="stringliteral">&quot;Enable detailed output mode&quot;</span>);
<a name="l01364"></a>01364 
<a name="l01365"></a>01365   validPL-&gt;set&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;Include exchange-correlation potential&quot;</span>,<span class="keyword">false</span>,<span class="stringliteral">&quot;Include exchange-correlation potential in poisson source term&quot;</span>);
<a name="l01366"></a>01366   validPL-&gt;set&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;Only solve schrodinger in quantum blocks&quot;</span>,<span class="keyword">true</span>,<span class="stringliteral">&quot;Limit schrodinger solution to elements blocks labeled as quantum in the materials DB&quot;</span>);
<a name="l01367"></a>01367 
<a name="l01368"></a>01368   validPL-&gt;sublist(<span class="stringliteral">&quot;Poisson Problem&quot;</span>, <span class="keyword">false</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01369"></a>01369   validPL-&gt;sublist(<span class="stringliteral">&quot;Schrodinger Problem&quot;</span>, <span class="keyword">false</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01370"></a>01370 
<a name="l01371"></a>01371   <span class="comment">// Candidates for deprecation. Pertain to the solution rather than the problem definition.</span>
<a name="l01372"></a>01372   validPL-&gt;set&lt;std::string&gt;(<span class="stringliteral">&quot;Solution Method&quot;</span>, <span class="stringliteral">&quot;Steady&quot;</span>, <span class="stringliteral">&quot;Flag for Steady, Transient, or Continuation&quot;</span>);
<a name="l01373"></a>01373   
<a name="l01374"></a>01374   <span class="keywordflow">return</span> validPL;
<a name="l01375"></a>01375 }
<a name="l01376"></a>01376 
<a name="l01377"></a>01377 
<a name="l01378"></a>01378 <span class="comment">//This function is used solely for Jacobian debugging</span>
<a name="l01379"></a>01379 <span class="comment">/*void QCAD::CoupledPoissonSchrodinger::computeResidual(const Teuchos::RCP&lt;const Epetra_Vector&gt;&amp; x,</span>
<a name="l01380"></a>01380 <span class="comment">                  Teuchos::RCP&lt;Epetra_Vector&gt;&amp; f,</span>
<a name="l01381"></a>01381 <span class="comment">                  Teuchos::RCP&lt;Epetra_CrsMatrix&gt;&amp; massMx) const</span>
<a name="l01382"></a>01382 <span class="comment">{</span>
<a name="l01383"></a>01383 <span class="comment">  double curr_time = 0.0;</span>
<a name="l01384"></a>01384 <span class="comment">  Epetra_Vector M_vec(*disc_map);  //temp storage for mass matrix times vec -- maybe don&#39;t allocate this on the stack??</span>
<a name="l01385"></a>01385 <span class="comment">  Epetra_LocalMap local_eigenval_map(nEigenvals, 0, *myComm);</span>
<a name="l01386"></a>01386 <span class="comment"></span>
<a name="l01387"></a>01387 <span class="comment">  int disc_nMyElements = disc_map-&gt;NumMyElements();</span>
<a name="l01388"></a>01388 <span class="comment">  int my_nEigenvals = combined_SP_map-&gt;NumMyElements() - disc_nMyElements * (1+nEigenvals);</span>
<a name="l01389"></a>01389 <span class="comment"></span>
<a name="l01390"></a>01390 <span class="comment">  Teuchos::RCP&lt;const Epetra_Vector&gt; x_poisson, eigenvals_dist;</span>
<a name="l01391"></a>01391 <span class="comment">  Teuchos::RCP&lt;const Epetra_MultiVector&gt; x_schrodinger;</span>
<a name="l01392"></a>01392 <span class="comment">  separateCombinedVector(x, x_poisson, x_schrodinger, eigenvals_dist);</span>
<a name="l01393"></a>01393 <span class="comment"></span>
<a name="l01394"></a>01394 <span class="comment">  Teuchos::RCP&lt;Epetra_Vector&gt;   f_poisson, f_norm_local, f_norm_dist;</span>
<a name="l01395"></a>01395 <span class="comment">  Teuchos::RCP&lt;Epetra_MultiVector&gt; f_schrodinger;</span>
<a name="l01396"></a>01396 <span class="comment">  std::vector&lt;Epetra_Vector*&gt; f_schrodinger_vec(nEigenvals);</span>
<a name="l01397"></a>01397 <span class="comment">  separateCombinedVector(f, f_poisson, f_schrodinger, f_norm_dist);</span>
<a name="l01398"></a>01398 <span class="comment">  for(int i=0; i&lt;nEigenvals; i++) f_schrodinger_vec[i] = (*f_schrodinger)(i);</span>
<a name="l01399"></a>01399 <span class="comment">  f_norm_local = Teuchos::rcp(new Epetra_Vector(local_eigenval_map));</span>
<a name="l01400"></a>01400 <span class="comment"></span>
<a name="l01401"></a>01401 <span class="comment"></span>
<a name="l01402"></a>01402 <span class="comment">  //update schrodinger wavefunctions for poisson</span>
<a name="l01403"></a>01403 <span class="comment"></span>
<a name="l01404"></a>01404 <span class="comment">  Epetra_Import eigenval_importer(local_eigenval_map, eigenvals_dist-&gt;Map() );</span>
<a name="l01405"></a>01405 <span class="comment">  Teuchos::RCP&lt;Epetra_Vector&gt; eigenvals =  Teuchos::rcp(new Epetra_Vector(local_eigenval_map));</span>
<a name="l01406"></a>01406 <span class="comment">  eigenvals-&gt;Import(*eigenvals_dist, eigenval_importer, Insert);</span>
<a name="l01407"></a>01407 <span class="comment">  Teuchos::RCP&lt;std::vector&lt;double&gt; &gt; stdvec_eigenvals = Teuchos::rcp(new std::vector&lt;double&gt;(&amp;(*eigenvals)[0], &amp;(*eigenvals)[0] + nEigenvals));</span>
<a name="l01408"></a>01408 <span class="comment"></span>
<a name="l01409"></a>01409 <span class="comment">  Teuchos::RCP&lt;Albany::EigendataStruct&gt; eigenData = Teuchos::rcp( new Albany::EigendataStruct );</span>
<a name="l01410"></a>01410 <span class="comment">  eigenData-&gt;eigenvalueRe = stdvec_eigenvals;</span>
<a name="l01411"></a>01411 <span class="comment">  eigenData-&gt;eigenvectorRe = Teuchos::rcp(new Epetra_MultiVector(*disc_overlap_map, nEigenvals));</span>
<a name="l01412"></a>01412 <span class="comment">  eigenData-&gt;eigenvectorIm = Teuchos::null;</span>
<a name="l01413"></a>01413 <span class="comment">  Teuchos::RCP&lt;Epetra_Import&gt; overlap_importer = Teuchos::rcp(new Epetra_Import(*disc_overlap_map, *disc_map));</span>
<a name="l01414"></a>01414 <span class="comment"></span>
<a name="l01415"></a>01415 <span class="comment">  for(int i=0; i&lt;nEigenvals; i++)</span>
<a name="l01416"></a>01416 <span class="comment">    (*(eigenData-&gt;eigenvectorRe))(i)-&gt;Import( *((*x_schrodinger)(i)), *overlap_importer, Insert );</span>
<a name="l01417"></a>01417 <span class="comment"></span>
<a name="l01418"></a>01418 <span class="comment">    // set eigenvalues / eigenvectors for use in poisson problem:</span>
<a name="l01419"></a>01419 <span class="comment">  poissonApp-&gt;getStateMgr().setEigenData(eigenData);</span>
<a name="l01420"></a>01420 <span class="comment">  poissonApp-&gt;computeGlobalResidual(curr_time, NULL, *x_poisson, </span>
<a name="l01421"></a>01421 <span class="comment">            poisson_sacado_param_vec, *f_poisson);</span>
<a name="l01422"></a>01422 <span class="comment">      </span>
<a name="l01423"></a>01423 <span class="comment"></span>
<a name="l01424"></a>01424 <span class="comment">    // Get overlapped version of potential (x_poisson) for passing as auxData to schrodinger app</span>
<a name="l01425"></a>01425 <span class="comment">  Teuchos::RCP&lt;Epetra_MultiVector&gt; overlapped_V = Teuchos::rcp(new Epetra_MultiVector(*disc_overlap_map, 1));</span>
<a name="l01426"></a>01426 <span class="comment">  Teuchos::RCP&lt;Epetra_Vector&gt; ones_vec = Teuchos::rcp(new Epetra_Vector(*disc_overlap_map));</span>
<a name="l01427"></a>01427 <span class="comment">  ones_vec-&gt;PutScalar(1.0);</span>
<a name="l01428"></a>01428 <span class="comment">  (*overlapped_V)(0)-&gt;Import( *x_poisson, *overlap_importer, Insert );</span>
<a name="l01429"></a>01429 <span class="comment">  (*overlapped_V)(0)-&gt;Update(offset_to_CB, *ones_vec, -1.0);</span>
<a name="l01430"></a>01430 <span class="comment">  schrodingerApp-&gt;getStateMgr().setAuxData(overlapped_V);</span>
<a name="l01431"></a>01431 <span class="comment"></span>
<a name="l01432"></a>01432 <span class="comment">    // compute schrodinger Hamiltonian</span>
<a name="l01433"></a>01433 <span class="comment">  Teuchos::RCP&lt;Epetra_Operator&gt; hamMx = schrodingerModel-&gt;create_W(); //maybe re-use this and not create it every time?</span>
<a name="l01434"></a>01434 <span class="comment">  Teuchos::RCP&lt;Epetra_CrsMatrix&gt; hamMx_crs = Teuchos::rcp_dynamic_cast&lt;Epetra_CrsMatrix&gt;(hamMx, true);</span>
<a name="l01435"></a>01435 <span class="comment">  Teuchos::RCP&lt;const Epetra_Vector&gt; dummy_xdot = schrodingerModel-&gt;get_x_dot_init();</span>
<a name="l01436"></a>01436 <span class="comment">  schrodingerApp-&gt;computeGlobalJacobian(0.0, 1.0, 0.0, curr_time, dummy_xdot.get(), NULL, *((*x_schrodinger)(0)), </span>
<a name="l01437"></a>01437 <span class="comment">          schrodinger_sacado_param_vec, f_schrodinger_vec[0], *hamMx_crs);</span>
<a name="l01438"></a>01438 <span class="comment"></span>
<a name="l01439"></a>01439 <span class="comment">  for(int i=0; i&lt;nEigenvals; i++) {</span>
<a name="l01440"></a>01440 <span class="comment">    const Epetra_Vector&amp; vec = *((*x_schrodinger)(i));</span>
<a name="l01441"></a>01441 <span class="comment">    massMx-&gt;Multiply(false, vec, M_vec);  </span>
<a name="l01442"></a>01442 <span class="comment">    hamMx_crs-&gt;Multiply(false, vec, *(f_schrodinger_vec[i]));  </span>
<a name="l01443"></a>01443 <span class="comment">    f_schrodinger_vec[i]-&gt;Update( (*stdvec_eigenvals)[i], M_vec, 1.0); </span>
<a name="l01444"></a>01444 <span class="comment"></span>
<a name="l01445"></a>01445 <span class="comment">    // Compute normalization equation residuals:  f_norm[i] = abs(1 - evec[i] . M . evec[i])</span>
<a name="l01446"></a>01446 <span class="comment">    double vec_M_vec;</span>
<a name="l01447"></a>01447 <span class="comment">    vec.Dot( M_vec, &amp;vec_M_vec );</span>
<a name="l01448"></a>01448 <span class="comment">    (*f_norm_local)[i] = 1.0 - vec_M_vec;</span>
<a name="l01449"></a>01449 <span class="comment">  }</span>
<a name="l01450"></a>01450 <span class="comment"></span>
<a name="l01451"></a>01451 <span class="comment">  // Fill elements of f_norm_dist that belong to this processor, i.e. loop over</span>
<a name="l01452"></a>01452 <span class="comment">  // eigenvalue indices &quot;owned&quot; by the current proc in the combined distributed map</span>
<a name="l01453"></a>01453 <span class="comment">  std::vector&lt;int&gt; eval_global_elements(my_nEigenvals);</span>
<a name="l01454"></a>01454 <span class="comment">  eigenvals_dist-&gt;Map().MyGlobalElements(&amp;eval_global_elements[0]);</span>
<a name="l01455"></a>01455 <span class="comment">  for(int i=0; i&lt;my_nEigenvals; i++)</span>
<a name="l01456"></a>01456 <span class="comment">    (*f_norm_dist)[i] = (*f_norm_local)[eval_global_elements[i]];</span>
<a name="l01457"></a>01457 <span class="comment">}*/</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Mar 26 2014 18:36:43 for Albany: a Trilinos-based PDE code by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
