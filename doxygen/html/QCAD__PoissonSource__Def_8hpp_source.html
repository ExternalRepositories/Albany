<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Albany: a Trilinos-based PDE code: QCAD_PoissonSource_Def.hpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>QCAD_PoissonSource_Def.hpp</h1>  </div>
</div>
<div class="contents">
<a href="QCAD__PoissonSource__Def_8hpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//*****************************************************************//</span>
<a name="l00002"></a>00002 <span class="comment">//    Albany 2.0:  Copyright 2012 Sandia Corporation               //</span>
<a name="l00003"></a>00003 <span class="comment">//    This Software is released under the BSD license detailed     //</span>
<a name="l00004"></a>00004 <span class="comment">//    in the file &quot;license.txt&quot; in the top-level Albany directory  //</span>
<a name="l00005"></a>00005 <span class="comment">//*****************************************************************//</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;fstream&gt;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &quot;Teuchos_TestForException.hpp&quot;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;Phalanx_DataLayout.hpp&quot;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &quot;Sacado_ParameterRegistration.hpp&quot;</span>
<a name="l00011"></a>00011 
<a name="l00012"></a><a class="code" href="QCAD__PoissonSource__Def_8hpp.html#ae90a40206df0562d83f505df1b4ff940">00012</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="QCAD__PoissonSource__Def_8hpp.html#ae90a40206df0562d83f505df1b4ff940">MAX_MESH_REGIONS</a> = 30;
<a name="l00013"></a><a class="code" href="QCAD__PoissonSource__Def_8hpp.html#a30fc35931e40d85586b2da77734b4f25">00013</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="QCAD__PoissonSource__Def_8hpp.html#a30fc35931e40d85586b2da77734b4f25">MAX_POINT_CHARGES</a> = 10;
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l00016"></a>00016 <a class="code" href="classQCAD_1_1PoissonSource.html#af0cd3d49d254b2cb7c11422aa9672360">QCAD::PoissonSource&lt;EvalT, Traits&gt;::</a>
<a name="l00017"></a><a class="code" href="classQCAD_1_1PoissonSource.html#af0cd3d49d254b2cb7c11422aa9672360">00017</a> <a class="code" href="classQCAD_1_1PoissonSource.html#af0cd3d49d254b2cb7c11422aa9672360">PoissonSource</a>(Teuchos::ParameterList&amp; p,
<a name="l00018"></a>00018                  <span class="keyword">const</span> Teuchos::RCP&lt;Albany::Layouts&gt;&amp; dl) :
<a name="l00019"></a>00019   coordVec(p.get&lt;std::string&gt;(<span class="stringliteral">&quot;Coordinate Vector Name&quot;</span>), dl-&gt;qp_vector),
<a name="l00020"></a>00020   coordVecAtVertices(p.get&lt;std::string&gt;(<span class="stringliteral">&quot;Coordinate Vector Name&quot;</span>), dl-&gt;vertices_vector),
<a name="l00021"></a>00021   weights(<span class="stringliteral">&quot;Weights&quot;</span>, dl-&gt;qp_scalar),
<a name="l00022"></a>00022   potential(p.get&lt;std::string&gt;(<span class="stringliteral">&quot;Variable Name&quot;</span>), dl-&gt;qp_scalar),
<a name="l00023"></a>00023   temperatureField(p.get&lt;std::string&gt;(<span class="stringliteral">&quot;Temperature Name&quot;</span>), dl-&gt;shared_param),
<a name="l00024"></a>00024   poissonSource(p.get&lt;std::string&gt;(<span class="stringliteral">&quot;Source Name&quot;</span>), dl-&gt;qp_scalar),
<a name="l00025"></a>00025   chargeDensity(<span class="stringliteral">&quot;Charge Density&quot;</span>,dl-&gt;qp_scalar),
<a name="l00026"></a>00026   electronDensity(<span class="stringliteral">&quot;Electron Density&quot;</span>,dl-&gt;qp_scalar),
<a name="l00027"></a>00027   artCBDensity(<span class="stringliteral">&quot;Artificial Conduction Band Density&quot;</span>,dl-&gt;qp_scalar),
<a name="l00028"></a>00028   holeDensity(<span class="stringliteral">&quot;Hole Density&quot;</span>,dl-&gt;qp_scalar),
<a name="l00029"></a>00029   electricPotential(<span class="stringliteral">&quot;Electric Potential&quot;</span>,dl-&gt;qp_scalar),
<a name="l00030"></a>00030   ionizedDopant(<span class="stringliteral">&quot;Ionized Dopant&quot;</span>,dl-&gt;qp_scalar),
<a name="l00031"></a>00031   conductionBand(<span class="stringliteral">&quot;Conduction Band&quot;</span>,dl-&gt;qp_scalar),
<a name="l00032"></a>00032   valenceBand(<span class="stringliteral">&quot;Valence Band&quot;</span>,dl-&gt;qp_scalar),
<a name="l00033"></a>00033   approxQuanEDen(<span class="stringliteral">&quot;Approx Quantum EDensity&quot;</span>,dl-&gt;qp_scalar)
<a name="l00034"></a>00034 {
<a name="l00035"></a>00035   <span class="comment">// Material database</span>
<a name="l00036"></a>00036   <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a> = p.get&lt; Teuchos::RCP&lt;QCAD::MaterialDatabase&gt; &gt;(<span class="stringliteral">&quot;MaterialDB&quot;</span>);
<a name="l00037"></a>00037 
<a name="l00038"></a>00038   Teuchos::ParameterList* psList = p.get&lt;Teuchos::ParameterList*&gt;(<span class="stringliteral">&quot;Parameter List&quot;</span>);
<a name="l00039"></a>00039 
<a name="l00040"></a>00040   Teuchos::RCP&lt;const Teuchos::ParameterList&gt; reflist = 
<a name="l00041"></a>00041       this-&gt;<a class="code" href="classQCAD_1_1PoissonSource.html#a6d88da05f05cf07bfd84f77c8df89c59" title="Reference parameter list generator to check xml input file.">getValidPoissonSourceParameters</a>();
<a name="l00042"></a>00042   psList-&gt;validateParameters(*reflist,0);
<a name="l00043"></a>00043 
<a name="l00044"></a>00044   std::vector&lt;PHX::DataLayout::size_type&gt; dims;
<a name="l00045"></a>00045   dl-&gt;qp_vector-&gt;dimensions(dims);
<a name="l00046"></a>00046   <a class="code" href="classQCAD_1_1PoissonSource.html#aef0fb486fbdf94b26e96eb6096a236ea" title="input">numQPs</a>  = dims[1];
<a name="l00047"></a>00047   <a class="code" href="classQCAD_1_1PoissonSource.html#abe44f806525ae2ac13105e5f499fa120">numDims</a> = dims[2];
<a name="l00048"></a>00048   <a class="code" href="classQCAD_1_1PoissonSource.html#ab6f81ddb14492a98526d3a01bd93c579">numNodes</a> = dl-&gt;node_scalar-&gt;dimension(1);
<a name="l00049"></a>00049 
<a name="l00050"></a>00050   <span class="comment">// get values from the input .xml and use default values if not provided</span>
<a name="l00051"></a>00051   <a class="code" href="classQCAD_1_1PoissonSource.html#a3412793c06f499339644c5462b336350" title="constant prefactor parameter in source function">factor</a> = psList-&gt;get(<span class="stringliteral">&quot;Factor&quot;</span>, 1.0);
<a name="l00052"></a>00052   <a class="code" href="classQCAD_1_1PoissonSource.html#a02d934acafa77da5ca44517dbd198858" title="string variable to differ the various devices implementation">device</a> = psList-&gt;get(<span class="stringliteral">&quot;Device&quot;</span>, <span class="stringliteral">&quot;defaultdevice&quot;</span>);
<a name="l00053"></a>00053   <a class="code" href="classQCAD_1_1PoissonSource.html#aafe24aed82d6a0c44e6b4e0ef34f22a3" title="strings specifing the how the source term inside and outside the quantum regions are computed:...">nonQuantumRegionSource</a> = psList-&gt;get(<span class="stringliteral">&quot;Non Quantum Region Source&quot;</span>, <span class="stringliteral">&quot;semiclassical&quot;</span>);
<a name="l00054"></a>00054   <a class="code" href="classQCAD_1_1PoissonSource.html#ab4b4436c43160ef17f769bfb836dfa76">quantumRegionSource</a>    = psList-&gt;get(<span class="stringliteral">&quot;Quantum Region Source&quot;</span>, <span class="stringliteral">&quot;semiclassical&quot;</span>); 
<a name="l00055"></a>00055   <a class="code" href="classQCAD_1_1PoissonSource.html#aa64d94632888257f782d92459a27e6cb">imagPartOfCoulombSrc</a>   = psList-&gt;get&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;Imaginary Part of Coulomb Source&quot;</span>, <span class="keyword">false</span>); 
<a name="l00056"></a>00056   <a class="code" href="classQCAD_1_1PoissonSource.html#a36ac1600805580de01cffada6a8c6bf7" title="specify carrier statistics and incomplete ionization">carrierStatistics</a> = psList-&gt;get(<span class="stringliteral">&quot;Carrier Statistics&quot;</span>, <span class="stringliteral">&quot;Boltzmann Statistics&quot;</span>);
<a name="l00057"></a>00057   <a class="code" href="classQCAD_1_1PoissonSource.html#a25f70d6c90c767cade9c663081913bbf">incompIonization</a> = psList-&gt;get(<span class="stringliteral">&quot;Incomplete Ionization&quot;</span>, <span class="stringliteral">&quot;False&quot;</span>);
<a name="l00058"></a>00058   <a class="code" href="classQCAD_1_1PoissonSource.html#a623c1ec89816a9681889f657470d13f8" title="Schrodinger coupling.">bUsePredictorCorrector</a> = psList-&gt;get&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;Use predictor-corrector method&quot;</span>,<span class="keyword">false</span>);
<a name="l00059"></a>00059   <a class="code" href="classQCAD_1_1PoissonSource.html#a82105311f3e25ff3f753937ad13b048e">bIncludeVxc</a> = psList-&gt;get&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;Include exchange-correlation potential&quot;</span>,<span class="keyword">false</span>);
<a name="l00060"></a>00060   <a class="code" href="classQCAD_1_1PoissonSource.html#aa8297a03b834e0fdb82a82e8a57254aa">fixedQuantumOcc</a> = psList-&gt;get&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Fixed Quantum Occupation&quot;</span>,-1.0);
<a name="l00061"></a>00061 
<a name="l00062"></a>00062   <span class="comment">// find element blocks and voltages applied on them</span>
<a name="l00063"></a>00063   std::string preName = <span class="stringliteral">&quot;DBC on NS &quot;</span>; 
<a name="l00064"></a>00064   std::string postName = <span class="stringliteral">&quot; for DOF Phi&quot;</span>;
<a name="l00065"></a>00065   std::size_t preLen = preName.length();
<a name="l00066"></a>00066   std::size_t postLen = postName.length();  
<a name="l00067"></a>00067 
<a name="l00068"></a>00068   <span class="comment">// look through DBCs and pull out any element block names we find (for setting the Fermi level below)</span>
<a name="l00069"></a>00069   <span class="keyword">const</span> Teuchos::ParameterList&amp; dbcPList = *(p.get&lt;Teuchos::ParameterList*&gt;(<span class="stringliteral">&quot;Dirichlet BCs ParameterList&quot;</span>));
<a name="l00070"></a>00070   <span class="keywordflow">for</span> (Teuchos::ParameterList::ConstIterator model_it = dbcPList.begin();
<a name="l00071"></a>00071          model_it != dbcPList.end(); ++model_it)
<a name="l00072"></a>00072   {
<a name="l00073"></a>00073     <span class="comment">// retrieve the nodeset name</span>
<a name="l00074"></a>00074     <span class="keyword">const</span> std::string&amp; dbcName = model_it-&gt;first;
<a name="l00075"></a>00075     std::size_t nsNameLen = dbcName.length() - preLen - postLen;
<a name="l00076"></a>00076     std::string nsName = dbcName.substr(preLen, nsNameLen);
<a name="l00077"></a>00077     
<a name="l00078"></a>00078     <span class="comment">// obtain the element block associated with this nodeset (should be ohmic, NOT contact on insulator) </span>
<a name="l00079"></a>00079     <span class="keyword">const</span> std::string&amp; ebName = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getNodeSetParam&lt;std::string&gt;(nsName,<span class="stringliteral">&quot;elementBlock&quot;</span>,<span class="stringliteral">&quot;&quot;</span>);
<a name="l00080"></a>00080     
<a name="l00081"></a>00081     <span class="comment">// map the element block to its applied voltage</span>
<a name="l00082"></a>00082     <span class="keywordflow">if</span> (ebName.length() &gt; 0)
<a name="l00083"></a>00083     {
<a name="l00084"></a>00084       <span class="keywordtype">double</span> dbcValue = dbcPList.get&lt;<span class="keywordtype">double</span>&gt;(dbcName); 
<a name="l00085"></a>00085       <a class="code" href="classQCAD_1_1PoissonSource.html#a864e0c4a03bc1bb0835c09ed28b1fa3a" title="Map element block and nodeset names to their associated DBC values.">mapDBCValue_eb</a>[ebName] = dbcValue;
<a name="l00086"></a>00086       <a class="code" href="classQCAD_1_1PoissonSource.html#a583ba511f82963de327783e63caa7e03">mapDBCValue_ns</a>[nsName] = dbcValue;
<a name="l00087"></a>00087       <span class="comment">//std::cout &lt;&lt; &quot;ebName = &quot; &lt;&lt; ebName &lt;&lt; &quot;, value = &quot; &lt;&lt; mapDBCValue_eb[ebName] &lt;&lt; std::endl;  </span>
<a name="l00088"></a>00088     }
<a name="l00089"></a>00089   }
<a name="l00090"></a>00090 
<a name="l00091"></a>00091   <span class="comment">// specific values for &quot;1D MOSCapacitor&quot;</span>
<a name="l00092"></a>00092   <span class="keywordflow">if</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#a02d934acafa77da5ca44517dbd198858" title="string variable to differ the various devices implementation">device</a> == <span class="stringliteral">&quot;1D MOSCapacitor&quot;</span>) 
<a name="l00093"></a>00093   {
<a name="l00094"></a>00094     <a class="code" href="classQCAD_1_1PoissonSource.html#a600a98d5cfae07bfed715de5b1921c67" title="specific parameters for &amp;quot;1D MOSCapacitor&amp;quot;">oxideWidth</a> = psList-&gt;get(<span class="stringliteral">&quot;Oxide Width&quot;</span>, 0.);
<a name="l00095"></a>00095     <a class="code" href="classQCAD_1_1PoissonSource.html#a088df825b707a32305860e5913d3699f">siliconWidth</a> = psList-&gt;get(<span class="stringliteral">&quot;Silicon Width&quot;</span>, 0.);
<a name="l00096"></a>00096     <a class="code" href="classQCAD_1_1PoissonSource.html#ad270d3cb12f055bb9ae4451bb164c036">dopingAcceptor</a> = psList-&gt;get(<span class="stringliteral">&quot;Acceptor Doping&quot;</span>, 1e14);
<a name="l00097"></a>00097     <a class="code" href="classQCAD_1_1PoissonSource.html#aa6ddeee4caa5435d83dda36cc8459928">acceptorActE</a> = psList-&gt;get(<span class="stringliteral">&quot;Acceptor Activation Energy&quot;</span>, 0.045);
<a name="l00098"></a>00098   }
<a name="l00099"></a>00099   
<a name="l00100"></a>00100   <span class="comment">// passed down from main list</span>
<a name="l00101"></a>00101   <a class="code" href="classQCAD_1_1PoissonSource.html#aa7122e9b80328be00b7e50bf61d8c899" title="scaling parameters">length_unit_in_m</a> = p.get&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Length unit in m&quot;</span>);
<a name="l00102"></a>00102   <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a> = p.get&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Energy unit in eV&quot;</span>);
<a name="l00103"></a>00103 
<a name="l00104"></a>00104   <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#ab4b4436c43160ef17f769bfb836dfa76">quantumRegionSource</a> == <span class="stringliteral">&quot;schrodinger&quot;</span> || 
<a name="l00105"></a>00105      <a class="code" href="classQCAD_1_1PoissonSource.html#ab4b4436c43160ef17f769bfb836dfa76">quantumRegionSource</a> == <span class="stringliteral">&quot;coulomb&quot;</span> || 
<a name="l00106"></a>00106      <a class="code" href="classQCAD_1_1PoissonSource.html#ab4b4436c43160ef17f769bfb836dfa76">quantumRegionSource</a> == <span class="stringliteral">&quot;ci&quot;</span>) {
<a name="l00107"></a>00107     std::string evecFieldRoot = p.get&lt;std::string&gt;(<span class="stringliteral">&quot;Eigenvector field name root&quot;</span>);
<a name="l00108"></a>00108     <a class="code" href="classQCAD_1_1PoissonSource.html#a010071e79d375e65daf1d94d06800eb8">nEigenvectors</a> = psList-&gt;get&lt;<span class="keywordtype">int</span>&gt;(<span class="stringliteral">&quot;Eigenvectors to Import&quot;</span>);
<a name="l00109"></a>00109     <a class="code" href="classQCAD_1_1PoissonSource.html#abd84830c6ce3f9ede727b1a3ab07e654">bRealEigenvectors</a> = psList-&gt;get&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;Eigenvectors are Real&quot;</span>, <span class="keyword">false</span>);
<a name="l00110"></a>00110 
<a name="l00111"></a>00111     <span class="keywordtype">char</span> buf[200];
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     <a class="code" href="classQCAD_1_1PoissonSource.html#ad891c871c4223cebd6f5080b2beb6536">eigenvector_Re</a>.resize(nEigenvectors);
<a name="l00114"></a>00114     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; nEigenvectors; ++k) {
<a name="l00115"></a>00115       sprintf(buf, <span class="stringliteral">&quot;%s_Re%d&quot;</span>, evecFieldRoot.c_str(), k);
<a name="l00116"></a>00116       PHX::MDField&lt;ScalarT,Cell,QuadPoint&gt; fr(buf,dl-&gt;qp_scalar);
<a name="l00117"></a>00117       <a class="code" href="classQCAD_1_1PoissonSource.html#ad891c871c4223cebd6f5080b2beb6536">eigenvector_Re</a>[k] = fr; this-&gt;addDependentField(<a class="code" href="classQCAD_1_1PoissonSource.html#ad891c871c4223cebd6f5080b2beb6536">eigenvector_Re</a>[k]);
<a name="l00118"></a>00118     }
<a name="l00119"></a>00119 
<a name="l00120"></a>00120     <span class="keywordflow">if</span>(!bRealEigenvectors) {
<a name="l00121"></a>00121       <a class="code" href="classQCAD_1_1PoissonSource.html#ab042832dbe11625224d1969979c4685a">eigenvector_Im</a>.resize(nEigenvectors);
<a name="l00122"></a>00122       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; nEigenvectors; ++k) {
<a name="l00123"></a>00123   sprintf(buf, <span class="stringliteral">&quot;%s_Im%d&quot;</span>, evecFieldRoot.c_str(), k);
<a name="l00124"></a>00124   PHX::MDField&lt;ScalarT,Cell,QuadPoint&gt; fi(buf,dl-&gt;qp_scalar);
<a name="l00125"></a>00125   <a class="code" href="classQCAD_1_1PoissonSource.html#ab042832dbe11625224d1969979c4685a">eigenvector_Im</a>[k] = fi; this-&gt;addDependentField(<a class="code" href="classQCAD_1_1PoissonSource.html#ab042832dbe11625224d1969979c4685a">eigenvector_Im</a>[k]);
<a name="l00126"></a>00126       }
<a name="l00127"></a>00127     }
<a name="l00128"></a>00128   }
<a name="l00129"></a>00129   <span class="keywordflow">else</span> {
<a name="l00130"></a>00130     <a class="code" href="classQCAD_1_1PoissonSource.html#a010071e79d375e65daf1d94d06800eb8">nEigenvectors</a> = 0;
<a name="l00131"></a>00131   }
<a name="l00132"></a>00132 
<a name="l00133"></a>00133   <span class="comment">// Defaults</span>
<a name="l00134"></a>00134   <a class="code" href="classQCAD_1_1PoissonSource.html#a3346c7205b90aeb59b82004cad032f14">prevDensityMixingFactor</a> = -1.0; <span class="comment">//Flag that factor is unset... - sometimes this factor isn&#39;t set correctly within Albany framework, so HACK here</span>
<a name="l00135"></a>00135 
<a name="l00136"></a>00136   <span class="comment">// Add factor as a Sacado-ized parameter</span>
<a name="l00137"></a>00137   Teuchos::RCP&lt;ParamLib&gt; paramLib =
<a name="l00138"></a>00138     p.get&lt; Teuchos::RCP&lt;ParamLib&gt; &gt;(<span class="stringliteral">&quot;Parameter Library&quot;</span>, Teuchos::null);
<a name="l00139"></a>00139   <span class="keyword">new</span> Sacado::ParameterRegistration&lt;EvalT, SPL_Traits&gt;(
<a name="l00140"></a>00140       <span class="stringliteral">&quot;Poisson Source Factor&quot;</span>, <span class="keyword">this</span>, paramLib);
<a name="l00141"></a>00141 
<a name="l00142"></a>00142   <span class="comment">// Add parameters from material database as Sacado params</span>
<a name="l00143"></a>00143   std::vector&lt;std::string&gt; dopingParamNames = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getAllMatchingParams&lt;std::string&gt;(<span class="stringliteral">&quot;Doping Parameter Name&quot;</span>);
<a name="l00144"></a>00144   std::vector&lt;std::string&gt; chargeParamNames = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getAllMatchingParams&lt;std::string&gt;(<span class="stringliteral">&quot;Charge Parameter Name&quot;</span>);
<a name="l00145"></a>00145   
<a name="l00146"></a>00146   std::vector&lt;std::string&gt;::iterator s;
<a name="l00147"></a>00147   <span class="keywordflow">for</span>(s = dopingParamNames.begin(); s != dopingParamNames.end(); s++) {
<a name="l00148"></a>00148     <span class="keywordflow">if</span>( psList-&gt;isParameter(*s) ) {
<a name="l00149"></a>00149       <a class="code" href="classQCAD_1_1PoissonSource.html#ae5648f10426a7ed73e61668eb37bafd1" title="Material database parameter values.">materialParams</a>[*s] = psList-&gt;get&lt;<span class="keywordtype">double</span>&gt;(*s);
<a name="l00150"></a>00150       <span class="keyword">new</span> Sacado::ParameterRegistration&lt;EvalT, SPL_Traits&gt;(*s, <span class="keyword">this</span>, paramLib);
<a name="l00151"></a>00151     }
<a name="l00152"></a>00152   }
<a name="l00153"></a>00153   <span class="keywordflow">for</span>(s = chargeParamNames.begin(); s != chargeParamNames.end(); s++) {
<a name="l00154"></a>00154     <span class="keywordflow">if</span>( psList-&gt;isParameter(*s) ) {
<a name="l00155"></a>00155       <a class="code" href="classQCAD_1_1PoissonSource.html#ae5648f10426a7ed73e61668eb37bafd1" title="Material database parameter values.">materialParams</a>[*s] = psList-&gt;get&lt;<span class="keywordtype">double</span>&gt;(*s);
<a name="l00156"></a>00156       <span class="keyword">new</span> Sacado::ParameterRegistration&lt;EvalT, SPL_Traits&gt;(*s, <span class="keyword">this</span>, paramLib);
<a name="l00157"></a>00157     }
<a name="l00158"></a>00158   }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160   <span class="comment">//Add Mesh Region Parameters (factors which multiply RHS </span>
<a name="l00161"></a>00161   <span class="comment">//  of Poisson equation in a given mesh region)</span>
<a name="l00162"></a>00162   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="QCAD__PoissonSource__Def_8hpp.html#ae90a40206df0562d83f505df1b4ff940">MAX_MESH_REGIONS</a>; i++) {
<a name="l00163"></a>00163     std::string subListName = <a class="code" href="namespaceAlbany.html#a0825dc2de792b06ebb1ded9784d6a111" title="Utility to make a string out of a string + int: strint(&amp;quot;dog&amp;quot;,2) = &amp;quot;dog 2&amp;quot;...">Albany::strint</a>(<span class="stringliteral">&quot;Mesh Region&quot;</span>,i);
<a name="l00164"></a>00164     <span class="keywordflow">if</span>( psList-&gt;isSublist(subListName) ) {
<a name="l00165"></a>00165       std::string factorName = <a class="code" href="namespaceAlbany.html#a0825dc2de792b06ebb1ded9784d6a111" title="Utility to make a string out of a string + int: strint(&amp;quot;dog&amp;quot;,2) = &amp;quot;dog 2&amp;quot;...">Albany::strint</a>(<span class="stringliteral">&quot;Mesh Region Factor&quot;</span>,i);
<a name="l00166"></a>00166       <span class="keyword">new</span> Sacado::ParameterRegistration&lt;EvalT, SPL_Traits&gt;(factorName, <span class="keyword">this</span>, paramLib);      
<a name="l00167"></a>00167 
<a name="l00168"></a>00168       <span class="comment">// Validate sublist</span>
<a name="l00169"></a>00169       Teuchos::RCP&lt;const Teuchos::ParameterList&gt; regionreflist = 
<a name="l00170"></a>00170   <a class="code" href="classQCAD_1_1MeshRegion.html" title="A utility class that encapsulates a defined region of a mesh.">QCAD::MeshRegion&lt;EvalT, Traits&gt;::getValidParameters</a>();
<a name="l00171"></a>00171       Teuchos::ParameterList refsublist(*regionreflist);
<a name="l00172"></a>00172       refsublist.set&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Factor Value&quot;</span>,1.0,<span class="stringliteral">&quot;Initial value of the factor corresponding to this mesh region&quot;</span>);
<a name="l00173"></a>00173       psList-&gt;sublist(subListName).validateParameters(refsublist,0);
<a name="l00174"></a>00174 
<a name="l00175"></a>00175       <span class="comment">// Create MeshRegion object</span>
<a name="l00176"></a>00176       Teuchos::RCP&lt;QCAD::MeshRegion&lt;EvalT, Traits&gt; &gt; region = 
<a name="l00177"></a>00177   Teuchos::rcp( <span class="keyword">new</span> <a class="code" href="classQCAD_1_1MeshRegion.html" title="A utility class that encapsulates a defined region of a mesh.">QCAD::MeshRegion&lt;EvalT, Traits&gt;</a>(p.get&lt;std::string&gt;(<span class="stringliteral">&quot;Coordinate Vector Name&quot;</span>),
<a name="l00178"></a>00178                 <span class="stringliteral">&quot;Weights&quot;</span>,psList-&gt;sublist(subListName),<a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>,dl) );
<a name="l00179"></a>00179 
<a name="l00180"></a>00180       <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> value = psList-&gt;sublist(subListName).get&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Factor Value&quot;</span>,1.0);
<a name="l00181"></a>00181       <a class="code" href="classQCAD_1_1PoissonSource.html#a0d29163645d39c6b0a6f38574a32160f" title="Mesh Region parameters.">meshRegionList</a>.push_back(region);
<a name="l00182"></a>00182       <a class="code" href="classQCAD_1_1PoissonSource.html#afb63b216947d707542cb0b5ac73bacfd">meshRegionFactors</a>.push_back( value );
<a name="l00183"></a>00183     }
<a name="l00184"></a>00184     <span class="keywordflow">else</span> <span class="keywordflow">break</span>;
<a name="l00185"></a>00185   }
<a name="l00186"></a>00186 
<a name="l00187"></a>00187   <span class="comment">//Add Point Charges (later add the charge as a Sacado param?)</span>
<a name="l00188"></a>00188   <a class="code" href="classQCAD_1_1PoissonSource.html#a82816b9a2255db5d2d3f95c611f80755">numWorksetsScannedForPtCharges</a> = 0;
<a name="l00189"></a>00189   Teuchos::RCP&lt;Teuchos::ParameterList&gt; ptChargeValidPL =
<a name="l00190"></a>00190       rcp(<span class="keyword">new</span> Teuchos::ParameterList(<span class="stringliteral">&quot;Valid Point Charge Params&quot;</span>));
<a name="l00191"></a>00191   ptChargeValidPL-&gt;set&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;X&quot;</span>, 0.0, <span class="stringliteral">&quot;x-coordinate of point charge&quot;</span>);
<a name="l00192"></a>00192   ptChargeValidPL-&gt;set&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Y&quot;</span>, 0.0, <span class="stringliteral">&quot;y-coordinate of point charge&quot;</span>);
<a name="l00193"></a>00193   ptChargeValidPL-&gt;set&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Z&quot;</span>, 0.0, <span class="stringliteral">&quot;z-coordinate of point charge&quot;</span>);
<a name="l00194"></a>00194   ptChargeValidPL-&gt;set&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Charge&quot;</span>, 1.0, <span class="stringliteral">&quot;Amount of charge in units of the elementary charge (default = +1)&quot;</span>);
<a name="l00195"></a>00195 
<a name="l00196"></a>00196   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="QCAD__PoissonSource__Def_8hpp.html#a30fc35931e40d85586b2da77734b4f25">MAX_POINT_CHARGES</a>; i++) {
<a name="l00197"></a>00197     std::string subListName = <a class="code" href="namespaceAlbany.html#a0825dc2de792b06ebb1ded9784d6a111" title="Utility to make a string out of a string + int: strint(&amp;quot;dog&amp;quot;,2) = &amp;quot;dog 2&amp;quot;...">Albany::strint</a>(<span class="stringliteral">&quot;Point Charge&quot;</span>,i);
<a name="l00198"></a>00198     <span class="keywordflow">if</span>( psList-&gt;isSublist(subListName) ) {
<a name="l00199"></a>00199 
<a name="l00200"></a>00200       <span class="comment">// Validate sublist</span>
<a name="l00201"></a>00201       psList-&gt;sublist(subListName).validateParameters(*ptChargeValidPL,0);
<a name="l00202"></a>00202 
<a name="l00203"></a>00203       <span class="comment">// Fill PointCharge struct and add to vector (list)</span>
<a name="l00204"></a>00204       <span class="comment">// QCAD::PoissonSource&lt;EvalT, Traits&gt;::PointCharge ptCharge;</span>
<a name="l00205"></a>00205       <a class="code" href="structQCAD_1_1PoissonSource_1_1PointCharge.html" title="Point Charge parameters.">PointCharge</a> ptCharge;
<a name="l00206"></a>00206       ptCharge.<a class="code" href="structQCAD_1_1PoissonSource_1_1PointCharge.html#a210defa08fdd819d256bf92c791790c8">position</a>[0] = psList-&gt;sublist(subListName).get&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;X&quot;</span>,0.0);
<a name="l00207"></a>00207       ptCharge.<a class="code" href="structQCAD_1_1PoissonSource_1_1PointCharge.html#a210defa08fdd819d256bf92c791790c8">position</a>[1] = psList-&gt;sublist(subListName).get&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Y&quot;</span>,0.0);
<a name="l00208"></a>00208       ptCharge.<a class="code" href="structQCAD_1_1PoissonSource_1_1PointCharge.html#a210defa08fdd819d256bf92c791790c8">position</a>[2] = psList-&gt;sublist(subListName).get&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Z&quot;</span>,0.0);
<a name="l00209"></a>00209       ptCharge.<a class="code" href="structQCAD_1_1PoissonSource_1_1PointCharge.html#a2083b0fabe91111bfd48f5423b5a698d">charge</a> = psList-&gt;sublist(subListName).get&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Charge&quot;</span>,+1.0);
<a name="l00210"></a>00210       ptCharge.<a class="code" href="structQCAD_1_1PoissonSource_1_1PointCharge.html#a4213c6233a743d49ed6ba34de85e4854">iWorkset</a> = ptCharge.<a class="code" href="structQCAD_1_1PoissonSource_1_1PointCharge.html#a90d6251c78fb3d4b67fe55dc954d24b5">iCell</a> = -1;  <span class="comment">// indicates workset &amp; cell are unknown</span>
<a name="l00211"></a>00211       
<a name="l00212"></a>00212       <a class="code" href="classQCAD_1_1PoissonSource.html#af42c69cb97e2192f19b9574ec492b1a6">pointCharges</a>.push_back(ptCharge);
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214     <span class="keywordflow">else</span> <span class="keywordflow">break</span>;
<a name="l00215"></a>00215   }
<a name="l00216"></a>00216 
<a name="l00217"></a>00217 
<a name="l00218"></a>00218   <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#ab4b4436c43160ef17f769bfb836dfa76">quantumRegionSource</a> == <span class="stringliteral">&quot;schrodinger&quot;</span>) {
<a name="l00219"></a>00219     <span class="keyword">new</span> Sacado::ParameterRegistration&lt;EvalT, SPL_Traits&gt;(<span class="stringliteral">&quot;Previous Quantum Density Mixing Factor&quot;</span>, <span class="keyword">this</span>, paramLib);
<a name="l00220"></a>00220   }
<a name="l00221"></a>00221   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#ab4b4436c43160ef17f769bfb836dfa76">quantumRegionSource</a> == <span class="stringliteral">&quot;coulomb&quot;</span>) {
<a name="l00222"></a>00222     <span class="comment">//Add Sacado parameters to set indices of eigenvectors to be multipled together</span>
<a name="l00223"></a>00223     <span class="keyword">new</span> Sacado::ParameterRegistration&lt;EvalT, SPL_Traits&gt;(<span class="stringliteral">&quot;Source Eigenvector 1&quot;</span>, <span class="keyword">this</span>, paramLib);
<a name="l00224"></a>00224     <span class="keyword">new</span> Sacado::ParameterRegistration&lt;EvalT, SPL_Traits&gt;(<span class="stringliteral">&quot;Source Eigenvector 2&quot;</span>, <span class="keyword">this</span>, paramLib);
<a name="l00225"></a>00225   }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227   this-&gt;addDependentField(<a class="code" href="classQCAD_1_1PoissonSource.html#ae66f55a004430bfc3497f006bdbe7f01">potential</a>);
<a name="l00228"></a>00228   this-&gt;addDependentField(<a class="code" href="classQCAD_1_1PoissonSource.html#a40266aa4c302576de741269de6565d90">coordVec</a>);
<a name="l00229"></a>00229   this-&gt;addDependentField(<a class="code" href="classQCAD_1_1PoissonSource.html#a3ad4b77aa3b399f00b5174bc9a1dc852">coordVecAtVertices</a>);
<a name="l00230"></a>00230   this-&gt;addDependentField(<a class="code" href="classQCAD_1_1PoissonSource.html#ae7a966a84cafaf80881e2a1cd7ab1506">weights</a>);
<a name="l00231"></a>00231   this-&gt;addDependentField(<a class="code" href="classQCAD_1_1PoissonSource.html#acbec0daaf0a9c9de29056d17c577bcdc">temperatureField</a>);
<a name="l00232"></a>00232     
<a name="l00233"></a>00233   <span class="keyword">typename</span> std::vector&lt; Teuchos::RCP&lt;MeshRegion&lt;EvalT, Traits&gt; &gt; &gt;::iterator it;
<a name="l00234"></a>00234   <span class="keywordflow">for</span>(it = <a class="code" href="classQCAD_1_1PoissonSource.html#a0d29163645d39c6b0a6f38574a32160f" title="Mesh Region parameters.">meshRegionList</a>.begin(); it != <a class="code" href="classQCAD_1_1PoissonSource.html#a0d29163645d39c6b0a6f38574a32160f" title="Mesh Region parameters.">meshRegionList</a>.end(); it++)
<a name="l00235"></a>00235     (*it)-&gt;addDependentFields(<span class="keyword">this</span>);
<a name="l00236"></a>00236 
<a name="l00237"></a>00237   this-&gt;addEvaluatedField(<a class="code" href="classQCAD_1_1PoissonSource.html#a4d3f473e00eac7aafe120bd596db647d" title="output">poissonSource</a>);
<a name="l00238"></a>00238   this-&gt;addEvaluatedField(<a class="code" href="classQCAD_1_1PoissonSource.html#ae574ccc85e9e3986d56b1b1b6b7a924d">chargeDensity</a>);
<a name="l00239"></a>00239   this-&gt;addEvaluatedField(<a class="code" href="classQCAD_1_1PoissonSource.html#a0a2d8a657e36facc1df8e509228910b8">electronDensity</a>);
<a name="l00240"></a>00240   this-&gt;addEvaluatedField(<a class="code" href="classQCAD_1_1PoissonSource.html#a0300c56c6a9ff5b939d79b2598dd7800">artCBDensity</a>);
<a name="l00241"></a>00241   this-&gt;addEvaluatedField(<a class="code" href="classQCAD_1_1PoissonSource.html#a33c2a1c3d6884eb0ff1ef71522e55716">holeDensity</a>);
<a name="l00242"></a>00242   this-&gt;addEvaluatedField(<a class="code" href="classQCAD_1_1PoissonSource.html#a47708a787cf7f127b0ef44b7d658d42f">electricPotential</a>);
<a name="l00243"></a>00243   this-&gt;addEvaluatedField(<a class="code" href="classQCAD_1_1PoissonSource.html#aec699e0c6ff57c1fe2100610abe6ac70">ionizedDopant</a>);
<a name="l00244"></a>00244   this-&gt;addEvaluatedField(<a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>);
<a name="l00245"></a>00245   this-&gt;addEvaluatedField(<a class="code" href="classQCAD_1_1PoissonSource.html#ac3d211c7dfc559d0b5d6903cb2509e63">valenceBand</a>);
<a name="l00246"></a>00246   this-&gt;addEvaluatedField(<a class="code" href="classQCAD_1_1PoissonSource.html#a862d9a94dfdeca69318880357360f2b4">approxQuanEDen</a>);
<a name="l00247"></a>00247   
<a name="l00248"></a>00248   this-&gt;setName(<span class="stringliteral">&quot;Poisson Source&quot;</span>+PHX::TypeString&lt;EvalT&gt;::value);
<a name="l00249"></a>00249 }
<a name="l00250"></a>00250 
<a name="l00251"></a>00251 <span class="comment">// **********************************************************************</span>
<a name="l00252"></a>00252 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l00253"></a>00253 <span class="keywordtype">void</span> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT, Traits&gt;::</a>
<a name="l00254"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a35d97f5bc0b53437c78a1e120f6e864a">00254</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">postRegistrationSetup</a>(<span class="keyword">typename</span> Traits::SetupData d,
<a name="l00255"></a>00255                       PHX::FieldManager&lt;Traits&gt;&amp; fm)
<a name="l00256"></a>00256 {
<a name="l00257"></a>00257   this-&gt;utils.setFieldData(<a class="code" href="classQCAD_1_1PoissonSource.html#a4d3f473e00eac7aafe120bd596db647d" title="output">poissonSource</a>,fm);
<a name="l00258"></a>00258   this-&gt;utils.setFieldData(<a class="code" href="classQCAD_1_1PoissonSource.html#ae66f55a004430bfc3497f006bdbe7f01">potential</a>,fm);
<a name="l00259"></a>00259   this-&gt;utils.setFieldData(<a class="code" href="classQCAD_1_1PoissonSource.html#a40266aa4c302576de741269de6565d90">coordVec</a>,fm);
<a name="l00260"></a>00260   this-&gt;utils.setFieldData(<a class="code" href="classQCAD_1_1PoissonSource.html#a3ad4b77aa3b399f00b5174bc9a1dc852">coordVecAtVertices</a>,fm);
<a name="l00261"></a>00261   this-&gt;utils.setFieldData(<a class="code" href="classQCAD_1_1PoissonSource.html#ae7a966a84cafaf80881e2a1cd7ab1506">weights</a>,fm);
<a name="l00262"></a>00262   this-&gt;utils.setFieldData(<a class="code" href="classQCAD_1_1PoissonSource.html#acbec0daaf0a9c9de29056d17c577bcdc">temperatureField</a>,fm);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264   this-&gt;utils.setFieldData(<a class="code" href="classQCAD_1_1PoissonSource.html#ae574ccc85e9e3986d56b1b1b6b7a924d">chargeDensity</a>,fm);
<a name="l00265"></a>00265   this-&gt;utils.setFieldData(<a class="code" href="classQCAD_1_1PoissonSource.html#a0a2d8a657e36facc1df8e509228910b8">electronDensity</a>,fm);
<a name="l00266"></a>00266   this-&gt;utils.setFieldData(<a class="code" href="classQCAD_1_1PoissonSource.html#a0300c56c6a9ff5b939d79b2598dd7800">artCBDensity</a>,fm);
<a name="l00267"></a>00267   this-&gt;utils.setFieldData(<a class="code" href="classQCAD_1_1PoissonSource.html#a33c2a1c3d6884eb0ff1ef71522e55716">holeDensity</a>,fm);
<a name="l00268"></a>00268   this-&gt;utils.setFieldData(<a class="code" href="classQCAD_1_1PoissonSource.html#a47708a787cf7f127b0ef44b7d658d42f">electricPotential</a>,fm);
<a name="l00269"></a>00269 
<a name="l00270"></a>00270   this-&gt;utils.setFieldData(<a class="code" href="classQCAD_1_1PoissonSource.html#aec699e0c6ff57c1fe2100610abe6ac70">ionizedDopant</a>,fm);
<a name="l00271"></a>00271   this-&gt;utils.setFieldData(<a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>,fm);
<a name="l00272"></a>00272   this-&gt;utils.setFieldData(<a class="code" href="classQCAD_1_1PoissonSource.html#ac3d211c7dfc559d0b5d6903cb2509e63">valenceBand</a>,fm);
<a name="l00273"></a>00273   this-&gt;utils.setFieldData(<a class="code" href="classQCAD_1_1PoissonSource.html#a862d9a94dfdeca69318880357360f2b4">approxQuanEDen</a>,fm);
<a name="l00274"></a>00274 
<a name="l00275"></a>00275   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; <a class="code" href="classQCAD_1_1PoissonSource.html#a010071e79d375e65daf1d94d06800eb8">nEigenvectors</a>; ++k)
<a name="l00276"></a>00276     this-&gt;utils.setFieldData(<a class="code" href="classQCAD_1_1PoissonSource.html#ad891c871c4223cebd6f5080b2beb6536">eigenvector_Re</a>[k],fm);
<a name="l00277"></a>00277 
<a name="l00278"></a>00278   <span class="keywordflow">if</span>(!<a class="code" href="classQCAD_1_1PoissonSource.html#abd84830c6ce3f9ede727b1a3ab07e654">bRealEigenvectors</a>) {
<a name="l00279"></a>00279     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; nEigenvectors; ++k)
<a name="l00280"></a>00280       this-&gt;utils.setFieldData(<a class="code" href="classQCAD_1_1PoissonSource.html#ab042832dbe11625224d1969979c4685a">eigenvector_Im</a>[k],fm);
<a name="l00281"></a>00281   }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283   <span class="keyword">typename</span> std::vector&lt; Teuchos::RCP&lt;MeshRegion&lt;EvalT, Traits&gt; &gt; &gt;::iterator it;
<a name="l00284"></a>00284   <span class="keywordflow">for</span>(it = <a class="code" href="classQCAD_1_1PoissonSource.html#a0d29163645d39c6b0a6f38574a32160f" title="Mesh Region parameters.">meshRegionList</a>.begin(); it != <a class="code" href="classQCAD_1_1PoissonSource.html#a0d29163645d39c6b0a6f38574a32160f" title="Mesh Region parameters.">meshRegionList</a>.end(); it++)
<a name="l00285"></a>00285     (*it)-&gt;postRegistrationSetup(fm);
<a name="l00286"></a>00286 
<a name="l00287"></a>00287 }
<a name="l00288"></a>00288 
<a name="l00289"></a>00289 <span class="comment">// **********************************************************************</span>
<a name="l00290"></a>00290 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l00291"></a>00291 <span class="keywordtype">void</span> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT, Traits&gt;::</a>
<a name="l00292"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a835628c5d1b55dd713cc99a058dc4416">00292</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">evaluateFields</a>(<span class="keyword">typename</span> Traits::EvalData workset)
<a name="l00293"></a>00293 {
<a name="l00294"></a>00294   <span class="keywordflow">if</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#a02d934acafa77da5ca44517dbd198858" title="string variable to differ the various devices implementation">device</a> == <span class="stringliteral">&quot;elementblocks&quot;</span>) <a class="code" href="classQCAD_1_1PoissonSource.html#a9957cabfa6a11dd8bbf28683e93a29bb" title="evaluateFields functions for different device types (device specified in xml input)">evaluateFields_elementblocks</a>(workset);
<a name="l00295"></a>00295   
<a name="l00296"></a>00296   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#a02d934acafa77da5ca44517dbd198858" title="string variable to differ the various devices implementation">device</a> == <span class="stringliteral">&quot;1D MOSCapacitor&quot;</span>) <a class="code" href="classQCAD_1_1PoissonSource.html#a01199b06e2a621b3e4018dda0260928c">evaluateFields_moscap1d</a>(workset);
<a name="l00297"></a>00297 
<a name="l00299"></a>00299   <span class="keywordflow">else</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a8d66177e07c78eded5d5b661748b3394">evaluateFields_default</a>(workset);
<a name="l00300"></a>00300 }
<a name="l00301"></a>00301 
<a name="l00302"></a>00302 <span class="comment">// **********************************************************************</span>
<a name="l00303"></a>00303 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT,<span class="keyword">typename</span> Traits&gt;
<a name="l00304"></a>00304 <span class="keyword">typename</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">QCAD::PoissonSource&lt;EvalT,Traits&gt;::ScalarT</a>&amp; 
<a name="l00305"></a><a class="code" href="classQCAD_1_1PoissonSource.html#aaa94e8c5311e5079cdcb17321c859e08">00305</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::getValue</a>(<span class="keyword">const</span> std::string &amp;<a class="code" href="MOR__ExtendedEpetraLapack_8cpp.html#af5da5165aa5eeff113accece5748c995">n</a>)
<a name="l00306"></a>00306 {
<a name="l00307"></a>00307   <span class="keywordflow">if</span>(n == <span class="stringliteral">&quot;Poisson Source Factor&quot;</span>) <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a3412793c06f499339644c5462b336350" title="constant prefactor parameter in source function">factor</a>;
<a name="l00308"></a>00308   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="classQCAD_1_1PoissonSource.html#ae5648f10426a7ed73e61668eb37bafd1" title="Material database parameter values.">materialParams</a>.find(n) != <a class="code" href="classQCAD_1_1PoissonSource.html#ae5648f10426a7ed73e61668eb37bafd1" title="Material database parameter values.">materialParams</a>.end() ) <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1PoissonSource.html#ae5648f10426a7ed73e61668eb37bafd1" title="Material database parameter values.">materialParams</a>[n];
<a name="l00309"></a>00309   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( n == <span class="stringliteral">&quot;Source Eigenvector 1&quot;</span>) <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a408a43093d96179b73a76e159ede1dc0">sourceEvecInds</a>[0];
<a name="l00310"></a>00310   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( n == <span class="stringliteral">&quot;Source Eigenvector 2&quot;</span>) <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a408a43093d96179b73a76e159ede1dc0">sourceEvecInds</a>[1];
<a name="l00311"></a>00311   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( n == <span class="stringliteral">&quot;Previous Quantum Density Mixing Factor&quot;</span>) <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a3346c7205b90aeb59b82004cad032f14">prevDensityMixingFactor</a>;
<a name="l00312"></a>00312   <span class="keywordflow">else</span> {
<a name="l00313"></a>00313     <span class="keywordtype">int</span> nRegions = <a class="code" href="classQCAD_1_1PoissonSource.html#afb63b216947d707542cb0b5ac73bacfd">meshRegionFactors</a>.size();
<a name="l00314"></a>00314     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;nRegions; i++)
<a name="l00315"></a>00315       <span class="keywordflow">if</span>( n == <a class="code" href="namespaceAlbany.html#a0825dc2de792b06ebb1ded9784d6a111" title="Utility to make a string out of a string + int: strint(&amp;quot;dog&amp;quot;,2) = &amp;quot;dog 2&amp;quot;...">Albany::strint</a>(<span class="stringliteral">&quot;Mesh Region Factor&quot;</span>,i) ) <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1PoissonSource.html#afb63b216947d707542cb0b5ac73bacfd">meshRegionFactors</a>[i];
<a name="l00316"></a>00316 
<a name="l00317"></a>00317     TEUCHOS_TEST_FOR_EXCEPT(<span class="keyword">true</span>); 
<a name="l00318"></a>00318     <span class="keywordflow">return</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a3412793c06f499339644c5462b336350" title="constant prefactor parameter in source function">factor</a>; <span class="comment">//dummy so all control paths return</span>
<a name="l00319"></a>00319   }
<a name="l00320"></a>00320 }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322 <span class="comment">// **********************************************************************</span>
<a name="l00323"></a>00323 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT,<span class="keyword">typename</span> Traits&gt;
<a name="l00324"></a>00324 Teuchos::RCP&lt;const Teuchos::ParameterList&gt;
<a name="l00325"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a6d88da05f05cf07bfd84f77c8df89c59">00325</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::getValidPoissonSourceParameters</a>()<span class="keyword"> const</span>
<a name="l00326"></a>00326 <span class="keyword"></span>{
<a name="l00327"></a>00327   Teuchos::RCP&lt;Teuchos::ParameterList&gt; validPL =
<a name="l00328"></a>00328        rcp(<span class="keyword">new</span> Teuchos::ParameterList(<span class="stringliteral">&quot;Valid Poisson Problem Params&quot;</span>));;
<a name="l00329"></a>00329 
<a name="l00330"></a>00330   validPL-&gt;set&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Factor&quot;</span>, 1.0, <span class="stringliteral">&quot;Constant multiplier in source term&quot;</span>);
<a name="l00331"></a>00331   validPL-&gt;set&lt;std::string&gt;(<span class="stringliteral">&quot;Device&quot;</span>, <span class="stringliteral">&quot;defaultdevice&quot;</span>, <span class="stringliteral">&quot;Switch between different device models&quot;</span>);
<a name="l00332"></a>00332   validPL-&gt;set&lt;std::string&gt;(<span class="stringliteral">&quot;Non Quantum Region Source&quot;</span>, <span class="stringliteral">&quot;semiclassical&quot;</span>, <span class="stringliteral">&quot;Source type for non-quantum regions&quot;</span>);
<a name="l00333"></a>00333   validPL-&gt;set&lt;std::string&gt;(<span class="stringliteral">&quot;Quantum Region Source&quot;</span>, <span class="stringliteral">&quot;semiclassical&quot;</span>, <span class="stringliteral">&quot;Source type for quantum regions&quot;</span>);
<a name="l00334"></a>00334   validPL-&gt;set&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;Imaginary Part Of Coulomb Source&quot;</span>,<span class="keyword">false</span>,<span class="stringliteral">&quot;Whether to use imag or real part of coulomb quantum region source&quot;</span>);
<a name="l00335"></a>00335   <span class="comment">//validPL-&gt;set&lt;double&gt;(&quot;Donor Doping&quot;, 1e14, &quot;Doping for nsilicon element blocks [cm^-3]&quot;);</span>
<a name="l00336"></a>00336   validPL-&gt;set&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Acceptor Doping&quot;</span>, 1e14, <span class="stringliteral">&quot;Doping for psilicon element blocks [cm^-3]&quot;</span>);
<a name="l00337"></a>00337   validPL-&gt;set&lt;std::string&gt;(<span class="stringliteral">&quot;Carrier Statistics&quot;</span>, <span class="stringliteral">&quot;Boltzmann Statistics&quot;</span>, <span class="stringliteral">&quot;Carrier statistics&quot;</span>);
<a name="l00338"></a>00338   validPL-&gt;set&lt;std::string&gt;(<span class="stringliteral">&quot;Incomplete Ionization&quot;</span>, <span class="stringliteral">&quot;False&quot;</span>, <span class="stringliteral">&quot;Partial ionization of dopants&quot;</span>);
<a name="l00339"></a>00339   <span class="comment">//validPL-&gt;set&lt;double&gt;(&quot;Donor Activation Energy&quot;, 0.045, &quot;Donor activation energy [eV]&quot;);</span>
<a name="l00340"></a>00340   validPL-&gt;set&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Acceptor Activation Energy&quot;</span>, 0.045, <span class="stringliteral">&quot;Acceptor activation energy [eV]&quot;</span>);
<a name="l00341"></a>00341   validPL-&gt;set&lt;<span class="keywordtype">int</span>&gt;(<span class="stringliteral">&quot;Eigenvectors to Import&quot;</span>, 0, <span class="stringliteral">&quot;Number of eigenvectors to take from eigendata information&quot;</span>);
<a name="l00342"></a>00342   validPL-&gt;set&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;Eigenvectors are Real&quot;</span>, <span class="keyword">false</span>, <span class="stringliteral">&quot;Whether eigenvectors contain imaginary parts (which should be imported)&quot;</span>);
<a name="l00343"></a>00343   validPL-&gt;set&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;Use predictor-corrector method&quot;</span>,<span class="keyword">false</span>, <span class="stringliteral">&quot;Enable use of predictor-corrector method for S-P iterations&quot;</span>);
<a name="l00344"></a>00344   validPL-&gt;set&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;Include exchange-correlation potential&quot;</span>,<span class="keyword">false</span>, <span class="stringliteral">&quot;Include the exchange correlation term in the output potential state&quot;</span>);
<a name="l00345"></a>00345   validPL-&gt;set&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;Imaginary Part of Coulomb Source&quot;</span>,<span class="keyword">false</span>,<span class="stringliteral">&quot;When &#39;Quantum Region Source&#39; equals &#39;coulomb&#39;, whether to use imaginary or real part as source term.&quot;</span>);
<a name="l00346"></a>00346   validPL-&gt;set&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Fixed Quantum Occupation&quot;</span>,-1.0, <span class="stringliteral">&quot;The fixed number of quantum orbitals (one orbital == spin * valley degeneracy e-) to fill (non-equilibrium).&quot;</span>);
<a name="l00347"></a>00347 
<a name="l00348"></a>00348   validPL-&gt;set&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Oxide Width&quot;</span>, 0., <span class="stringliteral">&quot;Oxide width for 1D MOSCapacitor device&quot;</span>);
<a name="l00349"></a>00349   validPL-&gt;set&lt;<span class="keywordtype">double</span>&gt;(<span class="stringliteral">&quot;Silicon Width&quot;</span>, 0., <span class="stringliteral">&quot;Silicon width for 1D MOSCapacitor device&quot;</span>);
<a name="l00350"></a>00350   
<a name="l00351"></a>00351   std::vector&lt;std::string&gt; dopingParamNames = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getAllMatchingParams&lt;std::string&gt;(<span class="stringliteral">&quot;Doping Parameter Name&quot;</span>);
<a name="l00352"></a>00352   std::vector&lt;std::string&gt; chargeParamNames = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getAllMatchingParams&lt;std::string&gt;(<span class="stringliteral">&quot;Charge Parameter Name&quot;</span>);
<a name="l00353"></a>00353   std::vector&lt;std::string&gt;::iterator s;
<a name="l00354"></a>00354   <span class="keywordflow">for</span>(s = dopingParamNames.begin(); s != dopingParamNames.end(); s++)
<a name="l00355"></a>00355     validPL-&gt;set&lt;<span class="keywordtype">double</span>&gt;( *s, 0.0, <span class="stringliteral">&quot;Doping Parameter [cm^-3]&quot;</span>);
<a name="l00356"></a>00356   <span class="keywordflow">for</span>(s = chargeParamNames.begin(); s != chargeParamNames.end(); s++)
<a name="l00357"></a>00357     validPL-&gt;set&lt;<span class="keywordtype">double</span>&gt;( *s, 0.0, <span class="stringliteral">&quot;Charge Parameter [cm^-3]&quot;</span>);
<a name="l00358"></a>00358 
<a name="l00359"></a>00359   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="QCAD__PoissonSource__Def_8hpp.html#ae90a40206df0562d83f505df1b4ff940">MAX_MESH_REGIONS</a>; i++) {
<a name="l00360"></a>00360     std::string subListName = <a class="code" href="namespaceAlbany.html#a0825dc2de792b06ebb1ded9784d6a111" title="Utility to make a string out of a string + int: strint(&amp;quot;dog&amp;quot;,2) = &amp;quot;dog 2&amp;quot;...">Albany::strint</a>(<span class="stringliteral">&quot;Mesh Region&quot;</span>,i);
<a name="l00361"></a>00361     validPL-&gt;sublist(subListName, <span class="keyword">false</span>, <span class="stringliteral">&quot;Sublist defining a mesh region&quot;</span>);
<a name="l00362"></a>00362   }
<a name="l00363"></a>00363 
<a name="l00364"></a>00364   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="QCAD__PoissonSource__Def_8hpp.html#a30fc35931e40d85586b2da77734b4f25">MAX_POINT_CHARGES</a>; i++) {
<a name="l00365"></a>00365     std::string subListName = <a class="code" href="namespaceAlbany.html#a0825dc2de792b06ebb1ded9784d6a111" title="Utility to make a string out of a string + int: strint(&amp;quot;dog&amp;quot;,2) = &amp;quot;dog 2&amp;quot;...">Albany::strint</a>(<span class="stringliteral">&quot;Point Charge&quot;</span>,i);
<a name="l00366"></a>00366     validPL-&gt;sublist(subListName, <span class="keyword">false</span>, <span class="stringliteral">&quot;Sublist defining a point charge&quot;</span>);
<a name="l00367"></a>00367   }
<a name="l00368"></a>00368   
<a name="l00369"></a>00369   <span class="keywordflow">return</span> validPL;
<a name="l00370"></a>00370 }
<a name="l00371"></a>00371 
<a name="l00372"></a>00372 
<a name="l00373"></a>00373 <span class="comment">// *****************************************************************************</span>
<a name="l00374"></a>00374 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l00375"></a>00375 <span class="keywordtype">void</span> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT, Traits&gt;::</a>
<a name="l00376"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a9957cabfa6a11dd8bbf28683e93a29bb">00376</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">evaluateFields_elementblocks</a>(<span class="keyword">typename</span> Traits::EvalData workset)
<a name="l00377"></a>00377 {
<a name="l00378"></a>00378   <span class="keyword">using</span> std::string;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> mrsFromEBTest = 1.0;          <span class="comment">// mesh region scaling factor from element block tests</span>
<a name="l00381"></a>00381   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> scaleFactor = <a class="code" href="classQCAD_1_1PoissonSource.html#a3412793c06f499339644c5462b336350" title="constant prefactor parameter in source function">factor</a> / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// overall scaling of RHS</span>
<a name="l00382"></a>00382 
<a name="l00383"></a>00383   <span class="keywordtype">bool</span>   isQuantum     =  <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">bool</span>&gt;(workset.EBName,<span class="stringliteral">&quot;quantum&quot;</span>,<span class="keyword">false</span>);
<a name="l00384"></a>00384   <span class="keywordtype">string</span> matrlCategory = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">string</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Category&quot;</span>);
<a name="l00385"></a>00385   <span class="keywordtype">string</span> sourceName    = isQuantum ? <a class="code" href="classQCAD_1_1PoissonSource.html#ab4b4436c43160ef17f769bfb836dfa76">quantumRegionSource</a> : <a class="code" href="classQCAD_1_1PoissonSource.html#aafe24aed82d6a0c44e6b4e0ef34f22a3" title="strings specifing the how the source term inside and outside the quantum regions are computed:...">nonQuantumRegionSource</a>;
<a name="l00386"></a>00386 
<a name="l00387"></a>00387 
<a name="l00388"></a>00388   <span class="comment">//mesh region scaling by element block</span>
<a name="l00389"></a>00389   std::size_t nRegions = <a class="code" href="classQCAD_1_1PoissonSource.html#a0d29163645d39c6b0a6f38574a32160f" title="Mesh Region parameters.">meshRegionList</a>.size();
<a name="l00390"></a>00390   std::vector&lt;bool&gt; bEBInRegion(nRegions,<span class="keyword">false</span>);
<a name="l00391"></a>00391   <span class="keywordflow">for</span>(std::size_t i=0; i&lt;nRegions; i++) {    
<a name="l00392"></a>00392     <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#a0d29163645d39c6b0a6f38574a32160f" title="Mesh Region parameters.">meshRegionList</a>[i]-&gt;elementBlockIsInRegion(workset.EBName)) {
<a name="l00393"></a>00393       mrsFromEBTest *= <a class="code" href="classQCAD_1_1PoissonSource.html#afb63b216947d707542cb0b5ac73bacfd">meshRegionFactors</a>[i];
<a name="l00394"></a>00394       bEBInRegion[i] = <span class="keyword">true</span>;
<a name="l00395"></a>00395     }
<a name="l00396"></a>00396   }
<a name="l00397"></a>00397   
<a name="l00399"></a>00399   void (<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;</a>::*sourceCalc) (<span class="keyword">const</span> <span class="keyword">typename</span> Traits::EvalData workset, std::size_t cell, std::size_t qp,
<a name="l00400"></a>00400                <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp; scaleFactor, <span class="keyword">const</span> <a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html">PoissonSourceSetupInfo</a>&amp; setup_info);
<a name="l00401"></a>00401         
<a name="l00402"></a>00402   <span class="comment">//special case of metals, which always have source == &quot;none&quot;, since they have no charge</span>
<a name="l00403"></a>00403   <span class="keywordflow">if</span>(matrlCategory == <span class="stringliteral">&quot;Metal&quot;</span>)  sourceName = <span class="stringliteral">&quot;none&quot;</span>;
<a name="l00404"></a>00404 
<a name="l00405"></a>00405   <span class="keywordflow">if</span>(sourceName == <span class="stringliteral">&quot;semiclassical&quot;</span>)    sourceCalc = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::source_semiclassical</a>;
<a name="l00406"></a>00406   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(sourceName == <span class="stringliteral">&quot;none&quot;</span>)        sourceCalc = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::source_none</a>;
<a name="l00407"></a>00407   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(sourceName == <span class="stringliteral">&quot;schrodinger&quot;</span>) sourceCalc = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::source_quantum</a>;
<a name="l00408"></a>00408   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(sourceName == <span class="stringliteral">&quot;ci&quot;</span>)          sourceCalc = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::source_quantum</a>;
<a name="l00409"></a>00409   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(sourceName == <span class="stringliteral">&quot;coulomb&quot;</span>)     sourceCalc = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::source_coulomb</a>;
<a name="l00410"></a>00410   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(sourceName == <span class="stringliteral">&quot;testcoulomb&quot;</span>) sourceCalc = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::source_testcoulomb</a>;
<a name="l00411"></a>00411   <span class="keywordflow">else</span> {
<a name="l00412"></a>00412     TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,
<a name="l00413"></a>00413   std::endl &lt;&lt; <span class="stringliteral">&quot;Error!  Unknown source name: &quot;</span> &lt;&lt; sourceName &lt;&lt; <span class="stringliteral">&quot;!&quot;</span>&lt;&lt; std::endl);
<a name="l00414"></a>00414   }
<a name="l00415"></a>00415 
<a name="l00416"></a>00416   <a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html">PoissonSourceSetupInfo</a> setup_info = <a class="code" href="classQCAD_1_1PoissonSource.html#adf3ae6ace1435778caad366f81a4b200" title="----------------- Poisson source setup and fill functions ---------------------">source_setup</a>(sourceName, matrlCategory, workset);
<a name="l00417"></a>00417   <span class="keywordflow">for</span> (std::size_t cell=0; cell &lt; workset.numCells; ++cell)
<a name="l00418"></a>00418   {
<a name="l00419"></a>00419     scaleFactor = <a class="code" href="classQCAD_1_1PoissonSource.html#a5ded27c5d9694853aeadf18d87f54594">getCellScaleFactor</a>(cell, bEBInRegion, mrsFromEBTest*<a class="code" href="classQCAD_1_1PoissonSource.html#a3412793c06f499339644c5462b336350" title="constant prefactor parameter in source function">factor</a> / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>);
<a name="l00420"></a>00420     <span class="keywordflow">for</span> (std::size_t qp=0; qp &lt; <a class="code" href="classQCAD_1_1PoissonSource.html#aef0fb486fbdf94b26e96eb6096a236ea" title="input">numQPs</a>; ++qp)
<a name="l00421"></a>00421       (this-&gt;*sourceCalc)(workset, cell, qp, scaleFactor, setup_info);
<a name="l00422"></a>00422   }
<a name="l00423"></a>00423 
<a name="l00424"></a>00424   <span class="comment">//point charges</span>
<a name="l00425"></a>00425   <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#af42c69cb97e2192f19b9574ec492b1a6">pointCharges</a>.size() &gt; 0)
<a name="l00426"></a>00426     <a class="code" href="classQCAD_1_1PoissonSource.html#a104fdb2543b1cbf4ddcd67f08368403f" title="----------------- Point charge functions ---------------------">source_pointcharges</a>(workset);
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 }
<a name="l00429"></a>00429 
<a name="l00430"></a>00430 
<a name="l00431"></a>00431 <span class="comment">// **********************************************************************</span>
<a name="l00432"></a>00432 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l00433"></a>00433 <span class="keywordtype">void</span> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT, Traits&gt;::</a>
<a name="l00434"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a8d66177e07c78eded5d5b661748b3394">00434</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">evaluateFields_default</a>(<span class="keyword">typename</span> Traits::EvalData workset)
<a name="l00435"></a>00435 {
<a name="l00436"></a>00436   <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>* coord;
<a name="l00437"></a>00437   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> charge;
<a name="l00438"></a>00438 
<a name="l00439"></a>00439   <span class="keywordflow">for</span> (std::size_t cell=0; cell &lt; workset.numCells; ++cell) 
<a name="l00440"></a>00440   {
<a name="l00441"></a>00441     <span class="keywordflow">for</span> (std::size_t qp=0; qp &lt; <a class="code" href="classQCAD_1_1PoissonSource.html#aef0fb486fbdf94b26e96eb6096a236ea" title="input">numQPs</a>; ++qp) 
<a name="l00442"></a>00442     {
<a name="l00443"></a>00443       coord = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html#a40266aa4c302576de741269de6565d90">coordVec</a>(cell,qp,0);
<a name="l00444"></a>00444       <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp; phi = <a class="code" href="classQCAD_1_1PoissonSource.html#ae66f55a004430bfc3497f006bdbe7f01">potential</a>(cell,qp);
<a name="l00445"></a>00445 
<a name="l00446"></a>00446       <span class="keywordflow">switch</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#abe44f806525ae2ac13105e5f499fa120">numDims</a>) {
<a name="l00447"></a>00447       <span class="keywordflow">case</span> 2:
<a name="l00448"></a>00448         <span class="keywordflow">if</span> (coord[1]&lt;0.8) charge = (coord[1]*coord[1]);
<a name="l00449"></a>00449         <span class="keywordflow">else</span> charge = 3.0;
<a name="l00450"></a>00450         charge *= (1.0 + exp(-phi));
<a name="l00451"></a>00451         <a class="code" href="classQCAD_1_1PoissonSource.html#ae574ccc85e9e3986d56b1b1b6b7a924d">chargeDensity</a>(cell, qp) = charge;
<a name="l00452"></a>00452         <span class="keywordflow">break</span>;
<a name="l00453"></a>00453       <span class="keywordflow">default</span>: TEUCHOS_TEST_FOR_EXCEPT(<span class="keyword">true</span>);
<a name="l00454"></a>00454       }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456       <span class="comment">// do not scale the default device since the DBC is not scaled</span>
<a name="l00457"></a>00457       <a class="code" href="classQCAD_1_1PoissonSource.html#a4d3f473e00eac7aafe120bd596db647d" title="output">poissonSource</a>(cell, qp) = <a class="code" href="classQCAD_1_1PoissonSource.html#a3412793c06f499339644c5462b336350" title="constant prefactor parameter in source function">factor</a>*charge;
<a name="l00458"></a>00458       
<a name="l00459"></a>00459       <span class="comment">// set all states to 0 except electricPotential </span>
<a name="l00460"></a>00460       <a class="code" href="classQCAD_1_1PoissonSource.html#ae574ccc85e9e3986d56b1b1b6b7a924d">chargeDensity</a>(cell, qp) = 0.0;
<a name="l00461"></a>00461       <a class="code" href="classQCAD_1_1PoissonSource.html#a0a2d8a657e36facc1df8e509228910b8">electronDensity</a>(cell, qp) = 0.0;  
<a name="l00462"></a>00462       <a class="code" href="classQCAD_1_1PoissonSource.html#a33c2a1c3d6884eb0ff1ef71522e55716">holeDensity</a>(cell, qp) = 0.0;      
<a name="l00463"></a>00463       <a class="code" href="classQCAD_1_1PoissonSource.html#a47708a787cf7f127b0ef44b7d658d42f">electricPotential</a>(cell, qp) = phi; <span class="comment">// no scaling</span>
<a name="l00464"></a>00464       <a class="code" href="classQCAD_1_1PoissonSource.html#aec699e0c6ff57c1fe2100610abe6ac70">ionizedDopant</a>(cell, qp) = 0.0;
<a name="l00465"></a>00465       <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell, qp) = 0.0; 
<a name="l00466"></a>00466       <a class="code" href="classQCAD_1_1PoissonSource.html#ac3d211c7dfc559d0b5d6903cb2509e63">valenceBand</a>(cell, qp) = 0.01; 
<a name="l00467"></a>00467       <a class="code" href="classQCAD_1_1PoissonSource.html#a862d9a94dfdeca69318880357360f2b4">approxQuanEDen</a>(cell,qp) = 0.0;
<a name="l00468"></a>00468       <a class="code" href="classQCAD_1_1PoissonSource.html#a0300c56c6a9ff5b939d79b2598dd7800">artCBDensity</a>(cell, qp) = 0.0;
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470   }
<a name="l00471"></a>00471 }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 
<a name="l00474"></a>00474 <span class="comment">// **********************************************************************</span>
<a name="l00475"></a>00475 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l00476"></a>00476 <span class="keywordtype">void</span> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT, Traits&gt;::</a>
<a name="l00477"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a01199b06e2a621b3e4018dda0260928c">00477</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">evaluateFields_moscap1d</a>(<span class="keyword">typename</span> Traits::EvalData workset)
<a name="l00478"></a>00478 {
<a name="l00479"></a>00479   <span class="comment">//Note: the moscap1d test structure always outputs values in [eV] (or [V]) and ignores the &quot;Energy Unit In Electron Volts&quot; input parameter</span>
<a name="l00480"></a>00480   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> temperature = <a class="code" href="classQCAD_1_1PoissonSource.html#acbec0daaf0a9c9de29056d17c577bcdc">temperatureField</a>(0); <span class="comment">//get shared temperature parameter from field</span>
<a name="l00481"></a>00481 
<a name="l00482"></a>00482   <span class="comment">// Scaling factors</span>
<a name="l00483"></a>00483   <span class="keywordtype">double</span> X0 = <a class="code" href="classQCAD_1_1PoissonSource.html#aa7122e9b80328be00b7e50bf61d8c899" title="scaling parameters">length_unit_in_m</a>/1e-2; <span class="comment">// length scaling to get to [cm] (structure dimension in [um])</span>
<a name="l00484"></a>00484   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> V0 = <a class="code" href="classQCAD_1_1PoissonSource.html#ad8f4dcca5195de778795ec98a8afd9b2" title="Public Universal Constants.">kbBoltz</a>*temperature/1.0; <span class="comment">// kb*T/q in [V], scaling for potential        </span>
<a name="l00485"></a>00485   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> Lambda2 = <a class="code" href="classQCAD_1_1PoissonSource.html#a66367459749e48e11a50a4fa6457666f">eps0</a>/(<a class="code" href="classQCAD_1_1PoissonSource.html#a69b53a45d322590c547e3b3873180966">eleQ</a>*X0*X0); <span class="comment">// derived scaling factor</span>
<a name="l00486"></a>00486   
<a name="l00488"></a>00488   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> qPhiRef;
<a name="l00489"></a>00489   {
<a name="l00490"></a>00490     std::string refMtrlName, category;
<a name="l00491"></a>00491     refMtrlName = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getParam&lt;std::string&gt;(<span class="stringliteral">&quot;Reference Material&quot;</span>);
<a name="l00492"></a>00492     category = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;std::string&gt;(refMtrlName,<span class="stringliteral">&quot;Category&quot;</span>);
<a name="l00493"></a>00493     <span class="keywordflow">if</span> (category == <span class="stringliteral">&quot;Semiconductor&quot;</span>) 
<a name="l00494"></a>00494     {
<a name="l00495"></a>00495       <span class="comment">// Same qPhiRef needs to be used for the entire structure</span>
<a name="l00496"></a>00496       <span class="keywordtype">double</span> mdn = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Electron DOS Effective Mass&quot;</span>);
<a name="l00497"></a>00497       <span class="keywordtype">double</span> mdp = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Hole DOS Effective Mass&quot;</span>);
<a name="l00498"></a>00498       <span class="keywordtype">double</span> Chi = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Electron Affinity&quot;</span>);
<a name="l00499"></a>00499       <span class="keywordtype">double</span> Eg0 = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Zero Temperature Band Gap&quot;</span>);
<a name="l00500"></a>00500       <span class="keywordtype">double</span> <a class="code" href="namespaceFELIX.html#a4d08741b97fea3938089670d2a84c598">alpha</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Band Gap Alpha Coefficient&quot;</span>);
<a name="l00501"></a>00501       <span class="keywordtype">double</span> beta = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Band Gap Beta Coefficient&quot;</span>);
<a name="l00502"></a>00502       <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> Eg = Eg0-alpha*pow(temperature,2.0)/(beta+temperature); <span class="comment">// in [eV]</span>
<a name="l00503"></a>00503     
<a name="l00504"></a>00504       <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> kbT = <a class="code" href="classQCAD_1_1PoissonSource.html#ad8f4dcca5195de778795ec98a8afd9b2" title="Public Universal Constants.">kbBoltz</a>*temperature;      <span class="comment">// in [eV]</span>
<a name="l00505"></a>00505       <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> Eic = -Eg/2. + 3./4.*kbT*log(mdp/mdn);  <span class="comment">// (Ei-Ec) in [eV]</span>
<a name="l00506"></a>00506       qPhiRef = Chi - Eic;  <span class="comment">// (Evac-Ei) in [eV] where Evac = vacuum level</span>
<a name="l00507"></a>00507     }
<a name="l00508"></a>00508     <span class="keywordflow">else</span> 
<a name="l00509"></a>00509     {
<a name="l00510"></a>00510       TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter, std::endl 
<a name="l00511"></a>00511         &lt;&lt; <span class="stringliteral">&quot;Error!  Invalid category &quot;</span> &lt;&lt; category 
<a name="l00512"></a>00512         &lt;&lt; <span class="stringliteral">&quot; for reference material !&quot;</span> &lt;&lt; std::endl);
<a name="l00513"></a>00513     }
<a name="l00514"></a>00514   }  
<a name="l00515"></a>00515 
<a name="l00516"></a>00516   <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>* coord;
<a name="l00517"></a>00517   
<a name="l00518"></a>00518   <span class="keywordflow">for</span> (std::size_t cell = 0; cell &lt; workset.numCells; ++cell) 
<a name="l00519"></a>00519   {
<a name="l00520"></a>00520     <span class="keywordflow">for</span> (std::size_t qp = 0; qp &lt; <a class="code" href="classQCAD_1_1PoissonSource.html#aef0fb486fbdf94b26e96eb6096a236ea" title="input">numQPs</a>; ++qp) 
<a name="l00521"></a>00521     {
<a name="l00522"></a>00522       coord = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html#a40266aa4c302576de741269de6565d90">coordVec</a>(cell,qp,0);
<a name="l00523"></a>00523       
<a name="l00524"></a>00524      <span class="comment">// Silicon region</span>
<a name="l00525"></a>00525      <span class="keywordflow">if</span> ( (coord[0] &gt; <a class="code" href="classQCAD_1_1PoissonSource.html#a600a98d5cfae07bfed715de5b1921c67" title="specific parameters for &amp;quot;1D MOSCapacitor&amp;quot;">oxideWidth</a>) &amp;&amp; (coord[0] &lt;= (<a class="code" href="classQCAD_1_1PoissonSource.html#a600a98d5cfae07bfed715de5b1921c67" title="specific parameters for &amp;quot;1D MOSCapacitor&amp;quot;">oxideWidth</a> + <a class="code" href="classQCAD_1_1PoissonSource.html#a088df825b707a32305860e5913d3699f">siliconWidth</a>)) )
<a name="l00526"></a>00526      {
<a name="l00527"></a>00527       <span class="keyword">const</span> std::string matName = <span class="stringliteral">&quot;Silicon&quot;</span>;
<a name="l00528"></a>00528         
<a name="l00530"></a>00530       <span class="keywordtype">double</span> mdn = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(matName,<span class="stringliteral">&quot;Electron DOS Effective Mass&quot;</span>);
<a name="l00531"></a>00531       <span class="keywordtype">double</span> mdp = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(matName,<span class="stringliteral">&quot;Hole DOS Effective Mass&quot;</span>);
<a name="l00532"></a>00532       <span class="keywordtype">double</span> Tref = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(matName,<span class="stringliteral">&quot;Reference Temperature&quot;</span>);
<a name="l00533"></a>00533     
<a name="l00534"></a>00534       <span class="keywordtype">double</span> Chi = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(matName,<span class="stringliteral">&quot;Electron Affinity&quot;</span>);
<a name="l00535"></a>00535       <span class="keywordtype">double</span> Eg0 = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(matName,<span class="stringliteral">&quot;Zero Temperature Band Gap&quot;</span>);
<a name="l00536"></a>00536       <span class="keywordtype">double</span> <a class="code" href="namespaceFELIX.html#a4d08741b97fea3938089670d2a84c598">alpha</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(matName,<span class="stringliteral">&quot;Band Gap Alpha Coefficient&quot;</span>);
<a name="l00537"></a>00537       <span class="keywordtype">double</span> beta = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(matName,<span class="stringliteral">&quot;Band Gap Beta Coefficient&quot;</span>);
<a name="l00538"></a>00538     
<a name="l00539"></a>00539       <span class="comment">// constant prefactor in calculating Nc and Nv in [cm-3]</span>
<a name="l00540"></a>00540       <span class="keywordtype">double</span> NcvFactor = 2.0*pow((<a class="code" href="classQCAD_1_1PoissonSource.html#ad8f4dcca5195de778795ec98a8afd9b2" title="Public Universal Constants.">kbBoltz</a>*<a class="code" href="classQCAD_1_1PoissonSource.html#a69b53a45d322590c547e3b3873180966">eleQ</a>*<a class="code" href="classQCAD_1_1PoissonSource.html#a7385d003a75e31eeaaf8637a9bee1731">m0</a>*Tref)/(2*<a class="code" href="classQCAD_1_1PoissonSource.html#a35d68aa6b59eabed3579ab39f2473861">pi</a>*pow(<a class="code" href="classQCAD_1_1PoissonSource.html#ab12eefe71615a8407a289022fc043464">hbar</a>,2)),3./2.)*1e-6;
<a name="l00541"></a>00541             <span class="comment">// eleQ converts kbBoltz in [eV/K] to [J/K], 1e-6 converts [m-3] to [cm-3]</span>
<a name="l00542"></a>00542     
<a name="l00544"></a>00544       <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> Nc;  <span class="comment">// conduction band effective DOS in [cm-3]</span>
<a name="l00545"></a>00545       <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> Nv;  <span class="comment">// valence band effective DOS in [cm-3]</span>
<a name="l00546"></a>00546       <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> Eg;  <span class="comment">// band gap at T [K] in [eV]</span>
<a name="l00547"></a>00547       <span class="comment">//ScalarT ni;  // intrinsic carrier concentration in [cm-3]</span>
<a name="l00548"></a>00548     
<a name="l00549"></a>00549       Nc = NcvFactor*pow(mdn,1.5)*pow(temperature/Tref,1.5);  <span class="comment">// in [cm-3]</span>
<a name="l00550"></a>00550       Nv = NcvFactor*pow(mdp,1.5)*pow(temperature/Tref,1.5); 
<a name="l00551"></a>00551       Eg = Eg0-alpha*pow(temperature,2.0)/(beta+temperature); <span class="comment">// in [eV]</span>
<a name="l00552"></a>00552     
<a name="l00553"></a>00553       <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> kbT = <a class="code" href="classQCAD_1_1PoissonSource.html#ad8f4dcca5195de778795ec98a8afd9b2" title="Public Universal Constants.">kbBoltz</a>*temperature;      <span class="comment">// in [eV]</span>
<a name="l00554"></a>00554       <span class="comment">//ni = sqrt(Nc*Nv)*exp(-Eg/(2.0*kbT));    // in [cm-3]</span>
<a name="l00555"></a>00555     
<a name="l00556"></a>00556       <span class="comment">// argument offset in calculating electron and hole density</span>
<a name="l00557"></a>00557       <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> eArgOffset = (-qPhiRef+Chi)/kbT;
<a name="l00558"></a>00558       <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> hArgOffset = (qPhiRef-Chi-Eg)/kbT;
<a name="l00559"></a>00559  
<a name="l00561"></a>00561       <span class="keywordtype">double</span> ml = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(matName,<span class="stringliteral">&quot;Longitudinal Electron Effective Mass&quot;</span>);
<a name="l00562"></a>00562       <span class="keywordtype">double</span> mt = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(matName,<span class="stringliteral">&quot;Transverse Electron Effective Mass&quot;</span>);        
<a name="l00563"></a>00563       <span class="keywordtype">double</span> invEffMass = (2.0/mt + 1.0/ml) / 3.0;
<a name="l00564"></a>00564       <span class="keywordtype">double</span> averagedEffMass = 1.0 / invEffMass;
<a name="l00565"></a>00565       <span class="keywordtype">double</span> relPerm = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(matName,<span class="stringliteral">&quot;Permittivity&quot;</span>);
<a name="l00566"></a>00566    
<a name="l00568"></a>00568       <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> (<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;</a>::*carrStat) (<span class="keyword">const</span> ScalarT);
<a name="l00569"></a>00569     
<a name="l00570"></a>00570       <span class="keywordflow">if</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#a36ac1600805580de01cffada6a8c6bf7" title="specify carrier statistics and incomplete ionization">carrierStatistics</a> == <span class="stringliteral">&quot;Boltzmann Statistics&quot;</span>)
<a name="l00571"></a>00571         carrStat = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::computeMBStat</a>;  
<a name="l00572"></a>00572 
<a name="l00573"></a>00573       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#a36ac1600805580de01cffada6a8c6bf7" title="specify carrier statistics and incomplete ionization">carrierStatistics</a> == <span class="stringliteral">&quot;Fermi-Dirac Statistics&quot;</span>)
<a name="l00574"></a>00574         carrStat = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::computeFDIntOneHalf</a>;
<a name="l00575"></a>00575 
<a name="l00576"></a>00576       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#a36ac1600805580de01cffada6a8c6bf7" title="specify carrier statistics and incomplete ionization">carrierStatistics</a> == <span class="stringliteral">&quot;0-K Fermi-Dirac Statistics&quot;</span>)
<a name="l00577"></a>00577         carrStat = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::computeZeroKFDInt</a>;
<a name="l00578"></a>00578 
<a name="l00579"></a>00579       <span class="keywordflow">else</span> TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,
<a name="l00580"></a>00580         std::endl &lt;&lt; <span class="stringliteral">&quot;Error!  Unknown carrier statistics ! &quot;</span> &lt;&lt; std::endl);
<a name="l00581"></a>00581 
<a name="l00583"></a>00583       <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> (<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;</a>::*ionDopant) (<span class="keyword">const</span> std::string, <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp;); 
<a name="l00584"></a>00584     
<a name="l00585"></a>00585       <span class="keywordflow">if</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#a25f70d6c90c767cade9c663081913bbf">incompIonization</a> == <span class="stringliteral">&quot;False&quot;</span>)
<a name="l00586"></a>00586         ionDopant = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::fullDopants</a>; 
<a name="l00587"></a>00587     
<a name="l00588"></a>00588       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#a25f70d6c90c767cade9c663081913bbf">incompIonization</a> == <span class="stringliteral">&quot;True&quot;</span>)
<a name="l00589"></a>00589         ionDopant = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::ionizedDopants</a>;
<a name="l00590"></a>00590     
<a name="l00591"></a>00591       <span class="keywordflow">else</span> TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,
<a name="l00592"></a>00592         std::endl &lt;&lt; <span class="stringliteral">&quot;Error!  Invalid incomplete ionization option ! &quot;</span> &lt;&lt; std::endl);
<a name="l00593"></a>00593 
<a name="l00595"></a>00595       <span class="keyword">const</span> std::string dopantType = <span class="stringliteral">&quot;Acceptor&quot;</span>;
<a name="l00596"></a>00596       <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> inArg, dopingConc, dopantActE;
<a name="l00597"></a>00597       dopingConc = <a class="code" href="classQCAD_1_1PoissonSource.html#ad270d3cb12f055bb9ae4451bb164c036">dopingAcceptor</a>; 
<a name="l00598"></a>00598       dopantActE = <a class="code" href="classQCAD_1_1PoissonSource.html#aa6ddeee4caa5435d83dda36cc8459928">acceptorActE</a>;
<a name="l00599"></a>00599 
<a name="l00600"></a>00600       <span class="keywordflow">if</span>(dopantType == <span class="stringliteral">&quot;Donor&quot;</span>) 
<a name="l00601"></a>00601         inArg = eArgOffset + dopantActE/kbT;
<a name="l00602"></a>00602       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dopantType == <span class="stringliteral">&quot;Acceptor&quot;</span>) 
<a name="l00603"></a>00603         inArg = hArgOffset + dopantActE/kbT;
<a name="l00604"></a>00604       <span class="keywordflow">else</span> TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,
<a name="l00605"></a>00605          std::endl &lt;&lt; <span class="stringliteral">&quot;Error!  Unknown dopant type &quot;</span> &lt;&lt; dopantType &lt;&lt; <span class="stringliteral">&quot;!&quot;</span>&lt;&lt; std::endl);
<a name="l00606"></a>00606 
<a name="l00608"></a>00608       <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#ab4b4436c43160ef17f769bfb836dfa76">quantumRegionSource</a> == <span class="stringliteral">&quot;schrodinger&quot;</span>)
<a name="l00609"></a>00609       {
<a name="l00610"></a>00610         <span class="comment">// retrieve Previous Poisson Potential</span>
<a name="l00611"></a>00611         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> prevPhi = 0.0, approxEDensity = 0.0;
<a name="l00612"></a>00612         
<a name="l00613"></a>00613         <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#a623c1ec89816a9681889f657470d13f8" title="Schrodinger coupling.">bUsePredictorCorrector</a>) {
<a name="l00614"></a>00614           <span class="comment">// compute the approximate quantum electron density using predictor-corrector method</span>
<a name="l00615"></a>00615     <a class="code" href="namespaceAlbany.html#a76b8c026e962fe80abcca7402bdad39b">Albany::MDArray</a> prevPhiArray = (*workset.stateArrayPtr)[<span class="stringliteral">&quot;PS Previous Poisson Potential&quot;</span>];
<a name="l00616"></a>00616     prevPhi = prevPhiArray(cell,qp);
<a name="l00617"></a>00617           approxEDensity = <a class="code" href="classQCAD_1_1PoissonSource.html#acd97a33569f4b36fb2fc06d6ab703c7e" title="----------------- Quantum electron density functions ---------------------">eDensityForPoissonSchrodinger</a>(workset, cell, qp, prevPhi, <span class="keyword">true</span>, 0.0, -1.0);
<a name="l00618"></a>00618   }
<a name="l00619"></a>00619         <span class="keywordflow">else</span>  <span class="comment">// otherwise, use the exact quantum density</span>
<a name="l00620"></a>00620           approxEDensity = <a class="code" href="classQCAD_1_1PoissonSource.html#acd97a33569f4b36fb2fc06d6ab703c7e" title="----------------- Quantum electron density functions ---------------------">eDensityForPoissonSchrodinger</a>(workset, cell, qp, 0.0, <span class="keyword">false</span>, 0.0, -1.0);
<a name="l00621"></a>00621 
<a name="l00622"></a>00622         <span class="comment">// compute the exact quantum electron density</span>
<a name="l00623"></a>00623         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> eDensity = <a class="code" href="classQCAD_1_1PoissonSource.html#acd97a33569f4b36fb2fc06d6ab703c7e" title="----------------- Quantum electron density functions ---------------------">eDensityForPoissonSchrodinger</a>(workset, cell, qp, 0.0, <span class="keyword">false</span>, 0.0, -1.0);
<a name="l00624"></a>00624           
<a name="l00625"></a>00625         <span class="comment">// obtain the scaled potential</span>
<a name="l00626"></a>00626         <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp; unscaled_phi = <a class="code" href="classQCAD_1_1PoissonSource.html#ae66f55a004430bfc3497f006bdbe7f01">potential</a>(cell,qp);
<a name="l00627"></a>00627         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> phi = unscaled_phi / V0; 
<a name="l00628"></a>00628            
<a name="l00629"></a>00629         <span class="comment">// compute the hole density treated as classical</span>
<a name="l00630"></a>00630         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> hDensity = Nv*(this-&gt;*carrStat)(-phi+hArgOffset); 
<a name="l00631"></a>00631 
<a name="l00632"></a>00632         <span class="comment">// obtain the ionized dopants</span>
<a name="l00633"></a>00633         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> ionN  = 0.0;
<a name="l00634"></a>00634         <span class="keywordflow">if</span> (dopantType == <span class="stringliteral">&quot;Donor&quot;</span>)  <span class="comment">// function takes care of sign</span>
<a name="l00635"></a>00635           ionN = (this-&gt;*ionDopant)(dopantType,phi+inArg)*dopingConc;
<a name="l00636"></a>00636         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dopantType == <span class="stringliteral">&quot;Acceptor&quot;</span>)
<a name="l00637"></a>00637           ionN = (this-&gt;*ionDopant)(dopantType,-phi+inArg)*dopingConc;
<a name="l00638"></a>00638         <span class="keywordflow">else</span> 
<a name="l00639"></a>00639           ionN = 0.0;
<a name="l00640"></a>00640               
<a name="l00641"></a>00641         <span class="comment">// the scaled full RHS</span>
<a name="l00642"></a>00642         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> charge; 
<a name="l00643"></a>00643         charge = 1.0/Lambda2 * (hDensity- approxEDensity + ionN);
<a name="l00644"></a>00644         <a class="code" href="classQCAD_1_1PoissonSource.html#a4d3f473e00eac7aafe120bd596db647d" title="output">poissonSource</a>(cell, qp) = <a class="code" href="classQCAD_1_1PoissonSource.html#a3412793c06f499339644c5462b336350" title="constant prefactor parameter in source function">factor</a>*charge;
<a name="l00645"></a>00645 
<a name="l00646"></a>00646         <span class="comment">// output states</span>
<a name="l00647"></a>00647         <a class="code" href="classQCAD_1_1PoissonSource.html#ae574ccc85e9e3986d56b1b1b6b7a924d">chargeDensity</a>(cell, qp) = hDensity -eDensity +ionN;
<a name="l00648"></a>00648         <a class="code" href="classQCAD_1_1PoissonSource.html#a0a2d8a657e36facc1df8e509228910b8">electronDensity</a>(cell, qp) = eDensity;
<a name="l00649"></a>00649         <a class="code" href="classQCAD_1_1PoissonSource.html#a33c2a1c3d6884eb0ff1ef71522e55716">holeDensity</a>(cell, qp) = hDensity;
<a name="l00650"></a>00650         <a class="code" href="classQCAD_1_1PoissonSource.html#a47708a787cf7f127b0ef44b7d658d42f">electricPotential</a>(cell, qp) = phi*V0 - qPhiRef;
<a name="l00651"></a>00651         <a class="code" href="classQCAD_1_1PoissonSource.html#aec699e0c6ff57c1fe2100610abe6ac70">ionizedDopant</a>(cell, qp) = ionN;
<a name="l00652"></a>00652         <a class="code" href="classQCAD_1_1PoissonSource.html#a862d9a94dfdeca69318880357360f2b4">approxQuanEDen</a>(cell,qp) = approxEDensity;
<a name="l00653"></a>00653         <a class="code" href="classQCAD_1_1PoissonSource.html#a0300c56c6a9ff5b939d79b2598dd7800">artCBDensity</a>(cell, qp) = ( eDensity &gt; 1e-6 ? eDensity : -Nc*(this-&gt;*carrStat)( -(phi+eArgOffset) ));
<a name="l00654"></a>00654         
<a name="l00655"></a>00655         <span class="keywordflow">if</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#a82105311f3e25ff3f753937ad13b048e">bIncludeVxc</a>)  <span class="comment">// include Vxc</span>
<a name="l00656"></a>00656         {
<a name="l00657"></a>00657           <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> Vxc = <a class="code" href="classQCAD_1_1PoissonSource.html#a87523eaee864c9fc18b16892882c5038" title="compute exchange-correlation potential energy within Local Density Approximation">computeVxcLDA</a>(relPerm, averagedEffMass, approxEDensity);
<a name="l00658"></a>00658           <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell, qp) = qPhiRef-Chi-phi*V0 +Vxc; <span class="comment">// [eV]</span>
<a name="l00659"></a>00659     <a class="code" href="classQCAD_1_1PoissonSource.html#a47708a787cf7f127b0ef44b7d658d42f">electricPotential</a>(cell, qp) = phi*V0 + Vxc - qPhiRef; <span class="comment">//add xc correction to electric potential (used in CI delta_ij computation)</span>
<a name="l00660"></a>00660           <span class="comment">// conductionBand(cell, qp) = qPhiRef -Chi -0.5*(phi*V0 +prevPhi) +Vxc; // [eV]</span>
<a name="l00661"></a>00661         }
<a name="l00662"></a>00662         <span class="keywordflow">else</span> { <span class="comment">// not include Vxc</span>
<a name="l00663"></a>00663           <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell, qp) = qPhiRef-Chi-phi*V0; <span class="comment">// [eV]</span>
<a name="l00664"></a>00664     <a class="code" href="classQCAD_1_1PoissonSource.html#a47708a787cf7f127b0ef44b7d658d42f">electricPotential</a>(cell, qp) = phi*V0 - qPhiRef;
<a name="l00665"></a>00665           <span class="comment">// conductionBand(cell, qp) = qPhiRef -Chi -0.5*(phi*V0 +prevPhi); // [eV]</span>
<a name="l00666"></a>00666   }
<a name="l00667"></a>00667         
<a name="l00668"></a>00668         <a class="code" href="classQCAD_1_1PoissonSource.html#ac3d211c7dfc559d0b5d6903cb2509e63">valenceBand</a>(cell, qp) = <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell,qp)-Eg;
<a name="l00669"></a>00669 
<a name="l00670"></a>00670       }
<a name="l00671"></a>00671 
<a name="l00673"></a>00673       <span class="keywordflow">else</span>
<a name="l00674"></a>00674       {
<a name="l00675"></a>00675         <span class="comment">// obtain the scaled potential</span>
<a name="l00676"></a>00676         <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp; unscaled_phi = <a class="code" href="classQCAD_1_1PoissonSource.html#ae66f55a004430bfc3497f006bdbe7f01">potential</a>(cell,qp);  <span class="comment">//[V]</span>
<a name="l00677"></a>00677         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> phi = unscaled_phi / V0; 
<a name="l00678"></a>00678           
<a name="l00679"></a>00679         <span class="comment">// obtain the ionized dopants</span>
<a name="l00680"></a>00680         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> ionN;
<a name="l00681"></a>00681         <span class="keywordflow">if</span> (dopantType == <span class="stringliteral">&quot;Donor&quot;</span>)  <span class="comment">// function takes care of sign</span>
<a name="l00682"></a>00682           ionN = (this-&gt;*ionDopant)(dopantType,phi+inArg)*dopingConc;
<a name="l00683"></a>00683         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dopantType == <span class="stringliteral">&quot;Acceptor&quot;</span>)
<a name="l00684"></a>00684           ionN = (this-&gt;*ionDopant)(dopantType,-phi+inArg)*dopingConc;
<a name="l00685"></a>00685         <span class="keywordflow">else</span> 
<a name="l00686"></a>00686           ionN = 0.0; 
<a name="l00687"></a>00687 
<a name="l00688"></a>00688         <span class="comment">// the scaled full RHS</span>
<a name="l00689"></a>00689         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> charge, eDensity, hDensity;
<a name="l00690"></a>00690         eDensity = Nc*(this-&gt;*carrStat)(phi+eArgOffset);
<a name="l00691"></a>00691         hDensity = Nv*(this-&gt;*carrStat)(-phi+hArgOffset);
<a name="l00692"></a>00692         charge = 1.0/Lambda2 * (hDensity - eDensity + ionN);
<a name="l00693"></a>00693         <a class="code" href="classQCAD_1_1PoissonSource.html#a4d3f473e00eac7aafe120bd596db647d" title="output">poissonSource</a>(cell, qp) = <a class="code" href="classQCAD_1_1PoissonSource.html#a3412793c06f499339644c5462b336350" title="constant prefactor parameter in source function">factor</a>*charge;
<a name="l00694"></a>00694           
<a name="l00695"></a>00695         <span class="comment">// output states</span>
<a name="l00696"></a>00696         <a class="code" href="classQCAD_1_1PoissonSource.html#ae574ccc85e9e3986d56b1b1b6b7a924d">chargeDensity</a>(cell, qp) = charge*Lambda2;
<a name="l00697"></a>00697         <a class="code" href="classQCAD_1_1PoissonSource.html#a0a2d8a657e36facc1df8e509228910b8">electronDensity</a>(cell, qp) = eDensity;
<a name="l00698"></a>00698         <a class="code" href="classQCAD_1_1PoissonSource.html#a33c2a1c3d6884eb0ff1ef71522e55716">holeDensity</a>(cell, qp) = hDensity;
<a name="l00699"></a>00699         <a class="code" href="classQCAD_1_1PoissonSource.html#a47708a787cf7f127b0ef44b7d658d42f">electricPotential</a>(cell, qp) = phi*V0 - qPhiRef;
<a name="l00700"></a>00700         <a class="code" href="classQCAD_1_1PoissonSource.html#aec699e0c6ff57c1fe2100610abe6ac70">ionizedDopant</a>(cell, qp) = ionN;
<a name="l00701"></a>00701         <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell, qp) = qPhiRef-Chi-phi*V0; <span class="comment">// [eV]</span>
<a name="l00702"></a>00702         <a class="code" href="classQCAD_1_1PoissonSource.html#ac3d211c7dfc559d0b5d6903cb2509e63">valenceBand</a>(cell, qp) = <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell,qp)-Eg;
<a name="l00703"></a>00703         <a class="code" href="classQCAD_1_1PoissonSource.html#a862d9a94dfdeca69318880357360f2b4">approxQuanEDen</a>(cell,qp) = 0.0; 
<a name="l00704"></a>00704         <a class="code" href="classQCAD_1_1PoissonSource.html#a0300c56c6a9ff5b939d79b2598dd7800">artCBDensity</a>(cell, qp) = ( eDensity &gt; 1e-6 ? eDensity 
<a name="l00705"></a>00705              : -Nc*(this-&gt;*carrStat)( -(phi+eArgOffset) ));
<a name="l00706"></a>00706       }
<a name="l00707"></a>00707       
<a name="l00708"></a>00708      } <span class="comment">// end of if ( (coord[0] &gt; oxideWidth) ...)</span>
<a name="l00709"></a>00709 
<a name="l00710"></a>00710 
<a name="l00711"></a>00711      <span class="comment">// Oxide region</span>
<a name="l00712"></a>00712      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((coord[0] &gt;= 0) &amp;&amp; (coord[0] &lt;= <a class="code" href="classQCAD_1_1PoissonSource.html#a600a98d5cfae07bfed715de5b1921c67" title="specific parameters for &amp;quot;1D MOSCapacitor&amp;quot;">oxideWidth</a>))
<a name="l00713"></a>00713      {
<a name="l00714"></a>00714       <span class="keyword">const</span> std::string matName = <span class="stringliteral">&quot;SiliconDioxide&quot;</span> ;  
<a name="l00715"></a>00715       <span class="keywordtype">double</span> Eg = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(matName,<span class="stringliteral">&quot;Band Gap&quot;</span>,0.0);
<a name="l00716"></a>00716       <span class="keywordtype">double</span> Chi = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(matName,<span class="stringliteral">&quot;Electron Affinity&quot;</span>,0.0);
<a name="l00717"></a>00717 
<a name="l00719"></a>00719       <span class="keywordtype">double</span> ml = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(matName,<span class="stringliteral">&quot;Longitudinal Electron Effective Mass&quot;</span>);
<a name="l00720"></a>00720       <span class="keywordtype">double</span> mt = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(matName,<span class="stringliteral">&quot;Transverse Electron Effective Mass&quot;</span>);        
<a name="l00721"></a>00721       <span class="keywordtype">double</span> invEffMass = (2.0/mt + 1.0/ml) / 3.0;
<a name="l00722"></a>00722       <span class="keywordtype">double</span> averagedEffMass = 1.0 / invEffMass; 
<a name="l00723"></a>00723       <span class="keywordtype">double</span> relPerm = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(matName,<span class="stringliteral">&quot;Permittivity&quot;</span>);
<a name="l00724"></a>00724      
<a name="l00725"></a>00725       <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> fixedCharge = 0.0; <span class="comment">// [cm^-3]</span>
<a name="l00726"></a>00726 
<a name="l00728"></a>00728       <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#ab4b4436c43160ef17f769bfb836dfa76">quantumRegionSource</a> == <span class="stringliteral">&quot;schrodinger&quot;</span>)
<a name="l00729"></a>00729       {
<a name="l00730"></a>00730         <span class="comment">// retrieve Previous Poisson Potential</span>
<a name="l00731"></a>00731         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> prevPhi = 0.0, approxEDensity = 0.0;
<a name="l00732"></a>00732         
<a name="l00733"></a>00733         <span class="keywordflow">if</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#a623c1ec89816a9681889f657470d13f8" title="Schrodinger coupling.">bUsePredictorCorrector</a>) {
<a name="l00734"></a>00734     <a class="code" href="namespaceAlbany.html#a76b8c026e962fe80abcca7402bdad39b">Albany::MDArray</a> prevPhiArray = (*workset.stateArrayPtr)[<span class="stringliteral">&quot;PS Previous Poisson Potential&quot;</span>];
<a name="l00735"></a>00735     prevPhi = prevPhiArray(cell,qp);
<a name="l00736"></a>00736 
<a name="l00737"></a>00737           <span class="comment">// compute the approximate quantum electron density using predictor-corrector method</span>
<a name="l00738"></a>00738           approxEDensity = <a class="code" href="classQCAD_1_1PoissonSource.html#acd97a33569f4b36fb2fc06d6ab703c7e" title="----------------- Quantum electron density functions ---------------------">eDensityForPoissonSchrodinger</a>(workset, cell, qp, prevPhi, <span class="keyword">true</span>, 0.0, -1.0);
<a name="l00739"></a>00739   }
<a name="l00740"></a>00740         <span class="keywordflow">else</span>
<a name="l00741"></a>00741           approxEDensity = <a class="code" href="classQCAD_1_1PoissonSource.html#acd97a33569f4b36fb2fc06d6ab703c7e" title="----------------- Quantum electron density functions ---------------------">eDensityForPoissonSchrodinger</a>(workset, cell, qp, 0.0, <span class="keyword">false</span>, 0.0, -1.0);
<a name="l00742"></a>00742 
<a name="l00743"></a>00743         <span class="comment">// compute the exact quantum electron density</span>
<a name="l00744"></a>00744         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> eDensity = <a class="code" href="classQCAD_1_1PoissonSource.html#acd97a33569f4b36fb2fc06d6ab703c7e" title="----------------- Quantum electron density functions ---------------------">eDensityForPoissonSchrodinger</a>(workset, cell, qp, 0.0, <span class="keyword">false</span>, 0.0, -1.0);
<a name="l00745"></a>00745 
<a name="l00746"></a>00746         <span class="comment">// obtain the scaled potential</span>
<a name="l00747"></a>00747         <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp; unscaled_phi = <a class="code" href="classQCAD_1_1PoissonSource.html#ae66f55a004430bfc3497f006bdbe7f01">potential</a>(cell,qp);
<a name="l00748"></a>00748         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> phi = unscaled_phi / V0; 
<a name="l00749"></a>00749 
<a name="l00750"></a>00750         <span class="comment">//(No other classical density in insulator)</span>
<a name="l00751"></a>00751               
<a name="l00752"></a>00752         <span class="comment">// the scaled full RHS</span>
<a name="l00753"></a>00753         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> charge;
<a name="l00754"></a>00754         charge = 1.0/Lambda2 * (-approxEDensity + fixedCharge);
<a name="l00755"></a>00755         <a class="code" href="classQCAD_1_1PoissonSource.html#a4d3f473e00eac7aafe120bd596db647d" title="output">poissonSource</a>(cell, qp) = <a class="code" href="classQCAD_1_1PoissonSource.html#a3412793c06f499339644c5462b336350" title="constant prefactor parameter in source function">factor</a>*charge;
<a name="l00756"></a>00756 
<a name="l00757"></a>00757         <span class="comment">// output states</span>
<a name="l00758"></a>00758         <a class="code" href="classQCAD_1_1PoissonSource.html#ae574ccc85e9e3986d56b1b1b6b7a924d">chargeDensity</a>(cell, qp) = -eDensity + fixedCharge; 
<a name="l00759"></a>00759         <a class="code" href="classQCAD_1_1PoissonSource.html#a0a2d8a657e36facc1df8e509228910b8">electronDensity</a>(cell, qp) = eDensity;  <span class="comment">// quantum electrons in an insulator</span>
<a name="l00760"></a>00760         <a class="code" href="classQCAD_1_1PoissonSource.html#a33c2a1c3d6884eb0ff1ef71522e55716">holeDensity</a>(cell, qp) = 0.0;           <span class="comment">// no holes in an insulator</span>
<a name="l00761"></a>00761         <a class="code" href="classQCAD_1_1PoissonSource.html#aec699e0c6ff57c1fe2100610abe6ac70">ionizedDopant</a>(cell, qp) = 0.0;
<a name="l00762"></a>00762         <a class="code" href="classQCAD_1_1PoissonSource.html#a862d9a94dfdeca69318880357360f2b4">approxQuanEDen</a>(cell,qp) = approxEDensity;
<a name="l00763"></a>00763         <a class="code" href="classQCAD_1_1PoissonSource.html#a0300c56c6a9ff5b939d79b2598dd7800">artCBDensity</a>(cell, qp) = eDensity;
<a name="l00764"></a>00764 
<a name="l00765"></a>00765         <span class="keywordflow">if</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#a82105311f3e25ff3f753937ad13b048e">bIncludeVxc</a>)  <span class="comment">// include Vxc</span>
<a name="l00766"></a>00766         {
<a name="l00767"></a>00767           <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> Vxc = <a class="code" href="classQCAD_1_1PoissonSource.html#a87523eaee864c9fc18b16892882c5038" title="compute exchange-correlation potential energy within Local Density Approximation">computeVxcLDA</a>(relPerm, averagedEffMass, approxEDensity);
<a name="l00768"></a>00768           <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell, qp) = qPhiRef-Chi-phi*V0 +Vxc; <span class="comment">// [eV]</span>
<a name="l00769"></a>00769     <a class="code" href="classQCAD_1_1PoissonSource.html#a47708a787cf7f127b0ef44b7d658d42f">electricPotential</a>(cell, qp) = phi*V0 + Vxc - qPhiRef; <span class="comment">//add xc correction to electric potential (used in CI delta_ij computation)</span>
<a name="l00770"></a>00770           <span class="comment">// conductionBand(cell, qp) = qPhiRef -Chi -0.5*(phi*V0 +prevPhi) +Vxc; // [eV]</span>
<a name="l00771"></a>00771         }
<a name="l00772"></a>00772         <span class="keywordflow">else</span>  { <span class="comment">// not include Vxc</span>
<a name="l00773"></a>00773           <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell, qp) = qPhiRef-Chi-phi*V0; <span class="comment">// [eV]</span>
<a name="l00774"></a>00774     <a class="code" href="classQCAD_1_1PoissonSource.html#a47708a787cf7f127b0ef44b7d658d42f">electricPotential</a>(cell, qp) = phi*V0 - qPhiRef;
<a name="l00775"></a>00775           <span class="comment">// conductionBand(cell, qp) = qPhiRef -Chi -0.5*(phi*V0 +prevPhi); // [eV]</span>
<a name="l00776"></a>00776   }
<a name="l00777"></a>00777         
<a name="l00778"></a>00778         <a class="code" href="classQCAD_1_1PoissonSource.html#ac3d211c7dfc559d0b5d6903cb2509e63">valenceBand</a>(cell, qp) = <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell,qp)-Eg;
<a name="l00779"></a>00779       }
<a name="l00780"></a>00780     
<a name="l00781"></a>00781       <span class="keywordflow">else</span>  <span class="comment">// use semiclassical source</span>
<a name="l00782"></a>00782       {  
<a name="l00783"></a>00783         <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp; unscaled_phi = <a class="code" href="classQCAD_1_1PoissonSource.html#ae66f55a004430bfc3497f006bdbe7f01">potential</a>(cell,qp);
<a name="l00784"></a>00784         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> phi = unscaled_phi / V0; 
<a name="l00785"></a>00785           
<a name="l00786"></a>00786         <span class="comment">// the scaled full RHS</span>
<a name="l00787"></a>00787         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> charge; 
<a name="l00788"></a>00788         charge = 1.0/Lambda2 * fixedCharge;  <span class="comment">// only fixed charge in an insulator</span>
<a name="l00789"></a>00789         <a class="code" href="classQCAD_1_1PoissonSource.html#a4d3f473e00eac7aafe120bd596db647d" title="output">poissonSource</a>(cell, qp) = <a class="code" href="classQCAD_1_1PoissonSource.html#a3412793c06f499339644c5462b336350" title="constant prefactor parameter in source function">factor</a>*charge;
<a name="l00790"></a>00790     
<a name="l00791"></a>00791         <a class="code" href="classQCAD_1_1PoissonSource.html#ae574ccc85e9e3986d56b1b1b6b7a924d">chargeDensity</a>(cell, qp) = fixedCharge; <span class="comment">// fixed space charge in an insulator</span>
<a name="l00792"></a>00792         <a class="code" href="classQCAD_1_1PoissonSource.html#a0a2d8a657e36facc1df8e509228910b8">electronDensity</a>(cell, qp) = 0.0;       <span class="comment">// no electrons in an insulator</span>
<a name="l00793"></a>00793         <a class="code" href="classQCAD_1_1PoissonSource.html#a33c2a1c3d6884eb0ff1ef71522e55716">holeDensity</a>(cell, qp) = 0.0;           <span class="comment">// no holes in an insulator</span>
<a name="l00794"></a>00794         <a class="code" href="classQCAD_1_1PoissonSource.html#a47708a787cf7f127b0ef44b7d658d42f">electricPotential</a>(cell, qp) = phi*V0 - qPhiRef;
<a name="l00795"></a>00795         <a class="code" href="classQCAD_1_1PoissonSource.html#aec699e0c6ff57c1fe2100610abe6ac70">ionizedDopant</a>(cell, qp) = 0.0;
<a name="l00796"></a>00796         <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell, qp) = qPhiRef-Chi-phi*V0; <span class="comment">// [eV]</span>
<a name="l00797"></a>00797         <a class="code" href="classQCAD_1_1PoissonSource.html#ac3d211c7dfc559d0b5d6903cb2509e63">valenceBand</a>(cell, qp) = <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell,qp)-Eg;
<a name="l00798"></a>00798         <a class="code" href="classQCAD_1_1PoissonSource.html#a862d9a94dfdeca69318880357360f2b4">approxQuanEDen</a>(cell,qp) = 0.0;
<a name="l00799"></a>00799         <a class="code" href="classQCAD_1_1PoissonSource.html#a0300c56c6a9ff5b939d79b2598dd7800">artCBDensity</a>(cell, qp) = 0.0;
<a name="l00800"></a>00800       }
<a name="l00801"></a>00801      
<a name="l00802"></a>00802      } <span class="comment">// end of else if ((coord[0] &gt;= 0) ...)</span>
<a name="l00803"></a>00803      
<a name="l00804"></a>00804      <span class="keywordflow">else</span> 
<a name="l00805"></a>00805       TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,
<a name="l00806"></a>00806          std::endl &lt;&lt; <span class="stringliteral">&quot;Error!  x-coord:&quot;</span> &lt;&lt; coord[0] &lt;&lt; <span class="stringliteral">&quot;is outside the oxideWidth&quot;</span> &lt;&lt; 
<a name="l00807"></a>00807          <span class="stringliteral">&quot; + siliconWidth range: &quot;</span> &lt;&lt; <a class="code" href="classQCAD_1_1PoissonSource.html#a600a98d5cfae07bfed715de5b1921c67" title="specific parameters for &amp;quot;1D MOSCapacitor&amp;quot;">oxideWidth</a> + <a class="code" href="classQCAD_1_1PoissonSource.html#a088df825b707a32305860e5913d3699f">siliconWidth</a> &lt;&lt; <span class="stringliteral">&quot;!&quot;</span>&lt;&lt; std::endl);
<a name="l00808"></a>00808 
<a name="l00809"></a>00809     }  <span class="comment">// end of loop over QPs</span>
<a name="l00810"></a>00810     
<a name="l00811"></a>00811   }  <span class="comment">// end of loop over cells</span>
<a name="l00812"></a>00812   
<a name="l00813"></a>00813 }
<a name="l00814"></a>00814 
<a name="l00815"></a>00815 
<a name="l00816"></a>00816 
<a name="l00817"></a>00817 
<a name="l00818"></a>00818 
<a name="l00820"></a>00820 
<a name="l00821"></a>00821 
<a name="l00822"></a>00822 <span class="comment">// **********************************************************************</span>
<a name="l00823"></a>00823 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l00824"></a>00824 <span class="keyword">typename</span> <a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html">QCAD::PoissonSource&lt;EvalT,Traits&gt;::PoissonSourceSetupInfo</a> 
<a name="l00825"></a><a class="code" href="classQCAD_1_1PoissonSource.html#adf3ae6ace1435778caad366f81a4b200">00825</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT, Traits&gt;::source_setup</a>(<span class="keyword">const</span> std::string&amp; sourceName, <span class="keyword">const</span> std::string&amp; mtrlCategory, 
<a name="l00826"></a>00826              <span class="keyword">const</span> <span class="keyword">typename</span> Traits::EvalData workset)
<a name="l00827"></a>00827 {
<a name="l00828"></a>00828   <a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html">PoissonSourceSetupInfo</a> ret;
<a name="l00829"></a>00829 
<a name="l00830"></a>00830   <span class="keywordtype">double</span> X0 = <a class="code" href="classQCAD_1_1PoissonSource.html#aa7122e9b80328be00b7e50bf61d8c899" title="scaling parameters">length_unit_in_m</a>/1e-2; <span class="comment">// length scaling to get to [cm] (structure dimension in [um] usually)</span>
<a name="l00831"></a>00831   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> temperature = <a class="code" href="classQCAD_1_1PoissonSource.html#acbec0daaf0a9c9de29056d17c577bcdc">temperatureField</a>(0); <span class="comment">//get shared temperature parameter from field</span>
<a name="l00832"></a>00832   ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#abdee072e4f4356812b254f5cc2d48796">kbT</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#ad8f4dcca5195de778795ec98a8afd9b2" title="Public Universal Constants.">kbBoltz</a>*temperature / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// in [myV]</span>
<a name="l00833"></a>00833 
<a name="l00835"></a>00835   ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ada323d86f136f2097c735e4550280755">qPhiRef</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#a4b4c967562f329d8e2456506e01b6ccf">getReferencePotential</a>(workset); <span class="comment">// in [myV]</span>
<a name="l00836"></a>00836 
<a name="l00837"></a>00837   ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a7c0f019ef3aa2f174db24bef3e5f4595">V0</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#ad8f4dcca5195de778795ec98a8afd9b2" title="Public Universal Constants.">kbBoltz</a>*temperature / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// kb*T in desired energy unit ( or kb*T/q in desired voltage unit) [myV]</span>
<a name="l00838"></a>00838   ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a63a4e8a5ad0f2aa59697d64afa1e09a9">Lambda2</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#a66367459749e48e11a50a4fa6457666f">eps0</a>/(<a class="code" href="classQCAD_1_1PoissonSource.html#a69b53a45d322590c547e3b3873180966">eleQ</a>*X0*X0);  <span class="comment">// derived scaling factor</span>
<a name="l00839"></a>00839 
<a name="l00840"></a>00840   <span class="keywordflow">if</span>(mtrlCategory == <span class="stringliteral">&quot;Semiconductor&quot;</span>) {
<a name="l00841"></a>00841 
<a name="l00843"></a>00843     <span class="keywordtype">double</span> mdn = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Electron DOS Effective Mass&quot;</span>);
<a name="l00844"></a>00844     <span class="keywordtype">double</span> mdp = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Hole DOS Effective Mass&quot;</span>);
<a name="l00845"></a>00845     <span class="keywordtype">double</span> Tref = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Reference Temperature&quot;</span>); <span class="comment">// in [K]</span>
<a name="l00846"></a>00846     
<a name="l00847"></a>00847     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a174729817e0542b61b6b398360c3ff67">Chi</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Electron Affinity&quot;</span>) / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// in [myV]</span>
<a name="l00848"></a>00848     <span class="keywordtype">double</span> Eg0 = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Zero Temperature Band Gap&quot;</span>) / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// in [myV]</span>
<a name="l00849"></a>00849     <span class="keywordtype">double</span> <a class="code" href="namespaceFELIX.html#a4d08741b97fea3938089670d2a84c598">alpha</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Band Gap Alpha Coefficient&quot;</span>); <span class="comment">// in [eV]</span>
<a name="l00850"></a>00850     <span class="keywordtype">double</span> beta = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Band Gap Beta Coefficient&quot;</span>); <span class="comment">// in [K]</span>
<a name="l00851"></a>00851     
<a name="l00853"></a>00853     <span class="keywordtype">double</span> NcvFactor = 2.0*pow((<a class="code" href="classQCAD_1_1PoissonSource.html#ad8f4dcca5195de778795ec98a8afd9b2" title="Public Universal Constants.">kbBoltz</a>*<a class="code" href="classQCAD_1_1PoissonSource.html#a69b53a45d322590c547e3b3873180966">eleQ</a>*<a class="code" href="classQCAD_1_1PoissonSource.html#a7385d003a75e31eeaaf8637a9bee1731">m0</a>*Tref)/(2*<a class="code" href="classQCAD_1_1PoissonSource.html#a35d68aa6b59eabed3579ab39f2473861">pi</a>*pow(<a class="code" href="classQCAD_1_1PoissonSource.html#ab12eefe71615a8407a289022fc043464">hbar</a>,2)),3./2.)*1e-6;
<a name="l00854"></a>00854             <span class="comment">// eleQ converts kbBoltz in [eV/K] to [J/K], 1e-6 converts [m-3] to [cm-3]</span>
<a name="l00855"></a>00855                 
<a name="l00856"></a>00856     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a14cd3ebba802cf34a80998450d0271e4" title="argument offset in calculating electron and hole density [unitless]">Nc</a> = NcvFactor*pow(mdn,1.5)*pow(temperature/Tref,1.5);  <span class="comment">// in [cm-3]</span>
<a name="l00857"></a>00857     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#aad653eeba31bac1db3482a7996cdaece">Nv</a> = NcvFactor*pow(mdp,1.5)*pow(temperature/Tref,1.5); 
<a name="l00858"></a>00858     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a8b6cdab1bb17e9d1705e052f4b019f55">Eg</a> = Eg0 - (alpha*pow(temperature,2.0)/(beta+temperature)) / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// in [myV]</span>
<a name="l00859"></a>00859     
<a name="l00860"></a>00860 
<a name="l00861"></a>00861     <span class="comment">//ni = sqrt(Nc*Nv)*exp(-Eg/(2.0*kbT));    // in [cm-3]</span>
<a name="l00862"></a>00862 
<a name="l00864"></a>00864     <span class="keyword">const</span> std::string&amp; condBandMin = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;std::string&gt;(workset.EBName,<span class="stringliteral">&quot;Conduction Band Minimum&quot;</span>);
<a name="l00865"></a>00865     <span class="keywordtype">double</span> ml = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Longitudinal Electron Effective Mass&quot;</span>);
<a name="l00866"></a>00866     <span class="keywordtype">double</span> mt = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Transverse Electron Effective Mass&quot;</span>);        
<a name="l00867"></a>00867     <span class="keywordflow">if</span> ((condBandMin == <span class="stringliteral">&quot;Gamma Valley&quot;</span>) &amp;&amp; (abs(ml-mt) &gt; 1e-10))
<a name="l00868"></a>00868       TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, std::logic_error, <span class="stringliteral">&quot;Gamma Valley&#39;s longitudinal and &quot;</span>
<a name="l00869"></a>00869         &lt;&lt; <span class="stringliteral">&quot;transverse electron effective mass must be equal ! &quot;</span>
<a name="l00870"></a>00870         &lt;&lt; <span class="stringliteral">&quot;Please check the values in materials.xml&quot;</span> &lt;&lt; std::endl);
<a name="l00871"></a>00871     
<a name="l00872"></a>00872     <span class="keywordtype">double</span> invEffMass = (2.0/mt + 1.0/ml) / 3.0;
<a name="l00873"></a>00873     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#af4ef89149ccbb534a81713da1136029d">averagedEffMass</a> = 1.0 / invEffMass; 
<a name="l00874"></a>00874     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#aa68b65cd0f06237a69fdc53a519f1b31">relPerm</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Permittivity&quot;</span>);
<a name="l00875"></a>00875     
<a name="l00877"></a>00877     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a92e7fd83d8bc5a0d3273e2c2b2ece377">eArgOffset</a> = (-ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ada323d86f136f2097c735e4550280755">qPhiRef</a>+ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a174729817e0542b61b6b398360c3ff67">Chi</a>)/ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#abdee072e4f4356812b254f5cc2d48796">kbT</a>;
<a name="l00878"></a>00878     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a29df8e4dae5068286d8c18c87f09f362">hArgOffset</a> = (ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ada323d86f136f2097c735e4550280755">qPhiRef</a>-ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a174729817e0542b61b6b398360c3ff67">Chi</a>-ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a8b6cdab1bb17e9d1705e052f4b019f55">Eg</a>)/ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#abdee072e4f4356812b254f5cc2d48796">kbT</a>;
<a name="l00879"></a>00879         
<a name="l00880"></a>00880     <span class="keywordflow">if</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#a36ac1600805580de01cffada6a8c6bf7" title="specify carrier statistics and incomplete ionization">carrierStatistics</a> == <span class="stringliteral">&quot;Boltzmann Statistics&quot;</span>)
<a name="l00881"></a>00881       ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a991ff9292623aa18e9860f0299534bc4" title="function pointer to carrier statistics member function">carrStat</a> = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::computeMBStat</a>;  
<a name="l00882"></a>00882 
<a name="l00883"></a>00883     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#a36ac1600805580de01cffada6a8c6bf7" title="specify carrier statistics and incomplete ionization">carrierStatistics</a> == <span class="stringliteral">&quot;Fermi-Dirac Statistics&quot;</span>)
<a name="l00884"></a>00884       ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a991ff9292623aa18e9860f0299534bc4" title="function pointer to carrier statistics member function">carrStat</a> = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::computeFDIntOneHalf</a>;
<a name="l00885"></a>00885 
<a name="l00886"></a>00886     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#a36ac1600805580de01cffada6a8c6bf7" title="specify carrier statistics and incomplete ionization">carrierStatistics</a> == <span class="stringliteral">&quot;0-K Fermi-Dirac Statistics&quot;</span>)
<a name="l00887"></a>00887       ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a991ff9292623aa18e9860f0299534bc4" title="function pointer to carrier statistics member function">carrStat</a> = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::computeZeroKFDInt</a>;
<a name="l00888"></a>00888 
<a name="l00889"></a>00889     <span class="keywordflow">else</span> TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,
<a name="l00890"></a>00890         std::endl &lt;&lt; <span class="stringliteral">&quot;Error!  Unknown carrier statistics ! &quot;</span> &lt;&lt; std::endl);
<a name="l00891"></a>00891     
<a name="l00892"></a>00892     <span class="keywordflow">if</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#a25f70d6c90c767cade9c663081913bbf">incompIonization</a> == <span class="stringliteral">&quot;False&quot;</span>)
<a name="l00893"></a>00893       ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a415b36da11100cace23924c48e3bc670" title="function pointer to ionized dopants member function">ionDopant</a> = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::fullDopants</a>; 
<a name="l00894"></a>00894     
<a name="l00895"></a>00895     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#a25f70d6c90c767cade9c663081913bbf">incompIonization</a> == <span class="stringliteral">&quot;True&quot;</span>)
<a name="l00896"></a>00896       ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a415b36da11100cace23924c48e3bc670" title="function pointer to ionized dopants member function">ionDopant</a> = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::ionizedDopants</a>;
<a name="l00897"></a>00897     
<a name="l00898"></a>00898     <span class="keywordflow">else</span> TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,
<a name="l00899"></a>00899         std::endl &lt;&lt; <span class="stringliteral">&quot;Error!  Invalid incomplete ionization option ! &quot;</span> &lt;&lt; std::endl);
<a name="l00900"></a>00900 
<a name="l00902"></a>00902 
<a name="l00903"></a>00903     <span class="comment">//  Each element block must have an associated Fermi level, otherwise</span>
<a name="l00904"></a>00904     <span class="comment">//  the Poisson source term cannot be computed.  Since QCAD does not implement</span>
<a name="l00905"></a>00905     <span class="comment">//  drift-diffusion equations, this Fermi level must be specified directly.  This </span>
<a name="l00906"></a>00906     <span class="comment">//  can be done in several ways:</span>
<a name="l00907"></a>00907     <span class="comment">//   1) a nodeset with a DBC (e.g. a contact) specifies &quot;elementBlock&quot; in its materials db list</span>
<a name="l00908"></a>00908     <span class="comment">//   2) an element block itself specifies &quot;contactNodeset&quot; in its materials db list</span>
<a name="l00909"></a>00909     <span class="comment">//   3) if neither 1) nor 2) hold, a default value of zero is used as the Fermi level.</span>
<a name="l00910"></a>00910 
<a name="l00911"></a>00911     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a4c8a6cc9949293c0bfd4b88b0319447b">fermiE</a> = 0.0;  <span class="comment">// default, [myV]</span>
<a name="l00912"></a>00912     <span class="keywordflow">if</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#a864e0c4a03bc1bb0835c09ed28b1fa3a" title="Map element block and nodeset names to their associated DBC values.">mapDBCValue_eb</a>.count(workset.EBName) &gt; 0) 
<a name="l00913"></a>00913     {
<a name="l00914"></a>00914       ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a4c8a6cc9949293c0bfd4b88b0319447b">fermiE</a> = -1.0*<a class="code" href="classQCAD_1_1PoissonSource.html#a864e0c4a03bc1bb0835c09ed28b1fa3a" title="Map element block and nodeset names to their associated DBC values.">mapDBCValue_eb</a>[workset.EBName] / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// [myV] (DBCs are in volts, regardless of desired output energy unit)</span>
<a name="l00915"></a>00915       <span class="comment">// std::cout &lt;&lt; &quot;EBName = &quot; &lt;&lt; workset.EBName &lt;&lt; &quot;, ret.fermiE = &quot; &lt;&lt; ret.fermiE &lt;&lt; std::endl; </span>
<a name="l00916"></a>00916     }
<a name="l00917"></a>00917     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;isElementBlockParam(workset.EBName, <span class="stringliteral">&quot;contactNodeset&quot;</span>))
<a name="l00918"></a>00918     {
<a name="l00919"></a>00919       std::string nsName = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;std::string&gt;(workset.EBName, <span class="stringliteral">&quot;contactNodeset&quot;</span>);
<a name="l00920"></a>00920       <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#a583ba511f82963de327783e63caa7e03">mapDBCValue_ns</a>.count(nsName) &gt; 0)
<a name="l00921"></a>00921   ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a4c8a6cc9949293c0bfd4b88b0319447b">fermiE</a> = -1.0*<a class="code" href="classQCAD_1_1PoissonSource.html#a583ba511f82963de327783e63caa7e03">mapDBCValue_ns</a>[nsName] / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// [myV]</span>
<a name="l00922"></a>00922     }
<a name="l00923"></a>00923 
<a name="l00925"></a>00925     <span class="comment">//** Note: doping profile unused currently</span>
<a name="l00926"></a>00926     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a1dfc7fb1fd3c60aecfb33a6ba6a276e0" title="Activated dopants / Fixed constant charge.">fixedChargeType</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;std::string&gt;(workset.EBName,<span class="stringliteral">&quot;Dopant Type&quot;</span>,<span class="stringliteral">&quot;None&quot;</span>);
<a name="l00927"></a>00927     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a576e4a992e58fc9be4702146dec7089e">fixedChargeConc</a> = 0.0; <span class="comment">//only applies to insulators</span>
<a name="l00928"></a>00928     std::string dopingProfile;
<a name="l00929"></a>00929 
<a name="l00930"></a>00930     <span class="keywordflow">if</span>(ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a1dfc7fb1fd3c60aecfb33a6ba6a276e0" title="Activated dopants / Fixed constant charge.">fixedChargeType</a> != <span class="stringliteral">&quot;None&quot;</span>) {
<a name="l00931"></a>00931       <span class="keywordtype">double</span> dopantActE;
<a name="l00932"></a>00932       dopingProfile = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;std::string&gt;(workset.EBName,<span class="stringliteral">&quot;Doping Profile&quot;</span>,<span class="stringliteral">&quot;Constant&quot;</span>);
<a name="l00933"></a>00933       dopantActE = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Dopant Activation Energy&quot;</span>,0.045) / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// [myV]</span>
<a name="l00934"></a>00934     
<a name="l00935"></a>00935       <span class="keywordflow">if</span>( <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;isElementBlockParam(workset.EBName, <span class="stringliteral">&quot;Doping Value&quot;</span>) ) 
<a name="l00936"></a>00936         ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a647ec3052ad088df2a561b550ca3a0ae">dopingConc</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Doping Value&quot;</span>);
<a name="l00937"></a>00937       <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;isElementBlockParam(workset.EBName, <span class="stringliteral">&quot;Doping Parameter Name&quot;</span>) ) {
<a name="l00938"></a>00938         <span class="keywordtype">double</span> scl = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Doping Parameter Scaling&quot;</span>, 1.0);
<a name="l00939"></a>00939         ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a647ec3052ad088df2a561b550ca3a0ae">dopingConc</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#ae5648f10426a7ed73e61668eb37bafd1" title="Material database parameter values.">materialParams</a>[ <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;std::string&gt;(workset.EBName,<span class="stringliteral">&quot;Doping Parameter Name&quot;</span>) ] * scl;
<a name="l00940"></a>00940       }
<a name="l00941"></a>00941       <span class="keywordflow">else</span> TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,
<a name="l00942"></a>00942         std::endl &lt;&lt; <span class="stringliteral">&quot;Error!  Unknown dopant concentration for &quot;</span> &lt;&lt; workset.EBName &lt;&lt; <span class="stringliteral">&quot;!&quot;</span>&lt;&lt; std::endl);
<a name="l00943"></a>00943 
<a name="l00944"></a>00944       <span class="keywordflow">if</span>(ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a1dfc7fb1fd3c60aecfb33a6ba6a276e0" title="Activated dopants / Fixed constant charge.">fixedChargeType</a> == <span class="stringliteral">&quot;Donor&quot;</span>) 
<a name="l00945"></a>00945         ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#af5c3db6e40e6ba1e45e53b0f2f1b6d8d">inArg</a> = ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a92e7fd83d8bc5a0d3273e2c2b2ece377">eArgOffset</a> + dopantActE/ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#abdee072e4f4356812b254f5cc2d48796">kbT</a> + ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a4c8a6cc9949293c0bfd4b88b0319447b">fermiE</a>/ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#abdee072e4f4356812b254f5cc2d48796">kbT</a>;
<a name="l00946"></a>00946       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a1dfc7fb1fd3c60aecfb33a6ba6a276e0" title="Activated dopants / Fixed constant charge.">fixedChargeType</a> == <span class="stringliteral">&quot;Acceptor&quot;</span>) 
<a name="l00947"></a>00947         ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#af5c3db6e40e6ba1e45e53b0f2f1b6d8d">inArg</a> = ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a29df8e4dae5068286d8c18c87f09f362">hArgOffset</a> + dopantActE/ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#abdee072e4f4356812b254f5cc2d48796">kbT</a> - ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a4c8a6cc9949293c0bfd4b88b0319447b">fermiE</a>/ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#abdee072e4f4356812b254f5cc2d48796">kbT</a>;
<a name="l00948"></a>00948       <span class="keywordflow">else</span> TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,
<a name="l00949"></a>00949          std::endl &lt;&lt; <span class="stringliteral">&quot;Error!  Unknown dopant type &quot;</span> &lt;&lt; ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a1dfc7fb1fd3c60aecfb33a6ba6a276e0" title="Activated dopants / Fixed constant charge.">fixedChargeType</a> &lt;&lt; <span class="stringliteral">&quot;!&quot;</span>&lt;&lt; std::endl);
<a name="l00950"></a>00950     }
<a name="l00951"></a>00951     <span class="keywordflow">else</span> {
<a name="l00952"></a>00952       dopingProfile = <span class="stringliteral">&quot;Constant&quot;</span>;
<a name="l00953"></a>00953       ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a647ec3052ad088df2a561b550ca3a0ae">dopingConc</a> = 0.0;
<a name="l00954"></a>00954       ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#af5c3db6e40e6ba1e45e53b0f2f1b6d8d">inArg</a> = 0.0;
<a name="l00955"></a>00955     }
<a name="l00956"></a>00956 
<a name="l00957"></a>00957   } <span class="comment">// end &quot;Semiconductor&quot; setup</span>
<a name="l00958"></a>00958   
<a name="l00959"></a>00959   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtrlCategory == <span class="stringliteral">&quot;Insulator&quot;</span>)
<a name="l00960"></a>00960   {  
<a name="l00961"></a>00961     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a8b6cdab1bb17e9d1705e052f4b019f55">Eg</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Band Gap&quot;</span>,0.0) / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// [myV]</span>
<a name="l00962"></a>00962     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a174729817e0542b61b6b398360c3ff67">Chi</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Electron Affinity&quot;</span>,0.0) / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// [myV]</span>
<a name="l00963"></a>00963     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a991ff9292623aa18e9860f0299534bc4" title="function pointer to carrier statistics member function">carrStat</a> = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::computeZeroStat</a>; <span class="comment">//always zero  </span>
<a name="l00964"></a>00964 
<a name="l00965"></a>00965     <span class="comment">//Unused in insulator.  Set as zero</span>
<a name="l00966"></a>00966     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a14cd3ebba802cf34a80998450d0271e4" title="argument offset in calculating electron and hole density [unitless]">Nc</a> = ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#aad653eeba31bac1db3482a7996cdaece">Nv</a> = 0.0;
<a name="l00967"></a>00967     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a29df8e4dae5068286d8c18c87f09f362">hArgOffset</a> = ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a92e7fd83d8bc5a0d3273e2c2b2ece377">eArgOffset</a> = 0.0;
<a name="l00968"></a>00968     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a4c8a6cc9949293c0bfd4b88b0319447b">fermiE</a> = 0.0;
<a name="l00969"></a>00969     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a647ec3052ad088df2a561b550ca3a0ae">dopingConc</a> = 0.0; <span class="comment">//only applies to semiconductors</span>
<a name="l00970"></a>00970 
<a name="l00972"></a>00972     <span class="keywordflow">if</span>( <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;isElementBlockParam(workset.EBName, <span class="stringliteral">&quot;Charge Value&quot;</span>) ) {
<a name="l00973"></a>00973       ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a1dfc7fb1fd3c60aecfb33a6ba6a276e0" title="Activated dopants / Fixed constant charge.">fixedChargeType</a> = <span class="stringliteral">&quot;Constant&quot;</span>;
<a name="l00974"></a>00974       ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a576e4a992e58fc9be4702146dec7089e">fixedChargeConc</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Charge Value&quot;</span>);
<a name="l00975"></a>00975       <span class="comment">//std::cout &lt;&lt; &quot;DEBUG: applying fixed charge &quot; &lt;&lt; ret.fixedChargeConc &lt;&lt; &quot; to element block &#39;&quot; &lt;&lt; workset.EBName &lt;&lt; &quot;&#39;&quot; &lt;&lt; std::endl;</span>
<a name="l00976"></a>00976     }
<a name="l00977"></a>00977     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;isElementBlockParam(workset.EBName, <span class="stringliteral">&quot;Charge Parameter Name&quot;</span>) ) { 
<a name="l00978"></a>00978       <span class="keywordtype">double</span> scl = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Charge Parameter Scaling&quot;</span>, 1.0);
<a name="l00979"></a>00979       ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a1dfc7fb1fd3c60aecfb33a6ba6a276e0" title="Activated dopants / Fixed constant charge.">fixedChargeType</a> = <span class="stringliteral">&quot;Constant&quot;</span>;
<a name="l00980"></a>00980       ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a576e4a992e58fc9be4702146dec7089e">fixedChargeConc</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#ae5648f10426a7ed73e61668eb37bafd1" title="Material database parameter values.">materialParams</a>[ <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;std::string&gt;(workset.EBName,<span class="stringliteral">&quot;Charge Parameter Name&quot;</span>) ] * scl;
<a name="l00981"></a>00981       <span class="comment">//std::cout &lt;&lt; &quot;DEBUG: applying fixed charge &quot; &lt;&lt; ret.fixedChargeConc &lt;&lt; &quot; to element block &#39;&quot; &lt;&lt; workset.EBName &lt;&lt; &quot;&#39; via param&quot; &lt;&lt; std::endl;</span>
<a name="l00982"></a>00982     }
<a name="l00983"></a>00983     <span class="keywordflow">else</span> {
<a name="l00984"></a>00984       ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a1dfc7fb1fd3c60aecfb33a6ba6a276e0" title="Activated dopants / Fixed constant charge.">fixedChargeType</a> = <span class="stringliteral">&quot;None&quot;</span>;
<a name="l00985"></a>00985       ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a576e4a992e58fc9be4702146dec7089e">fixedChargeConc</a> = 0.0; 
<a name="l00986"></a>00986     }
<a name="l00987"></a>00987 
<a name="l00989"></a>00989     <span class="keywordtype">double</span> ml = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Longitudinal Electron Effective Mass&quot;</span>);
<a name="l00990"></a>00990     <span class="keywordtype">double</span> mt = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Transverse Electron Effective Mass&quot;</span>);        
<a name="l00991"></a>00991     <span class="keywordflow">if</span> (abs(ml-mt) &gt; 1e-10) 
<a name="l00992"></a>00992       TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, std::logic_error, <span class="stringliteral">&quot;Insulator&#39;s longitudinal and &quot;</span>
<a name="l00993"></a>00993          &lt;&lt; <span class="stringliteral">&quot;transverse electron effective mass must be equal ! &quot;</span>
<a name="l00994"></a>00994          &lt;&lt; <span class="stringliteral">&quot;Please check the values in materials.xml&quot;</span> &lt;&lt; std::endl);
<a name="l00995"></a>00995 
<a name="l00996"></a>00996     <span class="keywordtype">double</span> invEffMass = (2.0/mt + 1.0/ml) / 3.0;
<a name="l00997"></a>00997     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#af4ef89149ccbb534a81713da1136029d">averagedEffMass</a> = 1.0 / invEffMass; 
<a name="l00998"></a>00998     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#aa68b65cd0f06237a69fdc53a519f1b31">relPerm</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Permittivity&quot;</span>);
<a name="l00999"></a>00999   } <span class="comment">// end &quot;Insulator&quot; setup</span>
<a name="l01000"></a>01000 
<a name="l01001"></a>01001 
<a name="l01002"></a>01002   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mtrlCategory == <span class="stringliteral">&quot;Metal&quot;</span>)
<a name="l01003"></a>01003   {  
<a name="l01004"></a>01004     <span class="comment">// Use work function where semiconductor and insulator use electron affinity</span>
<a name="l01005"></a>01005     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a174729817e0542b61b6b398360c3ff67">Chi</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Work Function&quot;</span>) / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// [myV]</span>
<a name="l01006"></a>01006     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a8b6cdab1bb17e9d1705e052f4b019f55">Eg</a> = 0.0;  <span class="comment">//no bandgap in metals</span>
<a name="l01007"></a>01007   } <span class="comment">// end &quot;Metal&quot; setup</span>
<a name="l01008"></a>01008 
<a name="l01009"></a>01009   <span class="keywordflow">else</span> {
<a name="l01010"></a>01010     TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,
<a name="l01011"></a>01011             std::endl &lt;&lt; <span class="stringliteral">&quot;Error!  Unknown material category &quot;</span> 
<a name="l01012"></a>01012       &lt;&lt; mtrlCategory &lt;&lt; <span class="stringliteral">&quot;!&quot;</span> &lt;&lt; std::endl);
<a name="l01013"></a>01013   }
<a name="l01014"></a>01014 
<a name="l01015"></a>01015   <span class="comment">// Previous electron density -- used for daming PS iterations</span>
<a name="l01016"></a>01016   ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a56697903b9dd449be634a050fd05639e">prevDensityFactor</a> = QCAD::EvaluatorTools&lt;EvalT,Traits&gt;::getDoubleValue( <a class="code" href="classQCAD_1_1PoissonSource.html#a3346c7205b90aeb59b82004cad032f14">prevDensityMixingFactor</a> );
<a name="l01017"></a>01017 
<a name="l01018"></a>01018   <span class="comment">//HACK</span>
<a name="l01019"></a>01019   <span class="keyword">static</span> <span class="keywordtype">double</span> lastNonDefaultFactor = -1.0;
<a name="l01020"></a>01020   <span class="keywordflow">if</span>(ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a56697903b9dd449be634a050fd05639e">prevDensityFactor</a> &lt; 0.0) { <span class="comment">//factor was not set by parameters, which is probably an interal Albany bug, so set using last non-default param</span>
<a name="l01021"></a>01021     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a56697903b9dd449be634a050fd05639e">prevDensityFactor</a> = lastNonDefaultFactor;
<a name="l01022"></a>01022     <span class="comment">//std::cout &lt;&lt; &quot;WARNING: prevDensityMixingFactor was not set via a parameter - setting to last non-default = &quot; &lt;&lt; lastNonDefaultFactor &lt;&lt; std::endl;</span>
<a name="l01023"></a>01023   }
<a name="l01024"></a>01024   <span class="keywordflow">if</span>(ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a56697903b9dd449be634a050fd05639e">prevDensityFactor</a> != lastNonDefaultFactor) {
<a name="l01025"></a>01025     std::cout &lt;&lt; <span class="stringliteral">&quot;DEBUG: setup prevDensityMixingFactor = &quot;</span> &lt;&lt; ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a56697903b9dd449be634a050fd05639e">prevDensityFactor</a> 
<a name="l01026"></a>01026         &lt;&lt; <span class="stringliteral">&quot; (lastDef = &quot;</span> &lt;&lt; lastNonDefaultFactor &lt;&lt; <span class="stringliteral">&quot;, scalarT = &quot;</span> &lt;&lt; <a class="code" href="classQCAD_1_1PoissonSource.html#a3346c7205b90aeb59b82004cad032f14">prevDensityMixingFactor</a> &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; std::endl;
<a name="l01027"></a>01027     lastNonDefaultFactor = ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a56697903b9dd449be634a050fd05639e">prevDensityFactor</a>;
<a name="l01028"></a>01028   }
<a name="l01029"></a>01029   <span class="comment">//END HACK</span>
<a name="l01030"></a>01030 
<a name="l01031"></a>01031   <span class="keywordflow">if</span>(ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a56697903b9dd449be634a050fd05639e">prevDensityFactor</a> &gt; 1e-8)
<a name="l01032"></a>01032     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a19989646723aee026c67e0c1c99f90aa">prevDensityArray</a> = (*workset.stateArrayPtr)[<span class="stringliteral">&quot;PS Previous Electron Density&quot;</span>];
<a name="l01033"></a>01033 
<a name="l01034"></a>01034   ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ae677aa71eb32a075a4ff8b58378ecb03" title="function pointer to quantum electron density member function">quantum_edensity_fn</a> = NULL; <span class="comment">//default</span>
<a name="l01035"></a>01035 
<a name="l01036"></a>01036   <span class="comment">//Fill additional members for quantum and coulomb sources</span>
<a name="l01037"></a>01037   <span class="keywordflow">if</span>(sourceName == <span class="stringliteral">&quot;schrodinger&quot;</span>) {
<a name="l01038"></a>01038     <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#a623c1ec89816a9681889f657470d13f8" title="Schrodinger coupling.">bUsePredictorCorrector</a>) <span class="comment">// retrieve Previous Poisson Potential</span>
<a name="l01039"></a>01039       ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a8bfe0c70453442b3f27aed498b44a68d">prevPhiArray</a> = (*workset.stateArrayPtr)[<span class="stringliteral">&quot;PS Previous Poisson Potential&quot;</span>]; <span class="comment">//assumed in [myV]</span>
<a name="l01040"></a>01040 
<a name="l01041"></a>01041     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ae677aa71eb32a075a4ff8b58378ecb03" title="function pointer to quantum electron density member function">quantum_edensity_fn</a> = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::eDensityForPoissonSchrodinger</a>;
<a name="l01042"></a>01042   }
<a name="l01043"></a>01043   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(sourceName == <span class="stringliteral">&quot;ci&quot;</span>) {
<a name="l01044"></a>01044     <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#a623c1ec89816a9681889f657470d13f8" title="Schrodinger coupling.">bUsePredictorCorrector</a>) <span class="comment">// retrieve Previous Poisson Potential</span>
<a name="l01045"></a>01045       ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a8bfe0c70453442b3f27aed498b44a68d">prevPhiArray</a> = (*workset.stateArrayPtr)[<span class="stringliteral">&quot;PS Previous Poisson Potential&quot;</span>]; <span class="comment">//assumed in [myV]</span>
<a name="l01046"></a>01046 
<a name="l01047"></a>01047     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ae677aa71eb32a075a4ff8b58378ecb03" title="function pointer to quantum electron density member function">quantum_edensity_fn</a> = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::eDensityForPoissonCI</a>;
<a name="l01048"></a>01048   }
<a name="l01049"></a>01049   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(sourceName == <span class="stringliteral">&quot;coulomb&quot;</span>)  {
<a name="l01050"></a>01050     <span class="comment">//RHS == evec[i] * evec[j]</span>
<a name="l01051"></a>01051     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a18844938e9063abd7af48b971d58b85a">sourceEvec1</a> = (int)QCAD::EvaluatorTools&lt;EvalT,Traits&gt;::getDoubleValue( <a class="code" href="classQCAD_1_1PoissonSource.html#a408a43093d96179b73a76e159ede1dc0">sourceEvecInds</a>[0] );
<a name="l01052"></a>01052     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a433c983e00ace80339834c2f82d19d62">sourceEvec2</a> = (int)QCAD::EvaluatorTools&lt;EvalT,Traits&gt;::getDoubleValue( <a class="code" href="classQCAD_1_1PoissonSource.html#a408a43093d96179b73a76e159ede1dc0">sourceEvecInds</a>[1] );
<a name="l01053"></a>01053     
<a name="l01054"></a>01054     <span class="comment">//int valleyDegeneracyFactor = materialDB-&gt;getElementBlockParam&lt;int&gt;(workset.EBName,&quot;Number of conduction band min&quot;,2);</span>
<a name="l01055"></a>01055     <span class="comment">// scale so electron density is in [cm^-3] (assume 3D? Suzey?) as expected of RHS of Poisson eqn</span>
<a name="l01056"></a>01056     ret.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a68e679a15e1670b8d4c03261fbe9289c">coulombPrefactor</a> = 1.0/pow(X0,(<span class="keywordtype">int</span>)<a class="code" href="classQCAD_1_1PoissonSource.html#abe44f806525ae2ac13105e5f499fa120">numDims</a>);
<a name="l01057"></a>01057   }
<a name="l01058"></a>01058 
<a name="l01059"></a>01059   <span class="keywordflow">return</span> ret;
<a name="l01060"></a>01060 }
<a name="l01061"></a>01061 
<a name="l01062"></a>01062 
<a name="l01063"></a>01063 <span class="comment">// **********************************************************************</span>
<a name="l01064"></a>01064 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l01065"></a>01065 <span class="keywordtype">void</span> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT, Traits&gt;::</a>
<a name="l01066"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a4fe7d49bc54f00a41cbb451c613f985d">01066</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">source_semiclassical</a>(<span class="keyword">const</span> <span class="keyword">typename</span> Traits::EvalData workset, std::size_t cell, std::size_t qp, <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp; scaleFactor,
<a name="l01067"></a>01067          <span class="keyword">const</span> <a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html">PoissonSourceSetupInfo</a>&amp; setup_info)
<a name="l01068"></a>01068 {
<a name="l01069"></a>01069   <span class="comment">// -- Semiconductor</span>
<a name="l01070"></a>01070   <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp; unscaled_phi = <a class="code" href="classQCAD_1_1PoissonSource.html#ae66f55a004430bfc3497f006bdbe7f01">potential</a>(cell,qp);  <span class="comment">// [myV]</span>
<a name="l01071"></a>01071   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> phi = unscaled_phi / setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a7c0f019ef3aa2f174db24bef3e5f4595">V0</a>; 
<a name="l01072"></a>01072           
<a name="l01073"></a>01073   <span class="comment">// obtain the ionized dopants (in semiconductor) or fixed charge (in insulator)</span>
<a name="l01074"></a>01074   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> fixedCharge;
<a name="l01075"></a>01075   <span class="keywordflow">if</span> (setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a1dfc7fb1fd3c60aecfb33a6ba6a276e0" title="Activated dopants / Fixed constant charge.">fixedChargeType</a> == <span class="stringliteral">&quot;Donor&quot;</span>)  <span class="comment">// function takes care of sign</span>
<a name="l01076"></a>01076     fixedCharge = (this-&gt;*(setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a415b36da11100cace23924c48e3bc670" title="function pointer to ionized dopants member function">ionDopant</a>))(<span class="stringliteral">&quot;Donor&quot;</span>,phi + setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#af5c3db6e40e6ba1e45e53b0f2f1b6d8d">inArg</a>)*setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a647ec3052ad088df2a561b550ca3a0ae">dopingConc</a>;
<a name="l01077"></a>01077   <span class="keywordflow">else</span> if (setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a1dfc7fb1fd3c60aecfb33a6ba6a276e0" title="Activated dopants / Fixed constant charge.">fixedChargeType</a> == <span class="stringliteral">&quot;Acceptor&quot;</span>)
<a name="l01078"></a>01078     fixedCharge = (this-&gt;*(setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a415b36da11100cace23924c48e3bc670" title="function pointer to ionized dopants member function">ionDopant</a>))(<span class="stringliteral">&quot;Acceptor&quot;</span>,-phi + setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#af5c3db6e40e6ba1e45e53b0f2f1b6d8d">inArg</a>)*setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a647ec3052ad088df2a561b550ca3a0ae">dopingConc</a>;
<a name="l01079"></a>01079   <span class="keywordflow">else</span> if (setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a1dfc7fb1fd3c60aecfb33a6ba6a276e0" title="Activated dopants / Fixed constant charge.">fixedChargeType</a> == <span class="stringliteral">&quot;Constant&quot;</span>)
<a name="l01080"></a>01080     fixedCharge = setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a576e4a992e58fc9be4702146dec7089e">fixedChargeConc</a>;
<a name="l01081"></a>01081   <span class="keywordflow">else</span> 
<a name="l01082"></a>01082     fixedCharge = 0.0; 
<a name="l01083"></a>01083   
<a name="l01084"></a>01084   <span class="comment">// the scaled full RHS</span>
<a name="l01085"></a>01085   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> charge, eDensity, hDensity; 
<a name="l01086"></a>01086   eDensity = setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a14cd3ebba802cf34a80998450d0271e4" title="argument offset in calculating electron and hole density [unitless]">Nc</a>*(this-&gt;*(setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a991ff9292623aa18e9860f0299534bc4" title="function pointer to carrier statistics member function">carrStat</a>))(phi + setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a92e7fd83d8bc5a0d3273e2c2b2ece377">eArgOffset</a> + setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a4c8a6cc9949293c0bfd4b88b0319447b">fermiE</a>/setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#abdee072e4f4356812b254f5cc2d48796">kbT</a>);
<a name="l01087"></a>01087   hDensity = setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#aad653eeba31bac1db3482a7996cdaece">Nv</a>*(this-&gt;*(setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a991ff9292623aa18e9860f0299534bc4" title="function pointer to carrier statistics member function">carrStat</a>))(-phi + setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a29df8e4dae5068286d8c18c87f09f362">hArgOffset</a> - setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a4c8a6cc9949293c0bfd4b88b0319447b">fermiE</a>/setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#abdee072e4f4356812b254f5cc2d48796">kbT</a>);
<a name="l01088"></a>01088 
<a name="l01089"></a>01089   <span class="comment">// Mix with previous density (to damp S-P iterations)</span>
<a name="l01090"></a>01090   <span class="keywordflow">if</span>(setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a56697903b9dd449be634a050fd05639e">prevDensityFactor</a> &gt; 1e-8) { 
<a name="l01091"></a>01091     <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> prevDensity = setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a19989646723aee026c67e0c1c99f90aa">prevDensityArray</a>(cell,qp); 
<a name="l01092"></a>01092     <span class="comment">//eDensity = eDensity * (1 - setup_info.prevDensityFactor) + setup_info.prevDensityFactor * prevDensity;</span>
<a name="l01093"></a>01093   }
<a name="l01094"></a>01094 
<a name="l01095"></a>01095   charge = 1.0/setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a63a4e8a5ad0f2aa59697d64afa1e09a9">Lambda2</a> * (hDensity - eDensity + fixedCharge);
<a name="l01096"></a>01096   <a class="code" href="classQCAD_1_1PoissonSource.html#a4d3f473e00eac7aafe120bd596db647d" title="output">poissonSource</a>(cell, qp) = scaleFactor*charge;
<a name="l01097"></a>01097   
<a name="l01098"></a>01098   <span class="comment">//DEBUG</span>
<a name="l01099"></a>01099   <span class="comment">/*if(isnan( QCAD::EvaluatorTools&lt;EvalT,Traits&gt;::getDoubleValue( poissonSource(cell,qp) )))</span>
<a name="l01100"></a>01100 <span class="comment">    std::cout &lt;&lt; &quot;semicl source(&quot;&lt;&lt;cell&lt;&lt;&quot;,&quot;&lt;&lt;qp&lt;&lt;&quot;) is NAN&quot; &lt;&lt; std::endl;</span>
<a name="l01101"></a>01101 <span class="comment">  if(isinf( QCAD::EvaluatorTools&lt;EvalT,Traits&gt;::getDoubleValue( poissonSource(cell,qp) )))</span>
<a name="l01102"></a>01102 <span class="comment">    std::cout &lt;&lt; &quot;semicl source(&quot;&lt;&lt;cell&lt;&lt;&quot;,&quot;&lt;&lt;qp&lt;&lt;&quot;) is INF -- h=&quot; &lt;&lt; hDensity &lt;&lt; &quot;, e=&quot;&lt;&lt; eDensity &lt;&lt; &quot;, i=&quot; &lt;&lt; fixedCharge</span>
<a name="l01103"></a>01103 <span class="comment">        &lt;&lt; &quot;, phi=&quot; &lt;&lt; phi &lt;&lt; &quot;, eArg=&quot; &lt;&lt; setup_info.eArgOffset &lt;&lt; &quot;, fermiE=&quot; &lt;&lt; setup_info.fermiE </span>
<a name="l01104"></a>01104 <span class="comment">        &lt;&lt; &quot;, kbT=&quot; &lt;&lt; setup_info.kbT &lt;&lt; std::endl;</span>
<a name="l01105"></a>01105 <span class="comment">  */</span>
<a name="l01106"></a>01106   
<a name="l01107"></a>01107   <span class="comment">// output states</span>
<a name="l01108"></a>01108   <a class="code" href="classQCAD_1_1PoissonSource.html#ae574ccc85e9e3986d56b1b1b6b7a924d">chargeDensity</a>(cell, qp) = hDensity - eDensity + fixedCharge;
<a name="l01109"></a>01109   <a class="code" href="classQCAD_1_1PoissonSource.html#a0a2d8a657e36facc1df8e509228910b8">electronDensity</a>(cell, qp) = eDensity;
<a name="l01110"></a>01110   <a class="code" href="classQCAD_1_1PoissonSource.html#a33c2a1c3d6884eb0ff1ef71522e55716">holeDensity</a>(cell, qp) = hDensity;
<a name="l01111"></a>01111   <a class="code" href="classQCAD_1_1PoissonSource.html#a47708a787cf7f127b0ef44b7d658d42f">electricPotential</a>(cell, qp) = phi*setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a7c0f019ef3aa2f174db24bef3e5f4595">V0</a> - setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ada323d86f136f2097c735e4550280755">qPhiRef</a>; <span class="comment">// [myV]</span>
<a name="l01112"></a>01112   <a class="code" href="classQCAD_1_1PoissonSource.html#aec699e0c6ff57c1fe2100610abe6ac70">ionizedDopant</a>(cell, qp) = fixedCharge;
<a name="l01113"></a>01113   <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell, qp) = setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ada323d86f136f2097c735e4550280755">qPhiRef</a>-setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a174729817e0542b61b6b398360c3ff67">Chi</a>-phi*setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a7c0f019ef3aa2f174db24bef3e5f4595">V0</a>; <span class="comment">// [myV]</span>
<a name="l01114"></a>01114   <a class="code" href="classQCAD_1_1PoissonSource.html#ac3d211c7dfc559d0b5d6903cb2509e63">valenceBand</a>(cell, qp) = <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell,qp)-setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a8b6cdab1bb17e9d1705e052f4b019f55">Eg</a>; <span class="comment">// [myV]</span>
<a name="l01115"></a>01115   <a class="code" href="classQCAD_1_1PoissonSource.html#a862d9a94dfdeca69318880357360f2b4">approxQuanEDen</a>(cell,qp) = 0.0; 
<a name="l01116"></a>01116   <a class="code" href="classQCAD_1_1PoissonSource.html#a0300c56c6a9ff5b939d79b2598dd7800">artCBDensity</a>(cell, qp) = ( eDensity &gt; 1e-6 ? eDensity
<a name="l01117"></a>01117            : -setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a14cd3ebba802cf34a80998450d0271e4" title="argument offset in calculating electron and hole density [unitless]">Nc</a>*(this-&gt;*(setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a991ff9292623aa18e9860f0299534bc4" title="function pointer to carrier statistics member function">carrStat</a>))( -(phi+setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a92e7fd83d8bc5a0d3273e2c2b2ece377">eArgOffset</a>) ));
<a name="l01118"></a>01118 }
<a name="l01119"></a>01119 
<a name="l01120"></a>01120 
<a name="l01121"></a>01121 <span class="comment">// **********************************************************************</span>
<a name="l01122"></a>01122 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l01123"></a>01123 <span class="keywordtype">void</span> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT, Traits&gt;::</a>
<a name="l01124"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a389bbc9111a5edf1ac8167314291d95a">01124</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">source_none</a>(<span class="keyword">const</span> <span class="keyword">typename</span> Traits::EvalData workset, std::size_t cell, std::size_t qp, <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp; scaleFactor,
<a name="l01125"></a>01125          <span class="keyword">const</span> <a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html">PoissonSourceSetupInfo</a>&amp; setup_info)
<a name="l01126"></a>01126 {
<a name="l01127"></a>01127   <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp; unscaled_phi = <a class="code" href="classQCAD_1_1PoissonSource.html#ae66f55a004430bfc3497f006bdbe7f01">potential</a>(cell,qp);  <span class="comment">//[myV]</span>
<a name="l01128"></a>01128   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> phi = unscaled_phi / setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a7c0f019ef3aa2f174db24bef3e5f4595">V0</a>;  <span class="comment">//[unitless]</span>
<a name="l01129"></a>01129   
<a name="l01130"></a>01130   <span class="comment">// the scaled full RHS</span>
<a name="l01131"></a>01131   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> charge = 0.0;  <span class="comment">// no charge in this RHS mode</span>
<a name="l01132"></a>01132   <a class="code" href="classQCAD_1_1PoissonSource.html#a4d3f473e00eac7aafe120bd596db647d" title="output">poissonSource</a>(cell, qp) = scaleFactor*charge;
<a name="l01133"></a>01133   
<a name="l01134"></a>01134   <a class="code" href="classQCAD_1_1PoissonSource.html#ae574ccc85e9e3986d56b1b1b6b7a924d">chargeDensity</a>(cell, qp) = 0.0;         <span class="comment">// no charge in this RHS mode</span>
<a name="l01135"></a>01135   <a class="code" href="classQCAD_1_1PoissonSource.html#a0a2d8a657e36facc1df8e509228910b8">electronDensity</a>(cell, qp) = 0.0;       <span class="comment">// no electron</span>
<a name="l01136"></a>01136   <a class="code" href="classQCAD_1_1PoissonSource.html#a33c2a1c3d6884eb0ff1ef71522e55716">holeDensity</a>(cell, qp) = 0.0;           <span class="comment">// no holes</span>
<a name="l01137"></a>01137   <a class="code" href="classQCAD_1_1PoissonSource.html#a47708a787cf7f127b0ef44b7d658d42f">electricPotential</a>(cell, qp) = phi*setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a7c0f019ef3aa2f174db24bef3e5f4595">V0</a> - setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ada323d86f136f2097c735e4550280755">qPhiRef</a>;
<a name="l01138"></a>01138   <a class="code" href="classQCAD_1_1PoissonSource.html#aec699e0c6ff57c1fe2100610abe6ac70">ionizedDopant</a>(cell, qp) = 0.0;
<a name="l01139"></a>01139   <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell, qp) = setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ada323d86f136f2097c735e4550280755">qPhiRef</a>-setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a174729817e0542b61b6b398360c3ff67">Chi</a>-phi*setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a7c0f019ef3aa2f174db24bef3e5f4595">V0</a>; <span class="comment">// [myV]</span>
<a name="l01140"></a>01140   <a class="code" href="classQCAD_1_1PoissonSource.html#ac3d211c7dfc559d0b5d6903cb2509e63">valenceBand</a>(cell, qp) = <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell,qp)-setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a8b6cdab1bb17e9d1705e052f4b019f55">Eg</a>;
<a name="l01141"></a>01141   <a class="code" href="classQCAD_1_1PoissonSource.html#a862d9a94dfdeca69318880357360f2b4">approxQuanEDen</a>(cell,qp) = 0.0;
<a name="l01142"></a>01142   <a class="code" href="classQCAD_1_1PoissonSource.html#a0300c56c6a9ff5b939d79b2598dd7800">artCBDensity</a>(cell, qp) = 0.0;
<a name="l01143"></a>01143 }
<a name="l01144"></a>01144 
<a name="l01145"></a>01145 
<a name="l01146"></a>01146 <span class="comment">// **********************************************************************</span>
<a name="l01147"></a>01147 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l01148"></a>01148 <span class="keywordtype">void</span> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT, Traits&gt;::</a>
<a name="l01149"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a3cea00ebcab571d59852703f319a8be2">01149</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">source_quantum</a>(<span class="keyword">const</span> <span class="keyword">typename</span> Traits::EvalData workset, std::size_t cell, std::size_t qp, <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp; scaleFactor,
<a name="l01150"></a>01150          <span class="keyword">const</span> <a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html">PoissonSourceSetupInfo</a>&amp; setup_info)
<a name="l01151"></a>01151 {
<a name="l01152"></a>01152   <span class="comment">// -- Semiconductor, but see &quot;insulator&quot; comments</span>
<a name="l01153"></a>01153   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> approxEDensity = 0.0;
<a name="l01154"></a>01154           
<a name="l01155"></a>01155   <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#a623c1ec89816a9681889f657470d13f8" title="Schrodinger coupling.">bUsePredictorCorrector</a>) {
<a name="l01156"></a>01156     <span class="comment">// compute the approximate quantum electron density using predictor-corrector method</span>
<a name="l01157"></a>01157     <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> prevPhi = setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a8bfe0c70453442b3f27aed498b44a68d">prevPhiArray</a>(cell,qp); 
<a name="l01158"></a>01158     approxEDensity = (this-&gt;*(setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ae677aa71eb32a075a4ff8b58378ecb03" title="function pointer to quantum electron density member function">quantum_edensity_fn</a>))(workset, cell, qp, prevPhi, <span class="keyword">true</span>, setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a4c8a6cc9949293c0bfd4b88b0319447b">fermiE</a>, <a class="code" href="classQCAD_1_1PoissonSource.html#aa8297a03b834e0fdb82a82e8a57254aa">fixedQuantumOcc</a>);
<a name="l01159"></a>01159   }
<a name="l01160"></a>01160   <span class="keywordflow">else</span>  <span class="comment">// otherwise, use the exact quantum density</span>
<a name="l01161"></a>01161     approxEDensity = (this-&gt;*(setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ae677aa71eb32a075a4ff8b58378ecb03" title="function pointer to quantum electron density member function">quantum_edensity_fn</a>))(workset, cell, qp, 0.0, <span class="keyword">false</span>, setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a4c8a6cc9949293c0bfd4b88b0319447b">fermiE</a>, <a class="code" href="classQCAD_1_1PoissonSource.html#aa8297a03b834e0fdb82a82e8a57254aa">fixedQuantumOcc</a>);
<a name="l01162"></a>01162 
<a name="l01163"></a>01163   <span class="comment">// compute the exact quantum electron density</span>
<a name="l01164"></a>01164   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> eDensity = (this-&gt;*(setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ae677aa71eb32a075a4ff8b58378ecb03" title="function pointer to quantum electron density member function">quantum_edensity_fn</a>))(workset, cell, qp, 0.0, <span class="keyword">false</span>, setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a4c8a6cc9949293c0bfd4b88b0319447b">fermiE</a>, <a class="code" href="classQCAD_1_1PoissonSource.html#aa8297a03b834e0fdb82a82e8a57254aa">fixedQuantumOcc</a>);
<a name="l01165"></a>01165 
<a name="l01166"></a>01166   <span class="comment">// Mix with previous density (to damp S-P iterations)</span>
<a name="l01167"></a>01167   <span class="keywordflow">if</span>(setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a56697903b9dd449be634a050fd05639e">prevDensityFactor</a> &gt; 1e-8) { 
<a name="l01168"></a>01168     <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> prevDensity = setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a19989646723aee026c67e0c1c99f90aa">prevDensityArray</a>(cell,qp); 
<a name="l01169"></a>01169     approxEDensity = approxEDensity * (1.0 - setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a56697903b9dd449be634a050fd05639e">prevDensityFactor</a>) + setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a56697903b9dd449be634a050fd05639e">prevDensityFactor</a> * prevDensity;
<a name="l01170"></a>01170     eDensity = eDensity * (1.0 - setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a56697903b9dd449be634a050fd05639e">prevDensityFactor</a>) + setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a56697903b9dd449be634a050fd05639e">prevDensityFactor</a> * prevDensity;
<a name="l01171"></a>01171   }
<a name="l01172"></a>01172 
<a name="l01173"></a>01173   <span class="comment">// obtain the scaled potential</span>
<a name="l01174"></a>01174   <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp; unscaled_phi = <a class="code" href="classQCAD_1_1PoissonSource.html#ae66f55a004430bfc3497f006bdbe7f01">potential</a>(cell,qp); <span class="comment">//[myV]</span>
<a name="l01175"></a>01175   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> phi = unscaled_phi / setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a7c0f019ef3aa2f174db24bef3e5f4595">V0</a>; 
<a name="l01176"></a>01176            
<a name="l01177"></a>01177   <span class="comment">// compute the hole density treated as classical</span>
<a name="l01178"></a>01178   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> hDensity = setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#aad653eeba31bac1db3482a7996cdaece">Nv</a>*(this-&gt;*(setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a991ff9292623aa18e9860f0299534bc4" title="function pointer to carrier statistics member function">carrStat</a>))(-phi + setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a29df8e4dae5068286d8c18c87f09f362">hArgOffset</a>);
<a name="l01179"></a>01179 
<a name="l01180"></a>01180   <span class="comment">// obtain the ionized dopants (in semiconductor) or fixed charge (in insulator)</span>
<a name="l01181"></a>01181   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> fixedCharge  = 0.0;
<a name="l01182"></a>01182   <span class="keywordflow">if</span> (setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a1dfc7fb1fd3c60aecfb33a6ba6a276e0" title="Activated dopants / Fixed constant charge.">fixedChargeType</a> == <span class="stringliteral">&quot;Donor&quot;</span>)  <span class="comment">// function takes care of sign</span>
<a name="l01183"></a>01183     fixedCharge = (this-&gt;*(setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a415b36da11100cace23924c48e3bc670" title="function pointer to ionized dopants member function">ionDopant</a>))(<span class="stringliteral">&quot;Donor&quot;</span>,phi + setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#af5c3db6e40e6ba1e45e53b0f2f1b6d8d">inArg</a>)*setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a647ec3052ad088df2a561b550ca3a0ae">dopingConc</a>;
<a name="l01184"></a>01184   <span class="keywordflow">else</span> if (setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a1dfc7fb1fd3c60aecfb33a6ba6a276e0" title="Activated dopants / Fixed constant charge.">fixedChargeType</a> == <span class="stringliteral">&quot;Acceptor&quot;</span>)
<a name="l01185"></a>01185     fixedCharge = (this-&gt;*(setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a415b36da11100cace23924c48e3bc670" title="function pointer to ionized dopants member function">ionDopant</a>))(<span class="stringliteral">&quot;Acceptor&quot;</span>,-phi + setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#af5c3db6e40e6ba1e45e53b0f2f1b6d8d">inArg</a>)*setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a647ec3052ad088df2a561b550ca3a0ae">dopingConc</a>;
<a name="l01186"></a>01186   <span class="keywordflow">else</span> if (setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a1dfc7fb1fd3c60aecfb33a6ba6a276e0" title="Activated dopants / Fixed constant charge.">fixedChargeType</a> == <span class="stringliteral">&quot;Constant&quot;</span>)
<a name="l01187"></a>01187     fixedCharge = setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a576e4a992e58fc9be4702146dec7089e">fixedChargeConc</a>;
<a name="l01188"></a>01188   <span class="keywordflow">else</span> 
<a name="l01189"></a>01189     fixedCharge = 0.0; 
<a name="l01190"></a>01190               
<a name="l01191"></a>01191   <span class="comment">// the scaled full RHS</span>
<a name="l01192"></a>01192   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> charge; 
<a name="l01193"></a>01193   charge = 1.0/setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a63a4e8a5ad0f2aa59697d64afa1e09a9">Lambda2</a>*(hDensity- approxEDensity + fixedCharge);
<a name="l01194"></a>01194   <a class="code" href="classQCAD_1_1PoissonSource.html#a4d3f473e00eac7aafe120bd596db647d" title="output">poissonSource</a>(cell, qp) = scaleFactor*charge;
<a name="l01195"></a>01195 
<a name="l01196"></a>01196   <span class="comment">//DEBUG</span>
<a name="l01197"></a>01197   <span class="comment">/*if(isnan( QCAD::EvaluatorTools&lt;EvalT,Traits&gt;::getDoubleValue( poissonSource(cell,qp) )))</span>
<a name="l01198"></a>01198 <span class="comment">    std::cout &lt;&lt; &quot;quantum source(&quot;&lt;&lt;cell&lt;&lt;&quot;,&quot;&lt;&lt;qp&lt;&lt;&quot;) is NAN&quot; &lt;&lt; std::endl;</span>
<a name="l01199"></a>01199 <span class="comment">    if(isinf( QCAD::EvaluatorTools&lt;EvalT,Traits&gt;::getDoubleValue( poissonSource(cell,qp) )))</span>
<a name="l01200"></a>01200 <span class="comment">    std::cout &lt;&lt; &quot;quantum source(&quot;&lt;&lt;cell&lt;&lt;&quot;,&quot;&lt;&lt;qp&lt;&lt;&quot;) is INF&quot; &lt;&lt; std::endl;</span>
<a name="l01201"></a>01201 <span class="comment">  */</span>
<a name="l01202"></a>01202 
<a name="l01203"></a>01203   <span class="comment">// output states</span>
<a name="l01204"></a>01204   <a class="code" href="classQCAD_1_1PoissonSource.html#ae574ccc85e9e3986d56b1b1b6b7a924d">chargeDensity</a>(cell, qp) = hDensity -eDensity +fixedCharge;
<a name="l01205"></a>01205   <a class="code" href="classQCAD_1_1PoissonSource.html#a0a2d8a657e36facc1df8e509228910b8">electronDensity</a>(cell, qp) = eDensity;
<a name="l01206"></a>01206   <a class="code" href="classQCAD_1_1PoissonSource.html#a33c2a1c3d6884eb0ff1ef71522e55716">holeDensity</a>(cell, qp) = hDensity;
<a name="l01207"></a>01207   <span class="comment">//electricPotential(cell, qp) = phi*V0 - qPhiRef; //electric potenial == solution shifted so &quot;reference&quot; == 0</span>
<a name="l01208"></a>01208   <a class="code" href="classQCAD_1_1PoissonSource.html#aec699e0c6ff57c1fe2100610abe6ac70">ionizedDopant</a>(cell, qp) = fixedCharge;
<a name="l01209"></a>01209   <a class="code" href="classQCAD_1_1PoissonSource.html#a862d9a94dfdeca69318880357360f2b4">approxQuanEDen</a>(cell,qp) = approxEDensity;
<a name="l01210"></a>01210   <a class="code" href="classQCAD_1_1PoissonSource.html#a0300c56c6a9ff5b939d79b2598dd7800">artCBDensity</a>(cell, qp) = ( eDensity &gt; 1e-6 ? eDensity : -setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a14cd3ebba802cf34a80998450d0271e4" title="argument offset in calculating electron and hole density [unitless]">Nc</a>*(this-&gt;*(setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a991ff9292623aa18e9860f0299534bc4" title="function pointer to carrier statistics member function">carrStat</a>))( -(phi+setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a92e7fd83d8bc5a0d3273e2c2b2ece377">eArgOffset</a>) ));
<a name="l01211"></a>01211 
<a name="l01212"></a>01212   <span class="keywordflow">if</span> (<a class="code" href="classQCAD_1_1PoissonSource.html#a82105311f3e25ff3f753937ad13b048e">bIncludeVxc</a>)  <span class="comment">// include Vxc</span>
<a name="l01213"></a>01213   {
<a name="l01214"></a>01214     <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> Vxc = <a class="code" href="classQCAD_1_1PoissonSource.html#a87523eaee864c9fc18b16892882c5038" title="compute exchange-correlation potential energy within Local Density Approximation">computeVxcLDA</a>(setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#aa68b65cd0f06237a69fdc53a519f1b31">relPerm</a>, setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#af4ef89149ccbb534a81713da1136029d">averagedEffMass</a>, approxEDensity) / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// [myV]</span>
<a name="l01215"></a>01215     <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell, qp) = setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ada323d86f136f2097c735e4550280755">qPhiRef</a> -setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a174729817e0542b61b6b398360c3ff67">Chi</a> -phi*setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a7c0f019ef3aa2f174db24bef3e5f4595">V0</a> +Vxc; <span class="comment">// [myV]</span>
<a name="l01216"></a>01216               
<a name="l01217"></a>01217     <span class="comment">// Suzey: need to be discussed (April 06, 2012) ? </span>
<a name="l01218"></a>01218     <a class="code" href="classQCAD_1_1PoissonSource.html#a47708a787cf7f127b0ef44b7d658d42f">electricPotential</a>(cell, qp) = phi*setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a7c0f019ef3aa2f174db24bef3e5f4595">V0</a> + Vxc- setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ada323d86f136f2097c735e4550280755">qPhiRef</a>; <span class="comment">//add xc correction to electric potential (used in CI delta_ij computation)</span>
<a name="l01219"></a>01219   }
<a name="l01220"></a>01220   <span class="keywordflow">else</span>  <span class="comment">// not include Vxc</span>
<a name="l01221"></a>01221   {
<a name="l01222"></a>01222     <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell, qp) = setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ada323d86f136f2097c735e4550280755">qPhiRef</a> -setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a174729817e0542b61b6b398360c3ff67">Chi</a> -phi*setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a7c0f019ef3aa2f174db24bef3e5f4595">V0</a>; <span class="comment">// [myV]</span>
<a name="l01223"></a>01223     <a class="code" href="classQCAD_1_1PoissonSource.html#a47708a787cf7f127b0ef44b7d658d42f">electricPotential</a>(cell, qp) = phi*setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a7c0f019ef3aa2f174db24bef3e5f4595">V0</a> - setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ada323d86f136f2097c735e4550280755">qPhiRef</a>; <span class="comment">// [myV]</span>
<a name="l01224"></a>01224   }
<a name="l01225"></a>01225   <a class="code" href="classQCAD_1_1PoissonSource.html#ac3d211c7dfc559d0b5d6903cb2509e63">valenceBand</a>(cell, qp) = <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell,qp)-setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a8b6cdab1bb17e9d1705e052f4b019f55">Eg</a>;
<a name="l01226"></a>01226 }
<a name="l01227"></a>01227 
<a name="l01228"></a>01228 
<a name="l01229"></a>01229 <span class="comment">// **********************************************************************</span>
<a name="l01230"></a>01230 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l01231"></a>01231 <span class="keywordtype">void</span> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT, Traits&gt;::</a>
<a name="l01232"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a60e6eaaa9e582ee9c7a6f256e4400430">01232</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">source_coulomb</a>(<span class="keyword">const</span> <span class="keyword">typename</span> Traits::EvalData workset, std::size_t cell, std::size_t qp, <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp; scaleFactor,
<a name="l01233"></a>01233          <span class="keyword">const</span> <a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html">PoissonSourceSetupInfo</a>&amp; setup_info)
<a name="l01234"></a>01234 {
<a name="l01235"></a>01235   <span class="comment">// obtain the scaled potential</span>
<a name="l01236"></a>01236   <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp; unscaled_phi = <a class="code" href="classQCAD_1_1PoissonSource.html#ae66f55a004430bfc3497f006bdbe7f01">potential</a>(cell,qp); <span class="comment">//[V]</span>
<a name="l01237"></a>01237   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> phi = unscaled_phi / setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a7c0f019ef3aa2f174db24bef3e5f4595">V0</a>; 
<a name="l01238"></a>01238 
<a name="l01239"></a>01239   <span class="comment">// the scaled full RHS   note: wavefunctions are assumed normalized by the mass matrix (i.e. integral( Psi_i^2 dR ) == 1)</span>
<a name="l01240"></a>01240   <span class="comment">// Source term is conj(evec_j) * evec_i  </span>
<a name="l01241"></a>01241   <span class="comment">// TODO: double-check this is correct, seeing as eigenvectors are normalized by mass matrix</span>
<a name="l01242"></a>01242   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> charge;
<a name="l01243"></a>01243   <span class="keywordtype">int</span> i = setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a18844938e9063abd7af48b971d58b85a">sourceEvec1</a>;
<a name="l01244"></a>01244   <span class="keywordtype">int</span> j = setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a433c983e00ace80339834c2f82d19d62">sourceEvec2</a>;
<a name="l01245"></a>01245   <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#aa64d94632888257f782d92459a27e6cb">imagPartOfCoulombSrc</a>) {
<a name="l01246"></a>01246     <span class="keywordflow">if</span>(!<a class="code" href="classQCAD_1_1PoissonSource.html#abd84830c6ce3f9ede727b1a3ab07e654">bRealEigenvectors</a>) <span class="comment">// if eigenvectors are all real, then there is no imaginary part of coulomb source</span>
<a name="l01247"></a>01247       charge = - setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a68e679a15e1670b8d4c03261fbe9289c">coulombPrefactor</a> * ( <a class="code" href="classQCAD_1_1PoissonSource.html#ad891c871c4223cebd6f5080b2beb6536">eigenvector_Re</a>[i](cell,qp) * <a class="code" href="classQCAD_1_1PoissonSource.html#ab042832dbe11625224d1969979c4685a">eigenvector_Im</a>[j](cell,qp) - 
<a name="l01248"></a>01248              <a class="code" href="classQCAD_1_1PoissonSource.html#ab042832dbe11625224d1969979c4685a">eigenvector_Im</a>[i](cell,qp) * <a class="code" href="classQCAD_1_1PoissonSource.html#ad891c871c4223cebd6f5080b2beb6536">eigenvector_Re</a>[j](cell,qp));
<a name="l01249"></a>01249     <span class="keywordflow">else</span> charge = 0.0;
<a name="l01250"></a>01250   }
<a name="l01251"></a>01251   <span class="keywordflow">else</span> {
<a name="l01252"></a>01252     <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#abd84830c6ce3f9ede727b1a3ab07e654">bRealEigenvectors</a>)
<a name="l01253"></a>01253       charge = - setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a68e679a15e1670b8d4c03261fbe9289c">coulombPrefactor</a> * ( <a class="code" href="classQCAD_1_1PoissonSource.html#ad891c871c4223cebd6f5080b2beb6536">eigenvector_Re</a>[i](cell,qp) * <a class="code" href="classQCAD_1_1PoissonSource.html#ad891c871c4223cebd6f5080b2beb6536">eigenvector_Re</a>[j](cell,qp) );
<a name="l01254"></a>01254     <span class="keywordflow">else</span>
<a name="l01255"></a>01255       charge = - setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a68e679a15e1670b8d4c03261fbe9289c">coulombPrefactor</a> * ( <a class="code" href="classQCAD_1_1PoissonSource.html#ad891c871c4223cebd6f5080b2beb6536">eigenvector_Re</a>[i](cell,qp) * <a class="code" href="classQCAD_1_1PoissonSource.html#ad891c871c4223cebd6f5080b2beb6536">eigenvector_Re</a>[j](cell,qp) + 
<a name="l01256"></a>01256              <a class="code" href="classQCAD_1_1PoissonSource.html#ab042832dbe11625224d1969979c4685a">eigenvector_Im</a>[i](cell,qp) * <a class="code" href="classQCAD_1_1PoissonSource.html#ab042832dbe11625224d1969979c4685a">eigenvector_Im</a>[j](cell,qp));
<a name="l01257"></a>01257   }
<a name="l01258"></a>01258 
<a name="l01259"></a>01259 
<a name="l01260"></a>01260   <a class="code" href="classQCAD_1_1PoissonSource.html#a4d3f473e00eac7aafe120bd596db647d" title="output">poissonSource</a>(cell, qp) = scaleFactor * 1.0/setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a63a4e8a5ad0f2aa59697d64afa1e09a9">Lambda2</a> * charge;
<a name="l01261"></a>01261 
<a name="l01262"></a>01262   <a class="code" href="classQCAD_1_1PoissonSource.html#ae574ccc85e9e3986d56b1b1b6b7a924d">chargeDensity</a>(cell, qp) = charge;
<a name="l01263"></a>01263   <a class="code" href="classQCAD_1_1PoissonSource.html#a0a2d8a657e36facc1df8e509228910b8">electronDensity</a>(cell, qp) = charge;
<a name="l01264"></a>01264   <a class="code" href="classQCAD_1_1PoissonSource.html#a33c2a1c3d6884eb0ff1ef71522e55716">holeDensity</a>(cell, qp) = 0.0;
<a name="l01265"></a>01265   <a class="code" href="classQCAD_1_1PoissonSource.html#a47708a787cf7f127b0ef44b7d658d42f">electricPotential</a>(cell, qp) = phi*setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a7c0f019ef3aa2f174db24bef3e5f4595">V0</a> - setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ada323d86f136f2097c735e4550280755">qPhiRef</a>;
<a name="l01266"></a>01266 
<a name="l01267"></a>01267   <span class="comment">//never include Vxc</span>
<a name="l01268"></a>01268   <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell, qp) = setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ada323d86f136f2097c735e4550280755">qPhiRef</a> -setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a174729817e0542b61b6b398360c3ff67">Chi</a> -phi*setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a7c0f019ef3aa2f174db24bef3e5f4595">V0</a>; <span class="comment">// [eV]</span>
<a name="l01269"></a>01269   <a class="code" href="classQCAD_1_1PoissonSource.html#ac3d211c7dfc559d0b5d6903cb2509e63">valenceBand</a>(cell, qp) = <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell,qp)-setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a8b6cdab1bb17e9d1705e052f4b019f55">Eg</a>;
<a name="l01270"></a>01270 }
<a name="l01271"></a>01271 
<a name="l01272"></a>01272 <span class="comment">// **********************************************************************</span>
<a name="l01273"></a>01273 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l01274"></a>01274 <span class="keywordtype">void</span> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT, Traits&gt;::</a>
<a name="l01275"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a3a1bc8219f699bcbde4ae0a45d7cfff5">01275</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">source_testcoulomb</a>(<span class="keyword">const</span> <span class="keyword">typename</span> Traits::EvalData workset, std::size_t cell, std::size_t qp, <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp; scaleFactor,
<a name="l01276"></a>01276          <span class="keyword">const</span> <a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html">PoissonSourceSetupInfo</a>&amp; setup_info)
<a name="l01277"></a>01277 {
<a name="l01278"></a>01278   <span class="comment">// obtain the scaled potential</span>
<a name="l01279"></a>01279   <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp; unscaled_phi = <a class="code" href="classQCAD_1_1PoissonSource.html#ae66f55a004430bfc3497f006bdbe7f01">potential</a>(cell,qp); <span class="comment">//[myV]</span>
<a name="l01280"></a>01280   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> phi = unscaled_phi / setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a7c0f019ef3aa2f174db24bef3e5f4595">V0</a>; 
<a name="l01281"></a>01281   <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>* coord = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html#a40266aa4c302576de741269de6565d90">coordVec</a>(cell,qp,0);
<a name="l01282"></a>01282 
<a name="l01283"></a>01283   <span class="comment">// the scaled full RHS   Source term is x^2 + y^2 + z^2 (for debugging purposes)</span>
<a name="l01284"></a>01284   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> charge = setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a68e679a15e1670b8d4c03261fbe9289c">coulombPrefactor</a> * ( exp(-(coord[0]*coord[0] + coord[1]*coord[1] + coord[2]*coord[2])));
<a name="l01285"></a>01285 
<a name="l01286"></a>01286   <a class="code" href="classQCAD_1_1PoissonSource.html#a4d3f473e00eac7aafe120bd596db647d" title="output">poissonSource</a>(cell, qp) = scaleFactor * 1.0/setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a63a4e8a5ad0f2aa59697d64afa1e09a9">Lambda2</a> * charge; <span class="comment">//sign??</span>
<a name="l01287"></a>01287 
<a name="l01288"></a>01288   <a class="code" href="classQCAD_1_1PoissonSource.html#ae574ccc85e9e3986d56b1b1b6b7a924d">chargeDensity</a>(cell, qp) = charge;
<a name="l01289"></a>01289   <a class="code" href="classQCAD_1_1PoissonSource.html#a0a2d8a657e36facc1df8e509228910b8">electronDensity</a>(cell, qp) = charge;
<a name="l01290"></a>01290   <a class="code" href="classQCAD_1_1PoissonSource.html#a33c2a1c3d6884eb0ff1ef71522e55716">holeDensity</a>(cell, qp) = 0.0;
<a name="l01291"></a>01291   <a class="code" href="classQCAD_1_1PoissonSource.html#a47708a787cf7f127b0ef44b7d658d42f">electricPotential</a>(cell, qp) = phi*setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a7c0f019ef3aa2f174db24bef3e5f4595">V0</a> - setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ada323d86f136f2097c735e4550280755">qPhiRef</a>;
<a name="l01292"></a>01292 
<a name="l01293"></a>01293   <span class="comment">//never include Vxc</span>
<a name="l01294"></a>01294   <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell, qp) = setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#ada323d86f136f2097c735e4550280755">qPhiRef</a>-setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a174729817e0542b61b6b398360c3ff67">Chi</a>-phi*setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a7c0f019ef3aa2f174db24bef3e5f4595">V0</a>; <span class="comment">// [myV]</span>
<a name="l01295"></a>01295   <a class="code" href="classQCAD_1_1PoissonSource.html#ac3d211c7dfc559d0b5d6903cb2509e63">valenceBand</a>(cell, qp) = <a class="code" href="classQCAD_1_1PoissonSource.html#a12a5e1ad419a82fd60c74afdcd2a28cc">conductionBand</a>(cell,qp)-setup_info.<a class="code" href="structQCAD_1_1PoissonSource_1_1PoissonSourceSetupInfo.html#a8b6cdab1bb17e9d1705e052f4b019f55">Eg</a>;
<a name="l01296"></a>01296 }
<a name="l01297"></a>01297 
<a name="l01298"></a>01298 
<a name="l01299"></a>01299 
<a name="l01300"></a>01300 
<a name="l01302"></a>01302 
<a name="l01303"></a>01303 
<a name="l01304"></a>01304 <span class="comment">// **********************************************************************</span>
<a name="l01305"></a>01305 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT,<span class="keyword">typename</span> Traits&gt;
<a name="l01306"></a>01306 <span class="keyword">inline</span> <span class="keyword">typename</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">QCAD::PoissonSource&lt;EvalT,Traits&gt;::ScalarT</a>
<a name="l01307"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a5762372373525bea53ae6fc0171f2fdb">01307</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::computeMBStat</a>(<span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> x)
<a name="l01308"></a>01308 {
<a name="l01309"></a>01309    <span class="keywordflow">return</span> exp(x);
<a name="l01310"></a>01310 }
<a name="l01311"></a>01311 
<a name="l01312"></a>01312 
<a name="l01313"></a>01313 <span class="comment">// **********************************************************************</span>
<a name="l01314"></a>01314 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT,<span class="keyword">typename</span> Traits&gt;
<a name="l01315"></a>01315 <span class="keyword">inline</span> <span class="keyword">typename</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">QCAD::PoissonSource&lt;EvalT,Traits&gt;::ScalarT</a>
<a name="l01316"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a15d7e72d16cf3db5fe949396de6449fa">01316</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::computeFDIntOneHalf</a>(<span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> x)
<a name="l01317"></a>01317 {
<a name="l01318"></a>01318    <span class="comment">// Use the approximate 1/2 FD integral by D. Bednarczyk and J. Bednarczyk, </span>
<a name="l01319"></a>01319    <span class="comment">// &quot;The approximation of the Fermi-Dirac integral F_{1/2}(x),&quot;</span>
<a name="l01320"></a>01320    <span class="comment">// Physics Letters A, vol.64, no.4, pp.409-410, 1978. The approximation </span>
<a name="l01321"></a>01321    <span class="comment">// has error &lt; 4e-3 in the entire x range.  </span>
<a name="l01322"></a>01322    
<a name="l01323"></a>01323    <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> fdInt; 
<a name="l01324"></a>01324    <span class="keywordflow">if</span> (x &gt;= -50.0)
<a name="l01325"></a>01325    {
<a name="l01326"></a>01326      fdInt = pow(x,4.) + 50. + 33.6*x*(1.-0.68*exp(-0.17*pow((x+1.),2.0)));
<a name="l01327"></a>01327      fdInt = pow((exp(-x) + (3./4.*sqrt(<a class="code" href="classQCAD_1_1PoissonSource.html#a35d68aa6b59eabed3579ab39f2473861">pi</a>)) * pow(fdInt, -3./8.)),-1.0);
<a name="l01328"></a>01328    }      
<a name="l01329"></a>01329    <span class="keywordflow">else</span>
<a name="l01330"></a>01330      fdInt = exp(x); <span class="comment">// for x&lt;-50, the 1/2 FD integral is well approximated by exp(x)</span>
<a name="l01331"></a>01331      
<a name="l01332"></a>01332    <span class="keywordflow">return</span> fdInt;
<a name="l01333"></a>01333 }
<a name="l01334"></a>01334 
<a name="l01335"></a>01335 
<a name="l01336"></a>01336 <span class="comment">// **********************************************************************</span>
<a name="l01337"></a>01337 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT,<span class="keyword">typename</span> Traits&gt;
<a name="l01338"></a>01338 <span class="keyword">inline</span> <span class="keyword">typename</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">QCAD::PoissonSource&lt;EvalT,Traits&gt;::ScalarT</a>
<a name="l01339"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a9568f5364686af40ea88d9f7fc58ff96">01339</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::computeZeroKFDInt</a>(<span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> x)
<a name="l01340"></a>01340 {
<a name="l01341"></a>01341    <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> zeroKFDInt;
<a name="l01342"></a>01342    <span class="keywordflow">if</span> (x &gt; 0.0) 
<a name="l01343"></a>01343      zeroKFDInt = 4./3./sqrt(<a class="code" href="classQCAD_1_1PoissonSource.html#a35d68aa6b59eabed3579ab39f2473861">pi</a>)*pow(x, 3./2.);
<a name="l01344"></a>01344    <span class="keywordflow">else</span>
<a name="l01345"></a>01345      zeroKFDInt = 0.0;
<a name="l01346"></a>01346       
<a name="l01347"></a>01347    <span class="keywordflow">return</span> zeroKFDInt;
<a name="l01348"></a>01348 }
<a name="l01349"></a>01349 
<a name="l01350"></a>01350 <span class="comment">// **********************************************************************</span>
<a name="l01351"></a>01351 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT,<span class="keyword">typename</span> Traits&gt;
<a name="l01352"></a>01352 <span class="keyword">inline</span> <span class="keyword">typename</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">QCAD::PoissonSource&lt;EvalT,Traits&gt;::ScalarT</a>
<a name="l01353"></a><a class="code" href="classQCAD_1_1PoissonSource.html#ad8ec112b405436a9df45098280d6bb66">01353</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::computeZeroStat</a>(<span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> x)
<a name="l01354"></a>01354 {
<a name="l01355"></a>01355    <span class="keywordflow">return</span> 0;
<a name="l01356"></a>01356 }
<a name="l01357"></a>01357 
<a name="l01358"></a>01358 
<a name="l01359"></a>01359 
<a name="l01360"></a>01360 
<a name="l01362"></a>01362 
<a name="l01363"></a>01363 
<a name="l01364"></a>01364 <span class="comment">// **********************************************************************</span>
<a name="l01365"></a>01365 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT,<span class="keyword">typename</span> Traits&gt;
<a name="l01366"></a>01366 <span class="keyword">inline</span> <span class="keyword">typename</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">QCAD::PoissonSource&lt;EvalT,Traits&gt;::ScalarT</a>
<a name="l01367"></a><a class="code" href="classQCAD_1_1PoissonSource.html#af5cb4d624e99350f375044a28a898c48">01367</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::fullDopants</a>(<span class="keyword">const</span> std::string dopType, <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> &amp;x)
<a name="l01368"></a>01368 {
<a name="l01369"></a>01369   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> ionDopants;
<a name="l01370"></a>01370 
<a name="l01371"></a>01371   <span class="comment">// fully ionized (create function to use function pointer)</span>
<a name="l01372"></a>01372   <span class="keywordflow">if</span> (dopType == <span class="stringliteral">&quot;Donor&quot;</span>)
<a name="l01373"></a>01373     ionDopants = 1.0;
<a name="l01374"></a>01374   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dopType == <span class="stringliteral">&quot;Acceptor&quot;</span>)
<a name="l01375"></a>01375     ionDopants = -1.0;
<a name="l01376"></a>01376   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dopType == <span class="stringliteral">&quot;None&quot;</span>)
<a name="l01377"></a>01377     ionDopants = 0.0;
<a name="l01378"></a>01378   <span class="keywordflow">else</span>
<a name="l01379"></a>01379   {
<a name="l01380"></a>01380     ionDopants = 0.0;
<a name="l01381"></a>01381     TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,
<a name="l01382"></a>01382        std::endl &lt;&lt; <span class="stringliteral">&quot;Error!  Unknown dopant type &quot;</span> &lt;&lt; dopType &lt;&lt; <span class="stringliteral">&quot;!&quot;</span>&lt;&lt; std::endl);
<a name="l01383"></a>01383   }
<a name="l01384"></a>01384 
<a name="l01385"></a>01385   <span class="keywordflow">return</span> ionDopants;  
<a name="l01386"></a>01386 }
<a name="l01387"></a>01387 
<a name="l01388"></a>01388 
<a name="l01389"></a>01389 <span class="comment">// **********************************************************************</span>
<a name="l01390"></a>01390 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT,<span class="keyword">typename</span> Traits&gt;
<a name="l01391"></a>01391 <span class="keyword">typename</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">QCAD::PoissonSource&lt;EvalT,Traits&gt;::ScalarT</a>
<a name="l01392"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a0bd3e591b9a5cfbcdbccd718d1ae1d35">01392</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::ionizedDopants</a>(<span class="keyword">const</span> std::string dopType, <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> &amp;x)
<a name="l01393"></a>01393 {
<a name="l01394"></a>01394   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> ionDopants;
<a name="l01395"></a>01395   
<a name="l01396"></a>01396   <span class="keywordflow">if</span> (dopType == <span class="stringliteral">&quot;Donor&quot;</span>)
<a name="l01397"></a>01397   {
<a name="l01398"></a>01398     <span class="keywordflow">if</span> (x &gt; <a class="code" href="classQCAD_1_1PoissonSource.html#a0f75995f5cf3b150c6309b8481f15da3">MAX_EXPONENT</a>)
<a name="l01399"></a>01399       ionDopants = 0.5 * exp(-x);  <span class="comment">// use Boltzman statistics for large positive x, </span>
<a name="l01400"></a>01400     <span class="keywordflow">else</span>                           <span class="comment">// as the Fermi statistics leads to bad derivative.</span>
<a name="l01401"></a>01401       ionDopants = 1.0 / (1. + 2.*exp(x));  
<a name="l01402"></a>01402   }  
<a name="l01403"></a>01403 
<a name="l01404"></a>01404   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dopType == <span class="stringliteral">&quot;Acceptor&quot;</span>)
<a name="l01405"></a>01405   {
<a name="l01406"></a>01406     <span class="keywordflow">if</span> (x &gt; <a class="code" href="classQCAD_1_1PoissonSource.html#a0f75995f5cf3b150c6309b8481f15da3">MAX_EXPONENT</a>)
<a name="l01407"></a>01407       ionDopants = -0.25 * exp(-x);
<a name="l01408"></a>01408     <span class="keywordflow">else</span>
<a name="l01409"></a>01409       ionDopants = -1.0 / (1. + 4.*exp(x));
<a name="l01410"></a>01410   }  
<a name="l01411"></a>01411 
<a name="l01412"></a>01412   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dopType == <span class="stringliteral">&quot;None&quot;</span>)
<a name="l01413"></a>01413     ionDopants = 0.0;
<a name="l01414"></a>01414   <span class="keywordflow">else</span>
<a name="l01415"></a>01415   {
<a name="l01416"></a>01416     ionDopants = 0.0;
<a name="l01417"></a>01417     TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,
<a name="l01418"></a>01418        std::endl &lt;&lt; <span class="stringliteral">&quot;Error!  Unknown dopant type &quot;</span> &lt;&lt; dopType &lt;&lt; <span class="stringliteral">&quot;!&quot;</span>&lt;&lt; std::endl);
<a name="l01419"></a>01419   }
<a name="l01420"></a>01420    
<a name="l01421"></a>01421   <span class="keywordflow">return</span> ionDopants; 
<a name="l01422"></a>01422 }
<a name="l01423"></a>01423 
<a name="l01424"></a>01424 
<a name="l01425"></a>01425 
<a name="l01426"></a>01426 
<a name="l01428"></a>01428 
<a name="l01429"></a>01429 
<a name="l01430"></a>01430 <span class="comment">// *****************************************************************************</span>
<a name="l01431"></a>01431 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l01432"></a>01432 <span class="keyword">typename</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">QCAD::PoissonSource&lt;EvalT,Traits&gt;::ScalarT</a>
<a name="l01433"></a>01433 <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::eDensityForPoissonSchrodinger</a> 
<a name="l01434"></a><a class="code" href="classQCAD_1_1PoissonSource.html#acd97a33569f4b36fb2fc06d6ab703c7e">01434</a>   (<span class="keyword">typename</span> Traits::EvalData workset, std::size_t cell, std::size_t qp, 
<a name="l01435"></a>01435    <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> prevPhi, <span class="keyword">const</span> <span class="keywordtype">bool</span> bUsePredCorr, <span class="keyword">const</span> <span class="keywordtype">double</span> Ef, <span class="keyword">const</span> <span class="keywordtype">double</span> fixedOcc)
<a name="l01436"></a>01436 {
<a name="l01437"></a>01437   <span class="comment">// Use the predictor-corrector method proposed by A. Trellakis, A. T. Galick,  </span>
<a name="l01438"></a>01438   <span class="comment">// and U. Ravaioli, &quot;Iteration scheme for the solution of the two-dimensional  </span>
<a name="l01439"></a>01439   <span class="comment">// Schrodinger-Poisson equations in quantum structures&quot;, J. Appl. Phys. 81, 7880 (1997). </span>
<a name="l01440"></a>01440   <span class="comment">// If bUsePredCorr = true, use the predictor-corrector approach.</span>
<a name="l01441"></a>01441   <span class="comment">// If bUsePredCorr = false, calculate the exact quantum electron density.</span>
<a name="l01442"></a>01442   <span class="comment">// Fermi-Dirac distribution is used in computing electron density.  </span>
<a name="l01443"></a>01443   
<a name="l01444"></a>01444   <span class="comment">// unit conversion factor</span>
<a name="l01445"></a>01445   <span class="keywordtype">double</span> <a class="code" href="QCAD__CoupledPSJacobian_8cpp.html#a35c5c91ca07d27b583d09b282131f5fc">eVPerJ</a> = 1.0/<a class="code" href="QCAD__CoupledPSJacobian_8cpp.html#a4cfc3aa2d3dc55427f84a7b9c14b43d9">eleQ</a>; 
<a name="l01446"></a>01446   <span class="keywordtype">double</span> <a class="code" href="QCAD__CoupledPSJacobian_8cpp.html#a67da0e2f296105b800ffcaaf5588ba53">cm2Perm2</a> = 1.0e4; 
<a name="l01447"></a>01447   
<a name="l01448"></a>01448   <span class="comment">// For Delta2-band in Silicon, valley degeneracy factor = 2</span>
<a name="l01449"></a>01449   <span class="keywordtype">int</span> valleyDegeneracyFactor = materialDB-&gt;getElementBlockParam&lt;<span class="keywordtype">int</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Number of conduction band min&quot;</span>,2);
<a name="l01450"></a>01450 
<a name="l01451"></a>01451   <span class="comment">// Scaling factors</span>
<a name="l01452"></a>01452   <span class="keywordtype">double</span> X0 = length_unit_in_m/1e-2; <span class="comment">// length scaling to get to [cm] (structure dimension in [um])</span>
<a name="l01453"></a>01453 
<a name="l01454"></a>01454   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> temperature = temperatureField(0); <span class="comment">//get shared temperature parameter from field</span>
<a name="l01455"></a>01455   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> kbT_eV = <a class="code" href="QCAD__CoupledPSJacobian_8cpp.html#ab64bb1319f148e3488eddc16044015db">kbBoltz</a>*temperature;  <span class="comment">// in [eV]</span>
<a name="l01456"></a>01456   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> kbT = <a class="code" href="QCAD__CoupledPSJacobian_8cpp.html#ab64bb1319f148e3488eddc16044015db">kbBoltz</a>*temperature / energy_unit_in_eV;  <span class="comment">// in [myV]</span>
<a name="l01457"></a>01457   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> eDensity = 0.0; 
<a name="l01458"></a>01458 
<a name="l01459"></a>01459   <span class="comment">// assume eigenvalues are in [myV] units (units of energy_unit_in_eV * eV)</span>
<a name="l01460"></a>01460   <span class="keyword">const</span> std::vector&lt;double&gt;&amp; neg_eigenvals = *(workset.eigenDataPtr-&gt;eigenvalueRe); 
<a name="l01461"></a>01461   std::vector&lt;double&gt; eigenvals( neg_eigenvals );
<a name="l01462"></a>01462   <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;eigenvals.size(); ++i) eigenvals[i] *= -1; <span class="comment">//apply minus sign (b/c of eigenval convention)</span>
<a name="l01463"></a>01463 
<a name="l01464"></a>01464   <span class="comment">// determine deltaPhi used in computing quantum electron density</span>
<a name="l01465"></a>01465   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> deltaPhi = 0.0;  <span class="comment">// 0 by default</span>
<a name="l01466"></a>01466   <span class="keywordflow">if</span> (bUsePredCorr)  <span class="comment">// true: apply the p-c method</span>
<a name="l01467"></a>01467   {
<a name="l01468"></a>01468     <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp; phi = potential(cell,qp); <span class="comment">//[myV]</span>
<a name="l01469"></a>01469     deltaPhi = (phi - prevPhi) / (kbT /1.0);  <span class="comment">//[unitless]</span>
<a name="l01470"></a>01470   }
<a name="l01471"></a>01471   <span class="keywordflow">else</span>
<a name="l01472"></a>01472     deltaPhi = 0.0;  <span class="comment">// false: do not apply the p-c method</span>
<a name="l01473"></a>01473 
<a name="l01474"></a>01474   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> eDenPrefactor;
<a name="l01475"></a>01475   std::vector&lt;ScalarT&gt; occ( eigenvals.size(), 0.0); <span class="comment">//occupation of ith eigenstate</span>
<a name="l01476"></a>01476   
<a name="l01477"></a>01477   <span class="comment">// compute quantum &quot;occupation&quot; according to dimensionality, which is just the coefficient </span>
<a name="l01478"></a>01478   <span class="comment">//   of each (wavefunction)^2 term in the density, as well as a prefactor.</span>
<a name="l01479"></a>01479   <span class="keywordflow">switch</span> (numDims)
<a name="l01480"></a>01480   {
<a name="l01481"></a>01481     <span class="keywordflow">case</span> 1: <span class="comment">// 1D wavefunction (1D confinement)</span>
<a name="l01482"></a>01482     {  
<a name="l01483"></a>01483       <span class="comment">// m11 = in-plane effective mass (y-z plane when the 1D wavefunc. is along x)</span>
<a name="l01484"></a>01484       <span class="comment">// For Delta2-band (or valley), m11 is the transverse effective mass (0.19). </span>
<a name="l01485"></a>01485       
<a name="l01486"></a>01486       <span class="keywordtype">double</span> m11 = materialDB-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Transverse Electron Effective Mass&quot;</span>);
<a name="l01487"></a>01487         
<a name="l01488"></a>01488       <span class="comment">// 2D density of states in [#/(eV.cm^2)] where 2D is the unconfined y-z plane</span>
<a name="l01489"></a>01489       <span class="comment">// dos2D below includes the spin degeneracy of 2</span>
<a name="l01490"></a>01490       <span class="keywordtype">double</span> dos2D = m11*<a class="code" href="QCAD__CoupledPSJacobian_8cpp.html#af3027c0e99e45cbbe91d6bebd64e5904">m0</a>/(<a class="code" href="AAdapt__AnalyticFunction_8cpp.html#a43016d873124d39034edb8cd164794db">pi</a>*<a class="code" href="QCAD__CoupledPSJacobian_8cpp.html#a0ae50bc0ad13e33e23eec85ec44b3e2b">hbar</a>*<a class="code" href="QCAD__CoupledPSJacobian_8cpp.html#a0ae50bc0ad13e33e23eec85ec44b3e2b">hbar</a>*eVPerJ*cm2Perm2); 
<a name="l01491"></a>01491         
<a name="l01492"></a>01492       <span class="comment">// subband-independent prefactor in calculating electron density</span>
<a name="l01493"></a>01493       <span class="comment">// X0 is used to scale wavefunc. squared from [um^-1] or [nm^-1] to [cm^-1]</span>
<a name="l01494"></a>01494       eDenPrefactor = valleyDegeneracyFactor*dos2D*kbT_eV/X0; 
<a name="l01495"></a>01495 
<a name="l01496"></a>01496       <span class="comment">// loop over eigenvalues to compute the occupation</span>
<a name="l01497"></a>01497       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; nEigenvectors; i++) 
<a name="l01498"></a>01498       {
<a name="l01499"></a>01499         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> tmpArg = (Ef-eigenvals[i])/kbT + deltaPhi;
<a name="l01500"></a>01500         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> logFunc; 
<a name="l01501"></a>01501         <span class="keywordflow">if</span> (tmpArg &gt; <a class="code" href="QCAD__CoupledPSJacobian_8cpp.html#ac62f9cb1e506ac5ee4407b9fc0c7beb8">MAX_EXPONENT</a>)
<a name="l01502"></a>01502           logFunc = tmpArg;  <span class="comment">// exp(tmpArg) blows up for large positive tmpArg, leading to bad derivative</span>
<a name="l01503"></a>01503         <span class="keywordflow">else</span>
<a name="l01504"></a>01504           logFunc = log(1.0 + exp(tmpArg));
<a name="l01505"></a>01505   occ[i] = logFunc;
<a name="l01506"></a>01506       }
<a name="l01507"></a>01507       <span class="keywordflow">break</span>; 
<a name="l01508"></a>01508     }  <span class="comment">// end of case 1 block</span>
<a name="l01509"></a>01509 
<a name="l01510"></a>01510 
<a name="l01511"></a>01511     <span class="keywordflow">case</span> 2: <span class="comment">// 2D wavefunction (2D confinement)</span>
<a name="l01512"></a>01512     {
<a name="l01513"></a>01513       <span class="comment">// mUnconfined = effective mass in the unconfined direction (z dir. when the 2D wavefunc. is in x-y plane)</span>
<a name="l01514"></a>01514       <span class="comment">// For Delta2-band and assume SiO2/Si interface parallel to [100] plane, mUnconfined=0.19. </span>
<a name="l01515"></a>01515       <span class="keywordtype">double</span> mUnconfined = materialDB-&gt;getElementBlockParam&lt;<span class="keywordtype">double</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Transverse Electron Effective Mass&quot;</span>);
<a name="l01516"></a>01516         
<a name="l01517"></a>01517       <span class="comment">// n1D below is a factor that is part of the line electron density </span>
<a name="l01518"></a>01518       <span class="comment">// in the unconfined dir. and includes spin degeneracy and in unit of [cm^-1]</span>
<a name="l01519"></a>01519       <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> n1D = sqrt(2.0*mUnconfined*<a class="code" href="QCAD__CoupledPSJacobian_8cpp.html#af3027c0e99e45cbbe91d6bebd64e5904">m0</a>*kbT_eV/(<a class="code" href="AAdapt__AnalyticFunction_8cpp.html#a43016d873124d39034edb8cd164794db">pi</a>*<a class="code" href="QCAD__CoupledPSJacobian_8cpp.html#a0ae50bc0ad13e33e23eec85ec44b3e2b">hbar</a>*<a class="code" href="QCAD__CoupledPSJacobian_8cpp.html#a0ae50bc0ad13e33e23eec85ec44b3e2b">hbar</a>*eVPerJ*cm2Perm2));
<a name="l01520"></a>01520         
<a name="l01521"></a>01521       <span class="comment">// subband-independent prefactor in calculating electron density</span>
<a name="l01522"></a>01522       <span class="comment">// X0^2 is used to scale wavefunc. squared from [um^-2] or [nm^-2] to [cm^-2]</span>
<a name="l01523"></a>01523       eDenPrefactor = valleyDegeneracyFactor*n1D/pow(X0,2.);
<a name="l01524"></a>01524 
<a name="l01525"></a>01525       <span class="comment">// loop over eigenvalues to compute the occupation</span>
<a name="l01526"></a>01526       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i &lt; nEigenvectors; i++) 
<a name="l01527"></a>01527       {
<a name="l01528"></a>01528         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> inArg = (Ef-eigenvals[i])/kbT + deltaPhi;
<a name="l01529"></a>01529   occ[i] = computeFDIntMinusOneHalf(inArg);
<a name="l01530"></a>01530       }
<a name="l01531"></a>01531       <span class="keywordflow">break</span>;
<a name="l01532"></a>01532     }  <span class="comment">// end of case 2 block    </span>
<a name="l01533"></a>01533 
<a name="l01534"></a>01534 
<a name="l01535"></a>01535     <span class="keywordflow">case</span> 3: <span class="comment">// 3D wavefunction (3D confinement)</span>
<a name="l01536"></a>01536     { 
<a name="l01537"></a>01537       <span class="comment">//degeneracy factor</span>
<a name="l01538"></a>01538       <span class="keywordtype">int</span> spinDegeneracyFactor = 2;
<a name="l01539"></a>01539       <span class="keywordtype">double</span> degeneracyFactor = spinDegeneracyFactor * valleyDegeneracyFactor;
<a name="l01540"></a>01540         
<a name="l01541"></a>01541       <span class="comment">// subband-independent prefactor in calculating electron density</span>
<a name="l01542"></a>01542       <span class="comment">// X0^3 is used to scale wavefunc. squared from [um^-3] or [nm^-3] to [cm^-3]</span>
<a name="l01543"></a>01543       eDenPrefactor = degeneracyFactor/pow(X0,3.);
<a name="l01544"></a>01544 
<a name="l01545"></a>01545       <span class="comment">// loop over eigenvalues to compute occupation</span>
<a name="l01546"></a>01546       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; nEigenvectors; i++) 
<a name="l01547"></a>01547       {
<a name="l01548"></a>01548         <span class="comment">// ScalarT tmpArg = (eigenvals[i]-Ef)/kbT + deltaPhi;</span>
<a name="l01549"></a>01549         <span class="comment">// It is critical to use -deltaPhi for 3D (while +deltaPhi for 1D and 2D) as </span>
<a name="l01550"></a>01550         <span class="comment">// derived theoretically. +deltaPhi leads to serious oscillations (tested).  </span>
<a name="l01551"></a>01551         
<a name="l01552"></a>01552         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> tmpArg = (eigenvals[i]-Ef)/kbT - deltaPhi;
<a name="l01553"></a>01553         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> fermiFactor; 
<a name="l01554"></a>01554         
<a name="l01555"></a>01555         <span class="keywordflow">if</span> (tmpArg &gt; <a class="code" href="QCAD__CoupledPSJacobian_8cpp.html#ac62f9cb1e506ac5ee4407b9fc0c7beb8">MAX_EXPONENT</a>) 
<a name="l01556"></a>01556           fermiFactor = exp(-tmpArg);  <span class="comment">// use Boltzmann statistics for large positive tmpArg,</span>
<a name="l01557"></a>01557         <span class="keywordflow">else</span>                           <span class="comment">// as the Fermi statistics leads to bad derivative        </span>
<a name="l01558"></a>01558           fermiFactor = 1.0/( exp(tmpArg) + 1.0 ); 
<a name="l01559"></a>01559   occ[i] = fermiFactor;
<a name="l01560"></a>01560       }
<a name="l01561"></a>01561       <span class="keywordflow">break</span>;
<a name="l01562"></a>01562     }  <span class="comment">// end of case 3 block </span>
<a name="l01563"></a>01563       
<a name="l01564"></a>01564     <span class="keywordflow">default</span>:
<a name="l01565"></a>01565       TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,
<a name="l01566"></a>01566         std::endl &lt;&lt; <span class="stringliteral">&quot;Error!  Invalid number of dimensions &quot;</span> &lt;&lt; numDims &lt;&lt; <span class="stringliteral">&quot;!&quot;</span>&lt;&lt; std::endl);
<a name="l01567"></a>01567       eDenPrefactor = 0.0; <span class="comment">//to avoid compiler warning</span>
<a name="l01568"></a>01568       <span class="keywordflow">break</span>; 
<a name="l01569"></a>01569       
<a name="l01570"></a>01570   }  <span class="comment">// end of switch (numDims) </span>
<a name="l01571"></a>01571 
<a name="l01572"></a>01572   <span class="comment">//Enforce a fixed occupation (non-equilibrium) if desired (indicated by fixedOcc &gt; 0)</span>
<a name="l01573"></a>01573   <span class="keywordflow">if</span>(fixedOcc &gt; -1e-6) {
<a name="l01574"></a>01574     <span class="keywordtype">double</span> occLeft = fixedOcc;
<a name="l01575"></a>01575     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; nEigenvectors; i++) {
<a name="l01576"></a>01576       occ[i] = std::min(1.0, occLeft);
<a name="l01577"></a>01577       occLeft -= QCAD::EvaluatorTools&lt;EvalT,Traits&gt;::getDoubleValue(occ[i]);
<a name="l01578"></a>01578     }
<a name="l01579"></a>01579   }
<a name="l01580"></a>01580 
<a name="l01581"></a>01581   <span class="comment">// loop over eigenvalues to compute electron density [cm^-3]</span>
<a name="l01582"></a>01582   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; nEigenvectors; i++) 
<a name="l01583"></a>01583   {
<a name="l01584"></a>01584     <span class="comment">// note: wavefunctions are assumed normalized here </span>
<a name="l01585"></a>01585     <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> wfSquared;
<a name="l01586"></a>01586     <span class="keywordflow">if</span>(bRealEigenvectors)
<a name="l01587"></a>01587       wfSquared = ( eigenvector_Re[i](cell,qp)*eigenvector_Re[i](cell,qp) );
<a name="l01588"></a>01588     <span class="keywordflow">else</span>
<a name="l01589"></a>01589       wfSquared = ( eigenvector_Re[i](cell,qp)*eigenvector_Re[i](cell,qp) + 
<a name="l01590"></a>01590         eigenvector_Im[i](cell,qp)*eigenvector_Im[i](cell,qp) );
<a name="l01591"></a>01591     eDensity += wfSquared*occ[i];
<a name="l01592"></a>01592   }
<a name="l01593"></a>01593   eDensity = eDenPrefactor*eDensity; <span class="comment">// in [cm^-3]</span>
<a name="l01594"></a>01594 
<a name="l01595"></a>01595   <span class="keywordflow">return</span> eDensity; 
<a name="l01596"></a>01596 }
<a name="l01597"></a>01597 
<a name="l01598"></a>01598 
<a name="l01599"></a>01599 <span class="comment">//Similar as eDensityForPoissonSchrodinger but assume |wf|^2 values are given in eigenvector_Re[.] instead of eigenvector</span>
<a name="l01600"></a>01600 <span class="comment">// Note: sum of |wf|^2 values == N where N is the number of electrons in the wave function, not necessarily == 1</span>
<a name="l01601"></a>01601 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l01602"></a>01602 <span class="keyword">typename</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">QCAD::PoissonSource&lt;EvalT,Traits&gt;::ScalarT</a>
<a name="l01603"></a>01603 <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::eDensityForPoissonCI</a> 
<a name="l01604"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a24c8de4c815e6fcfba7260134f7b4e8d">01604</a>   (<span class="keyword">typename</span> Traits::EvalData workset, std::size_t cell, std::size_t qp, 
<a name="l01605"></a>01605    <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> prevPhi, <span class="keyword">const</span> <span class="keywordtype">bool</span> bUsePredCorr, <span class="keyword">const</span> <span class="keywordtype">double</span> Ef, <span class="keyword">const</span> <span class="keywordtype">double</span> fixedOcc)
<a name="l01606"></a>01606 {
<a name="l01607"></a>01607   <span class="comment">// Use the predictor-corrector method proposed by A. Trellakis, A. T. Galick,  </span>
<a name="l01608"></a>01608   <span class="comment">// and U. Ravaioli, &quot;Iteration scheme for the solution of the two-dimensional  </span>
<a name="l01609"></a>01609   <span class="comment">// Schrodinger-Poisson equations in quantum structures&quot;, J. Appl. Phys. 81, 7880 (1997). </span>
<a name="l01610"></a>01610   <span class="comment">// If bUsePredCorr = true, use the predictor-corrector approach.</span>
<a name="l01611"></a>01611   <span class="comment">// If bUsePredCorr = false, calculate the exact quantum electron density.</span>
<a name="l01612"></a>01612   <span class="comment">// Fermi-Dirac distribution is used in computing electron density.  </span>
<a name="l01613"></a>01613   
<a name="l01614"></a>01614   <span class="comment">// unit conversion factor</span>
<a name="l01615"></a>01615   <span class="comment">//double eVPerJ = 1.0/eleQ; </span>
<a name="l01616"></a>01616   <span class="comment">//double cm2Perm2 = 1.0e4; </span>
<a name="l01617"></a>01617 
<a name="l01618"></a>01618   <span class="comment">// For Delta2-band in Silicon, valley degeneracy factor = 2</span>
<a name="l01619"></a>01619   <span class="keywordtype">int</span> valleyDegeneracyFactor = materialDB-&gt;getElementBlockParam&lt;<span class="keywordtype">int</span>&gt;(workset.EBName,<span class="stringliteral">&quot;Number of conduction band min&quot;</span>,2);
<a name="l01620"></a>01620 
<a name="l01621"></a>01621   <span class="comment">// Scaling factors</span>
<a name="l01622"></a>01622   <span class="keywordtype">double</span> X0 = length_unit_in_m/1e-2; <span class="comment">// length scaling to get to [cm] (structure dimension in [um])</span>
<a name="l01623"></a>01623 
<a name="l01624"></a>01624   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> temperature = temperatureField(0); <span class="comment">//get shared temperature parameter from field in [K]</span>
<a name="l01625"></a>01625   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> kbT = <a class="code" href="QCAD__CoupledPSJacobian_8cpp.html#ab64bb1319f148e3488eddc16044015db">kbBoltz</a>*temperature / energy_unit_in_eV;  <span class="comment">// in [myV]</span>
<a name="l01626"></a>01626   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> eDensity = 0.0; 
<a name="l01627"></a>01627   <span class="comment">//double Ef = 0.0;  //Fermi energy == 0</span>
<a name="l01628"></a>01628 
<a name="l01629"></a>01629   <span class="keyword">const</span> std::vector&lt;double&gt;&amp; neg_eigenvals = *(workset.eigenDataPtr-&gt;eigenvalueRe);
<a name="l01630"></a>01630   std::vector&lt;double&gt; eigenvals( neg_eigenvals );
<a name="l01631"></a>01631   <span class="keywordtype">int</span> nCIEvals = eigenvals.size(); <span class="comment">//not necessarily == nEigenvectors, since CI could have not converged as many as requested</span>
<a name="l01632"></a>01632   <span class="keywordtype">int</span> nEvals = std::min(nCIEvals, nEigenvectors); <span class="comment">// the number of eigen-pairs to use (we don&#39;t gather more than nEigenvectors)</span>
<a name="l01633"></a>01633 
<a name="l01634"></a>01634   <span class="comment">//I don&#39;t believe CI eigenvalues are negated...</span>
<a name="l01635"></a>01635   <span class="comment">//for(unsigned int i=0; i&lt;nEvals; ++i) eigenvals[i] *= -1; //apply minus sign (b/c of eigenval convention)</span>
<a name="l01636"></a>01636 
<a name="l01637"></a>01637   <span class="comment">//Note: NO predictor corrector method used here yet -- need to understand what&#39;s going on better first</span>
<a name="l01638"></a>01638 
<a name="l01639"></a>01639   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> eDenPrefactor;
<a name="l01640"></a>01640   std::vector&lt;ScalarT&gt; occ( nEvals, 0.0); <span class="comment">//occupation of ith eigenstate</span>
<a name="l01641"></a>01641   
<a name="l01642"></a>01642   <span class="comment">// compute quantum electron density according to dimensionality</span>
<a name="l01643"></a>01643   <span class="keywordflow">switch</span> (numDims)
<a name="l01644"></a>01644   {
<a name="l01645"></a>01645     <span class="comment">//No 1D case -- deal with this later</span>
<a name="l01646"></a>01646 
<a name="l01647"></a>01647     <span class="keywordflow">case</span> 2: <span class="comment">// 2D wavefunction (2D confinement)</span>
<a name="l01648"></a>01648     {
<a name="l01649"></a>01649       <span class="comment">// ** Assume for now that 2D case means there is confinement along the 3rd dimension such that only a single, completely non-degenerate</span>
<a name="l01650"></a>01650       <span class="comment">//  level exists in the third dimension.  In addition, the CI accounts for spin degeneracy, so there should be no spin degeneracy factors.</span>
<a name="l01651"></a>01651       <span class="comment">//  Together, I think this means n1D == 1.0 below. **</span>
<a name="l01652"></a>01652 
<a name="l01653"></a>01653       <span class="comment">// mUnconfined = effective mass in the unconfined direction (z dir. when the 2D wavefunc. is in x-y plane)</span>
<a name="l01654"></a>01654       <span class="comment">// For Delta2-band and assume SiO2/Si interface parallel to [100] plane, mUnconfined=0.19. </span>
<a name="l01655"></a>01655       <span class="comment">//double mUnconfined = materialDB-&gt;getElementBlockParam&lt;double&gt;(workset.EBName,&quot;Transverse Electron Effective Mass&quot;);</span>
<a name="l01656"></a>01656         
<a name="l01657"></a>01657       <span class="comment">// n1D below is a factor that is part of the line electron density </span>
<a name="l01658"></a>01658       <span class="comment">// in the unconfined dir. and includes spin degeneracy and in unit of [cm^-1]</span>
<a name="l01659"></a>01659       <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> n1D = 1.0; <span class="comment">//sqrt(2.0*mUnconfined*m0*kbT_eV/(pi*hbar*hbar*eVPerJ*cm2Perm2));</span>
<a name="l01660"></a>01660         
<a name="l01661"></a>01661       <span class="comment">// subband-independent prefactor in calculating electron density</span>
<a name="l01662"></a>01662       <span class="comment">// X0^2 is used to scale wavefunc. squared from [um^-2] or [nm^-2] to [cm^-2]</span>
<a name="l01663"></a>01663       <span class="comment">// Note: 1/energy_unit_in_eV factor ==&gt; correct [myV] units for LHS of Poisson</span>
<a name="l01664"></a>01664       eDenPrefactor = valleyDegeneracyFactor*n1D/pow(X0,2.) / energy_unit_in_eV;
<a name="l01665"></a>01665       
<a name="l01666"></a>01666       <span class="comment">// Get Z = sum( exp(-E_i/kT) )</span>
<a name="l01667"></a>01667       <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> <a class="code" href="namespaceFELIX.html#ac9186a7590bc4e2f11aa0500d5ec717e">Z</a> = 0.0;
<a name="l01668"></a>01668       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i &lt; nEvals; i++) Z += exp(-eigenvals[i]/kbT);
<a name="l01669"></a>01669 
<a name="l01670"></a>01670       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i &lt; nEvals; i++) 
<a name="l01671"></a>01671       {
<a name="l01672"></a>01672         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> wfOcc = exp(-eigenvals[i]/kbT) / Z;
<a name="l01673"></a>01673         occ[i] = wfOcc;
<a name="l01674"></a>01674       }
<a name="l01675"></a>01675       <span class="keywordflow">break</span>;
<a name="l01676"></a>01676     }  <span class="comment">// end of case 2 block    </span>
<a name="l01677"></a>01677 
<a name="l01678"></a>01678 
<a name="l01679"></a>01679     <span class="keywordflow">case</span> 3: <span class="comment">// 3D wavefunction (3D confinement)</span>
<a name="l01680"></a>01680     { 
<a name="l01681"></a>01681       <span class="comment">//degeneracy factor</span>
<a name="l01682"></a>01682       <span class="keywordtype">double</span> degeneracyFactor = valleyDegeneracyFactor; <span class="comment">//CI includes spin degeneracy</span>
<a name="l01683"></a>01683         
<a name="l01684"></a>01684       <span class="comment">// subband-independent prefactor in calculating electron density</span>
<a name="l01685"></a>01685       <span class="comment">// X0^3 is used to scale wavefunc. squared from [um^-3] or [nm^-3] to [cm^-3]</span>
<a name="l01686"></a>01686       eDenPrefactor = degeneracyFactor/pow(X0,3.);
<a name="l01687"></a>01687 
<a name="l01688"></a>01688       <span class="comment">// Get Z = sum( exp(-E_i/kT) )</span>
<a name="l01689"></a>01689       <span class="comment">//ScalarT Z = 0.0;</span>
<a name="l01690"></a>01690       <span class="comment">//for(int i=0; i &lt; nEvals; i++) Z += exp(-eigenvals[i]/kbT);</span>
<a name="l01691"></a>01691 
<a name="l01692"></a>01692       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; nEvals; i++) 
<a name="l01693"></a>01693       {
<a name="l01694"></a>01694         <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> oneOverOcc = 0.0;  <span class="comment">// get 1/(exp(-eigenvals[i]/kbT) / Z) as sum, then invert (avoids inf issues)</span>
<a name="l01695"></a>01695   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j &lt; nEvals; j++) oneOverOcc += exp(-(eigenvals[j]-eigenvals[i])/kbT);
<a name="l01696"></a>01696 
<a name="l01697"></a>01697   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> wfOcc = 0.0; <span class="comment">//exp(-eigenvals[i]/kbT) / Z;</span>
<a name="l01698"></a>01698   <span class="keywordflow">if</span>(!std::isinf(QCAD::EvaluatorTools&lt;EvalT,Traits&gt;::getDoubleValue(oneOverOcc)))
<a name="l01699"></a>01699     wfOcc = 1/oneOverOcc; <span class="comment">//otherwise just leave as zero since denom is infinite</span>
<a name="l01700"></a>01700   occ[i] = wfOcc;
<a name="l01701"></a>01701       }
<a name="l01702"></a>01702       <span class="keywordflow">break</span>;
<a name="l01703"></a>01703     }  <span class="comment">// end of case 3 block </span>
<a name="l01704"></a>01704       
<a name="l01705"></a>01705     <span class="keywordflow">default</span>:
<a name="l01706"></a>01706       TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter,
<a name="l01707"></a>01707         std::endl &lt;&lt; <span class="stringliteral">&quot;Error!  Invalid number of dimensions &quot;</span> &lt;&lt; numDims &lt;&lt; <span class="stringliteral">&quot;!&quot;</span>&lt;&lt; std::endl);
<a name="l01708"></a>01708       <span class="keywordflow">break</span>; 
<a name="l01709"></a>01709       
<a name="l01710"></a>01710   }  <span class="comment">// end of switch (numDims) </span>
<a name="l01711"></a>01711 
<a name="l01712"></a>01712   <span class="comment">//Enforce a fixed occupation (non-equilibrium) if desired (indicated by fixedOcc &gt; 0)</span>
<a name="l01713"></a>01713   <span class="keywordflow">if</span>(fixedOcc &gt; -1e-6) {
<a name="l01714"></a>01714     <span class="keywordtype">double</span> occLeft = fixedOcc;
<a name="l01715"></a>01715     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; nEigenvectors; i++) {
<a name="l01716"></a>01716       occ[i] = std::min(1.0, occLeft);
<a name="l01717"></a>01717       occLeft -= QCAD::EvaluatorTools&lt;EvalT,Traits&gt;::getDoubleValue(occ[i]);
<a name="l01718"></a>01718     }
<a name="l01719"></a>01719   }
<a name="l01720"></a>01720 
<a name="l01721"></a>01721   <span class="comment">// loop over eigenvalues to compute electron density [cm^-3]</span>
<a name="l01722"></a>01722   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; nEvals; i++) 
<a name="l01723"></a>01723   {
<a name="l01724"></a>01724     <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> wfSquared = ( eigenvector_Re[i](cell,qp) );
<a name="l01725"></a>01725     eDensity += wfSquared * occ[i];
<a name="l01726"></a>01726   }
<a name="l01727"></a>01727   eDensity = eDenPrefactor*eDensity; <span class="comment">// in [cm^-3]</span>
<a name="l01728"></a>01728 
<a name="l01729"></a>01729   <span class="keywordflow">return</span> eDensity; 
<a name="l01730"></a>01730 }
<a name="l01731"></a>01731 
<a name="l01732"></a>01732 
<a name="l01733"></a>01733 
<a name="l01734"></a>01734 
<a name="l01735"></a>01735 
<a name="l01737"></a>01737 
<a name="l01738"></a>01738 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l01739"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a104fdb2543b1cbf4ddcd67f08368403f">01739</a> <span class="keywordtype">void</span> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::source_pointcharges</a>(<span class="keyword">typename</span> Traits::EvalData workset)
<a name="l01740"></a>01740 {
<a name="l01741"></a>01741   <span class="comment">// Scaling factors</span>
<a name="l01742"></a>01742   <span class="keywordtype">double</span> X0 = <a class="code" href="classQCAD_1_1PoissonSource.html#aa7122e9b80328be00b7e50bf61d8c899" title="scaling parameters">length_unit_in_m</a>/1e-2; <span class="comment">// length scaling to get to [cm] (structure dimension in [um] usually)</span>
<a name="l01743"></a>01743   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> Lambda2 = <a class="code" href="classQCAD_1_1PoissonSource.html#a66367459749e48e11a50a4fa6457666f">eps0</a>/(<a class="code" href="classQCAD_1_1PoissonSource.html#a69b53a45d322590c547e3b3873180966">eleQ</a>*X0*X0);  
<a name="l01744"></a>01744 
<a name="l01746"></a>01746   <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#a82816b9a2255db5d2d3f95c611f80755">numWorksetsScannedForPtCharges</a> &lt;= workset.wsIndex) {
<a name="l01747"></a>01747     TEUCHOS_TEST_FOR_EXCEPTION ( !(<a class="code" href="classQCAD_1_1PoissonSource.html#abe44f806525ae2ac13105e5f499fa120">numDims</a> == 2 || ((<a class="code" href="classQCAD_1_1PoissonSource.html#ab6f81ddb14492a98526d3a01bd93c579">numNodes</a> == 4 || <a class="code" href="classQCAD_1_1PoissonSource.html#ab6f81ddb14492a98526d3a01bd93c579">numNodes</a> == 8) &amp;&amp; <a class="code" href="classQCAD_1_1PoissonSource.html#abe44f806525ae2ac13105e5f499fa120">numDims</a> == 3)), Teuchos::Exceptions::InvalidParameter,
<a name="l01748"></a>01748           std::endl &lt;&lt; <span class="stringliteral">&quot;Error!  Point charges are only supported for TET4 and HEX8 meshes in 3D currently.&quot;</span> &lt;&lt; std::endl);
<a name="l01749"></a>01749 
<a name="l01751"></a>01751     bool (<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;</a>::*point_test_fn) (<span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>*, <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>*, int);
<a name="l01752"></a>01752     <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#abe44f806525ae2ac13105e5f499fa120">numDims</a> == 3 &amp;&amp; <a class="code" href="classQCAD_1_1PoissonSource.html#ab6f81ddb14492a98526d3a01bd93c579">numNodes</a> == 4)      point_test_fn = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::pointIsInTetrahedron</a>; <span class="comment">//NOTE: this test should be replaced with cell type test</span>
<a name="l01753"></a>01753     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#abe44f806525ae2ac13105e5f499fa120">numDims</a> == 3 &amp;&amp; <a class="code" href="classQCAD_1_1PoissonSource.html#ab6f81ddb14492a98526d3a01bd93c579">numNodes</a> == 8) point_test_fn = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::pointIsInHexahedron</a>;  <span class="comment">//NOTE: this test should be replaced with cell type test</span>
<a name="l01754"></a>01754     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="classQCAD_1_1PoissonSource.html#abe44f806525ae2ac13105e5f499fa120">numDims</a> == 2)                  point_test_fn = &amp;<a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::pointIsInPolygon</a>;
<a name="l01755"></a>01755     <span class="keywordflow">else</span>                                   point_test_fn = NULL;
<a name="l01756"></a>01756     
<a name="l01757"></a>01757     <span class="comment">//std::cout &lt;&lt; &quot;DEBUG: Looking for point charges in ws &quot; &lt;&lt; workset.wsIndex &lt;&lt; &quot; - scanned &quot; </span>
<a name="l01758"></a>01758     <span class="comment">//  &lt;&lt; numWorksetsScannedForPtCharges &lt;&lt; &quot; worksets so far&quot; &lt;&lt; std::endl;</span>
<a name="l01759"></a>01759     MeshScalarT* cellVertices = <span class="keyword">new</span> MeshScalarT[<a class="code" href="classQCAD_1_1PoissonSource.html#ab6f81ddb14492a98526d3a01bd93c579">numNodes</a>*<a class="code" href="classQCAD_1_1PoissonSource.html#abe44f806525ae2ac13105e5f499fa120">numDims</a>];
<a name="l01760"></a>01760     <span class="keywordflow">for</span> (std::size_t cell=0; cell &lt; workset.numCells; ++cell) {
<a name="l01761"></a>01761   <span class="keywordflow">for</span>( std::size_t node=0; node&lt;<a class="code" href="classQCAD_1_1PoissonSource.html#ab6f81ddb14492a98526d3a01bd93c579">numNodes</a>; ++node ) {
<a name="l01762"></a>01762     <span class="keywordflow">for</span>( std::size_t k=0; k&lt;<a class="code" href="classQCAD_1_1PoissonSource.html#abe44f806525ae2ac13105e5f499fa120">numDims</a>; ++k )
<a name="l01763"></a>01763       cellVertices[node*numDims+k] = <a class="code" href="classQCAD_1_1PoissonSource.html#a3ad4b77aa3b399f00b5174bc9a1dc852">coordVecAtVertices</a>(cell,node,k);
<a name="l01764"></a>01764   }
<a name="l01765"></a>01765 
<a name="l01766"></a>01766   <span class="keywordflow">for</span>( std::size_t i=0; i &lt; <a class="code" href="classQCAD_1_1PoissonSource.html#af42c69cb97e2192f19b9574ec492b1a6">pointCharges</a>.size(); ++i) {
<a name="l01767"></a>01767     <span class="keywordflow">if</span>( (this-&gt;*point_test_fn)(cellVertices, <a class="code" href="classQCAD_1_1PoissonSource.html#af42c69cb97e2192f19b9574ec492b1a6">pointCharges</a>[i].position, numNodes) ) {
<a name="l01768"></a>01768       std::cout &lt;&lt; <span class="stringliteral">&quot;DEBUG: FOUND POINT CHARGE in ws &quot;</span> &lt;&lt; workset.wsIndex &lt;&lt; <span class="stringliteral">&quot;, cell &quot;</span> &lt;&lt; cell &lt;&lt; std::endl;
<a name="l01769"></a>01769       <span class="comment">//std::cout &lt;&lt; &quot;DEBUG: CELL &quot; &lt;&lt; cell &lt;&lt; &quot;VERTICES = &quot; &lt;&lt; std::endl;</span>
<a name="l01770"></a>01770       <span class="keywordflow">for</span>(std::size_t v=0; v&lt;numNodes; v++) {
<a name="l01771"></a>01771         std::cout &lt;&lt; <span class="stringliteral">&quot; (  &quot;</span>;
<a name="l01772"></a>01772         <span class="keywordflow">for</span>(std::size_t d=0; d&lt;<a class="code" href="classQCAD_1_1PoissonSource.html#abe44f806525ae2ac13105e5f499fa120">numDims</a>; d++) std::cout &lt;&lt; cellVertices[v*numDims] &lt;&lt; <span class="stringliteral">&quot;  &quot;</span>;
<a name="l01773"></a>01773         std::cout &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; std::endl;
<a name="l01774"></a>01774       }
<a name="l01775"></a>01775         
<a name="l01776"></a>01776       <a class="code" href="classQCAD_1_1PoissonSource.html#af42c69cb97e2192f19b9574ec492b1a6">pointCharges</a>[i].iWorkset = workset.wsIndex;
<a name="l01777"></a>01777       <a class="code" href="classQCAD_1_1PoissonSource.html#af42c69cb97e2192f19b9574ec492b1a6">pointCharges</a>[i].iCell = cell;
<a name="l01778"></a>01778     }
<a name="l01779"></a>01779   }
<a name="l01780"></a>01780     }
<a name="l01781"></a>01781     <span class="keyword">delete</span> [] cellVertices;
<a name="l01782"></a>01782 
<a name="l01783"></a>01783     assert(workset.wsIndex == <a class="code" href="classQCAD_1_1PoissonSource.html#a82816b9a2255db5d2d3f95c611f80755">numWorksetsScannedForPtCharges</a>); <span class="comment">//equality should always hold in if stmt above</span>
<a name="l01784"></a>01784     <a class="code" href="classQCAD_1_1PoissonSource.html#a82816b9a2255db5d2d3f95c611f80755">numWorksetsScannedForPtCharges</a>++;
<a name="l01785"></a>01785   }
<a name="l01786"></a>01786   
<a name="l01788"></a>01788   <span class="keywordflow">for</span>( std::size_t i=0; i &lt; <a class="code" href="classQCAD_1_1PoissonSource.html#af42c69cb97e2192f19b9574ec492b1a6">pointCharges</a>.size(); ++i) {
<a name="l01789"></a>01789     <span class="keywordflow">if</span>( <a class="code" href="classQCAD_1_1PoissonSource.html#af42c69cb97e2192f19b9574ec492b1a6">pointCharges</a>[i].iWorkset != (<span class="keywordtype">int</span>)workset.wsIndex ) <span class="keywordflow">continue</span>; <span class="comment">//skips if iWorkset == -1 (not found)</span>
<a name="l01790"></a>01790     
<a name="l01791"></a>01791     <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a> cellVol = 0.0, qpChargeDen;
<a name="l01792"></a>01792     std::size_t cell = <a class="code" href="classQCAD_1_1PoissonSource.html#af42c69cb97e2192f19b9574ec492b1a6">pointCharges</a>[i].iCell; <span class="comment">// iCell should be valid here since iWorkset is</span>
<a name="l01793"></a>01793     <span class="keywordflow">for</span> (std::size_t qp=0; qp &lt; <a class="code" href="classQCAD_1_1PoissonSource.html#aef0fb486fbdf94b26e96eb6096a236ea" title="input">numQPs</a>; ++qp)
<a name="l01794"></a>01794   cellVol += <a class="code" href="classQCAD_1_1PoissonSource.html#ae7a966a84cafaf80881e2a1cd7ab1506">weights</a>(cell,qp);
<a name="l01795"></a>01795     
<a name="l01796"></a>01796     qpChargeDen = <a class="code" href="classQCAD_1_1PoissonSource.html#af42c69cb97e2192f19b9574ec492b1a6">pointCharges</a>[i].charge / (cellVol*pow(X0,3)); <span class="comment">// 3 was (int)numDims but I think this is wrong (Suzey?); // [cm^-3] value of qps so that integrated charge is correct</span>
<a name="l01797"></a>01797     <span class="comment">//std::cout &lt;&lt; &quot;DEBUG: ADDING POINT CHARGE (den=&quot; &lt;&lt; qpChargeDen &lt;&lt; &quot;, was &quot; &lt;&lt; chargeDensity(cell,0) &lt;&lt; &quot;) to ws &quot;</span>
<a name="l01798"></a>01798     <span class="comment">//    &lt;&lt; workset.wsIndex &lt;&lt; &quot;, cell &quot; &lt;&lt; cell &lt;&lt; std::endl;</span>
<a name="l01799"></a>01799     <span class="keywordflow">for</span> (std::size_t qp=0; qp &lt; numQPs; ++qp) {
<a name="l01800"></a>01800   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> scaleFactor = 1.0; <span class="comment">//TODO: get appropriate scale factor from meshRegions (later?)</span>
<a name="l01801"></a>01801   <a class="code" href="classQCAD_1_1PoissonSource.html#a4d3f473e00eac7aafe120bd596db647d" title="output">poissonSource</a>(cell, qp) += 1.0/Lambda2 * scaleFactor * qpChargeDen;
<a name="l01802"></a>01802   <a class="code" href="classQCAD_1_1PoissonSource.html#ae574ccc85e9e3986d56b1b1b6b7a924d">chargeDensity</a>(cell, qp) += qpChargeDen;    
<a name="l01803"></a>01803     }
<a name="l01804"></a>01804   }
<a name="l01805"></a>01805 }
<a name="l01806"></a>01806 
<a name="l01807"></a>01807 
<a name="l01808"></a>01808 <span class="comment">// **********************************************************************</span>
<a name="l01809"></a>01809 
<a name="l01810"></a>01810 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l01811"></a>01811 <span class="keywordtype">bool</span> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::</a>
<a name="l01812"></a><a class="code" href="classQCAD_1_1PoissonSource.html#af747ae8a11025284f59851c0d3a54d1a">01812</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">pointIsInTetrahedron</a>(<span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>* cellVertices, <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>* position, <span class="keywordtype">int</span> <a class="code" href="Interface_8cpp.html#ac84f0e2f09cede787f23db9d9be27cd1">nVertices</a>)
<a name="l01813"></a>01813 {
<a name="l01814"></a>01814   <span class="comment">// Assumes cellVertices contains 4 3D points (length 12)</span>
<a name="l01815"></a>01815   <span class="comment">//  and position is one 3D point (length 3).</span>
<a name="l01816"></a>01816   <span class="comment">// Returns true if position lies within the tetrahedron defined by the 4 points, false otherwise.</span>
<a name="l01817"></a>01817   
<a name="l01818"></a>01818   <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a> v1[4], v2[4], v3[4], v4[4], p[4];
<a name="l01819"></a>01819   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;3; i++) {
<a name="l01820"></a>01820     v1[i] = cellVertices[i]; 
<a name="l01821"></a>01821     v2[i] = cellVertices[3+i];
<a name="l01822"></a>01822     v3[i] = cellVertices[6+i];
<a name="l01823"></a>01823     v4[i] = cellVertices[9+i];
<a name="l01824"></a>01824     p[i] = position[i];
<a name="l01825"></a>01825   }
<a name="l01826"></a>01826   v1[3] = v2[3] = v3[3] = v4[3] = p[3] = 1; <span class="comment">//last entry in each &quot;4D position&quot; == 1</span>
<a name="l01827"></a>01827 
<a name="l01828"></a>01828   <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a> *mx[4], *refMx[4];
<a name="l01829"></a>01829   <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a> refDet, det;
<a name="l01830"></a>01830 
<a name="l01831"></a>01831   refMx[0] = mx[0] = v1; refMx[1] = mx[1] = v2; 
<a name="l01832"></a>01832   refMx[2] = mx[2] = v3; refMx[3] = mx[3] = v4;
<a name="l01833"></a>01833   refDet = <a class="code" href="classQCAD_1_1PoissonSource.html#ab9e5d1045b4d7b4b9e2f56d68d522ced" title="evaluate determinant of a matrix (used by pointIsInTetrahedra)">determinant</a>(refMx, 4);
<a name="l01834"></a>01834 
<a name="l01835"></a>01835   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i &lt; 4; i++) {
<a name="l01836"></a>01836     mx[i] = p; det = <a class="code" href="classQCAD_1_1PoissonSource.html#ab9e5d1045b4d7b4b9e2f56d68d522ced" title="evaluate determinant of a matrix (used by pointIsInTetrahedra)">determinant</a>(mx, 4); mx[i] = refMx[i];
<a name="l01837"></a>01837     <span class="keywordflow">if</span>( (det &lt; 0 &amp;&amp; refDet &gt; 0) || (det &gt; 0 &amp;&amp; refDet &lt; 0) )
<a name="l01838"></a>01838       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01839"></a>01839   }
<a name="l01840"></a>01840   
<a name="l01841"></a>01841   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01842"></a>01842 }
<a name="l01843"></a>01843 
<a name="l01844"></a>01844 
<a name="l01845"></a>01845 <span class="comment">// **********************************************************************</span>
<a name="l01846"></a>01846 
<a name="l01847"></a>01847 
<a name="l01848"></a>01848 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l01849"></a>01849 <span class="keywordtype">bool</span> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::</a>
<a name="l01850"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a9c7d9f78245367404e92d0d08b505710">01850</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">pointIsInHexahedron</a>(<span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>* cellVertices, <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>* position, <span class="keywordtype">int</span> <a class="code" href="Interface_8cpp.html#ac84f0e2f09cede787f23db9d9be27cd1">nVertices</a>)
<a name="l01851"></a>01851 {
<a name="l01852"></a>01852   <span class="comment">// Assumes cellVertices contains 8 3D points (length 24) in the order specified by shards::Hexahedron </span>
<a name="l01853"></a>01853   <span class="comment">//  and position is one 3D point (length 3).</span>
<a name="l01854"></a>01854   <span class="comment">// Returns true if position lies within the hexahedron defined by the 8 points, false otherwise.</span>
<a name="l01855"></a>01855   
<a name="l01856"></a>01856   <span class="comment">/* From shards::Hexadedron (vertex ordering)</span>
<a name="l01857"></a>01857 <span class="comment">         7                    6</span>
<a name="l01858"></a>01858 <span class="comment">           o------------------o</span>
<a name="l01859"></a>01859 <span class="comment">          /|                 /|</span>
<a name="l01860"></a>01860 <span class="comment">         / |                / |</span>
<a name="l01861"></a>01861 <span class="comment">        /  |               /  |</span>
<a name="l01862"></a>01862 <span class="comment">       /   |              /   |</span>
<a name="l01863"></a>01863 <span class="comment">      /    |             /    |</span>
<a name="l01864"></a>01864 <span class="comment">     /     |            /     |</span>
<a name="l01865"></a>01865 <span class="comment">  4 /      |         5 /      |</span>
<a name="l01866"></a>01866 <span class="comment">   o------------------o       |</span>
<a name="l01867"></a>01867 <span class="comment">   |       |          |       |</span>
<a name="l01868"></a>01868 <span class="comment">   |     3 o----------|-------o 2</span>
<a name="l01869"></a>01869 <span class="comment">   |      /           |      /</span>
<a name="l01870"></a>01870 <span class="comment">   |     /            |     /</span>
<a name="l01871"></a>01871 <span class="comment">   |    /             |    /</span>
<a name="l01872"></a>01872 <span class="comment">   |   /              |   /</span>
<a name="l01873"></a>01873 <span class="comment">   |  /               |  /</span>
<a name="l01874"></a>01874 <span class="comment">   | /                | /</span>
<a name="l01875"></a>01875 <span class="comment">   |/                 |/</span>
<a name="l01876"></a>01876 <span class="comment">   o------------------o</span>
<a name="l01877"></a>01877 <span class="comment">  0                    1</span>
<a name="l01878"></a>01878 <span class="comment"></span>
<a name="l01879"></a>01879 <span class="comment">  */</span>
<a name="l01880"></a>01880   
<a name="l01881"></a>01881   <span class="comment">// Perform the following tests:</span>
<a name="l01882"></a>01882   <span class="comment">// 1) is P on same side of 0123 as 4?</span>
<a name="l01883"></a>01883   <span class="comment">// 2) is P on same side of 4567 as 0?</span>
<a name="l01884"></a>01884   <span class="comment">// 3) is P on same side of 0154 as 2?</span>
<a name="l01885"></a>01885   <span class="comment">// 4) is P on same side of 2376 as 0?</span>
<a name="l01886"></a>01886   <span class="comment">// 5) is P on same side of 0374 as 2?</span>
<a name="l01887"></a>01887   <span class="comment">// 6) is P on same side of 1265 as 0?</span>
<a name="l01888"></a>01888   <span class="comment">// Note: we assume faces are planar and so only need 3 of 4 vertices to determine plane.</span>
<a name="l01889"></a>01889 
<a name="l01890"></a>01890   <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a> *v0 = cellVertices;
<a name="l01891"></a>01891   <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a> *v1 = cellVertices + 3;
<a name="l01892"></a>01892   <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a> *v2 = cellVertices + 6;
<a name="l01893"></a>01893   <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a> *v3 = cellVertices + 9;
<a name="l01894"></a>01894   <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a> *v4 = cellVertices + 12;
<a name="l01895"></a>01895   <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a> *v5 = cellVertices + 15;
<a name="l01896"></a>01896   <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a> *v6 = cellVertices + 18;
<a name="l01897"></a>01897   <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a> *v7 = cellVertices + 21;
<a name="l01898"></a>01898 
<a name="l01899"></a>01899   <span class="keywordflow">if</span>(!<a class="code" href="classQCAD_1_1PoissonSource.html#afea6dfa83362b4e3f69fe5a5a5052d8a" title="determine whether two points (A and B) lie on the same side of a plane (defined by 3 pts) -- 3D only...">sameSideOfPlane</a>( v0, v1, v2, v4, position)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01900"></a>01900   <span class="keywordflow">if</span>(!<a class="code" href="classQCAD_1_1PoissonSource.html#afea6dfa83362b4e3f69fe5a5a5052d8a" title="determine whether two points (A and B) lie on the same side of a plane (defined by 3 pts) -- 3D only...">sameSideOfPlane</a>( v4, v5, v6, v0, position)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01901"></a>01901   <span class="keywordflow">if</span>(!<a class="code" href="classQCAD_1_1PoissonSource.html#afea6dfa83362b4e3f69fe5a5a5052d8a" title="determine whether two points (A and B) lie on the same side of a plane (defined by 3 pts) -- 3D only...">sameSideOfPlane</a>( v0, v1, v5, v2, position)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01902"></a>01902   <span class="keywordflow">if</span>(!<a class="code" href="classQCAD_1_1PoissonSource.html#afea6dfa83362b4e3f69fe5a5a5052d8a" title="determine whether two points (A and B) lie on the same side of a plane (defined by 3 pts) -- 3D only...">sameSideOfPlane</a>( v2, v3, v7, v0, position)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01903"></a>01903   <span class="keywordflow">if</span>(!<a class="code" href="classQCAD_1_1PoissonSource.html#afea6dfa83362b4e3f69fe5a5a5052d8a" title="determine whether two points (A and B) lie on the same side of a plane (defined by 3 pts) -- 3D only...">sameSideOfPlane</a>( v0, v3, v7, v2, position)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01904"></a>01904   <span class="keywordflow">if</span>(!<a class="code" href="classQCAD_1_1PoissonSource.html#afea6dfa83362b4e3f69fe5a5a5052d8a" title="determine whether two points (A and B) lie on the same side of a plane (defined by 3 pts) -- 3D only...">sameSideOfPlane</a>( v1, v2, v6, v0, position)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01905"></a>01905 
<a name="l01906"></a>01906   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01907"></a>01907 }
<a name="l01908"></a>01908 
<a name="l01909"></a>01909 
<a name="l01910"></a>01910 <span class="comment">// **********************************************************************</span>
<a name="l01911"></a>01911 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l01912"></a>01912 <span class="keywordtype">bool</span> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::</a>
<a name="l01913"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a5363def7c52d58bc6cf6c118d0ea3a92">01913</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">pointIsInPolygon</a>(<span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>* cellVertices, <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>* position, <span class="keywordtype">int</span> <a class="code" href="Interface_8cpp.html#ac84f0e2f09cede787f23db9d9be27cd1">nVertices</a>)
<a name="l01914"></a>01914 {
<a name="l01915"></a>01915   <span class="comment">// Assumes cellVertices contains nVertices 2D points in some order travelling around the polygon,</span>
<a name="l01916"></a>01916   <span class="comment">//  and position is one 2D point (length 2).</span>
<a name="l01917"></a>01917   <span class="comment">// Returns true if position lies within the polygon, false otherwise.</span>
<a name="l01918"></a>01918   <span class="comment">//  Algorithm = ray trace along positive x-axis</span>
<a name="l01919"></a>01919 
<a name="l01920"></a>01920   <span class="keywordtype">bool</span> c = <span class="keyword">false</span>;
<a name="l01921"></a>01921   <span class="keywordtype">int</span> <a class="code" href="MOR__ExtendedEpetraLapack_8cpp.html#af5da5165aa5eeff113accece5748c995">n</a> = nVertices;
<a name="l01922"></a>01922   <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a> x=position[0], y=position[1];
<a name="l01923"></a>01923   <span class="keyword">const</span> <span class="keywordtype">int</span> X=0,Y=1;
<a name="l01924"></a>01924 
<a name="l01925"></a>01925   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0, j = n-1; i &lt; n; j = i++) {
<a name="l01926"></a>01926     <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>* <a class="code" href="classQCAD_1_1PoissonSource.html#a35d68aa6b59eabed3579ab39f2473861">pi</a> = &amp;cellVertices[2*i]; <span class="comment">// 2 == dimension</span>
<a name="l01927"></a>01927     <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>* pj = &amp;cellVertices[2*j]; <span class="comment">// 2 == dimension</span>
<a name="l01928"></a>01928     <span class="keywordflow">if</span> ((((pi[Y] &lt;= y) &amp;&amp; (y &lt; pj[Y])) ||
<a name="l01929"></a>01929    ((pj[Y] &lt;= y) &amp;&amp; (y &lt; pi[Y]))) &amp;&amp;
<a name="l01930"></a>01930   (x &lt; (pj[X] - pi[X]) * (y - pi[Y]) / (pj[Y] - pi[Y]) + pi[X]))
<a name="l01931"></a>01931       c = !c;
<a name="l01932"></a>01932   }
<a name="l01933"></a>01933   <span class="keywordflow">return</span> c;
<a name="l01934"></a>01934 }
<a name="l01935"></a>01935 
<a name="l01936"></a>01936 
<a name="l01937"></a>01937 <span class="comment">// **********************************************************************</span>
<a name="l01938"></a>01938 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l01939"></a>01939 <span class="keyword">typename</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">QCAD::PoissonSource&lt;EvalT,Traits&gt;::MeshScalarT</a>
<a name="l01940"></a>01940 <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::</a>
<a name="l01941"></a><a class="code" href="classQCAD_1_1PoissonSource.html#ab9e5d1045b4d7b4b9e2f56d68d522ced">01941</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">determinant</a>(<span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>** mx, <span class="keywordtype">int</span> N)
<a name="l01942"></a>01942 {
<a name="l01943"></a>01943   <span class="comment">// Returns the determinant of an NxN matrix mx</span>
<a name="l01944"></a>01944   <span class="comment">// mx is an array of arrays: mx[i][j] gives matrix entry in row i, column j</span>
<a name="l01945"></a>01945   <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a> det = 0, term;
<a name="l01946"></a>01946 
<a name="l01947"></a>01947   <span class="comment">//Loop over all permutations and keep track of sign (Dijkstra&#39;s algorithm)</span>
<a name="l01948"></a>01948   <span class="keywordtype">int</span> t, <a class="code" href="QCAD__GreensFunctionTunneling_8cpp.html#a858396a5abdb7865e71cf803fdcb37ae">sign</a> = 0;
<a name="l01949"></a>01949   <span class="keywordtype">int</span>* inds = <span class="keyword">new</span> <span class="keywordtype">int</span>[N];
<a name="l01950"></a>01950   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;N; i++) inds[i] = i;
<a name="l01951"></a>01951 
<a name="l01952"></a>01952   <span class="keywordflow">while</span>(<span class="keyword">true</span>) {
<a name="l01953"></a>01953     <span class="comment">//inds holds indices of permutation and sign % 2 is sign</span>
<a name="l01954"></a>01954     term = 1;
<a name="l01955"></a>01955     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;N; i++)
<a name="l01956"></a>01956       term = term * mx[i][inds[i]];
<a name="l01957"></a>01957     det += ((sign % 2) ? -1 : 1) * term;
<a name="l01958"></a>01958 
<a name="l01959"></a>01959     <span class="keywordtype">int</span> i = N - 1;
<a name="l01960"></a>01960     <span class="keywordflow">while</span> (i &gt; 0 &amp;&amp; inds[i-1] &gt;= inds[i]) 
<a name="l01961"></a>01961       i = i-1;
<a name="l01962"></a>01962 
<a name="l01963"></a>01963     <span class="keywordflow">if</span>(i == 0) <span class="keywordflow">break</span>; <span class="comment">//we&#39;re done</span>
<a name="l01964"></a>01964 
<a name="l01965"></a>01965     <span class="keywordtype">int</span> j = N;
<a name="l01966"></a>01966     <span class="keywordflow">while</span> (inds[j-1] &lt;= inds[i-1]) 
<a name="l01967"></a>01967       j = j-1;
<a name="l01968"></a>01968   
<a name="l01969"></a>01969     t = inds[i-1]; inds[i-1] = inds[j-1]; inds[j-1] = t;  <span class="comment">// swap values at positions (i-1) and (j-1)</span>
<a name="l01970"></a>01970     sign++;
<a name="l01971"></a>01971 
<a name="l01972"></a>01972     i++; j = N;
<a name="l01973"></a>01973     <span class="keywordflow">while</span> (i &lt; j) {
<a name="l01974"></a>01974       t = inds[i-1]; inds[i-1] = inds[j-1]; inds[j-1] = t;  <span class="comment">// swap values at positions (i-1) and (j-1)</span>
<a name="l01975"></a>01975       sign++;
<a name="l01976"></a>01976       i++;
<a name="l01977"></a>01977       j--;
<a name="l01978"></a>01978     }
<a name="l01979"></a>01979   }
<a name="l01980"></a>01980 
<a name="l01981"></a>01981   <span class="keyword">delete</span> [] inds;
<a name="l01982"></a>01982   <span class="keywordflow">return</span> det;
<a name="l01983"></a>01983 }
<a name="l01984"></a>01984 
<a name="l01985"></a>01985 
<a name="l01986"></a>01986 <span class="comment">// **********************************************************************</span>
<a name="l01987"></a>01987 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l01988"></a>01988 <span class="keywordtype">bool</span> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::</a>
<a name="l01989"></a><a class="code" href="classQCAD_1_1PoissonSource.html#afea6dfa83362b4e3f69fe5a5a5052d8a">01989</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">  sameSideOfPlane</a>(<span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>* plane0, <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>* plane1, <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>* plane2, 
<a name="l01990"></a>01990       <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>* ptA, <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a>* ptB)
<a name="l01991"></a>01991 {
<a name="l01992"></a>01992   <span class="comment">// 3D only : assumes all arguments are length 3 arrays</span>
<a name="l01993"></a>01993   <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a> detA, detB;
<a name="l01994"></a>01994 
<a name="l01995"></a>01995   <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a> *mx[3];  <span class="comment">// row mx[0] defines the point in question, rows mx[1] and mx[2] define plane</span>
<a name="l01996"></a>01996   <a class="code" href="classQCAD_1_1PoissonSource.html#af449c51c18ce82e941fe4709cedeed3b">MeshScalarT</a> row0[3], row1[3], row2[3]; mx[0] = row0; mx[1] = row1; mx[2] = row2;
<a name="l01997"></a>01997 
<a name="l01998"></a>01998   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;3; i++) {
<a name="l01999"></a>01999     row0[i] = ptA[i] - plane0[i]; <span class="comment">// use plane0 as reference position (subtract off of others)</span>
<a name="l02000"></a>02000     row1[i] = plane1[i] - plane0[i];
<a name="l02001"></a>02001     row2[i] = plane2[i] - plane0[i];
<a name="l02002"></a>02002   }
<a name="l02003"></a>02003   detA = <a class="code" href="classQCAD_1_1PoissonSource.html#ab9e5d1045b4d7b4b9e2f56d68d522ced" title="evaluate determinant of a matrix (used by pointIsInTetrahedra)">determinant</a>(mx, 3);
<a name="l02004"></a>02004 
<a name="l02005"></a>02005   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;3; i++)
<a name="l02006"></a>02006     row0[i] = ptB[i] - plane0[i]; <span class="comment">// replace row 0 with ptB-plane0</span>
<a name="l02007"></a>02007 
<a name="l02008"></a>02008   detB = <a class="code" href="classQCAD_1_1PoissonSource.html#ab9e5d1045b4d7b4b9e2f56d68d522ced" title="evaluate determinant of a matrix (used by pointIsInTetrahedra)">determinant</a>(mx, 3);
<a name="l02009"></a>02009 
<a name="l02010"></a>02010   <span class="keywordflow">if</span>( (detA &lt; 0 &amp;&amp; detB &gt; 0) || (detA &gt; 0 &amp;&amp; detB &lt; 0) )
<a name="l02011"></a>02011     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02012"></a>02012   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02013"></a>02013 }
<a name="l02014"></a>02014 
<a name="l02015"></a>02015 
<a name="l02016"></a>02016 
<a name="l02017"></a>02017 
<a name="l02019"></a>02019 
<a name="l02020"></a>02020 
<a name="l02021"></a>02021 <span class="comment">// **********************************************************************</span>
<a name="l02022"></a>02022 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT,<span class="keyword">typename</span> Traits&gt;
<a name="l02023"></a>02023 <span class="keyword">inline</span> <span class="keyword">typename</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">QCAD::PoissonSource&lt;EvalT,Traits&gt;::ScalarT</a>
<a name="l02024"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a38604654add49c5ed7c3206d758c74c6">02024</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::computeFDIntMinusOneHalf</a>(<span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> x)
<a name="l02025"></a>02025 {
<a name="l02026"></a>02026    <span class="comment">// Use the approximate -1/2 FD integral by P. Van Halen and D. L. Pulfrey, </span>
<a name="l02027"></a>02027    <span class="comment">// &quot;Accurate, short series approximations to Fermi-Dirac integrals of order </span>
<a name="l02028"></a>02028    <span class="comment">// -/2, 1/2, 1, 3/2, 2, 5/2, 3, and 7/2&quot; J. Appl. Phys. 57, 5271 (1985) </span>
<a name="l02029"></a>02029    <span class="comment">// and its Erratum in J. Appl. Phys. 59, 2264 (1986). The approximation</span>
<a name="l02030"></a>02030    <span class="comment">// has error &lt; 1e-5 in the entire x range.  </span>
<a name="l02031"></a>02031    
<a name="l02032"></a>02032    <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> fdInt; 
<a name="l02033"></a>02033    <span class="keywordtype">double</span> a1, a2, a3, a4, a5, a6, a7; 
<a name="l02034"></a>02034    <span class="keywordflow">if</span> (x &lt;= 0.)  <span class="comment">// eqn.(4) in the reference</span>
<a name="l02035"></a>02035    {
<a name="l02036"></a>02036      a1 = 0.999909;  <span class="comment">// Table I in Erratum</span>
<a name="l02037"></a>02037      a2 = 0.706781;
<a name="l02038"></a>02038      a3 = 0.572752;
<a name="l02039"></a>02039      a4 = 0.466318;
<a name="l02040"></a>02040      a5 = 0.324511;
<a name="l02041"></a>02041      a6 = 0.152889;
<a name="l02042"></a>02042      a7 = 0.033673;
<a name="l02043"></a>02043      fdInt = a1*exp(x)-a2*exp(2.*x)+a3*exp(3.*x)-a4*exp(4.*x)+a5*exp(5.*x)-a6*exp(6.*x)+a7*exp(7.*x);
<a name="l02044"></a>02044    }
<a name="l02045"></a>02045    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x &gt;= 5.)  <span class="comment">// eqn.(6) in Erratum</span>
<a name="l02046"></a>02046    {
<a name="l02047"></a>02047      a1 = 1.12837;  <span class="comment">// Table II in Erratum</span>
<a name="l02048"></a>02048      a2 = -0.470698;
<a name="l02049"></a>02049      a3 = -0.453108;
<a name="l02050"></a>02050      a4 = -228.975;
<a name="l02051"></a>02051      a5 = 8303.50;
<a name="l02052"></a>02052      a6 = -118124;
<a name="l02053"></a>02053      a7 = 632895;
<a name="l02054"></a>02054      fdInt = sqrt(x)*(a1+ a2/pow(x,2.)+ a3/pow(x,4.)+ a4/pow(x,6.)+ a5/pow(x,8.)+ a6/pow(x,10.)+ a7/pow(x,12.));
<a name="l02055"></a>02055    }
<a name="l02056"></a>02056    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((x &gt; 0.) &amp;&amp; (x &lt;= 2.5))  <span class="comment">// eqn.(7) in Erratum</span>
<a name="l02057"></a>02057    {
<a name="l02058"></a>02058      <span class="keywordtype">double</span> a8, a9;
<a name="l02059"></a>02059      a1 = 0.604856;  <span class="comment">// Table III in Erratum</span>
<a name="l02060"></a>02060      a2 = 0.380080;
<a name="l02061"></a>02061      a3 = 0.059320;
<a name="l02062"></a>02062      a4 = -0.014526;
<a name="l02063"></a>02063      a5 = -0.004222;
<a name="l02064"></a>02064      a6 = 0.001335;
<a name="l02065"></a>02065      a7 = 0.000291;
<a name="l02066"></a>02066      a8 = -0.000159;
<a name="l02067"></a>02067      a9 = 0.000018;
<a name="l02068"></a>02068      fdInt = a1+ a2*x+ a3*pow(x,2.)+ a4*pow(x,3.)+ a5*pow(x,4.)+ a6*pow(x,5.)+ a7*pow(x,6.)+ a8*pow(x,7.)+ a9*pow(x,8.);
<a name="l02069"></a>02069    }
<a name="l02070"></a>02070    <span class="keywordflow">else</span>  <span class="comment">// 2.5&lt;x&lt;5, eqn.(7) in Erratum</span>
<a name="l02071"></a>02071    {
<a name="l02072"></a>02072      <span class="keywordtype">double</span> a8;
<a name="l02073"></a>02073      a1 = 0.638086;  <span class="comment">// Table III in Erratum</span>
<a name="l02074"></a>02074      a2 = 0.292266;
<a name="l02075"></a>02075      a3 = 0.159486;
<a name="l02076"></a>02076      a4 = -0.077691;
<a name="l02077"></a>02077      a5 = 0.018650;
<a name="l02078"></a>02078      a6 = -0.002736;
<a name="l02079"></a>02079      a7 = 0.000249;
<a name="l02080"></a>02080      a8 = -0.000013;
<a name="l02081"></a>02081      fdInt = a1+ a2*x+ a3*pow(x,2.)+ a4*pow(x,3.)+ a5*pow(x,4.)+ a6*pow(x,5.)+ a7*pow(x,6.)+ a8*pow(x,7.);
<a name="l02082"></a>02082    }
<a name="l02083"></a>02083    
<a name="l02084"></a>02084    <span class="keywordflow">return</span> fdInt;
<a name="l02085"></a>02085 }
<a name="l02086"></a>02086 
<a name="l02087"></a>02087 
<a name="l02088"></a>02088 <span class="comment">// *****************************************************************************</span>
<a name="l02089"></a>02089 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l02090"></a>02090 <span class="keyword">typename</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">QCAD::PoissonSource&lt;EvalT,Traits&gt;::ScalarT</a>
<a name="l02091"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a87523eaee864c9fc18b16892882c5038">02091</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT,Traits&gt;::computeVxcLDA</a> (<span class="keyword">const</span> <span class="keywordtype">double</span> &amp; relPerm, 
<a name="l02092"></a>02092       <span class="keyword">const</span> <span class="keywordtype">double</span> &amp; effMass, <span class="keyword">const</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a>&amp; eDensity)
<a name="l02093"></a>02093 {
<a name="l02094"></a>02094   <span class="comment">// Compute the exchange-correlation potential energy within the Local Density</span>
<a name="l02095"></a>02095   <span class="comment">// Approximation. Use the parameterized expression from: </span>
<a name="l02096"></a>02096   <span class="comment">// [1] L. Hedin and B. I. Lundqvist, J. Phys. C 4, 2064 (1971);</span>
<a name="l02097"></a>02097   <span class="comment">// [2] F. Stern and S. Das Sarma, Phys. Rev. B 30, 840 (1984);</span>
<a name="l02098"></a>02098   <span class="comment">// [3] Dragical Vasileska, &quot;Solving the Effective Mass Schrodinger Equation </span>
<a name="l02099"></a>02099   <span class="comment">// in State-of-the-Art Devices&quot;, http://nanohub.org. </span>
<a name="l02100"></a>02100   <span class="comment">// Potential in returned in units of eV.</span>
<a name="l02101"></a>02101   
<a name="l02102"></a>02102   <span class="comment">// first 100.0 converts eps0 from [C/(V.cm)] to [C/(V.m)],</span>
<a name="l02103"></a>02103   <span class="comment">// second 100.0 converts b from [m] to [cm]. </span>
<a name="l02104"></a>02104   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> b = (<a class="code" href="classQCAD_1_1PoissonSource.html#a66367459749e48e11a50a4fa6457666f">eps0</a>*100.0)*<a class="code" href="classQCAD_1_1PoissonSource.html#ab12eefe71615a8407a289022fc043464">hbar</a>*<a class="code" href="classQCAD_1_1PoissonSource.html#ab12eefe71615a8407a289022fc043464">hbar</a> / (<a class="code" href="classQCAD_1_1PoissonSource.html#a7385d003a75e31eeaaf8637a9bee1731">m0</a>*<a class="code" href="classQCAD_1_1PoissonSource.html#a69b53a45d322590c547e3b3873180966">eleQ</a>*<a class="code" href="classQCAD_1_1PoissonSource.html#a69b53a45d322590c547e3b3873180966">eleQ</a>) * 100.0;  <span class="comment">// [cm]</span>
<a name="l02105"></a>02105   b = b * (4.0*<a class="code" href="classQCAD_1_1PoissonSource.html#a35d68aa6b59eabed3579ab39f2473861">pi</a>*relPerm/effMass); 
<a name="l02106"></a>02106   
<a name="l02107"></a>02107   <span class="keywordtype">double</span> <a class="code" href="QCAD__CoupledPSJacobian_8cpp.html#a35c5c91ca07d27b583d09b282131f5fc">eVPerJ</a> = 1.0/<a class="code" href="classQCAD_1_1PoissonSource.html#a69b53a45d322590c547e3b3873180966">eleQ</a>; 
<a name="l02108"></a>02108   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> Ry = <a class="code" href="classQCAD_1_1PoissonSource.html#a69b53a45d322590c547e3b3873180966">eleQ</a>*<a class="code" href="classQCAD_1_1PoissonSource.html#a69b53a45d322590c547e3b3873180966">eleQ</a> / (<a class="code" href="classQCAD_1_1PoissonSource.html#a66367459749e48e11a50a4fa6457666f">eps0</a>*b) * eVPerJ / (8.*<a class="code" href="classQCAD_1_1PoissonSource.html#a35d68aa6b59eabed3579ab39f2473861">pi</a>*relPerm);  <span class="comment">// [eV]</span>
<a name="l02109"></a>02109   
<a name="l02110"></a>02110   <span class="keywordtype">double</span> <a class="code" href="namespaceFELIX.html#a4d08741b97fea3938089670d2a84c598">alpha</a> = pow(4.0/9.0/<a class="code" href="classQCAD_1_1PoissonSource.html#a35d68aa6b59eabed3579ab39f2473861">pi</a>, 1./3.);
<a name="l02111"></a>02111   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> Vxc; 
<a name="l02112"></a>02112   
<a name="l02113"></a>02113   <span class="keywordflow">if</span> (eDensity &lt;= 1.0) 
<a name="l02114"></a>02114     Vxc = 0.0; 
<a name="l02115"></a>02115   <span class="keywordflow">else</span>
<a name="l02116"></a>02116   {
<a name="l02117"></a>02117     <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> rs = pow(4.0*<a class="code" href="classQCAD_1_1PoissonSource.html#a35d68aa6b59eabed3579ab39f2473861">pi</a>*eDensity*pow(b,3.0)/3.0, -1./3.);  <span class="comment">// [unitless]</span>
<a name="l02118"></a>02118     <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> x = rs / 21.0; 
<a name="l02119"></a>02119     Vxc = -2.0/(<a class="code" href="classQCAD_1_1PoissonSource.html#a35d68aa6b59eabed3579ab39f2473861">pi</a>*alpha*rs) * Ry * (1.0+ 0.7734*x*log(1.+1.0/x)); <span class="comment">// [eV]</span>
<a name="l02120"></a>02120   }
<a name="l02121"></a>02121   
<a name="l02122"></a>02122   <span class="keywordflow">return</span> Vxc; 
<a name="l02123"></a>02123 }
<a name="l02124"></a>02124 
<a name="l02125"></a>02125 <span class="comment">// **********************************************************************</span>
<a name="l02126"></a>02126 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l02127"></a>02127 <span class="keyword">typename</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">QCAD::PoissonSource&lt;EvalT,Traits&gt;::ScalarT</a> 
<a name="l02128"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a5ded27c5d9694853aeadf18d87f54594">02128</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT, Traits&gt;::getCellScaleFactor</a>(std::size_t cell, <span class="keyword">const</span> std::vector&lt;bool&gt;&amp; bEBInRegion, <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> init_factor)
<a name="l02129"></a>02129 {
<a name="l02130"></a>02130   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> ret = init_factor;
<a name="l02131"></a>02131   std::size_t nRegions = <a class="code" href="classQCAD_1_1PoissonSource.html#a0d29163645d39c6b0a6f38574a32160f" title="Mesh Region parameters.">meshRegionList</a>.size();
<a name="l02132"></a>02132   <span class="keywordflow">if</span>(nRegions &gt; 0) {
<a name="l02133"></a>02133     <span class="keywordflow">for</span>(std::size_t i=0; i&lt;nRegions; i++) { 
<a name="l02134"></a>02134       <span class="keywordflow">if</span>(!bEBInRegion[i] &amp;&amp; <a class="code" href="classQCAD_1_1PoissonSource.html#a0d29163645d39c6b0a6f38574a32160f" title="Mesh Region parameters.">meshRegionList</a>[i]-&gt;cellIsInRegion(cell)) {
<a name="l02135"></a>02135   ret *= <a class="code" href="classQCAD_1_1PoissonSource.html#afb63b216947d707542cb0b5ac73bacfd">meshRegionFactors</a>[i];
<a name="l02136"></a>02136       }
<a name="l02137"></a>02137     }
<a name="l02138"></a>02138   }
<a name="l02139"></a>02139   <span class="keywordflow">return</span> ret;
<a name="l02140"></a>02140 }
<a name="l02141"></a>02141 
<a name="l02142"></a>02142 
<a name="l02143"></a>02143 <span class="comment">// **********************************************************************</span>
<a name="l02144"></a>02144 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> EvalT, <span class="keyword">typename</span> Traits&gt;
<a name="l02145"></a>02145 <span class="keyword">typename</span> <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">QCAD::PoissonSource&lt;EvalT,Traits&gt;::ScalarT</a> 
<a name="l02146"></a><a class="code" href="classQCAD_1_1PoissonSource.html#a4b4c967562f329d8e2456506e01b6ccf">02146</a> <a class="code" href="classQCAD_1_1PoissonSource.html" title="Evaluates Poisson Source Term.">QCAD::PoissonSource&lt;EvalT, Traits&gt;::getReferencePotential</a>(<span class="keyword">typename</span> Traits::EvalData workset)
<a name="l02147"></a>02147 {
<a name="l02149"></a>02149   <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> qPhiRef;
<a name="l02150"></a>02150 
<a name="l02151"></a>02151   std::string refMtrlName, category;
<a name="l02152"></a>02152   refMtrlName = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getParam&lt;std::string&gt;(<span class="stringliteral">&quot;Reference Material&quot;</span>);
<a name="l02153"></a>02153   category = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;std::string&gt;(refMtrlName,<span class="stringliteral">&quot;Category&quot;</span>);
<a name="l02154"></a>02154   <span class="keywordflow">if</span> (category == <span class="stringliteral">&quot;Semiconductor&quot;</span>) {
<a name="l02155"></a>02155  
<a name="l02156"></a>02156     <span class="comment">// Get quantities in desired energy (voltage) units, which we denote &quot;[myV]&quot;</span>
<a name="l02157"></a>02157  
<a name="l02158"></a>02158     <span class="comment">// Same qPhiRef needs to be used for the entire structure</span>
<a name="l02159"></a>02159     <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> temperature = <a class="code" href="classQCAD_1_1PoissonSource.html#acbec0daaf0a9c9de29056d17c577bcdc">temperatureField</a>(0); <span class="comment">//get shared temperature parameter from field</span>
<a name="l02160"></a>02160     <span class="keywordtype">double</span> mdn = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Electron DOS Effective Mass&quot;</span>);
<a name="l02161"></a>02161     <span class="keywordtype">double</span> mdp = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Hole DOS Effective Mass&quot;</span>);
<a name="l02162"></a>02162     <span class="keywordtype">double</span> Chi = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Electron Affinity&quot;</span>) / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// in [myV]</span>
<a name="l02163"></a>02163     <span class="keywordtype">double</span> Eg0 = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Zero Temperature Band Gap&quot;</span>) / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// in [myV]</span>
<a name="l02164"></a>02164     <span class="keywordtype">double</span> <a class="code" href="namespaceFELIX.html#a4d08741b97fea3938089670d2a84c598">alpha</a> = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Band Gap Alpha Coefficient&quot;</span>); <span class="comment">// in [eV/K]</span>
<a name="l02165"></a>02165     <span class="keywordtype">double</span> beta = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Band Gap Beta Coefficient&quot;</span>);  <span class="comment">// in [K]</span>
<a name="l02166"></a>02166     <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> Eg = Eg0-(alpha*pow(temperature,2.0)/(beta+temperature)) / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// in [myV]</span>
<a name="l02167"></a>02167   
<a name="l02168"></a>02168     <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> kbT = <a class="code" href="classQCAD_1_1PoissonSource.html#ad8f4dcca5195de778795ec98a8afd9b2" title="Public Universal Constants.">kbBoltz</a>*temperature / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// in [myV] (desired voltage unit)</span>
<a name="l02169"></a>02169     <a class="code" href="classQCAD_1_1PoissonSource.html#a0be3b81ae6c939148f48b66f0e667c05">ScalarT</a> Eic = -Eg/2. + 3./4.*kbT*log(mdp/mdn);  <span class="comment">// (Ei-Ec) in [myV]</span>
<a name="l02170"></a>02170     qPhiRef = Chi - Eic;  <span class="comment">// (Evac-Ei) in [myV] where Evac = vacuum level</span>
<a name="l02171"></a>02171   }
<a name="l02172"></a>02172   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (category == <span class="stringliteral">&quot;Insulator&quot;</span>) {
<a name="l02173"></a>02173     <span class="keywordtype">double</span> Chi = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Electron Affinity&quot;</span>);
<a name="l02174"></a>02174     qPhiRef = Chi / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// in [myV]</span>
<a name="l02175"></a>02175   }
<a name="l02176"></a>02176   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (category == <span class="stringliteral">&quot;Metal&quot;</span>) {
<a name="l02177"></a>02177     <span class="keywordtype">double</span> workFn = <a class="code" href="classQCAD_1_1PoissonSource.html#a8c7fe6cd976e1bd5b5cd03cd713711cc" title="Material database.">materialDB</a>-&gt;getMaterialParam&lt;<span class="keywordtype">double</span>&gt;(refMtrlName,<span class="stringliteral">&quot;Work Function&quot;</span>); 
<a name="l02178"></a>02178     qPhiRef = workFn / <a class="code" href="classQCAD_1_1PoissonSource.html#a1a43c120a5b69fcbb0cc09bf32f8a12e">energy_unit_in_eV</a>; <span class="comment">// in [myV]</span>
<a name="l02179"></a>02179   }
<a name="l02180"></a>02180   <span class="keywordflow">else</span> {
<a name="l02181"></a>02181     TEUCHOS_TEST_FOR_EXCEPTION (<span class="keyword">true</span>, Teuchos::Exceptions::InvalidParameter, std::endl 
<a name="l02182"></a>02182         &lt;&lt; <span class="stringliteral">&quot;Error!  Invalid category &quot;</span> &lt;&lt; category 
<a name="l02183"></a>02183         &lt;&lt; <span class="stringliteral">&quot; for reference material !&quot;</span> &lt;&lt; std::endl);
<a name="l02184"></a>02184   }
<a name="l02185"></a>02185 
<a name="l02186"></a>02186   <span class="keywordflow">return</span> qPhiRef;
<a name="l02187"></a>02187 }
<a name="l02188"></a>02188 
<a name="l02189"></a>02189 
<a name="l02190"></a>02190 <span class="comment">// **********************************************************************</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Mar 26 2014 18:36:44 for Albany: a Trilinos-based PDE code by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
