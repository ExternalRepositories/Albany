<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Albany: a Trilinos-based PDE code: AlbPUMI_FMDBDiscretization_Def.hpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>AlbPUMI_FMDBDiscretization_Def.hpp</h1>  </div>
</div>
<div class="contents">
<a href="AlbPUMI__FMDBDiscretization__Def_8hpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//*****************************************************************//</span>
<a name="l00002"></a>00002 <span class="comment">//    Albany 2.0:  Copyright 2012 Sandia Corporation               //</span>
<a name="l00003"></a>00003 <span class="comment">//    This Software is released under the BSD license detailed     //</span>
<a name="l00004"></a>00004 <span class="comment">//    in the file &quot;license.txt&quot; in the top-level Albany directory  //</span>
<a name="l00005"></a>00005 <span class="comment">//*****************************************************************//</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;limits&gt;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &quot;Epetra_Export.h&quot;</span>
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 <span class="preprocessor">#include &quot;<a class="code" href="Albany__Utils_8hpp.html">Albany_Utils.hpp</a>&quot;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &quot;<a class="code" href="AlbPUMI__FMDBDiscretization_8hpp.html">AlbPUMI_FMDBDiscretization.hpp</a>&quot;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;fstream&gt;</span>
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;Shards_BasicTopologies.hpp&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;Shards_CellTopology.hpp&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;Shards_CellTopologyData.h&quot;</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;<a class="code" href="PHAL__Dimension_8hpp.html">PHAL_Dimension.hpp</a>&gt;</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;apfMesh.h&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;apfShape.h&gt;</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00026"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a6e2d452eaae6a32de58f876bacc0a4d6">00026</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a6e2d452eaae6a32de58f876bacc0a4d6" title="Constructor.">AlbPUMI::FMDBDiscretization&lt;Output&gt;::FMDBDiscretization</a>(Teuchos::RCP&lt;AlbPUMI::FMDBMeshStruct&gt; fmdbMeshStruct_,
<a name="l00027"></a>00027             <span class="keyword">const</span> Teuchos::RCP&lt;const Epetra_Comm&gt;&amp; comm_,
<a name="l00028"></a>00028             <span class="keyword">const</span> Teuchos::RCP&lt;Piro::MLRigidBodyModes&gt;&amp; rigidBodyModes_) :
<a name="l00029"></a>00029   out(Teuchos::VerboseObjectBase::getDefaultOStream()),
<a name="l00030"></a>00030   previous_time_label(-1.0e32),
<a name="l00031"></a>00031   <a class="code" href="felix__driver_8cpp.html#ab048c6f9fcbcfaa57ce68b00263dbebe">comm</a>(comm_),
<a name="l00032"></a>00032   rigidBodyModes(rigidBodyModes_),
<a name="l00033"></a>00033   neq(fmdbMeshStruct_-&gt;neq),
<a name="l00034"></a>00034   fmdbMeshStruct(fmdbMeshStruct_),
<a name="l00035"></a>00035   <a class="code" href="felix__driver_8cpp.html#af1beb0c410a8a48552ab0fdb5e8c49ed">interleavedOrdering</a>(fmdbMeshStruct_-&gt;<a class="code" href="felix__driver_8cpp.html#af1beb0c410a8a48552ab0fdb5e8c49ed">interleavedOrdering</a>),
<a name="l00036"></a>00036   outputInterval(0),
<a name="l00037"></a>00037   meshOutput(*fmdbMeshStruct_, comm_)
<a name="l00038"></a>00038 {
<a name="l00039"></a>00039   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aa946c104ba44f8873854f3c35d8f9e4e">AlbPUMI::FMDBDiscretization&lt;Output&gt;::updateMesh</a>();
<a name="l00040"></a>00040 
<a name="l00041"></a>00041   Teuchos::Array&lt;std::string&gt; layout = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;solVectorLayout;
<a name="l00042"></a>00042   <span class="keywordtype">int</span> index;
<a name="l00043"></a>00043 
<a name="l00044"></a>00044   <span class="keywordflow">for</span> (std::size_t i=0; i &lt; layout.size(); i+=2) {
<a name="l00045"></a>00045     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aafade44467a1972f674e69d4053cbc8c">solNames</a>.push_back(layout[i]);
<a name="l00046"></a>00046     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a05c67b9d62ec1450ddaaf1098bb9989f">resNames</a>.push_back(layout[i].append(<span class="stringliteral">&quot;Res&quot;</span>));
<a name="l00047"></a>00047     <span class="keywordflow">if</span> (layout[i+1] == <span class="stringliteral">&quot;S&quot;</span>) {
<a name="l00048"></a>00048       index = 1;
<a name="l00049"></a>00049       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aa16f3ea135c51f848d7b5817df0bd7a1">solIndex</a>.push_back(index);
<a name="l00050"></a>00050     }
<a name="l00051"></a>00051     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (layout[i+1] == <span class="stringliteral">&quot;V&quot;</span>) {
<a name="l00052"></a>00052       index = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a025ea6e06d0965243acf4907a9d13002" title="Get number of spatial dimensions.">getNumDim</a>();
<a name="l00053"></a>00053       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aa16f3ea135c51f848d7b5817df0bd7a1">solIndex</a>.push_back(index);
<a name="l00054"></a>00054     }
<a name="l00055"></a>00055   }
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 }
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00060"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a737b33d93ad361667cfc24900fca73e4">00060</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::~FMDBDiscretization</a>()
<a name="l00061"></a>00061 {
<a name="l00062"></a>00062 }
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00065"></a>00065 Teuchos::RCP&lt;const Epetra_Map&gt;
<a name="l00066"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a98b04f0df78e70503be2046e2f088554">00066</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getMap</a>()<span class="keyword"> const</span>
<a name="l00067"></a>00067 <span class="keyword"></span>{
<a name="l00068"></a>00068   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad324c117e9184285851313cf597b0b61" title="Unknown Map.">map</a>;
<a name="l00069"></a>00069 }
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00072"></a>00072 Teuchos::RCP&lt;const Epetra_Map&gt;
<a name="l00073"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a969b6ce104d49d56dd81cdb52dffbbd9">00073</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getOverlapMap</a>()<span class="keyword"> const</span>
<a name="l00074"></a>00074 <span class="keyword"></span>{
<a name="l00075"></a>00075   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a519e43ce03e84dd4523bb926b430da70" title="Overlapped unknown map, and node map.">overlap_map</a>;
<a name="l00076"></a>00076 }
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00079"></a>00079 Teuchos::RCP&lt;const Epetra_CrsGraph&gt;
<a name="l00080"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a66e3a3ff55b65fabd09e1001d0710b5a">00080</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getJacobianGraph</a>()<span class="keyword"> const</span>
<a name="l00081"></a>00081 <span class="keyword"></span>{
<a name="l00082"></a>00082   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a687f7b0c2eaae12f67be20e56789699e" title="Jacobian matrix graph.">graph</a>;
<a name="l00083"></a>00083 }
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00086"></a>00086 Teuchos::RCP&lt;const Epetra_CrsGraph&gt;
<a name="l00087"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a90022d314a98240d3af553c8676fbdd4">00087</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getOverlapJacobianGraph</a>()<span class="keyword"> const</span>
<a name="l00088"></a>00088 <span class="keyword"></span>{
<a name="l00089"></a>00089   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ace5cff8437b7947e42a96e7fc40f0c63" title="Overlapped Jacobian matrix graph.">overlap_graph</a>;
<a name="l00090"></a>00090 }
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00093"></a>00093 Teuchos::RCP&lt;const Epetra_Map&gt;
<a name="l00094"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#abb9d708cf177a09bf8b90da0f8f7790e">00094</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getNodeMap</a>()<span class="keyword"> const</span>
<a name="l00095"></a>00095 <span class="keyword"></span>{
<a name="l00096"></a>00096   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ab8d6c20156402e12d1406136cd409db0" title="Node map.">node_map</a>;
<a name="l00097"></a>00097 }
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00100"></a>00100 Teuchos::RCP&lt;const Epetra_Map&gt;
<a name="l00101"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a197c9c0f0990b01d6668cb83844c0d46">00101</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getOverlapNodeMap</a>()<span class="keyword"> const</span>
<a name="l00102"></a>00102 <span class="keyword"></span>{
<a name="l00103"></a>00103   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#acad8cd7a63d6454e6dbb693a441433a5">overlap_node_map</a>;
<a name="l00104"></a>00104 }
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00107"></a>00107 <span class="keyword">const</span> <a class="code" href="structAlbany_1_1WorksetArray.html">Albany::WorksetArray&lt;Teuchos::ArrayRCP&lt;Teuchos::ArrayRCP&lt;Teuchos::ArrayRCP&lt;int&gt;</a> &gt; &gt; &gt;::type&amp;
<a name="l00108"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ac9883cdef268536e0fd2c2012cd45898">00108</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getWsElNodeEqID</a>()<span class="keyword"> const</span>
<a name="l00109"></a>00109 <span class="keyword"></span>{
<a name="l00110"></a>00110   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ab45bb22b3c3ee71ee40d7c3513282be9" title="Connectivity array [workset, element, local-node, Eq] =&amp;gt; LID.">wsElNodeEqID</a>;
<a name="l00111"></a>00111 }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00114"></a>00114 <span class="keyword">const</span> <a class="code" href="structAlbany_1_1WorksetArray.html">Albany::WorksetArray&lt;Teuchos::ArrayRCP&lt;Teuchos::ArrayRCP&lt;int&gt;</a> &gt; &gt;::type&amp;
<a name="l00115"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aaf23db797367803ea700646e44ffb525">00115</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getWsElNodeID</a>()<span class="keyword"> const</span>
<a name="l00116"></a>00116 <span class="keyword"></span>{
<a name="l00117"></a>00117   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aa50970dea5d6d5faaf83f95fe35e6343">wsElNodeID</a>;
<a name="l00118"></a>00118 }
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00121"></a>00121 <span class="keyword">const</span> <a class="code" href="structAlbany_1_1WorksetArray.html">Albany::WorksetArray&lt;Teuchos::ArrayRCP&lt;Teuchos::ArrayRCP&lt;double*&gt;</a> &gt; &gt;::type&amp;
<a name="l00122"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a21e7b84a8f2a9f61d8efccd10664a7f1">00122</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getCoords</a>()<span class="keyword"> const</span>
<a name="l00123"></a>00123 <span class="keyword"></span>{
<a name="l00124"></a>00124   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a458ba67499378c33ab3172419609892b">coords</a>;
<a name="l00125"></a>00125 }
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00128"></a>00128 <span class="keywordtype">void</span>
<a name="l00129"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a51044b622462125a882e7a9f22f086e2">00129</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::printCoords</a>()<span class="keyword"> const</span>
<a name="l00130"></a>00130 <span class="keyword"></span>{
<a name="l00131"></a>00131   <span class="keywordtype">int</span> mesh_dim;
<a name="l00132"></a>00132   FMDB_Mesh_GetDim(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;getMesh(), &amp;mesh_dim);
<a name="l00133"></a>00133 
<a name="l00134"></a>00134 std::cout &lt;&lt; <span class="stringliteral">&quot;Processor &quot;</span> &lt;&lt; SCUTIL_CommRank() &lt;&lt; <span class="stringliteral">&quot; has &quot;</span> &lt;&lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a458ba67499378c33ab3172419609892b">coords</a>.size() &lt;&lt; <span class="stringliteral">&quot; worksets.&quot;</span> &lt;&lt; std::endl;
<a name="l00135"></a>00135 
<a name="l00136"></a>00136        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ws=0; ws&lt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a458ba67499378c33ab3172419609892b">coords</a>.size(); ws++) {  <span class="comment">//workset</span>
<a name="l00137"></a>00137          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> e=0; e&lt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a458ba67499378c33ab3172419609892b">coords</a>[ws].size(); e++) { <span class="comment">//cell</span>
<a name="l00138"></a>00138            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a458ba67499378c33ab3172419609892b">coords</a>[ws][e].size(); j++) { <span class="comment">//node</span>
<a name="l00139"></a>00139              <span class="keywordflow">for</span> (<span class="keywordtype">int</span> d=0; d&lt;mesh_dim; d++){  <span class="comment">//node</span>
<a name="l00140"></a>00140 std::cout &lt;&lt; <span class="stringliteral">&quot;Coord for workset: &quot;</span> &lt;&lt; ws &lt;&lt; <span class="stringliteral">&quot; element: &quot;</span> &lt;&lt; e &lt;&lt; <span class="stringliteral">&quot; node: &quot;</span> &lt;&lt; j &lt;&lt; <span class="stringliteral">&quot; DOF: &quot;</span> &lt;&lt; d &lt;&lt; <span class="stringliteral">&quot; is: &quot;</span> &lt;&lt;
<a name="l00141"></a>00141                 <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a458ba67499378c33ab3172419609892b">coords</a>[ws][e][j][d] &lt;&lt; std::endl;
<a name="l00142"></a>00142        } } } }
<a name="l00143"></a>00143 
<a name="l00144"></a>00144 }
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00147"></a>00147 Teuchos::ArrayRCP&lt;double&gt;&amp;
<a name="l00148"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ae1b5a3fa5402be5ad8ff19b875f56ea3">00148</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getCoordinates</a>()<span class="keyword"> const</span>
<a name="l00149"></a>00149 <span class="keyword"></span>{
<a name="l00150"></a>00150   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#af463aaa757ceae108471aca50161e383">coordinates</a>.resize(3 * <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a24a42901f684d82939664ccb4755b51a">numOverlapNodes</a>);
<a name="l00151"></a>00151   apf::Field* f = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;apfMesh-&gt;getCoordinateField();
<a name="l00152"></a>00152   <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aad11108cbc0ab01e0085eee0c8c6de9b" title="list of all overlap nodes, saved for setting solution">nodes</a>.getSize(); ++i)
<a name="l00153"></a>00153     apf::getComponents(f,<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aad11108cbc0ab01e0085eee0c8c6de9b" title="list of all overlap nodes, saved for setting solution">nodes</a>[i].entity,<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aad11108cbc0ab01e0085eee0c8c6de9b" title="list of all overlap nodes, saved for setting solution">nodes</a>[i].node,&amp;(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#af463aaa757ceae108471aca50161e383">coordinates</a>[3*i]));
<a name="l00154"></a>00154   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#af463aaa757ceae108471aca50161e383">coordinates</a>;
<a name="l00155"></a>00155 }
<a name="l00156"></a>00156 
<a name="l00157"></a>00157 <span class="comment">// FELIX uninitialized variables (FIXME)</span>
<a name="l00158"></a>00158 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00159"></a>00159 <span class="keyword">const</span> <a class="code" href="structAlbany_1_1WorksetArray.html">Albany::WorksetArray&lt;Teuchos::ArrayRCP&lt;Teuchos::ArrayRCP&lt;double&gt;</a> &gt; &gt;::type&amp;
<a name="l00160"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a9a072ac4d0671d9c334ee63fb8342813">00160</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getSurfaceHeight</a>()<span class="keyword"> const</span>
<a name="l00161"></a>00161 <span class="keyword"></span>{
<a name="l00162"></a>00162   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a7c03e5aa1d7e27ad0902f785bb14f781">sHeight</a>;
<a name="l00163"></a>00163 }
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00166"></a>00166 <span class="keyword">const</span> <a class="code" href="structAlbany_1_1WorksetArray.html">Albany::WorksetArray&lt;Teuchos::ArrayRCP&lt;double&gt;</a> &gt;::type&amp;
<a name="l00167"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a67a9e8f3741be856e3fc0c71c24f7980">00167</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getTemperature</a>()<span class="keyword"> const</span>
<a name="l00168"></a>00168 <span class="keyword"></span>{
<a name="l00169"></a>00169   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a55b4daae2788b23a834312970eedd794">temperature</a>;
<a name="l00170"></a>00170 }
<a name="l00171"></a>00171 
<a name="l00172"></a>00172 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00173"></a>00173 <span class="keyword">const</span> <a class="code" href="structAlbany_1_1WorksetArray.html">Albany::WorksetArray&lt;Teuchos::ArrayRCP&lt;Teuchos::ArrayRCP&lt;double&gt;</a> &gt; &gt;::type&amp;
<a name="l00174"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a1531d613b7319c7d6815274eec4073e4">00174</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getBasalFriction</a>()<span class="keyword"> const</span>
<a name="l00175"></a>00175 <span class="keyword"></span>{
<a name="l00176"></a>00176   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad6ceffb80711f170d76f469f505388e4">basalFriction</a>;
<a name="l00177"></a>00177 }
<a name="l00178"></a>00178 
<a name="l00179"></a>00179 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00180"></a>00180 <span class="keyword">const</span> <a class="code" href="structAlbany_1_1WorksetArray.html">Albany::WorksetArray&lt;Teuchos::ArrayRCP&lt;Teuchos::ArrayRCP&lt;double&gt;</a> &gt; &gt;::type&amp;
<a name="l00181"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#abe8ee17e39b16bbd3eb8679a2eb7085b">00181</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getThickness</a>()<span class="keyword"> const</span>
<a name="l00182"></a>00182 <span class="keyword"></span>{
<a name="l00183"></a>00183   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5d6c36973fba3c74ed6a0832314feda1">thickness</a>;
<a name="l00184"></a>00184 }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00187"></a>00187 <span class="keyword">const</span> <a class="code" href="structAlbany_1_1WorksetArray.html">Albany::WorksetArray&lt;Teuchos::ArrayRCP&lt;double&gt;</a> &gt;::type&amp;
<a name="l00188"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aeec019cd80e3cb6039a4daa123d701d8">00188</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getFlowFactor</a>()<span class="keyword"> const</span>
<a name="l00189"></a>00189 <span class="keyword"></span>{
<a name="l00190"></a>00190   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3b22c768b879cd2730d8a60df90b1a08">flowFactor</a>;
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00194"></a>00194 <span class="keyword">const</span> <a class="code" href="structAlbany_1_1WorksetArray.html">Albany::WorksetArray&lt;Teuchos::ArrayRCP&lt;Teuchos::ArrayRCP&lt;double*&gt;</a> &gt; &gt;::type&amp;
<a name="l00195"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a65182f3a5c9924df4026adacd941b4da">00195</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getSurfaceVelocity</a>()<span class="keyword"> const</span>
<a name="l00196"></a>00196 <span class="keyword"></span>{
<a name="l00197"></a>00197   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aaf2c5762fca7d877f525f4ab7cdeb176">surfaceVelocity</a>;
<a name="l00198"></a>00198 }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00201"></a>00201 <span class="keyword">const</span> <a class="code" href="structAlbany_1_1WorksetArray.html">Albany::WorksetArray&lt;Teuchos::ArrayRCP&lt;Teuchos::ArrayRCP&lt;double*&gt;</a> &gt; &gt;::type&amp;
<a name="l00202"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a11cf14f8afc083e12d97cffe7710e42f">00202</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getVelocityRMS</a>()<span class="keyword"> const</span>
<a name="l00203"></a>00203 <span class="keyword"></span>{
<a name="l00204"></a>00204   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ae1ff3ab84fb971b3632044c1e3d0d598">velocityRMS</a>;
<a name="l00205"></a>00205 }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 <span class="comment">//The function transformMesh() maps a unit cube domain by applying the transformation</span>
<a name="l00208"></a>00208 <span class="comment">//x = L*x</span>
<a name="l00209"></a>00209 <span class="comment">//y = L*y</span>
<a name="l00210"></a>00210 <span class="comment">//z = s(x,y)*z + b(x,y)*(1-z)</span>
<a name="l00211"></a>00211 <span class="comment">//where b(x,y) and s(x,y) are curves specifying the bedrock and top surface</span>
<a name="l00212"></a>00212 <span class="comment">//geometries respectively.</span>
<a name="l00213"></a>00213 <span class="comment">//Currently this function is only needed for some FELIX problems.</span>
<a name="l00214"></a>00214 
<a name="l00215"></a>00215 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00216"></a>00216 <span class="keywordtype">void</span>
<a name="l00217"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aea4d7db03657daaef4208a7374114437">00217</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::setupMLCoords</a>()
<a name="l00218"></a>00218 {
<a name="l00219"></a>00219 
<a name="l00220"></a>00220   <span class="comment">// Function to return x,y,z at owned nodes as double*, specifically for ML</span>
<a name="l00221"></a>00221 
<a name="l00222"></a>00222   <span class="comment">// if ML is not used, return</span>
<a name="l00223"></a>00223 
<a name="l00224"></a>00224   <span class="keywordflow">if</span>(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#acbd6df4cf191aee3e9c940da41e0aaa5">rigidBodyModes</a>.is_null()) <span class="keywordflow">return</span>;
<a name="l00225"></a>00225 
<a name="l00226"></a>00226   <span class="keywordflow">if</span>(!<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#acbd6df4cf191aee3e9c940da41e0aaa5">rigidBodyModes</a>-&gt;isMLUsed()) <span class="keywordflow">return</span>;
<a name="l00227"></a>00227 
<a name="l00228"></a>00228   <span class="comment">// get mesh dimension and part handle</span>
<a name="l00229"></a>00229   <span class="keywordtype">int</span> mesh_dim, counter=0;
<a name="l00230"></a>00230   FMDB_Mesh_GetDim(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;getMesh(), &amp;mesh_dim);
<a name="l00231"></a>00231   pPart part;
<a name="l00232"></a>00232   FMDB_Mesh_GetPart(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;getMesh(), 0, part);
<a name="l00233"></a>00233 
<a name="l00234"></a>00234   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#acbd6df4cf191aee3e9c940da41e0aaa5">rigidBodyModes</a>-&gt;resize(mesh_dim, <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a8dc79e9eaa2504fb986595892bab3013" title="Number of elements on this processor.">numOwnedNodes</a>);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236   <span class="keywordtype">double</span> *<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#abbc1ecc2070c1778f60780a9ca8987f6">xx</a>;
<a name="l00237"></a>00237   <span class="keywordtype">double</span> *<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ac61443291651151167ca5bd0937993b1">yy</a>;
<a name="l00238"></a>00238   <span class="keywordtype">double</span> *<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a86b9e8dd733a65c2f0cbc243410c9018">zz</a>;
<a name="l00239"></a>00239 
<a name="l00240"></a>00240   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#acbd6df4cf191aee3e9c940da41e0aaa5">rigidBodyModes</a>-&gt;getCoordArrays(&amp;xx, &amp;yy, &amp;zz);
<a name="l00241"></a>00241 
<a name="l00242"></a>00242   <span class="keywordtype">double</span>* node_coords=<span class="keyword">new</span> <span class="keywordtype">double</span>[3];
<a name="l00243"></a>00243 
<a name="l00244"></a>00244   pPartEntIter node_it;
<a name="l00245"></a>00245   pMeshEnt node;
<a name="l00246"></a>00246 
<a name="l00247"></a>00247   <span class="keywordtype">int</span> owner_partid, iterEnd = FMDB_PartEntIter_Init(part, FMDB_VERTEX, FMDB_ALLTOPO, node_it);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249   <span class="comment">/* DAI: this function also has to change for high-order fields */</span>
<a name="l00250"></a>00250   <span class="keywordflow">while</span> (!iterEnd)
<a name="l00251"></a>00251   {
<a name="l00252"></a>00252     iterEnd = FMDB_PartEntIter_GetNext(node_it, node);
<a name="l00253"></a>00253     <span class="keywordflow">if</span> (iterEnd) <span class="keywordflow">break</span>;
<a name="l00254"></a>00254 
<a name="l00255"></a>00255     FMDB_Ent_GetOwnPartID(node, part, &amp;owner_partid);
<a name="l00256"></a>00256     <span class="keywordflow">if</span> (owner_partid!=FMDB_Part_ID(part)) <span class="keywordflow">continue</span>; <span class="comment">// skip un-owned entity</span>
<a name="l00257"></a>00257 
<a name="l00258"></a>00258     FMDB_Vtx_GetCoord (node, node_coords);
<a name="l00259"></a>00259     xx[counter]=node_coords[0];
<a name="l00260"></a>00260     yy[counter]=node_coords[1];
<a name="l00261"></a>00261     <span class="keywordflow">if</span> (mesh_dim&gt;2) zz[counter]=node_coords[2];
<a name="l00262"></a>00262     ++counter;
<a name="l00263"></a>00263   }
<a name="l00264"></a>00264 
<a name="l00265"></a>00265   FMDB_PartEntIter_Del (node_it);
<a name="l00266"></a>00266   <span class="keyword">delete</span> [] node_coords;
<a name="l00267"></a>00267 
<a name="l00268"></a>00268   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#acbd6df4cf191aee3e9c940da41e0aaa5">rigidBodyModes</a>-&gt;informML();
<a name="l00269"></a>00269 
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 
<a name="l00273"></a>00273 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00274"></a>00274 <span class="keyword">const</span> <a class="code" href="structAlbany_1_1WorksetArray.html#a2251678748f133c70ad2b97345319967">Albany::WorksetArray&lt;std::string&gt;::type</a>&amp;
<a name="l00275"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a90671f96a46c17342e7402d1679b8547">00275</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getWsEBNames</a>()<span class="keyword"> const</span>
<a name="l00276"></a>00276 <span class="keyword"></span>{
<a name="l00277"></a>00277   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a783794e3b9848c1501f488829a520c52">wsEBNames</a>;
<a name="l00278"></a>00278 }
<a name="l00279"></a>00279 
<a name="l00280"></a>00280 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00281"></a>00281 <span class="keyword">const</span> <a class="code" href="structAlbany_1_1WorksetArray.html#a2251678748f133c70ad2b97345319967">Albany::WorksetArray&lt;int&gt;::type</a>&amp;
<a name="l00282"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ae05cd59ba8231a793ba056ac57d53adf">00282</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getWsPhysIndex</a>()<span class="keyword"> const</span>
<a name="l00283"></a>00283 <span class="keyword"></span>{
<a name="l00284"></a>00284   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#afa68b6d861e5a6a6f09c5d6f65c59490">wsPhysIndex</a>;
<a name="l00285"></a>00285 }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00288"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a9ccc92aaa0f8bd72ad5bb04668de4ff5">00288</a> <span class="keywordtype">void</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::setField</a>(
<a name="l00289"></a>00289     <span class="keyword">const</span> <span class="keywordtype">char</span>* name,
<a name="l00290"></a>00290     <span class="keyword">const</span> Epetra_Vector&amp; data,
<a name="l00291"></a>00291     <span class="keywordtype">bool</span> overlapped,
<a name="l00292"></a>00292     <span class="keywordtype">int</span> offset)
<a name="l00293"></a>00293 {
<a name="l00294"></a>00294   apf::Mesh* m = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;apfMesh;
<a name="l00295"></a>00295   apf::Field* f = m-&gt;findField(name);
<a name="l00296"></a>00296   apf::Numbering* <a class="code" href="MOR__ExtendedEpetraLapack_8cpp.html#af5da5165aa5eeff113accece5748c995">n</a> = m-&gt;findNumbering(<span class="stringliteral">&quot;apf_owned_numbering&quot;</span>);
<a name="l00297"></a>00297   <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aad11108cbc0ab01e0085eee0c8c6de9b" title="list of all overlap nodes, saved for setting solution">nodes</a>.getSize(); ++i)
<a name="l00298"></a>00298   {
<a name="l00299"></a>00299     apf::Node node = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aad11108cbc0ab01e0085eee0c8c6de9b" title="list of all overlap nodes, saved for setting solution">nodes</a>[i];
<a name="l00300"></a>00300     <span class="keywordtype">int</span> node_gid = apf::getNumber(n,node.entity,node.node,0);
<a name="l00301"></a>00301     <span class="keywordtype">int</span> node_lid;
<a name="l00302"></a>00302     <span class="keywordflow">if</span> (overlapped)
<a name="l00303"></a>00303       node_lid = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#acad8cd7a63d6454e6dbb693a441433a5">overlap_node_map</a>-&gt;LID(node_gid);
<a name="l00304"></a>00304     <span class="keywordflow">else</span>
<a name="l00305"></a>00305     {
<a name="l00306"></a>00306       <span class="keywordflow">if</span> ( ! m-&gt;isOwned(node.entity)) <span class="keywordflow">continue</span>;
<a name="l00307"></a>00307       node_lid = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ab8d6c20156402e12d1406136cd409db0" title="Node map.">node_map</a>-&gt;LID(node_gid);
<a name="l00308"></a>00308     }
<a name="l00309"></a>00309     <span class="keywordtype">int</span> firstDOF = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3b85ad0bf31e97a6acfe3b9720a59a71">getDOF</a>(node_lid,offset);
<a name="l00310"></a>00310     apf::setComponents(f,node.entity,node.node,&amp;(data[firstDOF]));
<a name="l00311"></a>00311   }
<a name="l00312"></a>00312   <span class="keywordflow">if</span> ( ! overlapped)
<a name="l00313"></a>00313     apf::synchronize(f);
<a name="l00314"></a>00314 }
<a name="l00315"></a>00315 
<a name="l00316"></a>00316 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00317"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a7fb8731d78d1fb45c0e7cd0631043bb5">00317</a> <span class="keywordtype">void</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::setSplitFields</a>(std::vector&lt;std::string&gt; names,
<a name="l00318"></a>00318     std::vector&lt;int&gt; indices, <span class="keyword">const</span> Epetra_Vector&amp; data, <span class="keywordtype">bool</span> overlapped)
<a name="l00319"></a>00319 {
<a name="l00320"></a>00320   apf::Mesh* m = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;apfMesh;
<a name="l00321"></a>00321   <span class="keywordtype">int</span> offset = 0;
<a name="l00322"></a>00322   <span class="keywordtype">int</span> indexSum = 0;
<a name="l00323"></a>00323   <span class="keywordflow">for</span> (std::size_t i=0; i &lt; names.size(); ++i)
<a name="l00324"></a>00324   {
<a name="l00325"></a>00325     assert(indexSum==offset);
<a name="l00326"></a>00326     this-&gt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a9ccc92aaa0f8bd72ad5bb04668de4ff5">setField</a>(names[i].c_str(),data,overlapped,offset);
<a name="l00327"></a>00327     offset += apf::countComponents(m-&gt;findField(names[i].c_str()));
<a name="l00328"></a>00328     indexSum += indices[i];
<a name="l00329"></a>00329   }
<a name="l00330"></a>00330 }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00333"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ae2ee4820c70968857e6e34c06c725a1b">00333</a> <span class="keywordtype">void</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getField</a>(
<a name="l00334"></a>00334     <span class="keyword">const</span> <span class="keywordtype">char</span>* name,
<a name="l00335"></a>00335     Epetra_Vector&amp; data,
<a name="l00336"></a>00336     <span class="keywordtype">bool</span> overlapped,
<a name="l00337"></a>00337     <span class="keywordtype">int</span> offset)<span class="keyword"> const</span>
<a name="l00338"></a>00338 <span class="keyword"></span>{
<a name="l00339"></a>00339   apf::Mesh* m = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;apfMesh;
<a name="l00340"></a>00340   apf::Field* f = m-&gt;findField(name);
<a name="l00341"></a>00341   apf::Numbering* <a class="code" href="MOR__ExtendedEpetraLapack_8cpp.html#af5da5165aa5eeff113accece5748c995">n</a> = m-&gt;findNumbering(<span class="stringliteral">&quot;apf_owned_numbering&quot;</span>);
<a name="l00342"></a>00342   <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aad11108cbc0ab01e0085eee0c8c6de9b" title="list of all overlap nodes, saved for setting solution">nodes</a>.getSize(); ++i)
<a name="l00343"></a>00343   {
<a name="l00344"></a>00344     apf::Node node = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aad11108cbc0ab01e0085eee0c8c6de9b" title="list of all overlap nodes, saved for setting solution">nodes</a>[i];
<a name="l00345"></a>00345     <span class="keywordtype">int</span> node_gid = apf::getNumber(n,node.entity,node.node,0);
<a name="l00346"></a>00346     <span class="keywordtype">int</span> node_lid = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ab8d6c20156402e12d1406136cd409db0" title="Node map.">node_map</a>-&gt;LID(node_gid);
<a name="l00347"></a>00347     <span class="keywordflow">if</span> (overlapped)
<a name="l00348"></a>00348       node_lid = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#acad8cd7a63d6454e6dbb693a441433a5">overlap_node_map</a>-&gt;LID(node_gid);
<a name="l00349"></a>00349     <span class="keywordflow">else</span>
<a name="l00350"></a>00350     {
<a name="l00351"></a>00351       <span class="keywordflow">if</span> ( ! m-&gt;isOwned(node.entity)) <span class="keywordflow">continue</span>;
<a name="l00352"></a>00352       node_lid = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ab8d6c20156402e12d1406136cd409db0" title="Node map.">node_map</a>-&gt;LID(node_gid);
<a name="l00353"></a>00353     }
<a name="l00354"></a>00354     <span class="keywordtype">int</span> firstDOF = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3b85ad0bf31e97a6acfe3b9720a59a71">getDOF</a>(node_lid,offset);
<a name="l00355"></a>00355 <span class="comment">/* the only difference between setField and getField is this one char:</span>
<a name="l00356"></a>00356 <span class="comment">         V                                                           */</span>
<a name="l00357"></a>00357     apf::getComponents(f,node.entity,node.node,&amp;(data[firstDOF]));
<a name="l00358"></a>00358   }
<a name="l00359"></a>00359 }
<a name="l00360"></a>00360 
<a name="l00361"></a>00361 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00362"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a7f433e6c6822fabdf370c1ad1e69257f">00362</a> <span class="keywordtype">void</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getSplitFields</a>(std::vector&lt;std::string&gt; names,
<a name="l00363"></a>00363    std::vector&lt;int&gt; indices, Epetra_Vector&amp; data, <span class="keywordtype">bool</span> overlapped)<span class="keyword"> const</span>
<a name="l00364"></a>00364 <span class="keyword"></span>{
<a name="l00365"></a>00365   apf::Mesh* m = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;apfMesh;
<a name="l00366"></a>00366   <span class="keywordtype">int</span> offset = 0;
<a name="l00367"></a>00367   <span class="keywordtype">int</span> indexSum = 0;
<a name="l00368"></a>00368   <span class="keywordflow">for</span> (std::size_t i=0; i &lt; names.size(); ++i)
<a name="l00369"></a>00369   {
<a name="l00370"></a>00370     assert(indexSum==offset);
<a name="l00371"></a>00371  
<a name="l00372"></a>00372     this-&gt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ae2ee4820c70968857e6e34c06c725a1b">getField</a>(names[i].c_str(),data,overlapped,offset);
<a name="l00373"></a>00373     offset += apf::countComponents(m-&gt;findField(names[i].c_str()));
<a name="l00374"></a>00374     indexSum += indices[i];
<a name="l00375"></a>00375   }
<a name="l00376"></a>00376 }
<a name="l00377"></a>00377 
<a name="l00378"></a>00378 
<a name="l00379"></a>00379 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00380"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a33c34d80625402c312949d013f6b62c3">00380</a> <span class="keywordtype">void</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::writeSolution</a>(<span class="keyword">const</span> Epetra_Vector&amp; soln, <span class="keyword">const</span> <span class="keywordtype">double</span> time_value,
<a name="l00381"></a>00381        <span class="keyword">const</span> <span class="keywordtype">bool</span> overlapped){
<a name="l00382"></a>00382 
<a name="l00383"></a>00383   <span class="keywordflow">if</span> (<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;outputFileName.empty())
<a name="l00384"></a>00384     <span class="keywordflow">return</span>;
<a name="l00385"></a>00385 
<a name="l00386"></a>00386   <span class="comment">// Skip this write unless the proper interval has been reached</span>
<a name="l00387"></a>00387   <span class="keywordflow">if</span>(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a6a4e7ecd7b1066a40605885af696b698">outputInterval</a>++ % <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;outputInterval)
<a name="l00388"></a>00388     <span class="keywordflow">return</span>;
<a name="l00389"></a>00389 
<a name="l00390"></a>00390   <span class="keywordtype">double</span> time_label = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a2a6af66ff5a494175cf5fa3b020ad1c3">monotonicTimeLabel</a>(time_value);
<a name="l00391"></a>00391   <span class="keywordtype">int</span> out_step = 0;
<a name="l00392"></a>00392 
<a name="l00393"></a>00393   <span class="keywordflow">if</span> (<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad324c117e9184285851313cf597b0b61" title="Unknown Map.">map</a>-&gt;Comm().MyPID()==0) {
<a name="l00394"></a>00394     *<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a82acec84364ef37709fcbee2326c1cb7" title="Call stk_io for creating exodus output file.">out</a> &lt;&lt; <span class="stringliteral">&quot;AlbPUMI::FMDBDiscretization::writeSolution: writing time &quot;</span> &lt;&lt; time_value;
<a name="l00395"></a>00395     <span class="keywordflow">if</span> (time_label != time_value) *<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a82acec84364ef37709fcbee2326c1cb7" title="Call stk_io for creating exodus output file.">out</a> &lt;&lt; <span class="stringliteral">&quot; with label &quot;</span> &lt;&lt; time_label;
<a name="l00396"></a>00396     *<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a82acec84364ef37709fcbee2326c1cb7" title="Call stk_io for creating exodus output file.">out</a> &lt;&lt; <span class="stringliteral">&quot; to index &quot;</span> &lt;&lt;out_step&lt;&lt;<span class="stringliteral">&quot; in file &quot;</span>&lt;&lt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;outputFileName&lt;&lt; std::endl;
<a name="l00397"></a>00397   }
<a name="l00398"></a>00398 
<a name="l00399"></a>00399   <span class="keywordflow">if</span> (<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aafade44467a1972f674e69d4053cbc8c">solNames</a>.size() == 0)
<a name="l00400"></a>00400     this-&gt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a9ccc92aaa0f8bd72ad5bb04668de4ff5">setField</a>(<span class="stringliteral">&quot;solution&quot;</span>,soln,overlapped);
<a name="l00401"></a>00401   <span class="keywordflow">else</span>
<a name="l00402"></a>00402     this-&gt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a7fb8731d78d1fb45c0e7cd0631043bb5">setSplitFields</a>(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aafade44467a1972f674e69d4053cbc8c">solNames</a>,<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aa16f3ea135c51f848d7b5817df0bd7a1">solIndex</a>,soln,overlapped);
<a name="l00403"></a>00403 
<a name="l00404"></a>00404   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;solutionInitialized = <span class="keyword">true</span>;
<a name="l00405"></a>00405 
<a name="l00406"></a>00406   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a6a4e7ecd7b1066a40605885af696b698">outputInterval</a> = 0;
<a name="l00407"></a>00407 
<a name="l00408"></a>00408   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a8c7b0c43a3f10d74a0955d78a0a98139">copyQPStatesToAPF</a>();
<a name="l00409"></a>00409   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ac76cf75ed0c2b30055ba08198d51974c" title="Output object.">meshOutput</a>.writeFile(time_label);
<a name="l00410"></a>00410   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a72a4d089f56d7ca623120af0c2e7314c">removeQPStatesFromAPF</a>();
<a name="l00411"></a>00411 
<a name="l00412"></a>00412 }
<a name="l00413"></a>00413 
<a name="l00414"></a>00414 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00415"></a>00415 <span class="keywordtype">void</span>
<a name="l00416"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a07d6260870cfa3eeace18a66a1ac3442">00416</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::debugMeshWriteNative</a>(<span class="keyword">const</span> Epetra_Vector&amp; soln, <span class="keyword">const</span> <span class="keywordtype">char</span>* filename){
<a name="l00417"></a>00417 
<a name="l00418"></a>00418   <span class="keywordflow">if</span> (<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aafade44467a1972f674e69d4053cbc8c">solNames</a>.size() == 0 )
<a name="l00419"></a>00419     this-&gt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a9ccc92aaa0f8bd72ad5bb04668de4ff5">setField</a>(<span class="stringliteral">&quot;solution&quot;</span>,soln,<span class="comment">/*overlapped=*/</span><span class="keyword">false</span>);
<a name="l00420"></a>00420   <span class="keywordflow">else</span>
<a name="l00421"></a>00421     this-&gt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a7fb8731d78d1fb45c0e7cd0631043bb5">setSplitFields</a>(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aafade44467a1972f674e69d4053cbc8c">solNames</a>,<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aa16f3ea135c51f848d7b5817df0bd7a1">solIndex</a>,soln,<span class="comment">/*overlapped=*/</span><span class="keyword">false</span>);
<a name="l00422"></a>00422 
<a name="l00423"></a>00423   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;solutionInitialized = <span class="keyword">true</span>;
<a name="l00424"></a>00424   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;apfMesh-&gt;writeNative(filename);
<a name="l00425"></a>00425 
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00429"></a>00429 <span class="keywordtype">void</span>
<a name="l00430"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a26bb4abefd272725a25c49d23fcd632b">00430</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::debugMeshWrite</a>(<span class="keyword">const</span> Epetra_Vector&amp; soln, <span class="keyword">const</span> <span class="keywordtype">char</span>* filename){
<a name="l00431"></a>00431 
<a name="l00432"></a>00432   <span class="keywordflow">if</span> (<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aafade44467a1972f674e69d4053cbc8c">solNames</a>.size() == 0 )
<a name="l00433"></a>00433     this-&gt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a9ccc92aaa0f8bd72ad5bb04668de4ff5">setField</a>(<span class="stringliteral">&quot;solution&quot;</span>,soln,<span class="comment">/*overlapped=*/</span><span class="keyword">false</span>);
<a name="l00434"></a>00434   <span class="keywordflow">else</span>
<a name="l00435"></a>00435     this-&gt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a7fb8731d78d1fb45c0e7cd0631043bb5">setSplitFields</a>(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aafade44467a1972f674e69d4053cbc8c">solNames</a>,<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aa16f3ea135c51f848d7b5817df0bd7a1">solIndex</a>,soln,<span class="comment">/*overlapped=*/</span><span class="keyword">false</span>);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437   <span class="keywordflow">if</span> (! PCU_Comm_Self()) {
<a name="l00438"></a>00438     std::cout &lt;&lt; <span class="stringliteral">&quot;************************************************&quot;</span> &lt;&lt; std::endl;
<a name="l00439"></a>00439     std::cout &lt;&lt; <span class="stringliteral">&quot;Writing mesh debug output! &quot;</span> &lt;&lt; std::endl;
<a name="l00440"></a>00440     std::cout &lt;&lt; <span class="stringliteral">&quot;************************************************&quot;</span> &lt;&lt; std::endl;
<a name="l00441"></a>00441     std::cout &lt;&lt; std::endl;
<a name="l00442"></a>00442   }
<a name="l00443"></a>00443 
<a name="l00444"></a>00444   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;solutionInitialized = <span class="keyword">true</span>;
<a name="l00445"></a>00445 
<a name="l00446"></a>00446   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a8c7b0c43a3f10d74a0955d78a0a98139">copyQPStatesToAPF</a>();
<a name="l00447"></a>00447   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ac76cf75ed0c2b30055ba08198d51974c" title="Output object.">meshOutput</a>.debugMeshWrite(filename);
<a name="l00448"></a>00448   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a72a4d089f56d7ca623120af0c2e7314c">removeQPStatesFromAPF</a>();
<a name="l00449"></a>00449 
<a name="l00450"></a>00450 }
<a name="l00451"></a>00451 
<a name="l00452"></a>00452 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00453"></a>00453 <span class="keywordtype">double</span>
<a name="l00454"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a2a6af66ff5a494175cf5fa3b020ad1c3">00454</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::monotonicTimeLabel</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> time)
<a name="l00455"></a>00455 {
<a name="l00456"></a>00456   <span class="comment">// If increasing, then all is good</span>
<a name="l00457"></a>00457   <span class="keywordflow">if</span> (time &gt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a130520c3a0be4c685989282966f830d7">previous_time_label</a>) {
<a name="l00458"></a>00458     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a130520c3a0be4c685989282966f830d7">previous_time_label</a> = time;
<a name="l00459"></a>00459     <span class="keywordflow">return</span> time;
<a name="l00460"></a>00460   }
<a name="l00461"></a>00461 <span class="comment">// Try absolute value</span>
<a name="l00462"></a>00462   <span class="keywordtype">double</span> time_label = fabs(time);
<a name="l00463"></a>00463   <span class="keywordflow">if</span> (time_label &gt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a130520c3a0be4c685989282966f830d7">previous_time_label</a>) {
<a name="l00464"></a>00464     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a130520c3a0be4c685989282966f830d7">previous_time_label</a> = time_label;
<a name="l00465"></a>00465     <span class="keywordflow">return</span> time_label;
<a name="l00466"></a>00466   }
<a name="l00467"></a>00467 
<a name="l00468"></a>00468   <span class="comment">// Try adding 1.0 to time</span>
<a name="l00469"></a>00469   <span class="keywordflow">if</span> (time_label+1.0 &gt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a130520c3a0be4c685989282966f830d7">previous_time_label</a>) {
<a name="l00470"></a>00470     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a130520c3a0be4c685989282966f830d7">previous_time_label</a> = time_label+1.0;
<a name="l00471"></a>00471     <span class="keywordflow">return</span> time_label+1.0;
<a name="l00472"></a>00472   }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474   <span class="comment">// Otherwise, just add 1.0 to previous</span>
<a name="l00475"></a>00475   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a130520c3a0be4c685989282966f830d7">previous_time_label</a> += 1.0;
<a name="l00476"></a>00476   <span class="keywordflow">return</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a130520c3a0be4c685989282966f830d7">previous_time_label</a>;
<a name="l00477"></a>00477 }
<a name="l00478"></a>00478 
<a name="l00479"></a>00479 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00480"></a>00480 <span class="keywordtype">void</span>
<a name="l00481"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ae83d23ce766823ea38727d2bcb071e15">00481</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::setResidualField</a>(<span class="keyword">const</span> Epetra_Vector&amp; residual)
<a name="l00482"></a>00482 {
<a name="l00483"></a>00483   <span class="keywordflow">if</span> (<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aafade44467a1972f674e69d4053cbc8c">solNames</a>.size() == 0)
<a name="l00484"></a>00484     this-&gt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a9ccc92aaa0f8bd72ad5bb04668de4ff5">setField</a>(<span class="stringliteral">&quot;residual&quot;</span>,residual,<span class="comment">/*overlapped=*/</span><span class="keyword">false</span>);
<a name="l00485"></a>00485   <span class="keywordflow">else</span>
<a name="l00486"></a>00486     this-&gt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a7fb8731d78d1fb45c0e7cd0631043bb5">setSplitFields</a>(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a05c67b9d62ec1450ddaaf1098bb9989f">resNames</a>,<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aa16f3ea135c51f848d7b5817df0bd7a1">solIndex</a>,residual,<span class="comment">/*overlapped=*/</span><span class="keyword">false</span>);
<a name="l00487"></a>00487 
<a name="l00488"></a>00488   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;residualInitialized = <span class="keyword">true</span>;
<a name="l00489"></a>00489 }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00492"></a>00492 Teuchos::RCP&lt;Epetra_Vector&gt;
<a name="l00493"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aa6c20a6f0de906ecde1902511126a29c">00493</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::getSolutionField</a>()<span class="keyword"> const</span>
<a name="l00494"></a>00494 <span class="keyword"></span>{
<a name="l00495"></a>00495   <span class="comment">// Copy soln vector into solution field, one node at a time</span>
<a name="l00496"></a>00496   Teuchos::RCP&lt;Epetra_Vector&gt; soln = Teuchos::rcp(<span class="keyword">new</span> Epetra_Vector(*<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad324c117e9184285851313cf597b0b61" title="Unknown Map.">map</a>));
<a name="l00497"></a>00497 
<a name="l00498"></a>00498   <span class="keywordflow">if</span> (<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;solutionInitialized) {
<a name="l00499"></a>00499     <span class="keywordflow">if</span> (<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aafade44467a1972f674e69d4053cbc8c">solNames</a>.size() == 0)
<a name="l00500"></a>00500       this-&gt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ae2ee4820c70968857e6e34c06c725a1b">getField</a>(<span class="stringliteral">&quot;solution&quot;</span>,*soln,<span class="comment">/*overlapped=*/</span><span class="keyword">false</span>);
<a name="l00501"></a>00501     <span class="keywordflow">else</span>
<a name="l00502"></a>00502       this-&gt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a7f433e6c6822fabdf370c1ad1e69257f">getSplitFields</a>(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aafade44467a1972f674e69d4053cbc8c">solNames</a>,<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aa16f3ea135c51f848d7b5817df0bd7a1">solIndex</a>,*soln,<span class="comment">/*overlapped=*/</span><span class="keyword">false</span>);
<a name="l00503"></a>00503   }
<a name="l00504"></a>00504   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ! PCU_Comm_Self())
<a name="l00505"></a>00505     *<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a82acec84364ef37709fcbee2326c1cb7" title="Call stk_io for creating exodus output file.">out</a> &lt;&lt;__func__&lt;&lt;<span class="stringliteral">&quot;: uninit field&quot;</span> &lt;&lt; std::endl;
<a name="l00506"></a>00506 
<a name="l00507"></a>00507   <span class="keywordflow">return</span> soln;
<a name="l00508"></a>00508 }
<a name="l00509"></a>00509 
<a name="l00510"></a>00510 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00511"></a>00511 <span class="keywordtype">void</span>
<a name="l00512"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a4ec6a7dfe8c5495d212d99c9b10b406e">00512</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::setSolutionField</a>(<span class="keyword">const</span> Epetra_Vector&amp; soln)
<a name="l00513"></a>00513 {
<a name="l00514"></a>00514   <span class="keywordflow">if</span> (<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aafade44467a1972f674e69d4053cbc8c">solNames</a>.size() == 0)
<a name="l00515"></a>00515     this-&gt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a9ccc92aaa0f8bd72ad5bb04668de4ff5">setField</a>(<span class="stringliteral">&quot;solution&quot;</span>,soln,<span class="comment">/*overlapped=*/</span><span class="keyword">false</span>);
<a name="l00516"></a>00516   <span class="keywordflow">else</span>
<a name="l00517"></a>00517     this-&gt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a7fb8731d78d1fb45c0e7cd0631043bb5">setSplitFields</a>(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aafade44467a1972f674e69d4053cbc8c">solNames</a>,<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aa16f3ea135c51f848d7b5817df0bd7a1">solIndex</a>,soln,<span class="comment">/*overlapped=*/</span><span class="keyword">false</span>);
<a name="l00518"></a>00518 
<a name="l00519"></a>00519   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;solutionInitialized = <span class="keyword">true</span>;
<a name="l00520"></a>00520 }
<a name="l00521"></a>00521 
<a name="l00522"></a>00522 
<a name="l00523"></a>00523 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00524"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#acd61d39fb58cb34b3255480d0b66dcbf">00524</a> <span class="keywordtype">int</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::nonzeroesPerRow</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> neq)<span class="keyword"> const</span>
<a name="l00525"></a>00525 <span class="keyword"></span>{
<a name="l00526"></a>00526   <span class="keywordtype">int</span> numDim;
<a name="l00527"></a>00527   FMDB_Mesh_GetDim(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;getMesh(), &amp;numDim);
<a name="l00528"></a>00528 
<a name="l00529"></a>00529   <span class="comment">/* DAI: this function should be revisited for overall correctness,</span>
<a name="l00530"></a>00530 <span class="comment">     especially in the case of higher-order fields */</span>
<a name="l00531"></a>00531   <span class="keywordtype">int</span> estNonzeroesPerRow;
<a name="l00532"></a>00532   <span class="keywordflow">switch</span> (numDim) {
<a name="l00533"></a>00533   <span class="keywordflow">case</span> 0: estNonzeroesPerRow=1*neq; <span class="keywordflow">break</span>;
<a name="l00534"></a>00534   <span class="keywordflow">case</span> 1: estNonzeroesPerRow=3*neq; <span class="keywordflow">break</span>;
<a name="l00535"></a>00535   <span class="keywordflow">case</span> 2: estNonzeroesPerRow=9*neq; <span class="keywordflow">break</span>;
<a name="l00536"></a>00536   <span class="keywordflow">case</span> 3: estNonzeroesPerRow=27*neq; <span class="keywordflow">break</span>;
<a name="l00537"></a>00537   <span class="keywordflow">default</span>: TEUCHOS_TEST_FOR_EXCEPTION(<span class="keyword">true</span>, std::logic_error,
<a name="l00538"></a>00538             <span class="stringliteral">&quot;FMDBDiscretization:  Bad numDim&quot;</span>&lt;&lt; numDim);
<a name="l00539"></a>00539   }
<a name="l00540"></a>00540   <span class="keywordflow">return</span> estNonzeroesPerRow;
<a name="l00541"></a>00541 }
<a name="l00542"></a>00542 
<a name="l00543"></a>00543 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00544"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a24345f8118d9f5a9222d7c48e2d2c8e8">00544</a> <span class="keywordtype">void</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::computeOwnedNodesAndUnknowns</a>()
<a name="l00545"></a>00545 {
<a name="l00546"></a>00546   apf::Mesh* m = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;apfMesh;
<a name="l00547"></a>00547   apf::Numbering* <a class="code" href="MOR__ExtendedEpetraLapack_8cpp.html#af5da5165aa5eeff113accece5748c995">n</a> = m-&gt;findNumbering(<span class="stringliteral">&quot;apf_owned_numbering&quot;</span>);
<a name="l00548"></a>00548   <span class="keywordflow">if</span> (n) apf::destroyNumbering(n);
<a name="l00549"></a>00549   n = apf::numberOwnedNodes(m,<span class="stringliteral">&quot;apf_owned_numbering&quot;</span>);
<a name="l00550"></a>00550   apf::globalize(n); <span class="comment">/* turn local numbering to global numbering */</span>
<a name="l00551"></a>00551   apf::DynamicArray&lt;apf::Node&gt; ownedNodes;
<a name="l00552"></a>00552   apf::getNodes(n,ownedNodes);
<a name="l00553"></a>00553   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a8dc79e9eaa2504fb986595892bab3013" title="Number of elements on this processor.">numOwnedNodes</a> = ownedNodes.getSize();
<a name="l00554"></a>00554   apf::synchronize(n); <span class="comment">/* this puts owned node numbers on non-owned overlap nodes */</span>
<a name="l00555"></a>00555   std::vector&lt;int&gt; indices(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a8dc79e9eaa2504fb986595892bab3013" title="Number of elements on this processor.">numOwnedNodes</a>);
<a name="l00556"></a>00556   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a8dc79e9eaa2504fb986595892bab3013" title="Number of elements on this processor.">numOwnedNodes</a>; ++i)
<a name="l00557"></a>00557     indices[i] = getNumber(n,ownedNodes[i].entity,ownedNodes[i].node,0);
<a name="l00558"></a>00558   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ab8d6c20156402e12d1406136cd409db0" title="Node map.">node_map</a> = Teuchos::rcp(<span class="keyword">new</span> Epetra_Map(-1, numOwnedNodes,
<a name="l00559"></a>00559            &amp;(indices[0]), 0, *<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a7d1190558a94ea348521bd01bbdfd2d7" title="Stk Mesh Objects.">comm</a>));
<a name="l00560"></a>00560   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a6bde374c73a78f907d6fdf40e03548bf">numGlobalNodes</a> = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ab8d6c20156402e12d1406136cd409db0" title="Node map.">node_map</a>-&gt;MaxAllGID() + 1;
<a name="l00561"></a>00561   <span class="keywordflow">if</span>(Teuchos::nonnull(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;nodal_data_block))
<a name="l00562"></a>00562     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;nodal_data_block-&gt;resizeLocalMap(indices, *<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a7d1190558a94ea348521bd01bbdfd2d7" title="Stk Mesh Objects.">comm</a>);
<a name="l00563"></a>00563   indices.resize(numOwnedNodes*<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3189db7ba940e93aa9643f8b8bae2fb5" title="Number of equations (and unknowns) per node.">neq</a>);
<a name="l00564"></a>00564   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; numOwnedNodes; ++i)
<a name="l00565"></a>00565     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j &lt; neq; ++j)
<a name="l00566"></a>00566       indices[<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3b85ad0bf31e97a6acfe3b9720a59a71">getDOF</a>(i,j)] = 
<a name="l00567"></a>00567         <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3b85ad0bf31e97a6acfe3b9720a59a71">getDOF</a>(getNumber(n,ownedNodes[i].entity,ownedNodes[i].node,0),j);
<a name="l00568"></a>00568   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad324c117e9184285851313cf597b0b61" title="Unknown Map.">map</a> = Teuchos::rcp(<span class="keyword">new</span> Epetra_Map(-1, indices.size(), &amp;(indices[0]), 0, *<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a7d1190558a94ea348521bd01bbdfd2d7" title="Stk Mesh Objects.">comm</a>));
<a name="l00569"></a>00569 }
<a name="l00570"></a>00570 
<a name="l00571"></a>00571 <span class="keyword">template</span> &lt;<span class="keyword">class</span> Output&gt;
<a name="l00572"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a4863da5ffb1b1026704b0c3df212dfa3">00572</a> <span class="keywordtype">void</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::computeOverlapNodesAndUnknowns</a>()
<a name="l00573"></a>00573 {
<a name="l00574"></a>00574   apf::Mesh* m = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;apfMesh;
<a name="l00575"></a>00575   apf::Numbering* overlap = m-&gt;findNumbering(<span class="stringliteral">&quot;apf_overlap_numbering&quot;</span>);
<a name="l00576"></a>00576   <span class="keywordflow">if</span> (overlap) apf::destroyNumbering(overlap);
<a name="l00577"></a>00577   overlap = apf::numberOverlapNodes(m,<span class="stringliteral">&quot;apf_overlap_numbering&quot;</span>);
<a name="l00578"></a>00578   apf::getNodes(overlap,<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aad11108cbc0ab01e0085eee0c8c6de9b" title="list of all overlap nodes, saved for setting solution">nodes</a>);
<a name="l00579"></a>00579   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a24a42901f684d82939664ccb4755b51a">numOverlapNodes</a> = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aad11108cbc0ab01e0085eee0c8c6de9b" title="list of all overlap nodes, saved for setting solution">nodes</a>.getSize();
<a name="l00580"></a>00580   std::vector&lt;int&gt; nodeIndices(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a24a42901f684d82939664ccb4755b51a">numOverlapNodes</a>);
<a name="l00581"></a>00581   std::vector&lt;int&gt; dofIndices(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a24a42901f684d82939664ccb4755b51a">numOverlapNodes</a>*<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3189db7ba940e93aa9643f8b8bae2fb5" title="Number of equations (and unknowns) per node.">neq</a>);
<a name="l00582"></a>00582   apf::Numbering* owned = m-&gt;findNumbering(<span class="stringliteral">&quot;apf_owned_numbering&quot;</span>);
<a name="l00583"></a>00583   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a24a42901f684d82939664ccb4755b51a">numOverlapNodes</a>; ++i)
<a name="l00584"></a>00584   {
<a name="l00585"></a>00585     <span class="keywordtype">int</span> global = apf::getNumber(owned,<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aad11108cbc0ab01e0085eee0c8c6de9b" title="list of all overlap nodes, saved for setting solution">nodes</a>[i].entity,<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aad11108cbc0ab01e0085eee0c8c6de9b" title="list of all overlap nodes, saved for setting solution">nodes</a>[i].node,0);
<a name="l00586"></a>00586     nodeIndices[i] = global;
<a name="l00587"></a>00587     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j &lt; neq; ++j)
<a name="l00588"></a>00588       dofIndices[<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3b85ad0bf31e97a6acfe3b9720a59a71">getDOF</a>(i,j)] = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3b85ad0bf31e97a6acfe3b9720a59a71">getDOF</a>(global,j);
<a name="l00589"></a>00589   }
<a name="l00590"></a>00590   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#acad8cd7a63d6454e6dbb693a441433a5">overlap_node_map</a> = Teuchos::rcp(<span class="keyword">new</span> Epetra_Map(-1, nodeIndices.size(),
<a name="l00591"></a>00591              &amp;(nodeIndices[0]), 0, *<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a7d1190558a94ea348521bd01bbdfd2d7" title="Stk Mesh Objects.">comm</a>));
<a name="l00592"></a>00592   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a519e43ce03e84dd4523bb926b430da70" title="Overlapped unknown map, and node map.">overlap_map</a> = Teuchos::rcp(<span class="keyword">new</span> Epetra_Map(-1, dofIndices.size(),
<a name="l00593"></a>00593               &amp;(dofIndices[0]), 0, *<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a7d1190558a94ea348521bd01bbdfd2d7" title="Stk Mesh Objects.">comm</a>));
<a name="l00594"></a>00594   <span class="keywordflow">if</span>(Teuchos::nonnull(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;nodal_data_block))
<a name="l00595"></a>00595     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;nodal_data_block-&gt;resizeOverlapMap(nodeIndices, *<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a7d1190558a94ea348521bd01bbdfd2d7" title="Stk Mesh Objects.">comm</a>);
<a name="l00596"></a>00596 }
<a name="l00597"></a>00597 
<a name="l00598"></a>00598 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00599"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aa74e86321f0b669c9ecaf257fd1aac95">00599</a> <span class="keywordtype">void</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::computeGraphs</a>()
<a name="l00600"></a>00600 {
<a name="l00601"></a>00601   <span class="comment">// GAH: the following assumes all element blocks in the problem have the same</span>
<a name="l00602"></a>00602   <span class="comment">// number of nodes per element and that the cell topologies are the same.</span>
<a name="l00603"></a>00603   apf::Mesh* m = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;apfMesh;
<a name="l00604"></a>00604   <span class="keywordtype">int</span> numDim = m-&gt;getDimension();
<a name="l00605"></a>00605   std::vector&lt;apf::MeshEntity*&gt; cells;
<a name="l00606"></a>00606   cells.reserve(m-&gt;count(numDim));
<a name="l00607"></a>00607   apf::MeshIterator* it = m-&gt;begin(numDim);
<a name="l00608"></a>00608   apf::MeshEntity* e;
<a name="l00609"></a>00609   <span class="keywordflow">while</span> ((e = m-&gt;iterate(it)))
<a name="l00610"></a>00610     cells.push_back(e);
<a name="l00611"></a>00611   m-&gt;end(it);
<a name="l00612"></a>00612   <span class="comment">//got cells, count the nodes on the first one</span>
<a name="l00613"></a>00613   apf::Numbering* <a class="code" href="MOR__ExtendedEpetraLapack_8cpp.html#af5da5165aa5eeff113accece5748c995">n</a> = m-&gt;findNumbering(<span class="stringliteral">&quot;apf_owned_numbering&quot;</span>);
<a name="l00614"></a>00614   <span class="keywordtype">int</span> nodes_per_element = apf::countElementNodes(
<a name="l00615"></a>00615       apf::getShape(n),m-&gt;getType(cells[0]));
<a name="l00616"></a>00616   <span class="comment">/* construct the overlap graph of all local DOFs as they</span>
<a name="l00617"></a>00617 <span class="comment">     are coupled by element-node connectivity */</span>
<a name="l00618"></a>00618   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ace5cff8437b7947e42a96e7fc40f0c63" title="Overlapped Jacobian matrix graph.">overlap_graph</a> =
<a name="l00619"></a>00619     Teuchos::rcp(<span class="keyword">new</span> Epetra_CrsGraph(Copy, *<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a519e43ce03e84dd4523bb926b430da70" title="Overlapped unknown map, and node map.">overlap_map</a>,
<a name="l00620"></a>00620                                      <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3189db7ba940e93aa9643f8b8bae2fb5" title="Number of equations (and unknowns) per node.">neq</a>*nodes_per_element, <span class="keyword">false</span>));
<a name="l00621"></a>00621   <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i &lt; cells.size(); ++i)
<a name="l00622"></a>00622   {
<a name="l00623"></a>00623     apf::NewArray&lt;int&gt; cellNodes;
<a name="l00624"></a>00624     apf::getElementNumbers(n,cells[i],cellNodes);
<a name="l00625"></a>00625     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j &lt; nodes_per_element; ++j)
<a name="l00626"></a>00626     {
<a name="l00627"></a>00627       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3189db7ba940e93aa9643f8b8bae2fb5" title="Number of equations (and unknowns) per node.">neq</a>; ++k)
<a name="l00628"></a>00628       {
<a name="l00629"></a>00629         <span class="keywordtype">int</span> row = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3b85ad0bf31e97a6acfe3b9720a59a71">getDOF</a>(cellNodes[j],k);
<a name="l00630"></a>00630         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> l=0; l &lt; nodes_per_element; ++l)
<a name="l00631"></a>00631         {
<a name="l00632"></a>00632           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m=0; m &lt; neq; ++m)
<a name="l00633"></a>00633           {
<a name="l00634"></a>00634             <span class="keywordtype">int</span> col = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3b85ad0bf31e97a6acfe3b9720a59a71">getDOF</a>(cellNodes[l],m);
<a name="l00635"></a>00635             overlap_graph-&gt;InsertGlobalIndices(row,1,&amp;col);
<a name="l00636"></a>00636           }
<a name="l00637"></a>00637         }
<a name="l00638"></a>00638       }
<a name="l00639"></a>00639     }
<a name="l00640"></a>00640   }
<a name="l00641"></a>00641   overlap_graph-&gt;FillComplete();
<a name="l00642"></a>00642 
<a name="l00643"></a>00643   <span class="comment">// Create Owned graph by exporting overlap with known row map</span>
<a name="l00644"></a>00644 
<a name="l00645"></a>00645   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a687f7b0c2eaae12f67be20e56789699e" title="Jacobian matrix graph.">graph</a> = Teuchos::rcp(<span class="keyword">new</span> Epetra_CrsGraph(Copy, *<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad324c117e9184285851313cf597b0b61" title="Unknown Map.">map</a>, <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#acd61d39fb58cb34b3255480d0b66dcbf">nonzeroesPerRow</a>(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3189db7ba940e93aa9643f8b8bae2fb5" title="Number of equations (and unknowns) per node.">neq</a>), <span class="keyword">false</span>));
<a name="l00646"></a>00646 
<a name="l00647"></a>00647   <span class="comment">// Create non-overlapped matrix using two maps and export object</span>
<a name="l00648"></a>00648   Epetra_Export exporter(*<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a519e43ce03e84dd4523bb926b430da70" title="Overlapped unknown map, and node map.">overlap_map</a>, *<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad324c117e9184285851313cf597b0b61" title="Unknown Map.">map</a>);
<a name="l00649"></a>00649   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a687f7b0c2eaae12f67be20e56789699e" title="Jacobian matrix graph.">graph</a>-&gt;Export(*overlap_graph, exporter, Insert);
<a name="l00650"></a>00650   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a687f7b0c2eaae12f67be20e56789699e" title="Jacobian matrix graph.">graph</a>-&gt;FillComplete();
<a name="l00651"></a>00651 }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00654"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a857a84ea17f388728198fe0e7fae487a">00654</a> <span class="keywordtype">void</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::computeWorksetInfo</a>()
<a name="l00655"></a>00655 {
<a name="l00656"></a>00656   apf::Mesh* m = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;apfMesh;
<a name="l00657"></a>00657   <span class="keywordtype">int</span> numDim = m-&gt;getDimension();
<a name="l00658"></a>00658   apf::Numbering* en = m-&gt;findNumbering(<span class="stringliteral">&quot;apf_element_numbering&quot;</span>);
<a name="l00659"></a>00659   <span class="keywordflow">if</span> (en) apf::destroyNumbering(en);
<a name="l00660"></a>00660   en = apf::numberElements(m,<span class="stringliteral">&quot;apf_element_numbering&quot;</span>);
<a name="l00661"></a>00661   apf::globalize(en);
<a name="l00662"></a>00662   apf::Numbering* nn = m-&gt;findNumbering(<span class="stringliteral">&quot;apf_owned_numbering&quot;</span>);
<a name="l00663"></a>00663 
<a name="l00664"></a>00664 <span class="comment">/*</span>
<a name="l00665"></a>00665 <span class="comment">   * Note: Max workset size is given in input file, or set to a default in AlbPUMI_FMDBMeshStruct.cpp</span>
<a name="l00666"></a>00666 <span class="comment">   * The workset size is set in AlbPUMI_FMDBMeshStruct.cpp to be the maximum number in an element block if</span>
<a name="l00667"></a>00667 <span class="comment">   * the element block size &lt; Max workset size.</span>
<a name="l00668"></a>00668 <span class="comment">   * STK bucket size is set to the workset size. We will &quot;chunk&quot; the elements into worksets here.</span>
<a name="l00669"></a>00669 <span class="comment">   *</span>
<a name="l00670"></a>00670 <span class="comment">*/</span>
<a name="l00671"></a>00671 
<a name="l00672"></a>00672   <span class="comment">// This function is called each adaptive cycle. Need to reset the 2D array &quot;buckets&quot; back to the initial size.</span>
<a name="l00673"></a>00673 
<a name="l00674"></a>00674   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad8c395f1702c168a101a750414d0db27">buckets</a>.size(); i++)
<a name="l00675"></a>00675     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad8c395f1702c168a101a750414d0db27">buckets</a>[i].clear();
<a name="l00676"></a>00676 
<a name="l00677"></a>00677   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad8c395f1702c168a101a750414d0db27">buckets</a>.clear();
<a name="l00678"></a>00678 
<a name="l00679"></a>00679   pGeomEnt elem_blk;
<a name="l00680"></a>00680   std::map&lt;pElemBlk, int&gt; bucketMap;
<a name="l00681"></a>00681   std::map&lt;pElemBlk, int&gt;::iterator buck_it;
<a name="l00682"></a>00682   <span class="keywordtype">int</span> bucket_counter = 0;
<a name="l00683"></a>00683 
<a name="l00684"></a>00684   <span class="keywordtype">int</span> worksetSize = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;worksetSize;
<a name="l00685"></a>00685 
<a name="l00686"></a>00686   <span class="comment">// iterate over all elements</span>
<a name="l00687"></a>00687   apf::MeshIterator* it = m-&gt;begin(numDim);
<a name="l00688"></a>00688   apf::MeshEntity* element;
<a name="l00689"></a>00689   <span class="keywordflow">while</span> ((element = m-&gt;iterate(it)))
<a name="l00690"></a>00690   {
<a name="l00691"></a>00691 
<a name="l00692"></a>00692     <span class="comment">// skip owned elements</span>
<a name="l00693"></a>00693     <span class="keywordflow">if</span> ( ! m-&gt;isOwned(element))
<a name="l00694"></a>00694       <span class="keywordflow">continue</span>;
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     <span class="comment">// Get the element block that the element is in</span>
<a name="l00697"></a>00697     elem_blk = <span class="keyword">reinterpret_cast&lt;</span>pGeomEnt<span class="keyword">&gt;</span>(m-&gt;toModel(element));
<a name="l00698"></a>00698 
<a name="l00699"></a>00699     <span class="comment">// find which bucket holds the elements for the element block</span>
<a name="l00700"></a>00700     buck_it = bucketMap.find(elem_blk);
<a name="l00701"></a>00701 
<a name="l00702"></a>00702     <span class="keywordflow">if</span>((buck_it == bucketMap.end()) ||  <span class="comment">// Make a new bucket to hold the new element block&#39;s elements</span>
<a name="l00703"></a>00703        (<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad8c395f1702c168a101a750414d0db27">buckets</a>[buck_it-&gt;second].size() &gt;= worksetSize)){ <span class="comment">// old bucket is full, put the element in a new one</span>
<a name="l00704"></a>00704 
<a name="l00705"></a>00705       <span class="comment">// Associate this elem_blk with a new bucket</span>
<a name="l00706"></a>00706       bucketMap[elem_blk] = bucket_counter;
<a name="l00707"></a>00707 
<a name="l00708"></a>00708       <span class="comment">// resize the bucket array larger by one</span>
<a name="l00709"></a>00709       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad8c395f1702c168a101a750414d0db27">buckets</a>.resize(bucket_counter + 1);
<a name="l00710"></a>00710       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a783794e3b9848c1501f488829a520c52">wsEBNames</a>.resize(bucket_counter + 1);
<a name="l00711"></a>00711 
<a name="l00712"></a>00712       <span class="comment">// save the element in the bucket</span>
<a name="l00713"></a>00713       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad8c395f1702c168a101a750414d0db27">buckets</a>[bucket_counter].push_back(element);
<a name="l00714"></a>00714 
<a name="l00715"></a>00715       <span class="comment">// save the name of the new element block</span>
<a name="l00716"></a>00716       std::string EB_name;
<a name="l00717"></a>00717       PUMI_ElemBlk_GetName(elem_blk, EB_name);
<a name="l00718"></a>00718       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a783794e3b9848c1501f488829a520c52">wsEBNames</a>[bucket_counter] = EB_name;
<a name="l00719"></a>00719 
<a name="l00720"></a>00720       bucket_counter++;
<a name="l00721"></a>00721 
<a name="l00722"></a>00722     }
<a name="l00723"></a>00723     <span class="keywordflow">else</span> { <span class="comment">// put the element in the proper bucket</span>
<a name="l00724"></a>00724 
<a name="l00725"></a>00725       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad8c395f1702c168a101a750414d0db27">buckets</a>[buck_it-&gt;second].push_back(element);
<a name="l00726"></a>00726 
<a name="l00727"></a>00727     }
<a name="l00728"></a>00728 
<a name="l00729"></a>00729   }
<a name="l00730"></a>00730 
<a name="l00731"></a>00731   <span class="keywordtype">int</span> numBuckets = bucket_counter;
<a name="l00732"></a>00732 
<a name="l00733"></a>00733   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#afa68b6d861e5a6a6f09c5d6f65c59490">wsPhysIndex</a>.resize(numBuckets);
<a name="l00734"></a>00734 
<a name="l00735"></a>00735   <span class="keywordflow">if</span> (<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;allElementBlocksHaveSamePhysics)
<a name="l00736"></a>00736     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numBuckets; i++) <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#afa68b6d861e5a6a6f09c5d6f65c59490">wsPhysIndex</a>[i]=0;
<a name="l00737"></a>00737   <span class="keywordflow">else</span>
<a name="l00738"></a>00738     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numBuckets; i++) <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#afa68b6d861e5a6a6f09c5d6f65c59490">wsPhysIndex</a>[i]=<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;ebNameToIndex[<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a783794e3b9848c1501f488829a520c52">wsEBNames</a>[i]];
<a name="l00739"></a>00739 
<a name="l00740"></a>00740   <span class="comment">// Fill  wsElNodeEqID(workset, el_LID, local node, Eq) =&gt; unk_LID</span>
<a name="l00741"></a>00741 
<a name="l00742"></a>00742   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ab45bb22b3c3ee71ee40d7c3513282be9" title="Connectivity array [workset, element, local-node, Eq] =&amp;gt; LID.">wsElNodeEqID</a>.resize(numBuckets);
<a name="l00743"></a>00743   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aa50970dea5d6d5faaf83f95fe35e6343">wsElNodeID</a>.resize(numBuckets);
<a name="l00744"></a>00744   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a458ba67499378c33ab3172419609892b">coords</a>.resize(numBuckets);
<a name="l00745"></a>00745   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a7c03e5aa1d7e27ad0902f785bb14f781">sHeight</a>.resize(numBuckets);
<a name="l00746"></a>00746   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a55b4daae2788b23a834312970eedd794">temperature</a>.resize(numBuckets);
<a name="l00747"></a>00747   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad6ceffb80711f170d76f469f505388e4">basalFriction</a>.resize(numBuckets);
<a name="l00748"></a>00748   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5d6c36973fba3c74ed6a0832314feda1">thickness</a>.resize(numBuckets);
<a name="l00749"></a>00749   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aaf2c5762fca7d877f525f4ab7cdeb176">surfaceVelocity</a>.resize(numBuckets);
<a name="l00750"></a>00750   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ae1ff3ab84fb971b3632044c1e3d0d598">velocityRMS</a>.resize(numBuckets);
<a name="l00751"></a>00751   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3b22c768b879cd2730d8a60df90b1a08">flowFactor</a>.resize(numBuckets);
<a name="l00752"></a>00752   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aaf2c5762fca7d877f525f4ab7cdeb176">surfaceVelocity</a>.resize(numBuckets);
<a name="l00753"></a>00753   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ae1ff3ab84fb971b3632044c1e3d0d598">velocityRMS</a>.resize(numBuckets);
<a name="l00754"></a>00754 
<a name="l00755"></a>00755   <span class="comment">// Clear map if remeshing</span>
<a name="l00756"></a>00756   <span class="keywordflow">if</span>(!<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a958245b7cbcec18441b5187f75eb40d2" title="Connectivity map from elementGID to workset and LID in workset.">elemGIDws</a>.empty()) <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a958245b7cbcec18441b5187f75eb40d2" title="Connectivity map from elementGID to workset and LID in workset.">elemGIDws</a>.clear();
<a name="l00757"></a>00757 
<a name="l00758"></a>00758   <span class="comment">/* this block of code creates the wsElNodeEqID,</span>
<a name="l00759"></a>00759 <span class="comment">     wsElNodeID, and coords structures.</span>
<a name="l00760"></a>00760 <span class="comment">     These are (bucket, element, element_node, dof)-indexed</span>
<a name="l00761"></a>00761 <span class="comment">     structures to get numbers or coordinates */</span>
<a name="l00762"></a>00762   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> b=0; b &lt; numBuckets; b++) {
<a name="l00763"></a>00763 
<a name="l00764"></a>00764     std::vector&lt;apf::MeshEntity*&gt;&amp; buck = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad8c395f1702c168a101a750414d0db27">buckets</a>[b];
<a name="l00765"></a>00765     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ab45bb22b3c3ee71ee40d7c3513282be9" title="Connectivity array [workset, element, local-node, Eq] =&amp;gt; LID.">wsElNodeEqID</a>[b].resize(buck.size());
<a name="l00766"></a>00766     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aa50970dea5d6d5faaf83f95fe35e6343">wsElNodeID</a>[b].resize(buck.size());
<a name="l00767"></a>00767     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a458ba67499378c33ab3172419609892b">coords</a>[b].resize(buck.size());
<a name="l00768"></a>00768 
<a name="l00769"></a>00769     <span class="comment">// i is the element index within bucket b</span>
<a name="l00770"></a>00770 
<a name="l00771"></a>00771     <span class="keywordflow">for</span> (std::size_t i=0; i &lt; buck.size(); i++) {
<a name="l00772"></a>00772 
<a name="l00773"></a>00773       <span class="comment">// Traverse all the elements in this bucket</span>
<a name="l00774"></a>00774       element = buck[i];
<a name="l00775"></a>00775 
<a name="l00776"></a>00776       <span class="comment">// Now, save a map from element GID to workset on this PE</span>
<a name="l00777"></a>00777       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a958245b7cbcec18441b5187f75eb40d2" title="Connectivity map from elementGID to workset and LID in workset.">elemGIDws</a>[apf::getNumber(en,element,0,0)].ws = b;
<a name="l00778"></a>00778 
<a name="l00779"></a>00779       <span class="comment">// Now, save a map element GID to local id on this workset on this PE</span>
<a name="l00780"></a>00780       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a958245b7cbcec18441b5187f75eb40d2" title="Connectivity map from elementGID to workset and LID in workset.">elemGIDws</a>[apf::getNumber(en,element,0,0)].LID = i;
<a name="l00781"></a>00781 
<a name="l00782"></a>00782       <span class="comment">// get global node numbers</span>
<a name="l00783"></a>00783       apf::NewArray&lt;int&gt; nodeIDs;
<a name="l00784"></a>00784       apf::getElementNumbers(nn,element,nodeIDs);
<a name="l00785"></a>00785 
<a name="l00786"></a>00786       <span class="keywordtype">int</span> nodes_per_element = apf::countElementNodes(apf::getShape(nn),m-&gt;getType(element));
<a name="l00787"></a>00787       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ab45bb22b3c3ee71ee40d7c3513282be9" title="Connectivity array [workset, element, local-node, Eq] =&amp;gt; LID.">wsElNodeEqID</a>[b][i].resize(nodes_per_element);
<a name="l00788"></a>00788       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aa50970dea5d6d5faaf83f95fe35e6343">wsElNodeID</a>[b][i].resize(nodes_per_element);
<a name="l00789"></a>00789       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a458ba67499378c33ab3172419609892b">coords</a>[b][i].resize(nodes_per_element);
<a name="l00790"></a>00790 
<a name="l00791"></a>00791       <span class="comment">// loop over local nodes</span>
<a name="l00792"></a>00792 
<a name="l00793"></a>00793       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j &lt; nodes_per_element; j++) {
<a name="l00794"></a>00794 
<a name="l00795"></a>00795         <span class="keywordtype">int</span> node_gid = nodeIDs[j];
<a name="l00796"></a>00796         <span class="keywordtype">int</span> node_lid = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#acad8cd7a63d6454e6dbb693a441433a5">overlap_node_map</a>-&gt;LID(node_gid);
<a name="l00797"></a>00797 
<a name="l00798"></a>00798         TEUCHOS_TEST_FOR_EXCEPTION(node_lid&lt;0, std::logic_error,
<a name="l00799"></a>00799          <span class="stringliteral">&quot;FMDB1D_Disc: node_lid out of range &quot;</span> &lt;&lt; node_lid &lt;&lt; std::endl);
<a name="l00800"></a>00800 
<a name="l00801"></a>00801         <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a458ba67499378c33ab3172419609892b">coords</a>[b][i][j] = &amp;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#af463aaa757ceae108471aca50161e383">coordinates</a>[node_lid * 3];
<a name="l00802"></a>00802         <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ab45bb22b3c3ee71ee40d7c3513282be9" title="Connectivity array [workset, element, local-node, Eq] =&amp;gt; LID.">wsElNodeEqID</a>[b][i][j].resize(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3189db7ba940e93aa9643f8b8bae2fb5" title="Number of equations (and unknowns) per node.">neq</a>);
<a name="l00803"></a>00803         <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aa50970dea5d6d5faaf83f95fe35e6343">wsElNodeID</a>[b][i][j] = node_gid;
<a name="l00804"></a>00804 
<a name="l00805"></a>00805         <span class="keywordflow">for</span> (std::size_t eq=0; eq &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3189db7ba940e93aa9643f8b8bae2fb5" title="Number of equations (and unknowns) per node.">neq</a>; eq++)
<a name="l00806"></a>00806           <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ab45bb22b3c3ee71ee40d7c3513282be9" title="Connectivity array [workset, element, local-node, Eq] =&amp;gt; LID.">wsElNodeEqID</a>[b][i][j][eq] = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3b85ad0bf31e97a6acfe3b9720a59a71">getDOF</a>(node_lid,eq);
<a name="l00807"></a>00807 
<a name="l00808"></a>00808       }
<a name="l00809"></a>00809     }
<a name="l00810"></a>00810   }
<a name="l00811"></a>00811 
<a name="l00812"></a>00812   <span class="comment">// (Re-)allocate storage for element data</span>
<a name="l00813"></a>00813   <span class="comment">//</span>
<a name="l00814"></a>00814   <span class="comment">// For each state, create storage for the data for on processor elements</span>
<a name="l00815"></a>00815   <span class="comment">// elemGIDws.size() is the number of elements on this processor ...</span>
<a name="l00816"></a>00816   <span class="comment">// Note however that Intrepid will stride over numBuckets * worksetSize</span>
<a name="l00817"></a>00817   <span class="comment">// so we must allocate enough storage for that</span>
<a name="l00818"></a>00818 
<a name="l00819"></a>00819   std::size_t numElementsAccessed = numBuckets * worksetSize;
<a name="l00820"></a>00820 
<a name="l00821"></a>00821   <span class="keywordflow">for</span> (std::size_t i=0; i&lt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qpscalar_states.size(); i++) {
<a name="l00822"></a>00822       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qpscalar_states[i]-&gt;reAllocateBuffer(numElementsAccessed);
<a name="l00823"></a>00823   }
<a name="l00824"></a>00824   <span class="keywordflow">for</span> (std::size_t i=0; i&lt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qpvector_states.size(); i++) {
<a name="l00825"></a>00825       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qpvector_states[i]-&gt;reAllocateBuffer(numElementsAccessed);
<a name="l00826"></a>00826   }
<a name="l00827"></a>00827   <span class="keywordflow">for</span> (std::size_t i=0; i&lt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qptensor_states.size(); i++) {
<a name="l00828"></a>00828       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qptensor_states[i]-&gt;reAllocateBuffer(numElementsAccessed);
<a name="l00829"></a>00829   }
<a name="l00830"></a>00830   <span class="keywordflow">for</span> (std::size_t i=0; i&lt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;scalarValue_states.size(); i++) {
<a name="l00831"></a>00831       <span class="comment">// special case : need to store one double value that represents all the elements in the workset (time)</span>
<a name="l00832"></a>00832       <span class="comment">// numBuckets are the number of worksets</span>
<a name="l00833"></a>00833       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;scalarValue_states[i]-&gt;reAllocateBuffer(numBuckets);
<a name="l00834"></a>00834   }
<a name="l00835"></a>00835 
<a name="l00836"></a>00836   <span class="comment">// Pull out pointers to shards::Arrays for every bucket, for every state</span>
<a name="l00837"></a>00837 
<a name="l00838"></a>00838   <span class="comment">// Note that numBuckets is typically larger each time the mesh is adapted</span>
<a name="l00839"></a>00839 
<a name="l00840"></a>00840   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a61b42aea7b0fbd9cdba6f73c02de5c55">stateArrays</a>.<a class="code" href="structAlbany_1_1StateArrays.html#a5fa0a75997a1a3135dbd2559ad4e0e8f">elemStateArrays</a>.resize(numBuckets);
<a name="l00841"></a>00841 
<a name="l00842"></a>00842   <span class="keywordflow">for</span> (std::size_t b=0; b &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad8c395f1702c168a101a750414d0db27">buckets</a>.size(); b++) {
<a name="l00843"></a>00843 
<a name="l00844"></a>00844     std::vector&lt;apf::MeshEntity*&gt;&amp; buck = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad8c395f1702c168a101a750414d0db27">buckets</a>[b];
<a name="l00845"></a>00845 
<a name="l00846"></a>00846     <span class="keywordflow">for</span> (std::size_t i=0; i&lt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qpscalar_states.size(); i++) {
<a name="l00847"></a>00847       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a61b42aea7b0fbd9cdba6f73c02de5c55">stateArrays</a>.<a class="code" href="structAlbany_1_1StateArrays.html#a5fa0a75997a1a3135dbd2559ad4e0e8f">elemStateArrays</a>[b][<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qpscalar_states[i]-&gt;name] =
<a name="l00848"></a>00848                  <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qpscalar_states[i]-&gt;getMDA(buck.size());
<a name="l00849"></a>00849     }
<a name="l00850"></a>00850     <span class="keywordflow">for</span> (std::size_t i=0; i&lt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qpvector_states.size(); i++) {
<a name="l00851"></a>00851       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a61b42aea7b0fbd9cdba6f73c02de5c55">stateArrays</a>.<a class="code" href="structAlbany_1_1StateArrays.html#a5fa0a75997a1a3135dbd2559ad4e0e8f">elemStateArrays</a>[b][<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qpvector_states[i]-&gt;name] =
<a name="l00852"></a>00852                  <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qpvector_states[i]-&gt;getMDA(buck.size());
<a name="l00853"></a>00853     }
<a name="l00854"></a>00854     <span class="keywordflow">for</span> (std::size_t i=0; i&lt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qptensor_states.size(); i++) {
<a name="l00855"></a>00855       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a61b42aea7b0fbd9cdba6f73c02de5c55">stateArrays</a>.<a class="code" href="structAlbany_1_1StateArrays.html#a5fa0a75997a1a3135dbd2559ad4e0e8f">elemStateArrays</a>[b][<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qptensor_states[i]-&gt;name] =
<a name="l00856"></a>00856                  <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qptensor_states[i]-&gt;getMDA(buck.size());
<a name="l00857"></a>00857     }
<a name="l00858"></a>00858     <span class="keywordflow">for</span> (std::size_t i=0; i&lt;<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;scalarValue_states.size(); i++) {
<a name="l00859"></a>00859       <span class="comment">// Store one double precision value per workset</span>
<a name="l00860"></a>00860       <span class="keyword">const</span> <span class="keywordtype">int</span> size = 1;
<a name="l00861"></a>00861       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a61b42aea7b0fbd9cdba6f73c02de5c55">stateArrays</a>.<a class="code" href="structAlbany_1_1StateArrays.html#a5fa0a75997a1a3135dbd2559ad4e0e8f">elemStateArrays</a>[b][<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;scalarValue_states[i]-&gt;name] =
<a name="l00862"></a>00862                  <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;scalarValue_states[i]-&gt;getMDA(size);
<a name="l00863"></a>00863     }
<a name="l00864"></a>00864   }
<a name="l00865"></a>00865 
<a name="l00866"></a>00866 <span class="comment">// Process node data sets if present</span>
<a name="l00867"></a>00867 
<a name="l00868"></a>00868   <span class="keywordflow">if</span>(Teuchos::nonnull(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;nodal_data_block)){
<a name="l00869"></a>00869 
<a name="l00870"></a>00870     std::vector&lt; std::vector&lt;apf::Node&gt; &gt; nbuckets; <span class="comment">// bucket of nodes</span>
<a name="l00871"></a>00871     <span class="keywordtype">int</span> numNodeBuckets =  (int)ceil((<span class="keywordtype">double</span>)<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a8dc79e9eaa2504fb986595892bab3013" title="Number of elements on this processor.">numOwnedNodes</a> / (double)worksetSize);
<a name="l00872"></a>00872 
<a name="l00873"></a>00873     nbuckets.resize(numNodeBuckets);
<a name="l00874"></a>00874     <span class="keywordtype">int</span> node_bucket_counter = 0;
<a name="l00875"></a>00875     <span class="keywordtype">int</span> node_in_bucket = 0;
<a name="l00876"></a>00876 
<a name="l00877"></a>00877     <span class="comment">// iterate over all nodes and save the owned ones into buckets</span>
<a name="l00878"></a>00878     <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aad11108cbc0ab01e0085eee0c8c6de9b" title="list of all overlap nodes, saved for setting solution">nodes</a>.getSize(); ++i)
<a name="l00879"></a>00879       <span class="keywordflow">if</span> (m-&gt;isOwned(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aad11108cbc0ab01e0085eee0c8c6de9b" title="list of all overlap nodes, saved for setting solution">nodes</a>[i].entity))
<a name="l00880"></a>00880       {
<a name="l00881"></a>00881         nbuckets[node_bucket_counter].push_back(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aad11108cbc0ab01e0085eee0c8c6de9b" title="list of all overlap nodes, saved for setting solution">nodes</a>[i]);
<a name="l00882"></a>00882         node_in_bucket++;
<a name="l00883"></a>00883         <span class="keywordflow">if</span> (node_in_bucket &gt;= worksetSize) {
<a name="l00884"></a>00884           ++node_bucket_counter;
<a name="l00885"></a>00885           node_in_bucket = 0;
<a name="l00886"></a>00886         }
<a name="l00887"></a>00887       }
<a name="l00888"></a>00888 
<a name="l00889"></a>00889     Teuchos::RCP&lt;Albany::NodeFieldContainer&gt; node_states = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;nodal_data_block-&gt;getNodeContainer();
<a name="l00890"></a>00890 
<a name="l00891"></a>00891     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a61b42aea7b0fbd9cdba6f73c02de5c55">stateArrays</a>.<a class="code" href="structAlbany_1_1StateArrays.html#a93330d27ac0e1f884c7d0fae751e2741">nodeStateArrays</a>.resize(numNodeBuckets);
<a name="l00892"></a>00892 
<a name="l00893"></a>00893     <span class="comment">// Loop over all the node field containers</span>
<a name="l00894"></a>00894     <span class="keywordflow">for</span> (Albany::NodeFieldContainer::iterator nfs = node_states-&gt;begin();
<a name="l00895"></a>00895                 nfs != node_states-&gt;end(); ++nfs){
<a name="l00896"></a>00896       Teuchos::RCP&lt;AlbPUMI::AbstractPUMINodeFieldContainer&gt; nodeContainer =
<a name="l00897"></a>00897              Teuchos::rcp_dynamic_cast&lt;<a class="code" href="classAlbPUMI_1_1AbstractPUMINodeFieldContainer.html">AlbPUMI::AbstractPUMINodeFieldContainer</a>&gt;((*nfs).second);
<a name="l00898"></a>00898 
<a name="l00899"></a>00899       <span class="comment">// resize the container to hold all the owned node&#39;s data</span>
<a name="l00900"></a>00900       nodeContainer-&gt;resize(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ab8d6c20156402e12d1406136cd409db0" title="Node map.">node_map</a>);
<a name="l00901"></a>00901 
<a name="l00902"></a>00902       <span class="comment">// Now, loop over each workset to get a reference to each workset collection of nodes</span>
<a name="l00903"></a>00903       <span class="keywordflow">for</span> (std::size_t b=0; b &lt; nbuckets.size(); b++) {
<a name="l00904"></a>00904          std::vector&lt;apf::Node&gt;&amp; buck = nbuckets[b];
<a name="l00905"></a>00905          <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a61b42aea7b0fbd9cdba6f73c02de5c55">stateArrays</a>.<a class="code" href="structAlbany_1_1StateArrays.html#a93330d27ac0e1f884c7d0fae751e2741">nodeStateArrays</a>[b][(*nfs).first] = nodeContainer-&gt;getMDA(buck);
<a name="l00906"></a>00906       }
<a name="l00907"></a>00907     }
<a name="l00908"></a>00908   }
<a name="l00909"></a>00909 }
<a name="l00910"></a>00910 
<a name="l00911"></a>00911 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00912"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ae9bc9e1c39ef7319ba742cbe8eb786a6">00912</a> <span class="keywordtype">void</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::copyQPScalarToAPF</a>(
<a name="l00913"></a>00913     <span class="keywordtype">unsigned</span> nqp,
<a name="l00914"></a>00914     <a class="code" href="classAlbPUMI_1_1QPData.html">QPData&lt;double, 2&gt;</a>&amp; state,
<a name="l00915"></a>00915     apf::Field* f)
<a name="l00916"></a>00916 {
<a name="l00917"></a>00917   <span class="keywordflow">for</span> (std::size_t b=0; b &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad8c395f1702c168a101a750414d0db27">buckets</a>.size(); ++b) {
<a name="l00918"></a>00918     std::vector&lt;apf::MeshEntity*&gt;&amp; buck = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad8c395f1702c168a101a750414d0db27">buckets</a>[b];
<a name="l00919"></a>00919     <a class="code" href="namespaceAlbany.html#a76b8c026e962fe80abcca7402bdad39b">Albany::MDArray</a>&amp; ar = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a61b42aea7b0fbd9cdba6f73c02de5c55">stateArrays</a>.<a class="code" href="structAlbany_1_1StateArrays.html#a5fa0a75997a1a3135dbd2559ad4e0e8f">elemStateArrays</a>[b][state.<a class="code" href="classAlbPUMI_1_1QPData.html#a992734979655191cc7c8c9b959b88f31">name</a>];
<a name="l00920"></a>00920     <span class="keywordflow">for</span> (std::size_t e=0; e &lt; buck.size(); ++e)
<a name="l00921"></a>00921       <span class="keywordflow">for</span> (std::size_t p=0; p &lt; nqp; ++p)
<a name="l00922"></a>00922         apf::setScalar(f,buck[e],p,ar(e,p));
<a name="l00923"></a>00923   }
<a name="l00924"></a>00924 }
<a name="l00925"></a>00925 
<a name="l00926"></a>00926 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00927"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a789942fe8eb311264ad6f1e3f069d334">00927</a> <span class="keywordtype">void</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::copyQPVectorToAPF</a>(
<a name="l00928"></a>00928     <span class="keywordtype">unsigned</span> nqp,
<a name="l00929"></a>00929     <a class="code" href="classAlbPUMI_1_1QPData.html">QPData&lt;double, 3&gt;</a>&amp; state,
<a name="l00930"></a>00930     apf::Field* f)
<a name="l00931"></a>00931 {
<a name="l00932"></a>00932   <span class="keywordflow">for</span> (std::size_t b=0; b &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad8c395f1702c168a101a750414d0db27">buckets</a>.size(); ++b) {
<a name="l00933"></a>00933     std::vector&lt;apf::MeshEntity*&gt;&amp; buck = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad8c395f1702c168a101a750414d0db27">buckets</a>[b];
<a name="l00934"></a>00934     <a class="code" href="namespaceAlbany.html#a76b8c026e962fe80abcca7402bdad39b">Albany::MDArray</a>&amp; ar = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a61b42aea7b0fbd9cdba6f73c02de5c55">stateArrays</a>.<a class="code" href="structAlbany_1_1StateArrays.html#a5fa0a75997a1a3135dbd2559ad4e0e8f">elemStateArrays</a>[b][state.<a class="code" href="classAlbPUMI_1_1QPData.html#a992734979655191cc7c8c9b959b88f31">name</a>];
<a name="l00935"></a>00935     <span class="keywordflow">for</span> (std::size_t e=0; e &lt; buck.size(); ++e) {
<a name="l00936"></a>00936       apf::Vector3 v;
<a name="l00937"></a>00937       <span class="keywordflow">for</span> (std::size_t p=0; p &lt; nqp; ++p) {
<a name="l00938"></a>00938         <span class="keywordflow">for</span> (std::size_t i=0; i &lt; 3; ++i)
<a name="l00939"></a>00939           v[i] = ar(e,p,i);
<a name="l00940"></a>00940         apf::setVector(f,buck[e],p,v);
<a name="l00941"></a>00941       }
<a name="l00942"></a>00942     }
<a name="l00943"></a>00943   }
<a name="l00944"></a>00944 }
<a name="l00945"></a>00945 
<a name="l00946"></a>00946 <span class="keyword">template</span> &lt;<span class="keyword">class</span> Output&gt;
<a name="l00947"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a9b5844c50fd7df0b29a19a14ac2cf365">00947</a> <span class="keywordtype">void</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::copyQPTensorToAPF</a>(
<a name="l00948"></a>00948     <span class="keywordtype">unsigned</span> nqp,
<a name="l00949"></a>00949     <a class="code" href="classAlbPUMI_1_1QPData.html">QPData&lt;double, 4&gt;</a>&amp; state,
<a name="l00950"></a>00950     apf::Field* f)
<a name="l00951"></a>00951 {
<a name="l00952"></a>00952   <span class="keywordflow">for</span> (std::size_t b=0; b &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad8c395f1702c168a101a750414d0db27">buckets</a>.size(); ++b) {
<a name="l00953"></a>00953     std::vector&lt;apf::MeshEntity*&gt;&amp; buck = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ad8c395f1702c168a101a750414d0db27">buckets</a>[b];
<a name="l00954"></a>00954     <a class="code" href="namespaceAlbany.html#a76b8c026e962fe80abcca7402bdad39b">Albany::MDArray</a>&amp; ar = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a61b42aea7b0fbd9cdba6f73c02de5c55">stateArrays</a>.<a class="code" href="structAlbany_1_1StateArrays.html#a5fa0a75997a1a3135dbd2559ad4e0e8f">elemStateArrays</a>[b][state.<a class="code" href="classAlbPUMI_1_1QPData.html#a992734979655191cc7c8c9b959b88f31">name</a>];
<a name="l00955"></a>00955     <span class="keywordflow">for</span> (std::size_t e=0; e &lt; buck.size(); ++e) {
<a name="l00956"></a>00956       apf::Matrix3x3 v;
<a name="l00957"></a>00957       <span class="keywordflow">for</span> (std::size_t p=0; p &lt; nqp; ++p) {
<a name="l00958"></a>00958         <span class="keywordflow">for</span> (std::size_t i=0; i &lt; 3; ++i)
<a name="l00959"></a>00959         <span class="keywordflow">for</span> (std::size_t j=0; j &lt; 3; ++j)
<a name="l00960"></a>00960           v[i][j] = ar(e,p,i,j);
<a name="l00961"></a>00961         apf::setMatrix(f,buck[e],p,v);
<a name="l00962"></a>00962       }
<a name="l00963"></a>00963     }
<a name="l00964"></a>00964   }
<a name="l00965"></a>00965 }
<a name="l00966"></a>00966 
<a name="l00967"></a>00967 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00968"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a8c7b0c43a3f10d74a0955d78a0a98139">00968</a> <span class="keywordtype">void</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::copyQPStatesToAPF</a>() {
<a name="l00969"></a>00969   apf::Mesh2* m = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;apfMesh;
<a name="l00970"></a>00970   <span class="keywordtype">int</span> order = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;cubatureDegree;
<a name="l00971"></a>00971   apf::Field* f;
<a name="l00972"></a>00972   <span class="keywordflow">for</span> (std::size_t i=0; i &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qpscalar_states.size(); ++i) {
<a name="l00973"></a>00973     <a class="code" href="classAlbPUMI_1_1QPData.html">QPData&lt;double, 2&gt;</a>&amp; state = *(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qpscalar_states[i]);
<a name="l00974"></a>00974     <span class="keywordtype">int</span> nqp = state.<a class="code" href="classAlbPUMI_1_1QPData.html#ab30803049c1dc14e91fa4d5a61a4d4cd">dims</a>[1];
<a name="l00975"></a>00975     f = apf::createIPField(m,state.<a class="code" href="classAlbPUMI_1_1QPData.html#a992734979655191cc7c8c9b959b88f31">name</a>.c_str(),apf::SCALAR,order);
<a name="l00976"></a>00976     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ae9bc9e1c39ef7319ba742cbe8eb786a6" title="Transfer QPData to APF.">copyQPScalarToAPF</a>(nqp,state,f);
<a name="l00977"></a>00977   }
<a name="l00978"></a>00978   <span class="keywordflow">for</span> (std::size_t i=0; i &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qpvector_states.size(); ++i) {
<a name="l00979"></a>00979     <a class="code" href="classAlbPUMI_1_1QPData.html">QPData&lt;double, 3&gt;</a>&amp; state = *(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qpvector_states[i]);
<a name="l00980"></a>00980     <span class="keywordtype">int</span> nqp = state.<a class="code" href="classAlbPUMI_1_1QPData.html#ab30803049c1dc14e91fa4d5a61a4d4cd">dims</a>[1];
<a name="l00981"></a>00981     f = apf::createIPField(m,state.<a class="code" href="classAlbPUMI_1_1QPData.html#a992734979655191cc7c8c9b959b88f31">name</a>.c_str(),apf::VECTOR,order);
<a name="l00982"></a>00982     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a789942fe8eb311264ad6f1e3f069d334">copyQPVectorToAPF</a>(nqp,state,f);
<a name="l00983"></a>00983   }
<a name="l00984"></a>00984   <span class="keywordflow">for</span> (std::size_t i=0; i &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qptensor_states.size(); ++i) {
<a name="l00985"></a>00985     <a class="code" href="classAlbPUMI_1_1QPData.html">QPData&lt;double, 4&gt;</a>&amp; state = *(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qptensor_states[i]);
<a name="l00986"></a>00986     <span class="keywordtype">int</span> nqp = state.<a class="code" href="classAlbPUMI_1_1QPData.html#ab30803049c1dc14e91fa4d5a61a4d4cd">dims</a>[1];
<a name="l00987"></a>00987     f = apf::createIPField(m,state.<a class="code" href="classAlbPUMI_1_1QPData.html#a992734979655191cc7c8c9b959b88f31">name</a>.c_str(),apf::MATRIX,order);
<a name="l00988"></a>00988     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a9b5844c50fd7df0b29a19a14ac2cf365">copyQPTensorToAPF</a>(nqp,state,f);
<a name="l00989"></a>00989   }
<a name="l00990"></a>00990 }
<a name="l00991"></a>00991 
<a name="l00992"></a>00992 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l00993"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a72a4d089f56d7ca623120af0c2e7314c">00993</a> <span class="keywordtype">void</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::removeQPStatesFromAPF</a>() {
<a name="l00994"></a>00994   apf::Mesh2* m = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;apfMesh;
<a name="l00995"></a>00995   <span class="keywordflow">for</span> (std::size_t i=0; i &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qpscalar_states.size(); ++i) {
<a name="l00996"></a>00996     <a class="code" href="classAlbPUMI_1_1QPData.html">QPData&lt;double, 2&gt;</a>&amp; state = *(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qpscalar_states[i]);
<a name="l00997"></a>00997     apf::destroyField(m-&gt;findField(state.<a class="code" href="classAlbPUMI_1_1QPData.html#a992734979655191cc7c8c9b959b88f31">name</a>.c_str()));
<a name="l00998"></a>00998   }
<a name="l00999"></a>00999   <span class="keywordflow">for</span> (std::size_t i=0; i &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qpvector_states.size(); ++i) {
<a name="l01000"></a>01000     <a class="code" href="classAlbPUMI_1_1QPData.html">QPData&lt;double, 3&gt;</a>&amp; state = *(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qpvector_states[i]);
<a name="l01001"></a>01001     apf::destroyField(m-&gt;findField(state.<a class="code" href="classAlbPUMI_1_1QPData.html#a992734979655191cc7c8c9b959b88f31">name</a>.c_str()));
<a name="l01002"></a>01002   }
<a name="l01003"></a>01003   <span class="keywordflow">for</span> (std::size_t i=0; i &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qptensor_states.size(); ++i) {
<a name="l01004"></a>01004     <a class="code" href="classAlbPUMI_1_1QPData.html">QPData&lt;double, 4&gt;</a>&amp; state = *(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;qptensor_states[i]);
<a name="l01005"></a>01005     apf::destroyField(m-&gt;findField(state.<a class="code" href="classAlbPUMI_1_1QPData.html#a992734979655191cc7c8c9b959b88f31">name</a>.c_str()));
<a name="l01006"></a>01006   }
<a name="l01007"></a>01007 }
<a name="l01008"></a>01008 
<a name="l01009"></a>01009 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l01010"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a29d548c5632dddda51fbf71a4ce73007">01010</a> <span class="keywordtype">void</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::computeSideSets</a>() {
<a name="l01011"></a>01011 
<a name="l01012"></a>01012   pMeshMdl mesh = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;getMesh();
<a name="l01013"></a>01013   pPart part;
<a name="l01014"></a>01014   FMDB_Mesh_GetPart(mesh, 0, part);
<a name="l01015"></a>01015   apf::Mesh* m = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;apfMesh;
<a name="l01016"></a>01016   apf::Numbering* en = m-&gt;findNumbering(<span class="stringliteral">&quot;apf_element_numbering&quot;</span>);
<a name="l01017"></a>01017 
<a name="l01018"></a>01018   <span class="comment">// need a sideset list per workset</span>
<a name="l01019"></a>01019   <span class="keywordtype">int</span> num_buckets = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a783794e3b9848c1501f488829a520c52">wsEBNames</a>.size();
<a name="l01020"></a>01020   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a7f3cbd9ccf42c181731d304cc46ee9ff" title="side sets stored as std::map(string ID, SideArray classes) per workset (std::vector across worksets)...">sideSets</a>.resize(num_buckets);
<a name="l01021"></a>01021 
<a name="l01022"></a>01022   <span class="comment">// get side sets</span>
<a name="l01023"></a>01023   std::vector&lt;pSideSet&gt; side_sets;
<a name="l01024"></a>01024   PUMI_Exodus_GetSideSet(mesh, side_sets);
<a name="l01025"></a>01025 
<a name="l01026"></a>01026   std::vector&lt;pMeshEnt&gt; side_elems;
<a name="l01027"></a>01027   std::vector&lt;pMeshEnt&gt; ss_sides;
<a name="l01028"></a>01028 
<a name="l01029"></a>01029   <span class="comment">// loop over side sets</span>
<a name="l01030"></a>01030   <span class="keywordflow">for</span> (std::vector&lt;pSideSet&gt;::iterator ss = side_sets.begin();
<a name="l01031"></a>01031        ss != side_sets.end(); ++ss) {
<a name="l01032"></a>01032 
<a name="l01033"></a>01033     <span class="comment">// get the name of this side set</span>
<a name="l01034"></a>01034     std::string ss_name;
<a name="l01035"></a>01035     PUMI_SideSet_GetName(*ss, ss_name);
<a name="l01036"></a>01036 
<a name="l01037"></a>01037     <span class="comment">// get sides on side the side set</span>
<a name="l01038"></a>01038     ss_sides.clear();
<a name="l01039"></a>01039     PUMI_SideSet_GetSide(mesh, *ss, ss_sides);
<a name="l01040"></a>01040 
<a name="l01041"></a>01041     <span class="comment">// loop over the sides in this side set</span>
<a name="l01042"></a>01042     <span class="keywordflow">for</span> (std::vector&lt;pMeshEnt&gt;::iterator side = ss_sides.begin();
<a name="l01043"></a>01043    side != ss_sides.end(); ++side) {
<a name="l01044"></a>01044 
<a name="l01045"></a>01045       <span class="comment">// get the elements adjacent to this side</span>
<a name="l01046"></a>01046       <span class="comment">// note - if the side is internal, it will show up twice in the element list,</span>
<a name="l01047"></a>01047       <span class="comment">// once for each element that contains it</span>
<a name="l01048"></a>01048 
<a name="l01049"></a>01049       side_elems.clear();
<a name="l01050"></a>01050       <span class="keywordtype">int</span> side_dim;
<a name="l01051"></a>01051       FMDB_Ent_GetType(*side, &amp;side_dim);
<a name="l01052"></a>01052       FMDB_Ent_GetAdj(*side, side_dim+1, 1, side_elems);
<a name="l01053"></a>01053 
<a name="l01054"></a>01054       <span class="comment">// according to template below - we are not yet considering non-manifold side sets?</span>
<a name="l01055"></a>01055       <span class="comment">// i.e. side_elems.size() &gt; 1</span>
<a name="l01056"></a>01056       TEUCHOS_TEST_FOR_EXCEPTION(side_elems.size() != 1, std::logic_error,
<a name="l01057"></a>01057        <span class="stringliteral">&quot;FMDBDisc: cannot figure out side set topology for side set &quot;</span>&lt;&lt;ss_name&lt;&lt;std::endl);
<a name="l01058"></a>01058 
<a name="l01059"></a>01059       pMeshEnt elem = side_elems[0];
<a name="l01060"></a>01060 
<a name="l01061"></a>01061       <span class="comment">// fill in the data holder for a side struct</span>
<a name="l01062"></a>01062 
<a name="l01063"></a>01063       <a class="code" href="classAlbany_1_1SideStruct.html">Albany::SideStruct</a> sstruct;
<a name="l01064"></a>01064 
<a name="l01065"></a>01065       sstruct.<a class="code" href="classAlbany_1_1SideStruct.html#a50506ee9fc0595d300b04254e53a4793">elem_GID</a> = apf::getNumber(en,apf::castEntity(elem),0,0);
<a name="l01066"></a>01066       <span class="keywordtype">int</span> workset = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a958245b7cbcec18441b5187f75eb40d2" title="Connectivity map from elementGID to workset and LID in workset.">elemGIDws</a>[sstruct.<a class="code" href="classAlbany_1_1SideStruct.html#a50506ee9fc0595d300b04254e53a4793">elem_GID</a>].ws; <span class="comment">// workset ID that this element lives in</span>
<a name="l01067"></a>01067       sstruct.<a class="code" href="classAlbany_1_1SideStruct.html#a92168f82ffe346dbbfb6f342c118bda6">elem_LID</a> = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a958245b7cbcec18441b5187f75eb40d2" title="Connectivity map from elementGID to workset and LID in workset.">elemGIDws</a>[sstruct.<a class="code" href="classAlbany_1_1SideStruct.html#a50506ee9fc0595d300b04254e53a4793">elem_GID</a>].LID; <span class="comment">// local element id in this workset</span>
<a name="l01068"></a>01068       sstruct.<a class="code" href="classAlbany_1_1SideStruct.html#a393e973e78d18e4957af1d4c96d41024">elem_ebIndex</a> = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;ebNameToIndex[<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a783794e3b9848c1501f488829a520c52">wsEBNames</a>[workset]]; <span class="comment">// element block that workset lives in</span>
<a name="l01069"></a>01069 
<a name="l01070"></a>01070       <span class="keywordtype">int</span> side_exodus_order;
<a name="l01071"></a>01071       PUMI_MeshEnt_GetExodusOrder(elem, *side, &amp;side_exodus_order);
<a name="l01072"></a>01072       sstruct.<a class="code" href="classAlbany_1_1SideStruct.html#aef6d3d9d010972a218940d8c776fd178">side_local_id</a> = side_exodus_order-1; <span class="comment">// local id of side wrt element</span>
<a name="l01073"></a>01073 
<a name="l01074"></a>01074       <a class="code" href="namespaceAlbany.html#aa0bc1b08430527fdeb81b86e76b48e1e">Albany::SideSetList</a>&amp; ssList = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a7f3cbd9ccf42c181731d304cc46ee9ff" title="side sets stored as std::map(string ID, SideArray classes) per workset (std::vector across worksets)...">sideSets</a>[workset]; <span class="comment">// Get a ref to the side set map for this ws</span>
<a name="l01075"></a>01075 
<a name="l01076"></a>01076       Albany::SideSetList::iterator it = ssList.find(ss_name); <span class="comment">// Get an iterator to the correct sideset (if</span>
<a name="l01077"></a>01077                                                        <span class="comment">// it exists)</span>
<a name="l01078"></a>01078 
<a name="l01079"></a>01079       <span class="keywordflow">if</span>(it != ssList.end()) <span class="comment">// The sideset has already been created</span>
<a name="l01080"></a>01080 
<a name="l01081"></a>01081         it-&gt;second.push_back(sstruct); <span class="comment">// Save this side to the vector that belongs to the name ss-&gt;first</span>
<a name="l01082"></a>01082 
<a name="l01083"></a>01083       <span class="keywordflow">else</span> { <span class="comment">// Add the key ss_name to the map, and the side vector to that map</span>
<a name="l01084"></a>01084 
<a name="l01085"></a>01085         std::vector&lt;Albany::SideStruct&gt; tmpSSVec;
<a name="l01086"></a>01086         tmpSSVec.push_back(sstruct);
<a name="l01087"></a>01087         ssList.insert(Albany::SideSetList::value_type(ss_name, tmpSSVec));
<a name="l01088"></a>01088       }
<a name="l01089"></a>01089 
<a name="l01090"></a>01090     }
<a name="l01091"></a>01091   }
<a name="l01092"></a>01092 }
<a name="l01093"></a>01093 
<a name="l01094"></a>01094 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l01095"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a78891d77e44e2db4ab57b49fd5b06fff">01095</a> <span class="keywordtype">void</span> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::computeNodeSets</a>()
<a name="l01096"></a>01096 {
<a name="l01097"></a>01097   <span class="comment">// Make sure all the maps are allocated</span>
<a name="l01098"></a>01098   <span class="keywordflow">for</span> (std::vector&lt;std::string&gt;::iterator ns_iter = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;nsNames.begin();
<a name="l01099"></a>01099         ns_iter != <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;nsNames.end(); ++ns_iter )
<a name="l01100"></a>01100   { <span class="comment">// Iterate over Node Sets</span>
<a name="l01101"></a>01101     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aeaa47b390cd04fd65f6812859cb04a28" title="node sets stored as std::map(string ID, int vector of GIDs)">nodeSets</a>[*ns_iter].resize(0);
<a name="l01102"></a>01102     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a085368c8fc8322335def4cec0330ecb4">nodeSetCoords</a>[*ns_iter].resize(0);
<a name="l01103"></a>01103     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5ba22d206757ad29fedfb8be7aabbf90">nodeset_node_coords</a>[*ns_iter].resize(0);
<a name="l01104"></a>01104   }
<a name="l01105"></a>01105   <span class="comment">//grab the node set geometric objects</span>
<a name="l01106"></a>01106   std::vector&lt;pNodeSet&gt; node_set;
<a name="l01107"></a>01107   PUMI_Exodus_GetNodeSet(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;getMesh(), node_set);
<a name="l01108"></a>01108   apf::Mesh* m = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;apfMesh;
<a name="l01109"></a>01109   apf::Numbering* <a class="code" href="MOR__ExtendedEpetraLapack_8cpp.html#af5da5165aa5eeff113accece5748c995">n</a> = m-&gt;findNumbering(<span class="stringliteral">&quot;apf_owned_numbering&quot;</span>);
<a name="l01110"></a>01110   <span class="keywordtype">int</span> mesh_dim = m-&gt;getDimension();
<a name="l01111"></a>01111   <span class="keywordflow">for</span> (std::vector&lt;pNodeSet&gt;::iterator node_set_it=node_set.begin(); node_set_it!=node_set.end(); ++node_set_it)
<a name="l01112"></a>01112   {
<a name="l01113"></a>01113     apf::DynamicArray&lt;apf::Node&gt; nodesInSet;
<a name="l01114"></a>01114     apf::ModelEntity* me = <span class="keyword">reinterpret_cast&lt;</span>apf::ModelEntity*<span class="keyword">&gt;</span>(*node_set_it);
<a name="l01115"></a>01115     apf::getNodesOnClosure(m,me,nodesInSet);
<a name="l01116"></a>01116     std::vector&lt;apf::Node&gt; owned_ns_nodes;
<a name="l01117"></a>01117     <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i &lt; nodesInSet.getSize(); ++i)
<a name="l01118"></a>01118       <span class="keywordflow">if</span> (m-&gt;isOwned(nodesInSet[i].entity))
<a name="l01119"></a>01119         owned_ns_nodes.push_back(nodesInSet[i]);
<a name="l01120"></a>01120     std::string NS_name;
<a name="l01121"></a>01121     PUMI_NodeSet_GetName(*node_set_it, NS_name);
<a name="l01122"></a>01122     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aeaa47b390cd04fd65f6812859cb04a28" title="node sets stored as std::map(string ID, int vector of GIDs)">nodeSets</a>[NS_name].resize(owned_ns_nodes.size());
<a name="l01123"></a>01123     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a085368c8fc8322335def4cec0330ecb4">nodeSetCoords</a>[NS_name].resize(owned_ns_nodes.size());
<a name="l01124"></a>01124     <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5ba22d206757ad29fedfb8be7aabbf90">nodeset_node_coords</a>[NS_name].resize(owned_ns_nodes.size() * mesh_dim);
<a name="l01125"></a>01125     <span class="keywordflow">for</span> (std::size_t i=0; i &lt; owned_ns_nodes.size(); i++)
<a name="l01126"></a>01126     {
<a name="l01127"></a>01127       apf::Node node = owned_ns_nodes[i];
<a name="l01128"></a>01128       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aeaa47b390cd04fd65f6812859cb04a28" title="node sets stored as std::map(string ID, int vector of GIDs)">nodeSets</a>[NS_name][i].resize(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3189db7ba940e93aa9643f8b8bae2fb5" title="Number of equations (and unknowns) per node.">neq</a>);
<a name="l01129"></a>01129       <span class="keywordtype">int</span> node_gid = apf::getNumber(n,node.entity,node.node,0);
<a name="l01130"></a>01130       <span class="keywordtype">int</span> node_lid = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ab8d6c20156402e12d1406136cd409db0" title="Node map.">node_map</a>-&gt;LID(node_gid);
<a name="l01131"></a>01131       assert(node_lid &gt;= 0);
<a name="l01132"></a>01132       assert(node_lid &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a8dc79e9eaa2504fb986595892bab3013" title="Number of elements on this processor.">numOwnedNodes</a>);
<a name="l01133"></a>01133       <span class="keywordflow">for</span> (std::size_t eq=0; eq &lt; <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3189db7ba940e93aa9643f8b8bae2fb5" title="Number of equations (and unknowns) per node.">neq</a>; eq++)
<a name="l01134"></a>01134         <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aeaa47b390cd04fd65f6812859cb04a28" title="node sets stored as std::map(string ID, int vector of GIDs)">nodeSets</a>[NS_name][i][eq] = <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a3b85ad0bf31e97a6acfe3b9720a59a71">getDOF</a>(node_lid, eq);
<a name="l01135"></a>01135       <span class="keywordtype">double</span>* node_coords = &amp;(<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5ba22d206757ad29fedfb8be7aabbf90">nodeset_node_coords</a>[NS_name][i*mesh_dim]);
<a name="l01136"></a>01136       apf::getComponents(m-&gt;getCoordinateField(),node.entity,node.node,node_coords);
<a name="l01137"></a>01137       <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a085368c8fc8322335def4cec0330ecb4">nodeSetCoords</a>[NS_name][i] = node_coords;
<a name="l01138"></a>01138     }
<a name="l01139"></a>01139   }
<a name="l01140"></a>01140 }
<a name="l01141"></a>01141 
<a name="l01142"></a>01142 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Output&gt;
<a name="l01143"></a>01143 <span class="keywordtype">void</span>
<a name="l01144"></a><a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aa946c104ba44f8873854f3c35d8f9e4e">01144</a> <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html">AlbPUMI::FMDBDiscretization&lt;Output&gt;::updateMesh</a>()
<a name="l01145"></a>01145 {
<a name="l01146"></a>01146   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a24345f8118d9f5a9222d7c48e2d2c8e8" title="Process FMDB mesh for Owned nodal quantitites.">computeOwnedNodesAndUnknowns</a>();
<a name="l01147"></a>01147 <span class="preprocessor">#ifdef ALBANY_DEBUG</span>
<a name="l01148"></a>01148 <span class="preprocessor"></span>  std::cout&lt;&lt;<span class="stringliteral">&quot;[&quot;</span>&lt;&lt;SCUTIL_CommRank()&lt;&lt;<span class="stringliteral">&quot;] &quot;</span>&lt;&lt;__func__&lt;&lt;<span class="stringliteral">&quot;: computeOwnedNodesAndUnknowns() completed\n&quot;</span>;
<a name="l01149"></a>01149 <span class="preprocessor">#endif</span>
<a name="l01150"></a>01150 <span class="preprocessor"></span>
<a name="l01151"></a>01151   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a4863da5ffb1b1026704b0c3df212dfa3" title="Process FMDB mesh for Overlap nodal quantitites.">computeOverlapNodesAndUnknowns</a>();
<a name="l01152"></a>01152 <span class="preprocessor">#ifdef ALBANY_DEBUG</span>
<a name="l01153"></a>01153 <span class="preprocessor"></span>  std::cout&lt;&lt;<span class="stringliteral">&quot;[&quot;</span>&lt;&lt;SCUTIL_CommRank()&lt;&lt;<span class="stringliteral">&quot;] &quot;</span>&lt;&lt;__func__&lt;&lt;<span class="stringliteral">&quot;: computeOverlapNodesAndUnknowns() completed\n&quot;</span>;
<a name="l01154"></a>01154 <span class="preprocessor">#endif</span>
<a name="l01155"></a>01155 <span class="preprocessor"></span>
<a name="l01156"></a>01156   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#aa74e86321f0b669c9ecaf257fd1aac95" title="Process FMDB mesh for CRS Graphs.">computeGraphs</a>();
<a name="l01157"></a>01157 <span class="preprocessor">#ifdef ALBANY_DEBUG</span>
<a name="l01158"></a>01158 <span class="preprocessor"></span>  std::cout&lt;&lt;<span class="stringliteral">&quot;[&quot;</span>&lt;&lt;SCUTIL_CommRank()&lt;&lt;<span class="stringliteral">&quot;] &quot;</span>&lt;&lt;__func__&lt;&lt;<span class="stringliteral">&quot;: computeGraphs() completed\n&quot;</span>;
<a name="l01159"></a>01159 <span class="preprocessor">#endif</span>
<a name="l01160"></a>01160 <span class="preprocessor"></span>
<a name="l01161"></a>01161   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#ae1b5a3fa5402be5ad8ff19b875f56ea3" title="Retrieve coodinate vector (num_used_nodes * 3).">getCoordinates</a>(); <span class="comment">//fill the coordinates array</span>
<a name="l01162"></a>01162 
<a name="l01163"></a>01163   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a857a84ea17f388728198fe0e7fae487a" title="Process FMDB mesh for Workset/Bucket Info.">computeWorksetInfo</a>();
<a name="l01164"></a>01164 <span class="preprocessor">#ifdef ALBANY_DEBUG</span>
<a name="l01165"></a>01165 <span class="preprocessor"></span>  std::cout&lt;&lt;<span class="stringliteral">&quot;[&quot;</span>&lt;&lt;SCUTIL_CommRank()&lt;&lt;<span class="stringliteral">&quot;] &quot;</span>&lt;&lt;__func__&lt;&lt;<span class="stringliteral">&quot;: computeWorksetInfo() completed\n&quot;</span>;
<a name="l01166"></a>01166 <span class="preprocessor">#endif</span>
<a name="l01167"></a>01167 <span class="preprocessor"></span>
<a name="l01168"></a>01168   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a78891d77e44e2db4ab57b49fd5b06fff" title="Process FMDB mesh for NodeSets.">computeNodeSets</a>();
<a name="l01169"></a>01169 <span class="preprocessor">#ifdef ALBANY_DEBUG</span>
<a name="l01170"></a>01170 <span class="preprocessor"></span>  std::cout&lt;&lt;<span class="stringliteral">&quot;[&quot;</span>&lt;&lt;SCUTIL_CommRank()&lt;&lt;<span class="stringliteral">&quot;] &quot;</span>&lt;&lt;__func__&lt;&lt;<span class="stringliteral">&quot;: computeNodeSets() completed\n&quot;</span>;
<a name="l01171"></a>01171 <span class="preprocessor">#endif</span>
<a name="l01172"></a>01172 <span class="preprocessor"></span>
<a name="l01173"></a>01173   <a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a29d548c5632dddda51fbf71a4ce73007" title="Process FMDB mesh for SideSets.">computeSideSets</a>();
<a name="l01174"></a>01174 <span class="preprocessor">#ifdef ALBANY_DEBUG</span>
<a name="l01175"></a>01175 <span class="preprocessor"></span>  std::cout&lt;&lt;<span class="stringliteral">&quot;[&quot;</span>&lt;&lt;SCUTIL_CommRank()&lt;&lt;<span class="stringliteral">&quot;] &quot;</span>&lt;&lt;__func__&lt;&lt;<span class="stringliteral">&quot;: computeSideSets() completed\n&quot;</span>;
<a name="l01176"></a>01176 <span class="preprocessor">#endif</span>
<a name="l01177"></a>01177 <span class="preprocessor"></span>
<a name="l01178"></a>01178   <span class="keyword">static</span> <span class="keywordtype">bool</span> first = <span class="keyword">true</span>;
<a name="l01179"></a>01179   <span class="keywordflow">if</span> (first)
<a name="l01180"></a>01180     first = <span class="keyword">false</span>;
<a name="l01181"></a>01181   <span class="keywordflow">else</span>
<a name="l01182"></a>01182     apf::writeVtkFiles(<span class="stringliteral">&quot;updateMesh&quot;</span>,<a class="code" href="classAlbPUMI_1_1FMDBDiscretization.html#a5376a1c1a1d5e981aa4c945736f02090">fmdbMeshStruct</a>-&gt;apfMesh);
<a name="l01183"></a>01183 
<a name="l01184"></a>01184 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Mar 26 2014 18:36:37 for Albany: a Trilinos-based PDE code by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
